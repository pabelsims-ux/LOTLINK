<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://api.lotolink.com https://api.qrserver.com https://tile.openstreetmap.org https://api.allorigins.win https://corsproxy.io https://api.codetabs.com https://loteriasdominicanas.com;">
  <title>LotoLink Desktop â€” Premium Lottery App</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Font Awesome Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    /* ========================================
       LOTOLINK DESKTOP - PREMIUM DESIGN SYSTEM
       Inspired by Apple Music, Spotify, Discord, Linear
       ======================================== */
    
    :root {
      /* Premium Color Palette - Purple Theme */
      --primary: #7C3AED;
      --primary-dark: #6D28D9;
      --primary-light: #A78BFA;
      --success: #34c759;
      --warning: #ff9f0a;
      --danger: #ff3b30;
      --purple: #7C3AED;
      --pink: #EC4899;
      --teal: #5ac8fa;
      --indigo: #5856d6;
      
      /* Premium Gradients - Purple Theme */
      --gradient-primary: linear-gradient(135deg, #7C3AED 0%, #A855F7 100%);
      --gradient-sidebar: linear-gradient(180deg, #7C3AED 0%, #9333EA 50%, #A855F7 100%);
      --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-card: linear-gradient(135deg, #E9D5FF 0%, #FBCFE8 100%);
      --gradient-gold: linear-gradient(135deg, #f5af19 0%, #f12711 100%);
      
      /* Background Colors */
      --bg-main: #F5F3FF;
      --bg-lavender: #EDE9FE;
      --bg-card: #FFFFFF;
      
      /* Neutral Grays */
      --gray-50: #fafafa;
      --gray-100: #f5f5f7;
      --gray-200: #e8e8ed;
      --gray-300: #d2d2d7;
      --gray-400: #86868b;
      --gray-500: #6e6e73;
      --gray-600: #1d1d1f;
      
      /* Glass Effect */
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      
      /* Premium Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.15);
      
      /* Border Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      --radius-full: 9999px;
      
      /* Layout */
      --sidebar-width: 80px;
      --right-panel-width: 320px;
    }

    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      box-sizing: border-box;
    }

    body { 
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale;
      background: var(--bg-main);
      letter-spacing: -0.01em;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    .titlebar-drag { -webkit-app-region: drag; }
    .titlebar-no-drag { -webkit-app-region: no-drag; }
    
    /* ========================================
       PREMIUM ANIMATIONS
       ======================================== */
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes livePulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }
    
    @keyframes buttonPress {
      0% { transform: scale(1); }
      50% { transform: scale(0.97); }
      100% { transform: scale(1); }
    }
    
    @keyframes numberGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(124, 58, 237, 0.5); }
      50% { box-shadow: 0 0 40px rgba(124, 58, 237, 0.8); }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(12px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    @keyframes printIn {
      0% { transform: translateY(40px) scale(0.95); opacity: 0; }
      60% { transform: translateY(-8px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); }
    }
    
    @keyframes shine {
      0% { left: -100%; }
      50%, 100% { left: 100%; }
    }
    
    @keyframes ballBounce {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-8px) rotate(-5deg); }
      75% { transform: translateY(-8px) rotate(5deg); }
    }
    
    @keyframes progressBar {
      0% { width: 100%; }
      100% { width: 0%; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes loading {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }
    
    .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; }
    .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); }
    .animate-live-pulse { animation: livePulse 2s infinite; }
    .animate-number-glow { animation: numberGlow 2s infinite; }
    .animate-slide-in-right { animation: slideInRight 0.3s ease-out; }
    .animate-slide-out-right { animation: slideOutRight 0.3s ease-out forwards; }
    .animate-ball-bounce { animation: ballBounce 2s infinite ease-in-out; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    
    .delay-100 { animation-delay: 100ms; }
    .delay-200 { animation-delay: 200ms; }
    .delay-300 { animation-delay: 300ms; }
    
    /* ========================================
       PREMIUM BUTTONS - Purple Theme
       ======================================== */
    
    .btn-premium {
      background: linear-gradient(180deg, #8B5CF6 0%, #7C3AED 100%);
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
      box-shadow: 0 4px 14px rgba(124, 58, 237, 0.35);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .btn-premium:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(124, 58, 237, 0.45);
    }
    .btn-premium:active { animation: buttonPress 0.15s ease-out; }
    
    .btn-secondary {
      background: rgba(124, 58, 237, 0.1);
      color: var(--primary);
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .btn-secondary:hover { background: rgba(124, 58, 237, 0.15); }

    /* ========================================
       GLASS MORPHISM SIDEBAR - Purple Gradient
       ======================================== */
    
    .sidebar-glass {
      background: var(--gradient-sidebar);
      border-right: none;
      box-shadow: 4px 0 24px rgba(124, 58, 237, 0.2);
    }
    
    /* New Compact Sidebar Style */
    .sidebar-compact {
      background: var(--gradient-sidebar);
      width: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 0;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 40;
    }
    
    .sidebar-compact .nav-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 20px;
      transition: all 0.2s ease;
      cursor: pointer;
      margin: 4px 0;
    }
    
    .sidebar-compact .nav-icon:hover {
      background: rgba(255, 255, 255, 0.15);
      color: white;
    }
    
    .sidebar-compact .nav-icon.active {
      background: rgba(255, 255, 255, 0.25);
      color: white;
    }
    
    /* Right Panel Styles */
    .right-panel {
      width: var(--right-panel-width);
      background: white;
      border-left: 1px solid rgba(0, 0, 0, 0.06);
      padding: 24px;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 30;
    }
    
    .dark .sidebar-glass {
      background: linear-gradient(180deg, #4C1D95 0%, #5B21B6 50%, #6D28D9 100%);
      border-right: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* ========================================
       PREMIUM CARDS - Purple Gradient Theme
       ======================================== */
    
    .premium-card {
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(0, 0, 0, 0.04);
      transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
      position: relative;
      overflow: hidden;
    }
    .premium-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    }
    .premium-card:hover {
      box-shadow: var(--shadow-lg), 0 0 0 1px rgba(124, 58, 237, 0.1);
      transform: translateY(-4px);
    }
    
    /* Content Card with Gradient Background */
    .content-card {
      background: var(--gradient-card);
      border-radius: var(--radius-2xl);
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .content-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .content-card .card-image {
      width: 120px;
      height: 120px;
      border-radius: var(--radius-xl);
      background: rgba(255, 255, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .content-card .card-content {
      flex: 1;
    }
    
    .content-card .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-600);
      margin-bottom: 8px;
    }
    
    .content-card .card-description {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 12px;
    }
    
    .content-card .card-author {
      font-size: 13px;
      color: var(--gray-400);
    }
    
    .content-card .card-action {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .content-card .card-action:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    }
    
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      box-shadow: var(--glass-shadow);
    }
    
    /* Pill Filter Buttons */
    .pill-filter {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: var(--radius-full);
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .pill-filter:hover {
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .pill-filter.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Calendar Widget */
    .calendar-widget {
      background: white;
      border-radius: var(--radius-xl);
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }
    
    .calendar-widget .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .calendar-widget .calendar-nav {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .calendar-widget .calendar-nav:hover {
      background: var(--bg-lavender);
    }
    
    .calendar-widget .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
    }
    
    .calendar-widget .calendar-day {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .calendar-widget .calendar-day:hover {
      background: var(--bg-lavender);
    }
    
    .calendar-widget .calendar-day.today {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    .calendar-widget .calendar-day.highlighted {
      background: var(--bg-lavender);
      color: var(--primary);
      font-weight: 600;
    }
    
    /* Online Users List */
    .user-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-lg);
      transition: all 0.2s ease;
    }
    
    .user-list-item:hover {
      background: var(--bg-lavender);
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
      position: relative;
    }
    
    .user-avatar .status-indicator {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
    }
    
    .user-avatar .status-indicator.online {
      background: var(--success);
    }
    
    .user-avatar .status-indicator.offline {
      background: var(--gray-400);
    }

    /* ========================================
       LOTTERY BALL 3D EFFECT
       ======================================== */
    
    .lottery-ball {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      position: relative;
      box-shadow: 
        inset 0 -8px 20px rgba(0,0,0,0.25),
        inset 0 8px 20px rgba(255,255,255,0.25),
        0 8px 20px rgba(0,0,0,0.2);
      background: linear-gradient(180deg, #8B5CF6 0%, #7C3AED 100%);
    }
    .lottery-ball::before {
      content: '';
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 30%;
      background: linear-gradient(180deg, rgba(255,255,255,0.5) 0%, transparent 100%);
      border-radius: 50%;
    }
    
    .lottery-ball.gold { background: linear-gradient(180deg, #fbbf24 0%, #d97706 100%); }
    .lottery-ball.green { background: linear-gradient(180deg, #22c55e 0%, #15803d 100%); }
    .lottery-ball.red { background: linear-gradient(180deg, #ef4444 0%, #b91c1c 100%); }
    .lottery-ball.purple { background: linear-gradient(180deg, #a855f7 0%, #7c3aed 100%); }
    .lottery-ball.teal { background: linear-gradient(180deg, #14b8a6 0%, #0d9488 100%); }

    /* ========================================
       PREMIUM TOGGLE SWITCH
       ======================================== */
    
    .toggle-premium {
      width: 51px; 
      height: 31px; 
      border-radius: var(--radius-full); 
      background: #e9e9eb; 
      position: relative; 
      display: inline-block; 
      cursor: pointer;
      transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .toggle-premium .knob {
      width: 27px; 
      height: 27px; 
      border-radius: var(--radius-full); 
      background: white; 
      position: absolute; 
      top: 2px; 
      left: 2px; 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.1);
    }
    .toggle-premium.on { background: var(--success); }
    .toggle-premium.on .knob { transform: translateX(20px); }
    .dark .toggle-premium { background: #48484a; }

    /* ========================================
       NAVIGATION ITEMS - Purple Theme
       ======================================== */
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      color: var(--gray-500);
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
      text-decoration: none;
    }
    .nav-item:hover {
      background: rgba(124, 58, 237, 0.08);
      color: var(--primary);
    }
    .nav-item.active {
      background: rgba(124, 58, 237, 0.12);
      color: var(--primary);
    }
    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 20px;
      background: var(--primary);
      border-radius: 0 2px 2px 0;
    }
    .nav-item i {
      width: 20px;
      text-align: center;
      font-size: 16px;
    }
    
    .dark .nav-item { color: var(--gray-400); }
    .dark .nav-item:hover { 
      background: rgba(167, 139, 250, 0.15); 
      color: #A78BFA;
    }
    .dark .nav-item.active {
      background: rgba(167, 139, 250, 0.2);
      color: #A78BFA;
    }

    /* ========================================
       NUMBER GRID
       ======================================== */
    
    .num-btn { 
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
      border-radius: var(--radius-md);
      font-weight: 600;
      border: 2px solid var(--gray-200);
      background: white;
      cursor: pointer;
    }
    .num-btn:hover {
      transform: translateY(-2px);
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }
    .num-btn.selected { 
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      transform: scale(1.05);
      animation: numberGlow 1.5s infinite;
    }
    
    .dark .num-btn {
      background: #2c2c2e;
      border-color: #48484a;
      color: #f5f5f7;
    }

    /* ========================================
       SKELETON LOADING
       ======================================== */
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-md);
    }
    
    .dark .skeleton {
      background: linear-gradient(90deg, #2c2c2e 25%, #3c3c3e 50%, #2c2c2e 75%);
      background-size: 200% 100%;
    }

    /* ========================================
       TOAST NOTIFICATIONS
       ======================================== */
    
    .toast {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      border-radius: var(--radius-lg);
      background: white;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      animation: slideInRight 0.3s ease-out;
      position: relative;
      overflow: hidden;
      min-width: 300px;
    }
    .toast.dismissing { animation: slideOutRight 0.3s ease-out forwards; }
    .toast .toast-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .toast .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: var(--primary);
      animation: progressBar 4s linear forwards;
    }
    .toast.success .toast-icon { background: rgba(52, 199, 89, 0.15); color: var(--success); }
    .toast.error .toast-icon { background: rgba(255, 59, 48, 0.15); color: var(--danger); }
    .toast.warning .toast-icon { background: rgba(255, 159, 10, 0.15); color: var(--warning); }
    .toast.info .toast-icon { background: rgba(0, 113, 227, 0.15); color: var(--primary); }
    
    .dark .toast { background: #2c2c2e; color: #f5f5f7; }

    /* ========================================
       STEP INDICATOR
       ======================================== */
    
    .step-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .step-indicator .step {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      background: var(--gray-200);
      color: var(--gray-500);
      transition: all 0.3s ease;
    }
    .step-indicator .step.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.2);
    }
    .step-indicator .step.completed {
      background: var(--success);
      color: white;
    }
    .step-indicator .step-line {
      width: 50px;
      height: 3px;
      background: var(--gray-200);
      border-radius: 2px;
      transition: background 0.3s ease;
    }
    .step-indicator .step-line.active { background: var(--primary); }
    .step-indicator .step-line.completed { background: var(--success); }

    /* ========================================
       COUNTDOWN TIMER
       ======================================== */
    
    .countdown {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .countdown .unit {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 14px;
      background: linear-gradient(180deg, rgba(0, 113, 227, 0.1) 0%, rgba(0, 113, 227, 0.05) 100%);
      border-radius: var(--radius-lg);
      min-width: 55px;
      border: 1px solid rgba(0, 113, 227, 0.1);
    }
    .countdown .unit .value {
      font-size: 26px;
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }
    .countdown .unit .label {
      font-size: 9px;
      color: var(--gray-500);
      text-transform: uppercase;
      margin-top: 4px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .countdown .separator {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-300);
    }

    /* ========================================
       TICKET DESIGN
       ======================================== */
    
    .ticket-premium {
      width: 380px; 
      border-radius: var(--radius-2xl); 
      background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
      box-shadow: 0 25px 60px rgba(0,0,0,0.2);
      padding: 32px; 
      animation: printIn 700ms cubic-bezier(0.25,0.1,0.25,1);
      position: relative;
      overflow: hidden;
    }
    .ticket-premium::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      animation: shine 2.5s ease-in-out infinite;
    }
    .ticket-premium .watermark {
      position: absolute;
      bottom: 30px;
      right: 20px;
      font-size: 80px;
      opacity: 0.03;
      font-weight: 900;
      pointer-events: none;
    }
    
    /* ========================================
       MODAL
       ======================================== */
    
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    
    .modal-content {
      background: white;
      border-radius: var(--radius-2xl);
      box-shadow: 0 25px 80px rgba(0,0,0,0.25);
      animation: slideUp 0.3s ease-out;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .dark .modal-content { background: #1c1c1e; }

    /* ========================================
       DARK MODE
       ======================================== */
    
    .dark body { 
      background: linear-gradient(180deg, #000000 0%, #1c1c1e 100%);
      color: #f5f5f7; 
    }
    .dark .bg-white { background-color: #1c1c1e !important; }
    .dark .bg-gray-50 { background-color: #2c2c2e !important; }
    .dark .bg-gray-100 { background-color: #2c2c2e !important; }
    .dark .text-gray-900 { color: #f5f5f7 !important; }
    .dark .text-gray-700 { color: #e5e5e5 !important; }
    .dark .text-gray-600 { color: #a1a1a6 !important; }
    .dark .text-gray-500 { color: #8e8e93 !important; }
    .dark .border-gray-200 { border-color: #38383a !important; }
    .dark .border-gray-100 { border-color: #38383a !important; }
    
    .dark .premium-card {
      background: linear-gradient(180deg, rgba(44, 44, 46, 0.95) 0%, rgba(44, 44, 46, 0.85) 100%);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .dark input, .dark select, .dark textarea {
      background-color: #2c2c2e !important;
      border-color: #48484a !important;
      color: #f5f5f7 !important;
    }

    /* ========================================
       SCROLLBAR
       ======================================== */
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { 
      background: rgba(0, 0, 0, 0.15); 
      border-radius: 4px; 
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.25); }
    
    .dark ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); }
    .dark ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

    /* ========================================
       MISC
       ======================================== */
    
    #bancas-leaflet-map {
      width: 100%;
      height: 450px;
      border-radius: var(--radius-xl);
      z-index: 1;
    }
    
    input, select, textarea {
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.15);
    }
    
    .trust-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
      border: 1px solid rgba(124, 58, 237, 0.2);
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
    }
    .status-dot.online { background: var(--success); }
    .status-dot.offline { background: var(--gray-400); }
    
    @media print {
      body * { visibility: hidden; }
      #ticket-print-area, #ticket-print-area * { visibility: visible; }
      #ticket-print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>
<body class="min-h-screen text-gray-900">
  <!-- macOS Title Bar -->
  <div class="titlebar-drag h-8 bg-transparent fixed top-0 left-0 right-0 z-50"></div>
  
  <div id="app" class="pt-8 h-screen flex">
    <!-- Loading State -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-purple-50 to-pink-50 z-50">
      <div class="text-center">
        <div class="relative">
          <div class="w-28 h-28 mx-auto mb-6 bg-gradient-to-br from-purple-500 to-purple-700 rounded-[32px] flex items-center justify-center shadow-2xl animate-float">
            <img id="loading-logo" src="../../assets/icon.png" alt="LotoLink" class="w-16 h-16 object-contain" onerror="this.style.display='none'; var icon = document.createElement('i'); icon.className = 'fas fa-ticket-alt text-white text-4xl'; this.parentElement.appendChild(icon);">
          </div>
          <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-20 h-2 bg-black/10 rounded-full blur-sm"></div>
        </div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">LotoLink</h1>
        <p class="text-gray-500 text-sm">Premium Lottery Experience</p>
        <div class="mt-6 w-52 h-1.5 bg-gray-200 rounded-full mx-auto overflow-hidden">
          <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="animation: loading 2s ease-in-out infinite;"></div>
        </div>
      </div>
    </div>
    
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="hidden fixed inset-0 z-50 bg-gradient-to-br from-purple-600 via-purple-700 to-pink-600 flex items-center justify-center">
      <div class="max-w-lg w-full mx-4 text-center text-white">
        <div class="w-24 h-24 mx-auto mb-8 bg-white/20 rounded-3xl flex items-center justify-center backdrop-blur-xl">
          <i class="fas fa-ticket-alt text-4xl"></i>
        </div>
        <h1 class="text-4xl font-bold mb-4">Â¡Bienvenido a LotoLink!</h1>
        <p class="text-lg text-white/80 mb-8">La mejor aplicaciÃ³n de loterÃ­a para escritorio. Juega, gana y cobra tus premios fÃ¡cilmente.</p>
        
        <div class="grid grid-cols-3 gap-4 mb-8">
          <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
            <div class="w-12 h-12 mx-auto mb-3 bg-white/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-dice text-xl"></i>
            </div>
            <p class="text-sm font-medium">Juega FÃ¡cil</p>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
            <div class="w-12 h-12 mx-auto mb-3 bg-white/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-chart-line text-xl"></i>
            </div>
            <p class="text-sm font-medium">Resultados en Vivo</p>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
            <div class="w-12 h-12 mx-auto mb-3 bg-white/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-robot text-xl"></i>
            </div>
            <p class="text-sm font-medium">Asistente Luna</p>
          </div>
        </div>
        
        <button onclick="completeWelcome()" class="px-8 py-4 bg-white text-blue-600 font-bold text-lg rounded-full hover:bg-opacity-90 transition shadow-lg">
          Comenzar <i class="fas fa-arrow-right ml-2"></i>
        </button>
      </div>
    </div>
    
    <!-- Luna AI Assistant Panel -->
    <div id="luna-panel" class="hidden fixed bottom-4 right-4 w-96 z-50 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
            <i class="fas fa-robot text-white"></i>
          </div>
          <div>
            <h3 class="font-bold text-white">Luna</h3>
            <p class="text-xs text-white/70">Asistente Virtual</p>
          </div>
        </div>
        <button onclick="toggleLunaPanel()" class="text-white/80 hover:text-white p-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="p-4">
        <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-4 mb-4">
          <p id="luna-response" class="text-gray-700 dark:text-gray-300 text-sm">
            Â¡Hola! Soy Luna, tu asistente virtual. Di "Ayuda" para ver lo que puedo hacer por ti.
          </p>
        </div>
        
        <!-- Voice Settings -->
        <details class="mb-4 group">
          <summary class="flex items-center justify-between cursor-pointer text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-blue-600">
            <span class="flex items-center gap-2"><i class="fas fa-cog"></i> ConfiguraciÃ³n de Voz</span>
            <i class="fas fa-chevron-down group-open:rotate-180 transition-transform"></i>
          </summary>
          <div class="mt-3 space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-600 dark:text-gray-300">Voz habilitada</span>
              <div id="voice-toggle" class="toggle-premium on titlebar-no-drag" onclick="toggleVoice()">
                <div class="knob"></div>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-600 dark:text-gray-300">GÃ©nero</span>
              <div class="flex gap-1">
                <button onclick="setVoiceGender('female')" class="px-3 py-1 text-xs rounded-full bg-pink-500 text-white">ðŸ‘© Femenina</button>
                <button onclick="setVoiceGender('male')" class="px-3 py-1 text-xs rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">ðŸ‘¨ Masculina</button>
              </div>
            </div>
          </div>
        </details>
        
        <button id="luna-mic-btn" onclick="startListening()" class="w-full py-4 bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-xl font-bold text-lg flex items-center justify-center gap-3 hover:shadow-lg transition titlebar-no-drag">
          <i class="fas fa-microphone text-2xl"></i>
          Hablar
        </button>
        
        <p class="text-xs text-center text-gray-400 mt-3">
          ðŸ’¡ Di "Quiero jugar" para empezar o "Ayuda" para mÃ¡s comandos
        </p>
      </div>
    </div>
    
    <!-- Global Cart Panel -->
    <div id="cart-panel" class="hidden fixed top-12 right-4 w-96 z-50 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden max-h-[80vh]">
      <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
            <i class="fas fa-shopping-cart text-white"></i>
          </div>
          <div>
            <h3 class="font-bold text-white">Carrito de Jugadas</h3>
            <p class="text-xs text-white/70" id="cart-count">0 jugadas</p>
          </div>
        </div>
        <button onclick="toggleCartPanel()" class="text-white/80 hover:text-white p-2">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="cart-items" class="overflow-y-auto max-h-[50vh]">
        <!-- Cart items rendered here -->
      </div>
      
      <div class="p-4 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
        <div class="flex justify-between items-center mb-4">
          <span class="font-medium text-gray-600 dark:text-gray-300">Total:</span>
          <span id="cart-total" class="text-2xl font-bold text-blue-600">RD$ 0</span>
        </div>
        <div class="flex gap-2">
          <button onclick="clearCart()" class="flex-1 py-3 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition titlebar-no-drag">
            <i class="fas fa-trash mr-2"></i>Vaciar
          </button>
          <button onclick="checkoutCart()" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold hover:shadow-lg transition titlebar-no-drag">
            <i class="fas fa-check mr-2"></i>Confirmar Todo
          </button>
        </div>
      </div>
    </div>
    
    <!-- Main App Content -->
    <div id="main-content" class="hidden flex w-full h-full">
      <!-- Compact Purple Sidebar -->
      <aside class="sidebar-compact">
        <!-- Logo -->
        <div class="mb-8">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <i class="fas fa-ticket-alt text-white text-lg"></i>
          </div>
        </div>
        
        <!-- Main Navigation Icons -->
        <nav class="flex-1 flex flex-col items-center gap-2 titlebar-no-drag">
          <button onclick="navigate('home'); return false;" class="nav-icon active" title="Dashboard">
            <i class="fas fa-th-large"></i>
          </button>
          <button onclick="navigate('play'); return false;" class="nav-icon" title="Jugar">
            <i class="fas fa-dice"></i>
          </button>
          <button onclick="navigate('results'); return false;" class="nav-icon" title="Resultados">
            <i class="fas fa-envelope"></i>
          </button>
          <button onclick="navigate('bancas'); return false;" class="nav-icon" title="Bancas">
            <i class="fas fa-users"></i>
          </button>
          <button onclick="navigate('loterias'); return false;" class="nav-icon" title="LoterÃ­as">
            <i class="fas fa-calendar-alt"></i>
          </button>
        </nav>
        
        <!-- Bottom Icons -->
        <div class="flex flex-col items-center gap-2 titlebar-no-drag">
          <button onclick="navigate('profile'); return false;" class="nav-icon" title="ConfiguraciÃ³n">
            <i class="fas fa-cog"></i>
          </button>
          <button onclick="navigate('wallet'); return false;" class="nav-icon" title="Directorio">
            <i class="fas fa-folder"></i>
          </button>
        </div>
      </aside>
      
      <!-- Right Panel -->
      <div class="right-panel">
        <!-- User Profile -->
        <div class="mb-6">
          <div class="flex items-center gap-3">
            <div class="user-avatar">
              JP
              <div class="status-indicator online"></div>
            </div>
            <div class="flex-1">
              <p class="font-semibold text-gray-900 dark:text-white">Juan PÃ©rez</p>
              <p class="text-xs text-gray-500">ID: #JP2024001</p>
            </div>
            <button class="p-2 hover:bg-gray-100 rounded-lg transition titlebar-no-drag">
              <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
            </button>
          </div>
        </div>
        
        <!-- Calendar Widget -->
        <div class="calendar-widget mb-6">
          <div class="calendar-header">
            <button class="calendar-nav titlebar-no-drag">
              <i class="fas fa-chevron-left text-gray-400"></i>
            </button>
            <span class="font-semibold text-gray-700" id="calendar-month">Diciembre 2024</span>
            <button class="calendar-nav titlebar-no-drag">
              <i class="fas fa-chevron-right text-gray-400"></i>
            </button>
          </div>
          <div class="calendar-grid text-sm text-gray-400 mb-2">
            <span>Lu</span><span>Ma</span><span>Mi</span><span>Ju</span><span>Vi</span><span>Sa</span><span>Do</span>
          </div>
          <div class="calendar-grid" id="calendar-days">
            <!-- Calendar days rendered dynamically -->
          </div>
        </div>
        
        <!-- Online Users Section -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700 dark:text-gray-300">Usuarios en lÃ­nea</h3>
            <button class="text-sm text-purple-600 hover:text-purple-700 titlebar-no-drag">Ver todos</button>
          </div>
          <div class="space-y-2" id="online-users">
            <!-- Online users rendered dynamically -->
          </div>
        </div>
        
        <!-- Balance Card (moved from sidebar) -->
        <div class="mt-6 p-5 bg-gradient-to-br from-purple-600 to-purple-700 rounded-2xl text-white shadow-lg relative overflow-hidden">
          <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
          <div class="relative">
            <p class="text-sm text-purple-200 font-medium">Balance disponible</p>
            <p id="sidebar-balance" class="text-3xl font-bold mt-1">RD$ 2,500</p>
            <button onclick="navigate('wallet')" class="mt-4 w-full bg-white/20 hover:bg-white/30 py-2.5 rounded-xl text-sm font-semibold transition flex items-center justify-center gap-2 titlebar-no-drag">
              <i class="fas fa-plus-circle"></i>
              Recargar
            </button>
          </div>
        </div>
        
        <!-- Dark Mode Toggle -->
        <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl flex items-center justify-between">
          <span class="text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2">
            <i class="fas fa-moon text-purple-500"></i>
            <span>Modo Oscuro</span>
          </span>
          <div id="dark-mode-toggle" class="toggle-premium titlebar-no-drag" onclick="toggleDarkMode()">
            <div class="knob"></div>
          </div>
        </div>
        
        <!-- Footer Info -->
        <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
          <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
            <div class="flex items-center gap-2">
              <div id="connection-status" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
              <span id="connection-text">Conectado</span>
            </div>
            <span id="last-sync">Sync: ahora</span>
          </div>
        </div>
      </div>
      
      <!-- Main Content Area -->
      <main class="ml-20 flex-1 p-8 overflow-y-auto" style="margin-right: var(--right-panel-width)">
        <!-- Home View -->
        <div id="view-home" class="view animate-fade-in">
          <!-- Section Header with Search -->
          <header class="mb-8">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-3xl font-bold text-gray-900 dark:text-white">LoterÃ­as Disponibles</h2>
              <div class="flex items-center gap-4">
                <div class="relative">
                  <input type="text" placeholder="Buscar..." class="pl-10 pr-4 py-2 bg-white border border-gray-200 rounded-xl w-64 focus:border-purple-400 focus:ring-2 focus:ring-purple-100">
                  <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <button class="w-10 h-10 bg-white border border-gray-200 rounded-xl flex items-center justify-center hover:border-purple-400 transition titlebar-no-drag">
                  <i class="fas fa-bell text-gray-500"></i>
                </button>
                <button class="w-10 h-10 bg-white border border-gray-200 rounded-xl flex items-center justify-center hover:border-purple-400 transition titlebar-no-drag">
                  <i class="fas fa-cog text-gray-500"></i>
                </button>
              </div>
            </div>
            
            <!-- Filter Pills -->
            <div class="flex gap-3">
              <button class="pill-filter active titlebar-no-drag">
                <i class="fas fa-layer-group"></i>
                <span>Todas</span>
              </button>
              <button class="pill-filter titlebar-no-drag">
                <i class="fas fa-star"></i>
                <span>Favoritas</span>
                <i class="fas fa-chevron-down text-xs ml-1"></i>
              </button>
              <button class="pill-filter titlebar-no-drag">
                <i class="fas fa-clock"></i>
                <span>PrÃ³ximas</span>
                <i class="fas fa-chevron-down text-xs ml-1"></i>
              </button>
              <button class="pill-filter titlebar-no-drag">
                <i class="fas fa-fire"></i>
                <span>Populares</span>
                <i class="fas fa-chevron-down text-xs ml-1"></i>
              </button>
            </div>
          </header>
          
          <!-- Content Cards with Gradient -->
          <div class="space-y-4 mb-8" id="lottery-content-cards">
            <!-- Cards will be rendered dynamically -->
          </div>
          
          <!-- Quick Stats Cards -->
          <section class="mb-8">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">EstadÃ­sticas RÃ¡pidas</h3>
            <div class="grid grid-cols-4 gap-4">
              <div class="premium-card p-5 group cursor-pointer" onclick="navigate('play')">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                    <i class="fas fa-dice text-xl"></i>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">47</p>
                    <p class="text-sm text-gray-500">Jugadas</p>
                  </div>
                </div>
              </div>
              <div class="premium-card p-5 group cursor-pointer" onclick="navigate('results')">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                    <i class="fas fa-trophy text-xl"></i>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">5</p>
                    <p class="text-sm text-gray-500">Victorias</p>
                  </div>
                </div>
              </div>
              <div class="premium-card p-5 group cursor-pointer" onclick="navigate('wallet')">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                    <i class="fas fa-coins text-xl"></i>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">RD$ 1,250</p>
                    <p class="text-sm text-gray-500">Ganado</p>
                  </div>
                </div>
              </div>
              <div class="premium-card p-5 group cursor-pointer">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform">
                    <i class="fas fa-fire text-xl"></i>
                  </div>
                  <div>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">3</p>
                    <p class="text-sm text-gray-500">Racha ðŸ”¥</p>
                  </div>
                </div>
              </div>
            </div>
          </section>
          
          <!-- Upcoming Draws with Animated Countdown -->
          <section class="mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                <span class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></span>
                PrÃ³ximos Sorteos
              </h3>
              <button class="btn-secondary text-sm py-2 px-4 titlebar-no-drag" onclick="navigate('loterias')">
                <i class="fas fa-calendar-alt mr-2"></i>
                Ver todos
              </button>
            </div>
            <div class="grid grid-cols-3 gap-4" id="upcoming-draws">
              <!-- Sorteos se renderizan dinÃ¡micamente -->
            </div>
          </section>
          
          <!-- Live Results Section -->
          <section class="mb-8">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                <span class="w-3 h-3 bg-red-500 rounded-full animate-live-pulse"></span>
                Resultados en Vivo
              </h3>
              <button class="btn-secondary text-sm py-2 px-4 titlebar-no-drag" onclick="navigate('results')">
                Ver todos <i class="fas fa-arrow-right ml-2"></i>
              </button>
            </div>
            <div class="grid grid-cols-2 gap-4" id="live-results">
              <!-- Resultados se renderizan dinÃ¡micamente -->
            </div>
          </section>
          
          <!-- Recent Plays -->
          <section class="mb-8">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-3 mb-4">
              <i class="fas fa-history text-gray-400"></i>
              Jugadas Recientes
            </h3>
            <div class="premium-card overflow-hidden">
              <div id="recent-plays" class="divide-y divide-gray-100 dark:divide-gray-800">
                <!-- Jugadas se renderizan dinÃ¡micamente -->
              </div>
            </div>
          </section>
          
          <!-- Most Played Numbers -->
          <section>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-3 mb-4">
              <i class="fas fa-fire text-orange-500"></i>
              NÃºmeros MÃ¡s Jugados
            </h3>
            <div class="grid grid-cols-3 gap-4">
              <div class="premium-card p-5">
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                  <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                  Quiniela
                </h4>
                <div class="flex gap-2 flex-wrap">
                  <span class="lottery-ball" style="width: 40px; height: 40px; font-size: 14px;">08</span>
                  <span class="lottery-ball gold" style="width: 40px; height: 40px; font-size: 14px;">66</span>
                  <span class="lottery-ball green" style="width: 40px; height: 40px; font-size: 14px;">36</span>
                  <span class="lottery-ball red" style="width: 40px; height: 40px; font-size: 14px;">63</span>
                  <span class="lottery-ball purple" style="width: 40px; height: 40px; font-size: 14px;">42</span>
                </div>
              </div>
              <div class="premium-card p-5">
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                  <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                  PalÃ© Popular
                </h4>
                <div class="flex gap-2 flex-wrap">
                  <div class="flex gap-1">
                    <span class="lottery-ball" style="width: 36px; height: 36px; font-size: 12px;">08</span>
                    <span class="lottery-ball gold" style="width: 36px; height: 36px; font-size: 12px;">66</span>
                  </div>
                  <div class="flex gap-1">
                    <span class="lottery-ball green" style="width: 36px; height: 36px; font-size: 12px;">36</span>
                    <span class="lottery-ball red" style="width: 36px; height: 36px; font-size: 12px;">63</span>
                  </div>
                </div>
              </div>
              <div class="premium-card p-5">
                <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                  <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                  Tripleta Popular
                </h4>
                <div class="flex gap-2 flex-wrap">
                  <div class="flex gap-1">
                    <span class="lottery-ball" style="width: 32px; height: 32px; font-size: 11px;">15</span>
                    <span class="lottery-ball gold" style="width: 32px; height: 32px; font-size: 11px;">26</span>
                    <span class="lottery-ball green" style="width: 32px; height: 32px; font-size: 11px;">07</span>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
        
        <!-- Play View with Visual Stepper -->
        <div id="view-play" class="view hidden animate-fade-in">
          <header class="mb-8">
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <i class="fas fa-dice text-blue-500"></i>
              Nueva Jugada
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Selecciona loterÃ­a, modalidad y tus nÃºmeros de la suerte</p>
          </header>
          
          <!-- Visual Step Indicator -->
          <div class="mb-8 flex justify-center">
            <div class="step-indicator">
              <div class="step active" id="step-1">1</div>
              <div class="step-line" id="line-1"></div>
              <div class="step" id="step-2">2</div>
              <div class="step-line" id="line-2"></div>
              <div class="step" id="step-3">3</div>
              <div class="step-line" id="line-3"></div>
              <div class="step" id="step-4">4</div>
            </div>
          </div>
          <div class="text-center mb-8">
            <p class="text-sm text-gray-500" id="step-description">Paso 1: Selecciona una loterÃ­a</p>
          </div>
          
          <div class="grid grid-cols-3 gap-6">
            <!-- Left Column: Selection -->
            <div class="col-span-2 space-y-6">
              <!-- Step 1: Lottery Selection -->
              <div class="premium-card p-6" id="lottery-section">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <span class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 text-sm font-bold">1</span>
                  Selecciona una LoterÃ­a
                </h3>
                <div class="grid grid-cols-3 gap-4" id="lottery-selection">
                  <!-- LoterÃ­as se renderizan dinÃ¡micamente -->
                </div>
              </div>
              
              <!-- Step 2: Modality -->
              <div class="premium-card p-6" id="modality-section">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <span class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 text-sm font-bold">2</span>
                  Modalidad de Juego
                </h3>
                <div class="grid grid-cols-2 gap-4" id="modality-selection">
                  <!-- Modalidades se renderizan dinÃ¡micamente -->
                </div>
              </div>
              
              <!-- Step 3: Numbers Grid -->
              <div class="premium-card p-6" id="numbers-section">
                <div class="flex justify-between items-center mb-4">
                  <div>
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                      <span class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 text-sm font-bold">3</span>
                      Selecciona tus NÃºmeros
                    </h3>
                    <p class="text-sm text-gray-500 mt-1">Selecciona <span id="required-numbers" class="font-bold text-blue-600">2</span> nÃºmero(s)</p>
                  </div>
                  <button onclick="randomNumbers()" class="btn-premium text-sm py-2 px-4 titlebar-no-drag">
                    <i class="fas fa-random mr-2"></i>
                    Aleatorio
                  </button>
                </div>
                <div id="number-grid" class="grid grid-cols-10 gap-2">
                  <!-- Numbers 00-99 generados por JavaScript -->
                </div>
              </div>
              
              <!-- Step 4: Stake -->
              <div class="premium-card p-6" id="stake-section">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <span class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 text-sm font-bold">4</span>
                  Monto de Apuesta
                </h3>
                <div class="flex gap-3 flex-wrap" id="stake-selection">
                  <!-- Montos se renderizan dinÃ¡micamente -->
                </div>
                <!-- Slider -->
                <div class="mt-4">
                  <input type="range" id="stake-slider" min="10" max="1000" step="10" value="25" 
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer titlebar-no-drag"
                    oninput="updateStakeFromSlider(this.value)">
                  <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>RD$ 10</span>
                    <span>RD$ 1,000</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Right Column: Summary (Sticky) -->
            <div class="space-y-6">
              <div class="sticky top-0">
                <!-- Selected Numbers Display -->
                <div class="premium-card p-6 mb-4">
                  <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-star text-yellow-500"></i>
                    NÃºmeros Seleccionados
                  </h3>
                  <div id="selected-numbers" class="flex gap-3 flex-wrap min-h-[70px] items-center justify-center">
                    <span class="text-gray-400 text-sm">Selecciona nÃºmeros del grid</span>
                  </div>
                </div>
                
                <!-- Summary Card -->
                <div class="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-700 p-6 rounded-2xl shadow-xl text-white relative overflow-hidden">
                  <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                  <div class="absolute bottom-0 left-0 w-32 h-32 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
                  <div class="relative">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                      <i class="fas fa-receipt"></i>
                      Resumen de Jugada
                    </h3>
                    <div class="space-y-3 text-sm">
                      <div class="flex justify-between">
                        <span class="opacity-80">LoterÃ­a</span>
                        <span id="summary-lottery" class="font-semibold">-</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="opacity-80">Modalidad</span>
                        <span id="summary-modality" class="font-semibold">-</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="opacity-80">NÃºmeros</span>
                        <span id="summary-numbers" class="font-semibold">-</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="opacity-80">Apuesta</span>
                        <span id="summary-stake" class="font-semibold">RD$ 25</span>
                      </div>
                      <hr class="border-white/20 my-4">
                      <div class="flex justify-between text-lg">
                        <span class="font-semibold">Premio Potencial</span>
                        <span id="summary-prize" class="font-bold text-yellow-300 text-xl">RD$ 1,500</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-3 mt-4">
                  <button onclick="addPlayToCart()" class="flex-1 py-4 border-2 border-white/30 text-white font-bold rounded-xl hover:bg-white/10 transition titlebar-no-drag">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    Agregar al Carrito
                  </button>
                  <button onclick="confirmPlay()" class="flex-1 btn-premium py-4 text-lg titlebar-no-drag group">
                    <i class="fas fa-check-circle mr-2 group-hover:scale-110 transition-transform"></i>
                    Confirmar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Bancas View with Leaflet Map -->
        <div id="view-bancas" class="view hidden animate-fade-in">
          <header class="mb-8">
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <i class="fas fa-store text-green-500"></i>
              Bancas Cercanas
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Encuentra bancas cerca de ti para realizar tus jugadas</p>
          </header>
          
          <!-- View Toggle -->
          <div class="flex gap-3 mb-6">
            <button onclick="toggleBancasView('list')" id="btn-list" class="btn-premium text-sm py-2 px-5 titlebar-no-drag">
              <i class="fas fa-list mr-2"></i>Lista
            </button>
            <button onclick="toggleBancasView('map')" id="btn-map" class="btn-secondary text-sm py-2 px-5 titlebar-no-drag">
              <i class="fas fa-map mr-2"></i>Mapa
            </button>
          </div>
          
          <!-- Bancas List -->
          <div id="bancas-list" class="grid grid-cols-2 gap-4">
            <!-- Bancas se renderizan dinÃ¡micamente -->
          </div>
          
          <!-- Map View -->
          <div id="bancas-map" class="hidden">
            <div id="bancas-leaflet-map" class="shadow-lg"></div>
            <p class="text-center text-gray-500 text-sm mt-4">
              <i class="fas fa-info-circle mr-1"></i>
              Haz clic en un marcador para ver detalles y jugar en esa banca
            </p>
          </div>
        </div>
        
        <!-- LoterÃ­as View -->
        <div id="view-loterias" class="view hidden animate-fade-in">
          <header class="mb-8">
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <i class="fas fa-ticket-alt text-purple-500"></i>
              LoterÃ­as Disponibles
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Todas las loterÃ­as dominicanas y sus horarios de sorteo</p>
          </header>
          
          <div class="grid grid-cols-3 gap-4" id="loterias-grid">
            <!-- LoterÃ­as se renderizan dinÃ¡micamente -->
          </div>
        </div>
        
        <!-- Results View with Charts -->
        <div id="view-results" class="view hidden animate-fade-in">
          <header class="mb-8">
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <i class="fas fa-chart-bar text-indigo-500"></i>
              Resultados
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Resultados de sorteos y estadÃ­sticas</p>
          </header>
          
          <!-- Tabs Filter -->
          <div class="flex gap-2 mb-6 bg-gray-100 dark:bg-gray-800 p-1 rounded-xl w-fit">
            <button onclick="filterResults('today')" class="results-tab active px-4 py-2 rounded-lg text-sm font-semibold transition titlebar-no-drag bg-white dark:bg-gray-700 shadow text-gray-900 dark:text-white">
              Hoy
            </button>
            <button onclick="filterResults('yesterday')" class="results-tab px-4 py-2 rounded-lg text-sm font-semibold transition titlebar-no-drag text-gray-500 hover:text-gray-700">
              Ayer
            </button>
            <button onclick="filterResults('week')" class="results-tab px-4 py-2 rounded-lg text-sm font-semibold transition titlebar-no-drag text-gray-500 hover:text-gray-700">
              Esta Semana
            </button>
          </div>
          
          <!-- Filters -->
          <div class="flex gap-3 mb-6">
            <select id="results-lottery-filter" class="px-4 py-2.5 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option>Todas las loterÃ­as</option>
              <option>Nacional</option>
              <option>Leidsa</option>
              <option>Loteka</option>
              <option>La Primera</option>
            </select>
            <input type="date" class="px-4 py-2.5 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="refreshResults()" class="btn-secondary text-sm py-2 px-4 titlebar-no-drag">
              <i class="fas fa-sync-alt mr-2"></i>Actualizar
            </button>
          </div>
          
          <!-- Charts Section -->
          <div class="grid grid-cols-2 gap-6 mb-8">
            <div class="premium-card p-6">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i class="fas fa-chart-bar text-blue-500"></i>
                NÃºmeros mÃ¡s Frecuentes
              </h3>
              <canvas id="frequency-chart" height="200"></canvas>
            </div>
            <div class="premium-card p-6">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie text-purple-500"></i>
                DistribuciÃ³n por LoterÃ­a
              </h3>
              <canvas id="distribution-chart" height="200"></canvas>
            </div>
          </div>
          
          <!-- Live Results with 3D Balls -->
          <section class="mb-8">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-3">
              <span class="w-3 h-3 bg-red-500 rounded-full animate-live-pulse"></span>
              Resultados en Vivo
              <span id="last-update" class="text-sm text-gray-400 font-normal ml-2"></span>
            </h3>
            <div class="grid grid-cols-2 gap-4" id="results-live-grid">
              <!-- Resultados se renderizan dinÃ¡micamente -->
            </div>
          </section>
          
          <!-- Historical Results -->
          <section>
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
              <i class="fas fa-history text-gray-400"></i>
              Historial de Resultados
            </h3>
            <div class="premium-card overflow-hidden">
              <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-800">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">LoterÃ­a</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Hora</th>
                    <th class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Resultados</th>
                  </tr>
                </thead>
                <tbody id="results-history" class="divide-y divide-gray-100 dark:divide-gray-800">
                  <!-- Historial se renderiza dinÃ¡micamente -->
                </tbody>
              </table>
            </div>
          </section>
        </div>
        
        <!-- Wallet View -->
        <div id="view-wallet" class="view hidden animate-fade-in">
          <header class="mb-8">
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <i class="fas fa-wallet text-green-500"></i>
              Mi Cartera
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Gestiona tu balance y transacciones</p>
          </header>
          
          <div class="grid grid-cols-3 gap-6 mb-8">
            <!-- Balance Card -->
            <div class="col-span-2 bg-gradient-to-br from-emerald-500 via-green-500 to-teal-600 p-8 rounded-2xl shadow-xl text-white relative overflow-hidden">
              <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
              <div class="absolute bottom-0 left-0 w-48 h-48 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
              <div class="relative">
                <p class="text-green-100 mb-2 flex items-center gap-2">
                  <i class="fas fa-piggy-bank"></i>
                  Balance Disponible
                </p>
                <p id="wallet-balance" class="text-5xl font-bold mb-6">RD$ 2,500</p>
                <div class="flex gap-4">
                  <button onclick="showRechargeModal()" class="flex-1 py-3 bg-white/20 hover:bg-white/30 rounded-xl font-semibold transition flex items-center justify-center gap-2 titlebar-no-drag">
                    <i class="fas fa-plus-circle"></i>
                    Recargar
                  </button>
                  <button onclick="showWithdrawModal()" class="flex-1 py-3 bg-white/20 hover:bg-white/30 rounded-xl font-semibold transition flex items-center justify-center gap-2 titlebar-no-drag">
                    <i class="fas fa-money-bill-wave"></i>
                    Retirar
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="premium-card p-6">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i class="fas fa-chart-line text-blue-500"></i>
                Resumen del Mes
              </h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-500 flex items-center gap-2">
                    <i class="fas fa-arrow-up text-green-500 text-xs"></i>
                    Ganancias
                  </span>
                  <span class="font-bold text-green-600 text-lg">+RD$ 750</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-500 flex items-center gap-2">
                    <i class="fas fa-credit-card text-blue-500 text-xs"></i>
                    Recargas
                  </span>
                  <span class="font-bold text-gray-900 dark:text-white">4</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-500 flex items-center gap-2">
                    <i class="fas fa-dice text-purple-500 text-xs"></i>
                    Jugadas
                  </span>
                  <span class="font-bold text-gray-900 dark:text-white">12</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Balance Chart -->
          <div class="premium-card p-6 mb-8">
            <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
              <i class="fas fa-chart-area text-indigo-500"></i>
              Historial de Balance
            </h3>
            <canvas id="balance-chart" height="100"></canvas>
          </div>
          
          <!-- Transaction History -->
          <section>
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <i class="fas fa-exchange-alt text-gray-400"></i>
                Historial de Transacciones
              </h3>
              <button onclick="exportTransactions()" class="btn-secondary text-sm py-2 px-4 titlebar-no-drag">
                <i class="fas fa-download mr-2"></i>Exportar CSV
              </button>
            </div>
            <div class="premium-card divide-y divide-gray-100 dark:divide-gray-800" id="transactions-list">
              <!-- Transacciones se renderizan dinÃ¡micamente -->
            </div>
          </section>
        </div>
        
        <!-- Profile View -->
        <div id="view-profile" class="view hidden animate-fade-in">
          <header class="mb-8">
            <h2 class="text-4xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <i class="fas fa-user-circle text-purple-500"></i>
              Mi Perfil
            </h2>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Gestiona tu cuenta y preferencias</p>
          </header>
          
          <div class="grid grid-cols-3 gap-6">
            <!-- User Info Card -->
            <div class="premium-card p-6">
              <div class="flex items-center gap-4 mb-6">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500 via-pink-500 to-orange-500 flex items-center justify-center text-white text-2xl font-bold shadow-xl">
                  JP
                </div>
                <div>
                  <h3 class="font-bold text-xl text-gray-900 dark:text-white">Juan PÃ©rez</h3>
                  <p class="text-sm text-gray-500 dark:text-gray-400">juan.perez@email.com</p>
                  <span class="inline-flex items-center gap-1.5 text-xs text-green-600 mt-2 bg-green-50 dark:bg-green-900/30 px-2 py-1 rounded-full">
                    <i class="fas fa-check-circle"></i>
                    Verificado
                  </span>
                </div>
              </div>
              <div class="space-y-3 text-sm">
                <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-800">
                  <span class="text-gray-500 flex items-center gap-2">
                    <i class="fas fa-phone text-xs"></i>
                    TelÃ©fono
                  </span>
                  <span class="font-medium text-gray-900 dark:text-white">+1 809-555-1234</span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-gray-500 flex items-center gap-2">
                    <i class="fas fa-calendar text-xs"></i>
                    Miembro desde
                  </span>
                  <span class="font-medium text-gray-900 dark:text-white">Enero 2024</span>
                </div>
              </div>
              <button onclick="showEditProfileModal()" class="w-full mt-4 btn-secondary text-sm py-2.5 titlebar-no-drag">
                <i class="fas fa-edit mr-2"></i>Editar Perfil
              </button>
            </div>
            
            <!-- Stats Card with Chart -->
            <div class="premium-card p-6">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie text-blue-500"></i>
                EstadÃ­sticas
              </h3>
              <canvas id="profile-stats-chart" height="150"></canvas>
              <div class="mt-4 space-y-3 text-sm">
                <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 rounded-lg">
                  <span class="text-gray-500">Total Jugadas</span>
                  <span class="font-bold text-xl text-gray-900 dark:text-white">47</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
                  <span class="text-gray-500">Victorias</span>
                  <span class="font-bold text-xl text-green-600">5 ðŸ†</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                  <span class="text-gray-500">Racha actual</span>
                  <span class="font-bold text-xl text-orange-600">3 ðŸ”¥</span>
                </div>
              </div>
            </div>
            
            <!-- Settings Card -->
            <div class="premium-card p-6">
              <h3 class="font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i class="fas fa-cog text-gray-400"></i>
                ConfiguraciÃ³n
              </h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                  <span class="text-gray-700 dark:text-gray-300 flex items-center gap-3">
                    <i class="fas fa-bell text-blue-500"></i>
                    Notificaciones
                  </span>
                  <div id="notifications-toggle" class="toggle-premium on titlebar-no-drag" onclick="toggleNotifications()">
                    <div class="knob"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                  <span class="text-gray-700 dark:text-gray-300 flex items-center gap-3">
                    <i class="fas fa-volume-up text-green-500"></i>
                    Sonidos
                  </span>
                  <div id="sounds-toggle" class="toggle-premium on titlebar-no-drag" onclick="toggleSounds()">
                    <div class="knob"></div>
                  </div>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800 rounded-xl">
                  <span class="text-gray-700 dark:text-gray-300 flex items-center gap-3">
                    <i class="fas fa-sync text-purple-500"></i>
                    Auto-refresh
                  </span>
                  <div id="autorefresh-toggle" class="toggle-premium on titlebar-no-drag" onclick="toggleAutoRefresh()">
                    <div class="knob"></div>
                  </div>
                </div>
              </div>
              <button onclick="logout()" class="w-full mt-6 py-3 text-red-500 border-2 border-red-200 dark:border-red-900 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition font-semibold titlebar-no-drag">
                <i class="fas fa-sign-out-alt mr-2"></i>Cerrar SesiÃ³n
              </button>
            </div>
          </div>
          
          <!-- Badges Section -->
          <section class="mt-8">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
              <i class="fas fa-medal text-yellow-500"></i>
              Logros y Badges
            </h3>
            <div class="grid grid-cols-6 gap-4" id="badges-grid">
              <!-- Badges se renderizan dinÃ¡micamente -->
            </div>
          </section>
          
          <!-- Ticket History -->
          <section class="mt-8">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
              <i class="fas fa-ticket-alt text-indigo-500"></i>
              Historial de Tickets
            </h3>
            <div class="premium-card overflow-hidden">
              <table class="w-full">
                <thead class="bg-gray-50 dark:bg-gray-800">
                  <tr>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">LoterÃ­a</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">NÃºmeros</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Apuesta</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Estado</th>
                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Premio</th>
                  </tr>
                </thead>
                <tbody id="tickets-history" class="divide-y divide-gray-100 dark:divide-gray-800">
                  <!-- Tickets se renderizan dinÃ¡micamente -->
                </tbody>
              </table>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>
  
  <!-- Payment Method Modal -->
  <div id="payment-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closePaymentModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="modal-content w-full max-w-lg p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white">
              <i class="fas fa-credit-card"></i>
            </div>
            MÃ©todo de Pago
          </h3>
          <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition titlebar-no-drag">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div id="payment-amount-display" class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl mb-6">
          <p class="text-sm text-gray-500 dark:text-gray-400">Total a pagar</p>
          <p id="payment-total" class="text-3xl font-bold text-gray-900 dark:text-white">RD$ 0</p>
        </div>
        
        <div class="space-y-3 mb-6">
          <button onclick="selectPaymentMethod('wallet')" id="pm-wallet" class="payment-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-blue-400 transition titlebar-no-drag">
            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white">
              <i class="fas fa-wallet text-lg"></i>
            </div>
            <div class="flex-1 text-left">
              <p class="font-semibold text-gray-900 dark:text-white">Balance de Wallet</p>
              <p id="pm-wallet-balance" class="text-sm text-gray-500">Disponible: RD$ 2,500</p>
            </div>
            <i class="fas fa-check-circle text-green-500 hidden" id="pm-wallet-check"></i>
          </button>
          
          <button onclick="selectPaymentMethod('card')" id="pm-card" class="payment-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-blue-400 transition titlebar-no-drag">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white">
              <i class="fas fa-credit-card text-lg"></i>
            </div>
            <div class="flex-1 text-left">
              <p class="font-semibold text-gray-900 dark:text-white">Tarjeta de CrÃ©dito/DÃ©bito</p>
              <p class="text-sm text-gray-500">Visa, Mastercard, American Express</p>
            </div>
            <i class="fas fa-check-circle text-green-500 hidden" id="pm-card-check"></i>
          </button>
          
          <button onclick="selectPaymentMethod('transfer')" id="pm-transfer" class="payment-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-blue-400 transition titlebar-no-drag">
            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center text-white">
              <i class="fas fa-university text-lg"></i>
            </div>
            <div class="flex-1 text-left">
              <p class="font-semibold text-gray-900 dark:text-white">Transferencia Bancaria</p>
              <p class="text-sm text-gray-500">Banco Popular, BHD LeÃ³n, Reservas</p>
            </div>
            <i class="fas fa-check-circle text-green-500 hidden" id="pm-transfer-check"></i>
          </button>
          
          <button onclick="selectPaymentMethod('mobile')" id="pm-mobile" class="payment-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-blue-400 transition opacity-50 cursor-not-allowed titlebar-no-drag" disabled>
            <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center text-white">
              <i class="fas fa-mobile-alt text-lg"></i>
            </div>
            <div class="flex-1 text-left">
              <p class="font-semibold text-gray-900 dark:text-white">Pago MÃ³vil</p>
              <p class="text-sm text-gray-500">PrÃ³ximamente</p>
            </div>
            <span class="px-2 py-1 bg-orange-100 text-orange-600 text-xs font-semibold rounded-full">SOON</span>
          </button>
        </div>
        
        <!-- Card Form (hidden by default) -->
        <div id="card-form-section" class="hidden mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fas fa-lock text-green-500"></i>
            Datos de Tarjeta
          </h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">NÃºmero de Tarjeta</label>
              <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" 
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 titlebar-no-drag"
                oninput="formatCardNumber(this)">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de ExpiraciÃ³n</label>
                <input type="text" id="card-expiry" placeholder="MM/AA" maxlength="5"
                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 titlebar-no-drag"
                  oninput="formatCardExpiry(this)">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CVV</label>
                <input type="text" id="card-cvv" placeholder="123" maxlength="4"
                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 titlebar-no-drag">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre en la Tarjeta</label>
              <input type="text" id="card-name" placeholder="JUAN PEREZ"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 titlebar-no-drag">
            </div>
          </div>
        </div>
        
        <!-- Transfer Info (hidden by default) -->
        <div id="transfer-info-section" class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fas fa-info-circle text-blue-500"></i>
            Datos para Transferencia
          </h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">Banco:</span>
              <span class="font-medium text-gray-900 dark:text-white">Banco Popular Dominicano</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">Tipo de Cuenta:</span>
              <span class="font-medium text-gray-900 dark:text-white">Corriente</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">NÃºmero de Cuenta:</span>
              <span class="font-medium text-gray-900 dark:text-white">123-456789-0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">RNC:</span>
              <span class="font-medium text-gray-900 dark:text-white">1-30-12345-6</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">Titular:</span>
              <span class="font-medium text-gray-900 dark:text-white">LotoLink SRL</span>
            </div>
          </div>
          <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
            <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>
            DespuÃ©s de realizar la transferencia, tu pago serÃ¡ verificado en 24-48 horas.
          </p>
        </div>
        
        <div id="payment-loading" class="hidden text-center py-8">
          <div class="w-16 h-16 mx-auto mb-4 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
          <p class="text-gray-600 dark:text-gray-400">Procesando pago...</p>
        </div>
        
        <button id="confirm-payment-btn" onclick="processPaymentConfirmation()" class="w-full btn-premium py-4 text-lg titlebar-no-drag" disabled>
          <i class="fas fa-lock mr-2"></i>
          <span id="confirm-payment-text">Selecciona un mÃ©todo de pago</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Recharge Modal -->
  <div id="recharge-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeRechargeModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="modal-content w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white">
              <i class="fas fa-plus-circle"></i>
            </div>
            Recargar Balance
          </h3>
          <button onclick="closeRechargeModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition titlebar-no-drag">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl mb-6">
          <p class="text-sm text-gray-500 dark:text-gray-400">Balance Actual</p>
          <p id="recharge-current-balance" class="text-3xl font-bold text-gray-900 dark:text-white">RD$ 2,500</p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Monto a Recargar</label>
          <div class="grid grid-cols-3 gap-3 mb-4">
            <button onclick="selectRechargeAmount(100)" class="recharge-amount-btn p-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl font-semibold hover:border-green-400 transition titlebar-no-drag">RD$ 100</button>
            <button onclick="selectRechargeAmount(500)" class="recharge-amount-btn p-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl font-semibold hover:border-green-400 transition titlebar-no-drag">RD$ 500</button>
            <button onclick="selectRechargeAmount(1000)" class="recharge-amount-btn p-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl font-semibold hover:border-green-400 transition titlebar-no-drag">RD$ 1,000</button>
            <button onclick="selectRechargeAmount(2000)" class="recharge-amount-btn p-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl font-semibold hover:border-green-400 transition titlebar-no-drag">RD$ 2,000</button>
            <button onclick="selectRechargeAmount(5000)" class="recharge-amount-btn p-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl font-semibold hover:border-green-400 transition titlebar-no-drag">RD$ 5,000</button>
            <button onclick="toggleCustomRechargeAmount()" class="recharge-amount-btn p-3 border-2 border-gray-200 dark:border-gray-700 rounded-xl font-semibold hover:border-green-400 transition titlebar-no-drag">
              <i class="fas fa-edit"></i> Otro
            </button>
          </div>
          <div id="custom-recharge-input" class="hidden">
            <input type="number" id="recharge-custom-amount" placeholder="Monto personalizado" min="50" max="50000"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 titlebar-no-drag"
              oninput="updateRechargeAmount(this.value)">
            <p class="text-xs text-gray-500 mt-1">MÃ­nimo RD$ 50 - MÃ¡ximo RD$ 50,000</p>
          </div>
        </div>
        
        <div id="recharge-selected-amount" class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-xl mb-6 hidden">
          <p class="text-sm text-green-600 dark:text-green-400">Monto seleccionado</p>
          <p id="recharge-amount-display" class="text-2xl font-bold text-green-600 dark:text-green-400">RD$ 0</p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">MÃ©todo de Pago</label>
          <div class="space-y-3">
            <button onclick="selectRechargeMethod('card')" id="rm-card" class="recharge-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-green-400 transition titlebar-no-drag">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white">
                <i class="fas fa-credit-card"></i>
              </div>
              <div class="flex-1 text-left">
                <p class="font-semibold text-gray-900 dark:text-white">Tarjeta de CrÃ©dito/DÃ©bito</p>
              </div>
              <i class="fas fa-check-circle text-green-500 hidden" id="rm-card-check"></i>
            </button>
            
            <button onclick="selectRechargeMethod('transfer')" id="rm-transfer" class="recharge-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-green-400 transition titlebar-no-drag">
              <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center text-white">
                <i class="fas fa-university"></i>
              </div>
              <div class="flex-1 text-left">
                <p class="font-semibold text-gray-900 dark:text-white">Transferencia Bancaria</p>
              </div>
              <i class="fas fa-check-circle text-green-500 hidden" id="rm-transfer-check"></i>
            </button>
          </div>
        </div>
        
        <!-- Card Form for Recharge -->
        <div id="recharge-card-form" class="hidden mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fas fa-lock text-green-500"></i>
            Datos de Tarjeta
          </h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">NÃºmero de Tarjeta</label>
              <input type="text" id="recharge-card-number" placeholder="1234 5678 9012 3456" maxlength="19" 
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 titlebar-no-drag"
                oninput="formatCardNumber(this)">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de ExpiraciÃ³n</label>
                <input type="text" id="recharge-card-expiry" placeholder="MM/AA" maxlength="5"
                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 titlebar-no-drag"
                  oninput="formatCardExpiry(this)">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CVV</label>
                <input type="text" id="recharge-card-cvv" placeholder="123" maxlength="4"
                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-green-500 titlebar-no-drag">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Transfer Info for Recharge -->
        <div id="recharge-transfer-info" class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
            <i class="fas fa-info-circle text-blue-500"></i>
            Datos para Transferencia
          </h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">Banco:</span>
              <span class="font-medium text-gray-900 dark:text-white">Banco Popular Dominicano</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">Cuenta:</span>
              <span class="font-medium text-gray-900 dark:text-white">123-456789-0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 dark:text-gray-400">Titular:</span>
              <span class="font-medium text-gray-900 dark:text-white">LotoLink SRL</span>
            </div>
          </div>
        </div>
        
        <div id="recharge-loading" class="hidden text-center py-8">
          <div class="w-16 h-16 mx-auto mb-4 border-4 border-green-200 border-t-green-600 rounded-full animate-spin"></div>
          <p class="text-gray-600 dark:text-gray-400">Procesando recarga...</p>
        </div>
        
        <button id="confirm-recharge-btn" onclick="processRecharge()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition titlebar-no-drag" disabled>
          <i class="fas fa-plus-circle mr-2"></i>
          <span id="confirm-recharge-text">Selecciona monto y mÃ©todo</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Withdraw Modal -->
  <div id="withdraw-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeWithdrawModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="modal-content w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center text-white">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            Retirar Fondos
          </h3>
          <button onclick="closeWithdrawModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition titlebar-no-drag">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="text-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl mb-6">
          <p class="text-sm text-gray-500 dark:text-gray-400">Balance Disponible</p>
          <p id="withdraw-available-balance" class="text-3xl font-bold text-gray-900 dark:text-white">RD$ 2,500</p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Monto a Retirar</label>
          <input type="number" id="withdraw-amount" placeholder="Ingresa el monto" min="100"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-orange-500 titlebar-no-drag"
            oninput="validateWithdrawAmount(this.value)">
          <p class="text-xs text-gray-500 mt-1">MÃ­nimo RD$ 100</p>
          <p id="withdraw-error" class="text-xs text-red-500 mt-1 hidden"></p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">MÃ©todo de Retiro</label>
          <div class="space-y-3">
            <button onclick="selectWithdrawMethod('bank')" id="wm-bank" class="withdraw-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-orange-400 transition titlebar-no-drag">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white">
                <i class="fas fa-university"></i>
              </div>
              <div class="flex-1 text-left">
                <p class="font-semibold text-gray-900 dark:text-white">Transferencia Bancaria</p>
                <p class="text-xs text-gray-500">1-3 dÃ­as hÃ¡biles</p>
              </div>
              <i class="fas fa-check-circle text-orange-500 hidden" id="wm-bank-check"></i>
            </button>
            
            <button onclick="selectWithdrawMethod('cash')" id="wm-cash" class="withdraw-method-btn w-full p-4 border-2 border-gray-200 dark:border-gray-700 rounded-xl flex items-center gap-4 hover:border-orange-400 transition titlebar-no-drag">
              <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center text-white">
                <i class="fas fa-store"></i>
              </div>
              <div class="flex-1 text-left">
                <p class="font-semibold text-gray-900 dark:text-white">Efectivo en Banca</p>
                <p class="text-xs text-gray-500">Recoge en cualquier banca afiliada</p>
              </div>
              <i class="fas fa-check-circle text-orange-500 hidden" id="wm-cash-check"></i>
            </button>
          </div>
        </div>
        
        <!-- Bank Details Form -->
        <div id="withdraw-bank-form" class="hidden mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-4">Datos Bancarios</h4>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Banco</label>
              <select id="withdraw-bank" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-orange-500 titlebar-no-drag">
                <option value="">Selecciona tu banco</option>
                <option value="popular">Banco Popular Dominicano</option>
                <option value="bhd">BHD LeÃ³n</option>
                <option value="reservas">Banreservas</option>
                <option value="scotiabank">Scotiabank</option>
                <option value="promerica">Promerica</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Cuenta</label>
              <select id="withdraw-account-type" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-orange-500 titlebar-no-drag">
                <option value="savings">Cuenta de Ahorro</option>
                <option value="checking">Cuenta Corriente</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">NÃºmero de Cuenta</label>
              <input type="text" id="withdraw-account-number" placeholder="Ingresa tu nÃºmero de cuenta"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-orange-500 titlebar-no-drag">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Titular de la Cuenta</label>
              <input type="text" id="withdraw-account-holder" placeholder="Nombre completo"
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-orange-500 titlebar-no-drag">
            </div>
          </div>
        </div>
        
        <!-- Cash Pickup Info -->
        <div id="withdraw-cash-info" class="hidden mb-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
            <i class="fas fa-info-circle text-yellow-500"></i>
            Instrucciones para Retiro en Efectivo
          </h4>
          <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
            <li class="flex items-start gap-2">
              <i class="fas fa-check text-green-500 mt-1"></i>
              RecibirÃ¡s un cÃ³digo de retiro por SMS y email
            </li>
            <li class="flex items-start gap-2">
              <i class="fas fa-check text-green-500 mt-1"></i>
              Presenta tu cÃ©dula y el cÃ³digo en cualquier banca afiliada
            </li>
            <li class="flex items-start gap-2">
              <i class="fas fa-check text-green-500 mt-1"></i>
              El cÃ³digo es vÃ¡lido por 72 horas
            </li>
          </ul>
        </div>
        
        <div id="withdraw-loading" class="hidden text-center py-8">
          <div class="w-16 h-16 mx-auto mb-4 border-4 border-orange-200 border-t-orange-600 rounded-full animate-spin"></div>
          <p class="text-gray-600 dark:text-gray-400">Procesando solicitud...</p>
        </div>
        
        <button id="confirm-withdraw-btn" onclick="processWithdraw()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transition titlebar-no-drag" disabled>
          <i class="fas fa-money-bill-wave mr-2"></i>
          <span id="confirm-withdraw-text">Completa los datos</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Ticket Modal -->
  <div id="ticket-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeTicketModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div id="ticket-content" class="ticket-premium relative">
        <div class="watermark">L</div>
        <!-- Ticket content se renderiza dinÃ¡micamente -->
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-12 right-4 z-50 space-y-3">
    <!-- Toasts se aÃ±aden dinÃ¡micamente -->
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ========================================
    // LOTOLINK DESKTOP APP - PREMIUM JAVASCRIPT
    // Complete Lottery Application
    // ========================================

    // ===== APP STATE =====
    const appState = {
      user: {
        name: 'Juan PÃ©rez',
        email: 'juan.perez@email.com',
        phone: '+1 809-555-1234',
        balance: 2500,
        memberSince: 'Enero 2024',
        verified: true
      },
      selectedLottery: null,
      selectedModality: null,
      selectedNumbers: [],
      selectedStake: 25,
      maxNumbers: 2,
      multiplier: 60,
      currentStep: 1,
      darkMode: false,
      notifications: true,
      sounds: true,
      autoRefresh: true,
      autoRefreshInterval: null,
      isOnline: true,
      // Global Cart for multiple plays
      globalCart: [],
      // Luna AI Assistant state
      luna: {
        enabled: true,
        voiceEnabled: true,
        voiceGender: 'female',
        voiceSpeed: 'normal',
        voiceAccent: 'es-DO',
        isListening: false,
        mode: 'idle', // 'idle', 'select_banca', 'select_lottery', 'select_modality', 'select_numbers'
        guidedPlayData: { banca: null, lottery: null, modality: null, numbers: [] }
      },
      // Welcome screen state
      showWelcome: !localStorage.getItem('ll_welcome_completed')
    };

    // ===== LOTTERY RESULTS API CONFIGURATION =====
    const LOTTERY_API_CONFIG = {
      BASE_URL: 'https://loteriasdominicanas.com',
      ENDPOINTS: {
        LOTEKA: '/loteka',
        LEIDSA: '/leidsa',
        NACIONAL: '/loteria-nacional',
        LA_PRIMERA: '/la-primera',
        REAL: '/la-suerte',
        AMERICANAS: '/americanas'
      },
      CORS_PROXIES: [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest='
      ],
      UPDATE_INTERVAL_MS: 30000,
      FALLBACK_TO_SIMULATION: true,
      CACHE_DURATION_MS: 300000
    };

    // ===== MOST PLAYED NUMBERS =====
    const MOST_PLAYED = {
      Quiniela: ["08", "66", "36", "63", "42"],
      Tripleta: [["15", "26", "07"], ["12", "34", "56"]],
      PalÃ©: [["08", "66"], ["36", "63"]]
    };

    // ===== MOCK DATA =====
    const LOTTERIES = [
      { id: 'leidsa', name: 'Leidsa', color: '#FFD700', logo: 'LD', schedule: 'Hoy 8:55 PM', modalities: ['Quiniela', 'PalÃ©', 'Tripleta', 'Pega 3'] },
      { id: 'loteka', name: 'Loteka', color: '#00B0DB', logo: 'LK', schedule: 'Hoy 7:55 PM', modalities: ['Quiniela', 'PalÃ©', 'Tripleta', 'Toca 3'] },
      { id: 'laprimera', name: 'La Primera', color: '#C81F46', logo: 'LP', schedule: 'Hoy 8:00 PM', modalities: ['Quiniela', 'PalÃ©', 'Tripleta'] },
      { id: 'nacional', name: 'LoterÃ­a Nacional', color: '#496079', logo: 'LN', schedule: 'Hoy 9:00 PM', modalities: ['Quiniela', 'PalÃ©', 'Tripleta'] },
      { id: 'real', name: 'LoterÃ­a Real', color: '#008000', logo: 'LR', schedule: 'Hoy 12:55 PM', modalities: ['Quiniela', 'PalÃ©', 'Tripleta'] },
      { id: 'lasuerte', name: 'La Suerte Dominicana', color: '#FFA500', logo: 'LS', schedule: '12:30 PM y 6:00 PM', modalities: ['Quiniela', 'PalÃ©', 'Tripleta'] },
      { id: 'lotedom', name: 'LoteDom', color: '#800080', logo: 'LDm', schedule: 'Sorteos diarios 12:00 PM', modalities: ['Quiniela', 'PalÃ©', 'Tripleta'] },
      { id: 'americana', name: 'Americana (NY)', color: '#1e3a5f', logo: 'NY', schedule: 'Hoy 2:30 PM', modalities: ['Quiniela', 'PalÃ©'] }
    ];

    const MODALITIES = {
      'Quiniela': { 
        numbers: 1, 
        multiplier: 60, 
        description: '1 nÃºmero â€¢ Premio 60x', 
        icon: 'fa-bullseye',
        prizes: [
          { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
          { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
          { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
        ]
      },
      'PalÃ©': { 
        numbers: 2, 
        multiplier: 1000, 
        description: '2 nÃºmeros â€¢ Premio 1,000x', 
        icon: 'fa-layer-group',
        prizes: [
          { position: "1er y 2do Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
          { position: "1er y 3er Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
          { position: "2do y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
        ]
      },
      'Tripleta': { 
        numbers: 3, 
        multiplier: 20000, 
        description: '3 nÃºmeros â€¢ Premio 20,000x', 
        icon: 'fa-cubes',
        prizes: [
          { position: "3 nÃºmeros (cualquier orden)", multiplier: "20,000x", example: "Apuesta RD$10 = Gana RD$200,000" },
          { position: "2 de 3 nÃºmeros", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
        ]
      },
      'Pega 3': { 
        numbers: 3, 
        multiplier: 700, 
        description: '3 dÃ­gitos (0-9) â€¢ Premio 700x', 
        icon: 'fa-sort-numeric-down',
        prizes: [
          { position: "Orden Exacto", multiplier: "700x", example: "Apuesta RD$10 = Gana RD$7,000" },
          { position: "Cualquier Orden", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
        ]
      },
      'Toca 3': { 
        numbers: 3, 
        multiplier: 600, 
        description: '3 dÃ­gitos (0-9) â€¢ Premio 600x', 
        icon: 'fa-hand-point-up',
        prizes: [
          { position: "Orden Exacto", multiplier: "600x", example: "Apuesta RD$10 = Gana RD$6,000" },
          { position: "Cualquier Orden", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
        ]
      }
    };

    const BANCAS = [
      { id: 1, name: 'Banca La Fortuna', address: 'Av. 27 de Febrero #123, Santo Domingo', coords: [18.4693, -69.8990], status: 'open', rating: 4.8, distance: 0.3, lotteries: ['Nacional', 'Leidsa', 'Real', 'Loteka'] },
      { id: 2, name: 'Banca El Millonario', address: 'C/ Duarte #456, Santiago', coords: [18.4825, -69.9312], status: 'open', rating: 4.5, distance: 0.8, lotteries: ['Nacional', 'Loteka'] },
      { id: 3, name: 'Banca Suerte Total', address: 'Av. Independencia #789, Santo Domingo', coords: [18.4661, -69.8989], status: 'closed', rating: 4.7, distance: 1.2, lotteries: ['Nacional', 'Leidsa', 'Real', 'Loteka', 'La Primera'] },
      { id: 4, name: 'Banca Los Ganadores', address: 'C/ El Conde #321, Zona Colonial', coords: [18.4890, -69.9220], status: 'open', rating: 4.9, distance: 1.5, lotteries: ['Nacional', 'Leidsa'] },
      { id: 5, name: 'Banca Premium Plus', address: 'Av. Winston Churchill #555, Piantini', coords: [18.4750, -69.9400], status: 'open', rating: 4.6, distance: 2.0, lotteries: ['Leidsa', 'Loteka', 'La Primera'] }
    ];

    const MOCK_RESULTS = [
      { lottery: 'Nacional', time: '12:30 PM', date: 'Hoy', numbers: ['23', '45', '67'], color: '#ef4444', ballClass: 'red' },
      { lottery: 'Leidsa', time: '8:55 PM', date: 'Ayer', numbers: ['12', '34', '56'], color: '#22c55e', ballClass: 'green' },
      { lottery: 'Loteka', time: '7:55 PM', date: 'Ayer', numbers: ['78', '90', '11'], color: '#00B0DB', ballClass: 'teal' },
      { lottery: 'Real', time: '12:55 PM', date: 'Hoy', numbers: ['08', '66', '42'], color: '#eab308', ballClass: 'gold' }
    ];

    const TRANSACTIONS = [
      { type: 'recharge', amount: 1000, date: 'Hoy 10:30 AM', method: 'Tarjeta de CrÃ©dito', icon: 'fa-plus-circle', color: 'green' },
      { type: 'play', amount: -50, date: 'Hoy 11:45 AM', method: 'Nacional - Quiniela', icon: 'fa-dice', color: 'blue' },
      { type: 'win', amount: 500, date: 'Hoy 1:00 PM', method: 'Nacional - Quiniela', icon: 'fa-trophy', color: 'yellow' },
      { type: 'withdraw', amount: -200, date: 'Ayer 9:00 AM', method: 'Transferencia Bancaria', icon: 'fa-money-bill-wave', color: 'orange', status: 'pending' }
    ];

    const BADGES = [
      { id: 1, name: 'Primera Jugada', icon: 'fa-bullseye', earned: true, color: 'blue' },
      { id: 2, name: 'Primera Victoria', icon: 'fa-trophy', earned: true, color: 'yellow' },
      { id: 3, name: 'Racha de 3', icon: 'fa-fire', earned: true, color: 'orange' },
      { id: 4, name: '10 Jugadas', icon: 'fa-dice', earned: true, color: 'purple' },
      { id: 5, name: 'Gran Ganador', icon: 'fa-gem', earned: false, color: 'pink' },
      { id: 6, name: 'VIP', icon: 'fa-star', earned: false, color: 'gold' }
    ];

    // ===== UTILITY FUNCTIONS =====
    function pad(n) { return String(n).padStart(2, '0'); }
    function formatMoney(amount) { 
      var prefix = amount < 0 ? '-RD$ ' : 'RD$ ';
      return prefix + Math.abs(amount).toLocaleString(); 
    }
    function uid(prefix = 'T') { return prefix + '-' + Date.now().toString(36).slice(2, 9).toUpperCase(); }

    // ===== PERSISTENCE FUNCTIONS =====
    // Storage keys
    const STORAGE_KEYS = {
      TICKETS: 'lotolink_tickets',
      TRANSACTIONS: 'lotolink_transactions',
      BALANCE: 'lotolink_user_balance'
    };

    // Load balance from localStorage
    function loadBalance() {
      var savedBalance = localStorage.getItem(STORAGE_KEYS.BALANCE);
      if (savedBalance !== null) {
        appState.user.balance = parseFloat(savedBalance);
      }
    }

    // Save balance to localStorage
    function saveBalance() {
      localStorage.setItem(STORAGE_KEYS.BALANCE, appState.user.balance.toString());
    }

    // Get all tickets from localStorage
    function getTickets() {
      try {
        var tickets = localStorage.getItem(STORAGE_KEYS.TICKETS);
        return tickets ? JSON.parse(tickets) : [];
      } catch (e) {
        console.error('Error loading tickets:', e);
        return [];
      }
    }

    // Save a new ticket to localStorage
    function saveTicket(ticketData) {
      try {
        var tickets = getTickets();
        var ticket = {
          id: ticketData.id || uid('TKT'),
          lotteryId: ticketData.lotteryId || '',
          lotteryName: ticketData.lotteryName || ticketData.lottery || '',
          modality: ticketData.modality || '',
          numbers: ticketData.numbers || [],
          stake: ticketData.stake || 0,
          potentialPrize: ticketData.potentialPrize || 0,
          status: ticketData.status || 'pending', // 'pending', 'won', 'lost'
          prize: ticketData.prize || 0,
          paymentMethod: ticketData.paymentMethod || 'wallet',
          banca: ticketData.banca || 'Banca Online',
          createdAt: ticketData.createdAt || new Date().toISOString(),
          ticketCode: ticketData.ticketCode || 'LNK-' + new Date().getFullYear() + '-' + String(Math.floor(Math.random() * 1000000)).padStart(6, '0'),
          drawDate: ticketData.drawDate || new Date().toISOString().split('T')[0],
          drawTime: ticketData.drawTime || '8:55 PM'
        };
        tickets.unshift(ticket); // Add to beginning
        localStorage.setItem(STORAGE_KEYS.TICKETS, JSON.stringify(tickets));
        return ticket;
      } catch (e) {
        console.error('Error saving ticket:', e);
        return null;
      }
    }

    // Update ticket status
    function updateTicketStatus(ticketId, status, prize) {
      try {
        var tickets = getTickets();
        var ticketIndex = tickets.findIndex(function(t) { return t.id === ticketId; });
        if (ticketIndex !== -1) {
          tickets[ticketIndex].status = status;
          if (prize !== undefined) {
            tickets[ticketIndex].prize = prize;
          }
          localStorage.setItem(STORAGE_KEYS.TICKETS, JSON.stringify(tickets));
          return true;
        }
        return false;
      } catch (e) {
        console.error('Error updating ticket:', e);
        return false;
      }
    }

    // Get all transactions from localStorage
    function getTransactions() {
      try {
        var transactions = localStorage.getItem(STORAGE_KEYS.TRANSACTIONS);
        return transactions ? JSON.parse(transactions) : [];
      } catch (e) {
        console.error('Error loading transactions:', e);
        return [];
      }
    }

    // Save a new transaction to localStorage
    function saveTransaction(transactionData) {
      try {
        var transactions = getTransactions();
        var transaction = {
          id: transactionData.id || uid('TXN'),
          type: transactionData.type || 'play', // 'deposit', 'play', 'win', 'withdrawal'
          amount: transactionData.amount || 0,
          method: transactionData.method || '',
          status: transactionData.status || 'completed', // 'completed', 'pending', 'failed'
          reference: transactionData.reference || uid('REF'),
          details: transactionData.details || '',
          createdAt: transactionData.createdAt || new Date().toISOString()
        };
        transactions.unshift(transaction); // Add to beginning
        localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
        return transaction;
      } catch (e) {
        console.error('Error saving transaction:', e);
        return null;
      }
    }

    // ===== PAYMENT MODAL FUNCTIONS =====
    var pendingPayment = {
      amount: 0,
      type: 'play', // 'play' or 'cart'
      onSuccess: null,
      selectedMethod: null,
      playData: null
    };

    function showPaymentModal(amount, type, onSuccess, playData) {
      pendingPayment.amount = amount;
      pendingPayment.type = type;
      pendingPayment.onSuccess = onSuccess;
      pendingPayment.selectedMethod = null;
      pendingPayment.playData = playData || null;

      // Reset modal state
      document.querySelectorAll('.payment-method-btn').forEach(function(btn) {
        btn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      document.querySelectorAll('[id^="pm-"][id$="-check"]').forEach(function(el) {
        el.classList.add('hidden');
      });
      document.getElementById('card-form-section').classList.add('hidden');
      document.getElementById('transfer-info-section').classList.add('hidden');
      document.getElementById('payment-loading').classList.add('hidden');

      // Update display
      document.getElementById('payment-total').textContent = formatMoney(amount);
      document.getElementById('pm-wallet-balance').textContent = 'Disponible: ' + formatMoney(appState.user.balance);
      
      // Disable wallet if insufficient balance
      var walletBtn = document.getElementById('pm-wallet');
      if (amount > appState.user.balance) {
        walletBtn.classList.add('opacity-50');
        walletBtn.disabled = true;
        document.getElementById('pm-wallet-balance').textContent = 'Balance insuficiente';
      } else {
        walletBtn.classList.remove('opacity-50');
        walletBtn.disabled = false;
      }

      // Reset confirm button
      var confirmBtn = document.getElementById('confirm-payment-btn');
      confirmBtn.disabled = true;
      document.getElementById('confirm-payment-text').textContent = 'Selecciona un mÃ©todo de pago';

      // Clear card form
      document.getElementById('card-number').value = '';
      document.getElementById('card-expiry').value = '';
      document.getElementById('card-cvv').value = '';
      document.getElementById('card-name').value = '';

      document.getElementById('payment-modal').classList.remove('hidden');
    }

    function closePaymentModal() {
      document.getElementById('payment-modal').classList.add('hidden');
      pendingPayment = { amount: 0, type: 'play', onSuccess: null, selectedMethod: null, playData: null };
    }

    function selectPaymentMethod(method) {
      pendingPayment.selectedMethod = method;

      // Update UI
      document.querySelectorAll('.payment-method-btn').forEach(function(btn) {
        btn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      document.querySelectorAll('[id^="pm-"][id$="-check"]').forEach(function(el) {
        el.classList.add('hidden');
      });

      var selectedBtn = document.getElementById('pm-' + method);
      if (selectedBtn) {
        selectedBtn.classList.remove('border-gray-200', 'dark:border-gray-700');
        selectedBtn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        document.getElementById('pm-' + method + '-check').classList.remove('hidden');
      }

      // Show/hide forms
      document.getElementById('card-form-section').classList.toggle('hidden', method !== 'card');
      document.getElementById('transfer-info-section').classList.toggle('hidden', method !== 'transfer');

      // Update confirm button
      var confirmBtn = document.getElementById('confirm-payment-btn');
      confirmBtn.disabled = false;
      var methodNames = { wallet: 'Pagar con Wallet', card: 'Pagar con Tarjeta', transfer: 'Confirmar Transferencia' };
      document.getElementById('confirm-payment-text').textContent = methodNames[method] || 'Confirmar Pago';
    }

    function formatCardNumber(input) {
      var value = input.value.replace(/\D/g, '');
      value = value.replace(/(.{4})/g, '$1 ').trim();
      input.value = value.substring(0, 19);
    }

    function formatCardExpiry(input) {
      var value = input.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
      }
      input.value = value;
    }

    function validateCardForm() {
      var cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
      var cardExpiry = document.getElementById('card-expiry').value;
      var cardCvv = document.getElementById('card-cvv').value;
      var cardName = document.getElementById('card-name').value;

      if (cardNumber.length < 13 || cardNumber.length > 19) {
        showToast('NÃºmero de tarjeta invÃ¡lido', 'error');
        return false;
      }
      if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
        showToast('Fecha de expiraciÃ³n invÃ¡lida', 'error');
        return false;
      }
      if (cardCvv.length < 3 || cardCvv.length > 4) {
        showToast('CVV invÃ¡lido', 'error');
        return false;
      }
      if (cardName.length < 3) {
        showToast('Nombre en tarjeta requerido', 'error');
        return false;
      }
      return true;
    }

    function processPaymentConfirmation() {
      if (!pendingPayment.selectedMethod) {
        showToast('Selecciona un mÃ©todo de pago', 'warning');
        return;
      }

      // Validate card form if card selected
      if (pendingPayment.selectedMethod === 'card' && !validateCardForm()) {
        return;
      }

      // Show loading
      document.getElementById('payment-loading').classList.remove('hidden');
      document.getElementById('confirm-payment-btn').disabled = true;

      // Simulate payment processing
      setTimeout(function() {
        document.getElementById('payment-loading').classList.add('hidden');

        var methodNames = {
          wallet: 'Balance de Wallet',
          card: 'Tarjeta de CrÃ©dito',
          transfer: 'Transferencia Bancaria'
        };

        if (pendingPayment.selectedMethod === 'wallet') {
          // Deduct from balance
          appState.user.balance -= pendingPayment.amount;
          saveBalance();
          updateBalance();
        }

        // Execute success callback
        if (pendingPayment.onSuccess) {
          pendingPayment.onSuccess(pendingPayment.selectedMethod, methodNames[pendingPayment.selectedMethod]);
        }

        closePaymentModal();

        if (pendingPayment.selectedMethod === 'transfer') {
          showToast('Transferencia registrada. Pendiente de verificaciÃ³n.', 'info');
        } else {
          showToast('Â¡Pago procesado con Ã©xito!', 'success');
        }
      }, 1500);
    }

    // ===== RECHARGE MODAL FUNCTIONS =====
    var rechargeState = {
      amount: 0,
      method: null
    };

    function showRechargeModal() {
      rechargeState = { amount: 0, method: null };

      // Reset UI
      document.querySelectorAll('.recharge-amount-btn').forEach(function(btn) {
        btn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      document.querySelectorAll('.recharge-method-btn').forEach(function(btn) {
        btn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      document.querySelectorAll('[id^="rm-"][id$="-check"]').forEach(function(el) {
        el.classList.add('hidden');
      });

      document.getElementById('recharge-current-balance').textContent = formatMoney(appState.user.balance);
      document.getElementById('recharge-selected-amount').classList.add('hidden');
      document.getElementById('custom-recharge-input').classList.add('hidden');
      document.getElementById('recharge-card-form').classList.add('hidden');
      document.getElementById('recharge-transfer-info').classList.add('hidden');
      document.getElementById('recharge-loading').classList.add('hidden');
      document.getElementById('recharge-custom-amount').value = '';

      // Clear card form
      document.getElementById('recharge-card-number').value = '';
      document.getElementById('recharge-card-expiry').value = '';
      document.getElementById('recharge-card-cvv').value = '';

      var confirmBtn = document.getElementById('confirm-recharge-btn');
      confirmBtn.disabled = true;
      document.getElementById('confirm-recharge-text').textContent = 'Selecciona monto y mÃ©todo';

      document.getElementById('recharge-modal').classList.remove('hidden');
    }

    function closeRechargeModal() {
      document.getElementById('recharge-modal').classList.add('hidden');
    }

    function selectRechargeAmount(amount) {
      rechargeState.amount = amount;

      document.querySelectorAll('.recharge-amount-btn').forEach(function(btn) {
        btn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      if (event && event.target) {
        event.target.classList.remove('border-gray-200', 'dark:border-gray-700');
        event.target.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
      }

      document.getElementById('custom-recharge-input').classList.add('hidden');
      document.getElementById('recharge-selected-amount').classList.remove('hidden');
      document.getElementById('recharge-amount-display').textContent = formatMoney(amount);

      updateRechargeButton();
    }

    function toggleCustomRechargeAmount() {
      document.querySelectorAll('.recharge-amount-btn').forEach(function(btn) {
        btn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      if (event && event.target) {
        event.target.classList.remove('border-gray-200', 'dark:border-gray-700');
        event.target.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
      }

      document.getElementById('custom-recharge-input').classList.remove('hidden');
      rechargeState.amount = 0;
      document.getElementById('recharge-selected-amount').classList.add('hidden');
      updateRechargeButton();
    }

    function updateRechargeAmount(value) {
      var amount = parseInt(value) || 0;
      if (amount >= 50 && amount <= 50000) {
        rechargeState.amount = amount;
        document.getElementById('recharge-selected-amount').classList.remove('hidden');
        document.getElementById('recharge-amount-display').textContent = formatMoney(amount);
      } else {
        rechargeState.amount = 0;
        document.getElementById('recharge-selected-amount').classList.add('hidden');
      }
      updateRechargeButton();
    }

    function selectRechargeMethod(method) {
      rechargeState.method = method;

      document.querySelectorAll('.recharge-method-btn').forEach(function(btn) {
        btn.classList.remove('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      document.querySelectorAll('[id^="rm-"][id$="-check"]').forEach(function(el) {
        el.classList.add('hidden');
      });

      var selectedBtn = document.getElementById('rm-' + method);
      if (selectedBtn) {
        selectedBtn.classList.remove('border-gray-200', 'dark:border-gray-700');
        selectedBtn.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20');
        document.getElementById('rm-' + method + '-check').classList.remove('hidden');
      }

      document.getElementById('recharge-card-form').classList.toggle('hidden', method !== 'card');
      document.getElementById('recharge-transfer-info').classList.toggle('hidden', method !== 'transfer');

      updateRechargeButton();
    }

    function updateRechargeButton() {
      var confirmBtn = document.getElementById('confirm-recharge-btn');
      if (rechargeState.amount >= 50 && rechargeState.method) {
        confirmBtn.disabled = false;
        document.getElementById('confirm-recharge-text').textContent = 'Recargar ' + formatMoney(rechargeState.amount);
      } else {
        confirmBtn.disabled = true;
        document.getElementById('confirm-recharge-text').textContent = 'Selecciona monto y mÃ©todo';
      }
    }

    function validateRechargeCardForm() {
      var cardNumber = document.getElementById('recharge-card-number').value.replace(/\s/g, '');
      var cardExpiry = document.getElementById('recharge-card-expiry').value;
      var cardCvv = document.getElementById('recharge-card-cvv').value;

      if (cardNumber.length < 13 || cardNumber.length > 19) {
        showToast('NÃºmero de tarjeta invÃ¡lido', 'error');
        return false;
      }
      if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
        showToast('Fecha de expiraciÃ³n invÃ¡lida', 'error');
        return false;
      }
      if (cardCvv.length < 3 || cardCvv.length > 4) {
        showToast('CVV invÃ¡lido', 'error');
        return false;
      }
      return true;
    }

    function processRecharge() {
      if (rechargeState.amount < 50) {
        showToast('Monto mÃ­nimo es RD$ 50', 'warning');
        return;
      }
      if (!rechargeState.method) {
        showToast('Selecciona un mÃ©todo de pago', 'warning');
        return;
      }
      if (rechargeState.method === 'card' && !validateRechargeCardForm()) {
        return;
      }

      document.getElementById('recharge-loading').classList.remove('hidden');
      document.getElementById('confirm-recharge-btn').disabled = true;

      setTimeout(function() {
        document.getElementById('recharge-loading').classList.add('hidden');

        var methodName = rechargeState.method === 'card' ? 'Tarjeta de CrÃ©dito' : 'Transferencia Bancaria';
        var status = rechargeState.method === 'transfer' ? 'pending' : 'completed';

        // Save transaction
        saveTransaction({
          type: 'deposit',
          amount: rechargeState.amount,
          method: methodName,
          status: status,
          details: 'Recarga de balance'
        });

        // Update balance (if card payment, instant; if transfer, pending)
        if (rechargeState.method === 'card') {
          appState.user.balance += rechargeState.amount;
          saveBalance();
          updateBalance();
          showToast('Â¡Recarga exitosa! +' + formatMoney(rechargeState.amount), 'success');
        } else {
          showToast('Transferencia registrada. Tu balance se actualizarÃ¡ al verificar el pago.', 'info');
        }

        closeRechargeModal();
        
        // Refresh transactions if on wallet view
        if (document.getElementById('view-wallet') && !document.getElementById('view-wallet').classList.contains('hidden')) {
          renderTransactions();
        }
      }, 1500);
    }

    // ===== WITHDRAW MODAL FUNCTIONS =====
    var withdrawState = {
      amount: 0,
      method: null,
      isValid: false
    };

    function showWithdrawModal() {
      withdrawState = { amount: 0, method: null, isValid: false };

      document.getElementById('withdraw-available-balance').textContent = formatMoney(appState.user.balance);
      document.getElementById('withdraw-amount').value = '';
      document.getElementById('withdraw-error').classList.add('hidden');

      document.querySelectorAll('.withdraw-method-btn').forEach(function(btn) {
        btn.classList.remove('border-orange-500', 'bg-orange-50', 'dark:bg-orange-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      document.querySelectorAll('[id^="wm-"][id$="-check"]').forEach(function(el) {
        el.classList.add('hidden');
      });

      document.getElementById('withdraw-bank-form').classList.add('hidden');
      document.getElementById('withdraw-cash-info').classList.add('hidden');
      document.getElementById('withdraw-loading').classList.add('hidden');

      // Clear form
      document.getElementById('withdraw-bank').value = '';
      document.getElementById('withdraw-account-type').value = 'savings';
      document.getElementById('withdraw-account-number').value = '';
      document.getElementById('withdraw-account-holder').value = '';

      var confirmBtn = document.getElementById('confirm-withdraw-btn');
      confirmBtn.disabled = true;
      document.getElementById('confirm-withdraw-text').textContent = 'Completa los datos';

      document.getElementById('withdraw-modal').classList.remove('hidden');
    }

    function closeWithdrawModal() {
      document.getElementById('withdraw-modal').classList.add('hidden');
    }

    function validateWithdrawAmount(value) {
      var amount = parseInt(value) || 0;
      var errorEl = document.getElementById('withdraw-error');

      if (amount < 100 && amount > 0) {
        errorEl.textContent = 'El monto mÃ­nimo es RD$ 100';
        errorEl.classList.remove('hidden');
        withdrawState.isValid = false;
      } else if (amount > appState.user.balance) {
        errorEl.textContent = 'Monto excede tu balance disponible';
        errorEl.classList.remove('hidden');
        withdrawState.isValid = false;
      } else if (amount > 0) {
        errorEl.classList.add('hidden');
        withdrawState.isValid = true;
      } else {
        errorEl.classList.add('hidden');
        withdrawState.isValid = false;
      }

      withdrawState.amount = amount;
      updateWithdrawButton();
    }

    function selectWithdrawMethod(method) {
      withdrawState.method = method;

      document.querySelectorAll('.withdraw-method-btn').forEach(function(btn) {
        btn.classList.remove('border-orange-500', 'bg-orange-50', 'dark:bg-orange-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      document.querySelectorAll('[id^="wm-"][id$="-check"]').forEach(function(el) {
        el.classList.add('hidden');
      });

      var selectedBtn = document.getElementById('wm-' + method);
      if (selectedBtn) {
        selectedBtn.classList.remove('border-gray-200', 'dark:border-gray-700');
        selectedBtn.classList.add('border-orange-500', 'bg-orange-50', 'dark:bg-orange-900/20');
        document.getElementById('wm-' + method + '-check').classList.remove('hidden');
      }

      document.getElementById('withdraw-bank-form').classList.toggle('hidden', method !== 'bank');
      document.getElementById('withdraw-cash-info').classList.toggle('hidden', method !== 'cash');

      updateWithdrawButton();
    }

    function updateWithdrawButton() {
      var confirmBtn = document.getElementById('confirm-withdraw-btn');
      var canProcess = withdrawState.isValid && withdrawState.amount >= 100 && withdrawState.method;

      if (withdrawState.method === 'bank') {
        var bank = document.getElementById('withdraw-bank').value;
        var accountNumber = document.getElementById('withdraw-account-number').value;
        var accountHolder = document.getElementById('withdraw-account-holder').value;
        canProcess = canProcess && bank && accountNumber && accountHolder;
      }

      if (canProcess) {
        confirmBtn.disabled = false;
        document.getElementById('confirm-withdraw-text').textContent = 'Solicitar Retiro de ' + formatMoney(withdrawState.amount);
      } else {
        confirmBtn.disabled = true;
        document.getElementById('confirm-withdraw-text').textContent = 'Completa los datos';
      }
    }

    function processWithdraw() {
      if (!withdrawState.isValid || withdrawState.amount < 100) {
        showToast('Ingresa un monto vÃ¡lido', 'warning');
        return;
      }
      if (!withdrawState.method) {
        showToast('Selecciona un mÃ©todo de retiro', 'warning');
        return;
      }
      if (withdrawState.amount > appState.user.balance) {
        showToast('Balance insuficiente', 'error');
        return;
      }

      if (withdrawState.method === 'bank') {
        var bank = document.getElementById('withdraw-bank').value;
        var accountNumber = document.getElementById('withdraw-account-number').value;
        var accountHolder = document.getElementById('withdraw-account-holder').value;
        if (!bank || !accountNumber || !accountHolder) {
          showToast('Completa los datos bancarios', 'warning');
          return;
        }
      }

      document.getElementById('withdraw-loading').classList.remove('hidden');
      document.getElementById('confirm-withdraw-btn').disabled = true;

      setTimeout(function() {
        document.getElementById('withdraw-loading').classList.add('hidden');

        var methodName = withdrawState.method === 'bank' ? 'Transferencia Bancaria' : 'Efectivo en Banca';

        // Deduct from balance immediately
        appState.user.balance -= withdrawState.amount;
        saveBalance();
        updateBalance();

        // Save transaction as pending
        saveTransaction({
          type: 'withdrawal',
          amount: -withdrawState.amount,
          method: methodName,
          status: 'pending',
          details: 'Retiro de fondos'
        });

        closeWithdrawModal();

        if (withdrawState.method === 'bank') {
          showToast('Solicitud de retiro enviada. Procesamiento en 1-3 dÃ­as hÃ¡biles.', 'success');
        } else {
          showToast('CÃ³digo de retiro enviado a tu telÃ©fono y email.', 'success');
        }

        // Refresh transactions if on wallet view
        if (document.getElementById('view-wallet') && !document.getElementById('view-wallet').classList.contains('hidden')) {
          renderTransactions();
        }
      }, 1500);
    }

    // Add event listeners for bank form validation
    document.addEventListener('DOMContentLoaded', function() {
      var bankFormFields = ['withdraw-bank', 'withdraw-account-number', 'withdraw-account-holder'];
      bankFormFields.forEach(function(fieldId) {
        var field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', updateWithdrawButton);
          field.addEventListener('change', updateWithdrawButton);
        }
      });
    });

    // ===== GLOBAL CART FUNCTIONS =====
    function addToGlobalCart(item) {
      appState.globalCart.push({
        id: uid('CART'),
        lottery: item.lottery,
        modality: item.modality,
        numbers: item.numbers,
        stake: item.stake,
        banca: item.banca || 'Banca Online',
        timestamp: new Date().toISOString()
      });
      updateCartBadge();
      showToast('Jugada agregada al carrito ðŸ›’', 'success');
      renderCartPanel();
    }

    function removeFromCart(itemId) {
      appState.globalCart = appState.globalCart.filter(item => item.id !== itemId);
      updateCartBadge();
      renderCartPanel();
      showToast('Jugada eliminada del carrito', 'info');
    }

    function clearCart() {
      appState.globalCart = [];
      updateCartBadge();
      renderCartPanel();
      showToast('Carrito vaciado', 'info');
    }

    function getCartTotal() {
      return appState.globalCart.reduce((sum, item) => sum + item.stake, 0);
    }

    function updateCartBadge() {
      const badge = document.getElementById('cart-badge');
      if (badge) {
        const count = appState.globalCart.length;
        badge.textContent = count;
        badge.style.display = count > 0 ? 'flex' : 'none';
      }
    }

    function toggleCartPanel() {
      const panel = document.getElementById('cart-panel');
      if (panel) {
        panel.classList.toggle('hidden');
        renderCartPanel();
      }
    }

    function renderCartPanel() {
      const container = document.getElementById('cart-items');
      if (!container) return;

      if (appState.globalCart.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-shopping-cart text-4xl mb-4"></i><p>Tu carrito estÃ¡ vacÃ­o</p></div>';
      } else {
        container.innerHTML = appState.globalCart.map(item => 
          '<div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-gray-700">' +
            '<div class="flex-1">' +
              '<p class="font-semibold text-gray-900 dark:text-white">' + item.lottery + ' - ' + item.modality + '</p>' +
              '<p class="text-sm text-gray-500">' + item.numbers.join(', ') + ' â€¢ ' + formatMoney(item.stake) + '</p>' +
              '<p class="text-xs text-gray-400">' + item.banca + '</p>' +
            '</div>' +
            '<button onclick="removeFromCart(\'' + item.id + '\')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">' +
              '<i class="fas fa-trash"></i>' +
            '</button>' +
          '</div>'
        ).join('');
      }

      const totalEl = document.getElementById('cart-total');
      if (totalEl) {
        totalEl.textContent = formatMoney(getCartTotal());
      }
    }

    function checkoutCart() {
      if (appState.globalCart.length === 0) {
        showToast('Tu carrito estÃ¡ vacÃ­o', 'warning');
        return;
      }
      const total = getCartTotal();
      
      // Show payment modal for cart checkout
      showPaymentModal(total, 'cart', function(paymentMethod, methodName) {
        // Process each item in cart
        appState.globalCart.forEach(function(item) {
          // Find lottery info
          var lottery = LOTTERIES.find(function(l) { return l.name === item.lottery; });
          var modInfo = MODALITIES[item.modality] || { multiplier: 60 };
          
          // Save ticket
          saveTicket({
            lotteryId: lottery ? lottery.id : '',
            lotteryName: item.lottery,
            modality: item.modality,
            numbers: item.numbers,
            stake: item.stake,
            potentialPrize: item.stake * modInfo.multiplier,
            paymentMethod: paymentMethod,
            banca: item.banca || 'Banca Online'
          });
          
          // Save transaction for each play
          saveTransaction({
            type: 'play',
            amount: -item.stake,
            method: methodName,
            status: 'completed',
            details: item.lottery + ' - ' + item.modality
          });
        });
        
        // Show first ticket modal (or could show all)
        var firstItem = appState.globalCart[0];
        if (firstItem) {
          showTicketModal(firstItem.lottery, firstItem.modality, firstItem.numbers, firstItem.stake, paymentMethod);
        }
        
        clearCart();
        showToast('Â¡Todas las jugadas confirmadas! Buena suerte ðŸ€', 'success');
      }, null);
    }

    // ===== LUNA AI ASSISTANT FUNCTIONS =====
    function speakText(text) {
      if (!appState.luna.voiceEnabled || !('speechSynthesis' in window)) return;
      
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = appState.luna.voiceAccent;
      utterance.rate = appState.luna.voiceSpeed === 'slow' ? 0.8 : appState.luna.voiceSpeed === 'fast' ? 1.2 : 1;
      
      // Try to find a voice that matches the accent and gender
      const voices = window.speechSynthesis.getVoices();
      const langPrefix = appState.luna.voiceAccent.split('-')[0];
      const preferredVoice = voices.find(function(v) {
        if (!v.lang.startsWith(langPrefix)) return false;
        var nameLower = v.name.toLowerCase();
        if (appState.luna.voiceGender === 'female') {
          return nameLower.includes('female') || nameLower.includes('mujer') || nameLower.includes('woman');
        } else {
          return nameLower.includes('male') || nameLower.includes('hombre') || nameLower.includes('man');
        }
      });
      // Fallback to any voice with matching language if gender-specific not found
      var fallbackVoice = voices.find(function(v) { return v.lang.startsWith(langPrefix); });
      utterance.voice = preferredVoice || fallbackVoice || null;
      
      window.speechSynthesis.speak(utterance);
    }

    function startListening() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Tu navegador no soporta reconocimiento de voz', 'warning');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-DO';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      appState.luna.isListening = true;
      updateLunaUI();

      recognition.onresult = function(event) {
        if (!event.results || !event.results[0] || !event.results[0][0]) {
          showToast('No se pudo reconocer el audio', 'warning');
          return;
        }
        var transcript = event.results[0][0].transcript;
        if (transcript) {
          processVoiceCommand(transcript.toLowerCase());
        }
      };

      recognition.onerror = function(event) {
        appState.luna.isListening = false;
        updateLunaUI();
        showToast('Error de reconocimiento de voz: ' + event.error, 'error');
      };

      recognition.onend = function() {
        appState.luna.isListening = false;
        updateLunaUI();
      };

      recognition.start();
    }

    function processVoiceCommand(command) {
      const response = { text: '', action: null };
      
      // Navigation commands
      if (command.includes('inicio') || command.includes('home')) {
        response.text = 'Te llevo al inicio';
        response.action = () => navigate('home');
      } else if (command.includes('jugar') || command.includes('nueva jugada')) {
        response.text = 'Vamos a crear una nueva jugada. Â¿QuÃ© loterÃ­a prefieres?';
        response.action = () => { navigate('play'); appState.luna.mode = 'select_lottery'; };
      } else if (command.includes('banca') || command.includes('sucursal')) {
        response.text = 'Te muestro las bancas disponibles';
        response.action = () => navigate('bancas');
      } else if (command.includes('resultado')) {
        response.text = 'AquÃ­ estÃ¡n los resultados mÃ¡s recientes';
        response.action = () => navigate('results');
      } else if (command.includes('cartera') || command.includes('balance')) {
        response.text = 'Tu balance actual es ' + formatMoney(appState.user.balance);
        response.action = () => navigate('wallet');
      } else if (command.includes('perfil') || command.includes('cuenta')) {
        response.text = 'Te llevo a tu perfil';
        response.action = () => navigate('profile');
      } else if (command.includes('ayuda')) {
        response.text = 'Puedo ayudarte a jugar, ver resultados, consultar tu balance o navegar por la app. Â¿QuÃ© deseas hacer?';
      }
      // Lottery selection in guided mode
      else if (appState.luna.mode === 'select_lottery') {
        const lotteryMatch = LOTTERIES.find(l => command.includes(l.name.toLowerCase()));
        if (lotteryMatch) {
          appState.luna.guidedPlayData.lottery = lotteryMatch;
          selectLottery(lotteryMatch.id);
          response.text = 'Perfecto, ' + lotteryMatch.name + '. Â¿QuÃ© modalidad prefieres? Quiniela, PalÃ© o Tripleta?';
          appState.luna.mode = 'select_modality';
        } else {
          response.text = 'No reconocÃ­ esa loterÃ­a. Di el nombre: Leidsa, Loteka, La Primera, Nacional, Real, o La Suerte.';
        }
      }
      // Modality selection
      else if (appState.luna.mode === 'select_modality') {
        let modality = null;
        if (command.includes('quiniela')) modality = 'Quiniela';
        else if (command.includes('palÃ©') || command.includes('pale')) modality = 'PalÃ©';
        else if (command.includes('tripleta')) modality = 'Tripleta';
        
        if (modality) {
          appState.luna.guidedPlayData.modality = modality;
          selectModality(modality);
          const numCount = MODALITIES[modality].numbers;
          response.text = 'Excelente, ' + modality + '. Ahora dime ' + numCount + ' nÃºmero' + (numCount > 1 ? 's' : '') + ' del 0 al 99.';
          appState.luna.mode = 'select_numbers';
        } else {
          response.text = 'Di: Quiniela para 1 nÃºmero, PalÃ© para 2, o Tripleta para 3 nÃºmeros.';
        }
      }
      // Number selection
      else if (appState.luna.mode === 'select_numbers') {
        const numbers = command.match(/\d+/g);
        if (numbers && numbers.length > 0) {
          numbers.forEach(n => {
            const num = pad(parseInt(n) % 100);
            if (appState.selectedNumbers.length < appState.maxNumbers && !appState.selectedNumbers.includes(num)) {
              toggleNumber(num);
            }
          });
          
          if (appState.selectedNumbers.length >= appState.maxNumbers) {
            response.text = 'NÃºmeros seleccionados: ' + appState.selectedNumbers.join(', ') + '. Â¿Confirmo la jugada?';
            appState.luna.mode = 'confirm';
          } else {
            response.text = 'Tienes ' + appState.selectedNumbers.join(', ') + '. Necesitas ' + (appState.maxNumbers - appState.selectedNumbers.length) + ' mÃ¡s.';
          }
        } else {
          response.text = 'No entendÃ­ los nÃºmeros. Di los nÃºmeros del 0 al 99 que deseas jugar.';
        }
      }
      // Confirmation
      else if (appState.luna.mode === 'confirm') {
        if (command.includes('sÃ­') || command.includes('si') || command.includes('confirma') || command.includes('confirmo')) {
          response.text = 'Jugada confirmada. Â¡Buena suerte!';
          response.action = () => { confirmPlay(); appState.luna.mode = 'idle'; };
        } else if (command.includes('no') || command.includes('cancelar')) {
          response.text = 'Jugada cancelada. Â¿Deseas empezar de nuevo?';
          appState.luna.mode = 'idle';
        }
      }
      else {
        response.text = 'No entendÃ­ tu solicitud. Di "ayuda" para ver las opciones disponibles.';
      }

      // Execute response
      updateLunaResponse(response.text);
      speakText(response.text);
      if (response.action) response.action();
    }

    function updateLunaUI() {
      const micBtn = document.getElementById('luna-mic-btn');
      if (micBtn) {
        if (appState.luna.isListening) {
          micBtn.classList.add('animate-pulse', 'bg-red-500');
          micBtn.classList.remove('bg-gradient-to-r', 'from-gray-800', 'to-gray-900');
        } else {
          micBtn.classList.remove('animate-pulse', 'bg-red-500');
          micBtn.classList.add('bg-gradient-to-r', 'from-gray-800', 'to-gray-900');
        }
      }
    }

    function updateLunaResponse(text) {
      const responseEl = document.getElementById('luna-response');
      if (responseEl) {
        responseEl.textContent = text;
      }
    }

    function toggleLunaPanel() {
      const panel = document.getElementById('luna-panel');
      if (panel) {
        panel.classList.toggle('hidden');
      }
    }

    // ===== REAL-TIME LOTTERY RESULTS =====
    // Allowed proxy domains for security
    var ALLOWED_PROXY_DOMAINS = ['api.allorigins.win', 'corsproxy.io', 'api.codetabs.com'];
    
    function isValidProxyUrl(proxyUrl) {
      try {
        var url = new URL(proxyUrl);
        return ALLOWED_PROXY_DOMAINS.some(function(domain) {
          return url.hostname === domain || url.hostname.endsWith('.' + domain);
        });
      } catch (e) {
        return false;
      }
    }

    async function fetchRealLotteryResults(lotteryType) {
      var endpoint = LOTTERY_API_CONFIG.ENDPOINTS[lotteryType] || LOTTERY_API_CONFIG.ENDPOINTS.LOTEKA;
      var url = LOTTERY_API_CONFIG.BASE_URL + endpoint;
      
      for (var i = 0; i < LOTTERY_API_CONFIG.CORS_PROXIES.length; i++) {
        var proxy = LOTTERY_API_CONFIG.CORS_PROXIES[i];
        
        // Validate proxy URL before use
        if (!isValidProxyUrl(proxy)) {
          console.warn('Skipping invalid proxy URL:', proxy);
          continue;
        }
        
        try {
          var response = await fetch(proxy + encodeURIComponent(url), {
            method: 'GET',
            headers: { 'Accept': 'text/html', 'Cache-Control': 'no-cache' }
          });
          
          if (!response.ok) continue;
          
          var html = await response.text();
          var results = parseLotteryHTML(html);
          if (results && results.numbers && results.numbers.length > 0) {
            return results;
          }
        } catch (error) {
          console.warn('CORS proxy failed:', proxy, error);
          continue;
        }
      }
      return null;
    }

    function parseLotteryHTML(html) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        const patterns = ['.resultado', '.winning-numbers', '.numeros-ganadores', '.numero', '.ball'];
        
        for (const pattern of patterns) {
          const elements = doc.querySelectorAll(pattern);
          if (elements.length > 0) {
            const numbers = [];
            elements.forEach(el => {
              const num = el.textContent?.trim();
              if (num && /^\d{1,2}$/.test(num)) {
                numbers.push(pad(parseInt(num)));
              }
            });
            
            if (numbers.length >= 3) {
              return {
                numbers: numbers.slice(0, 3),
                time: new Date().toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' }),
                isLive: true
              };
            }
          }
        }
        
        return null;
      } catch (error) {
        console.error('Error parsing lottery HTML:', error);
        return null;
      }
    }

    // ===== WELCOME SCREEN =====
    function showWelcomeScreen() {
      if (!appState.showWelcome) return;
      
      const welcomeEl = document.getElementById('welcome-screen');
      if (welcomeEl) {
        welcomeEl.classList.remove('hidden');
      }
    }

    function completeWelcome() {
      localStorage.setItem('ll_welcome_completed', 'true');
      appState.showWelcome = false;
      const welcomeEl = document.getElementById('welcome-screen');
      if (welcomeEl) {
        welcomeEl.classList.add('hidden');
      }
    }

    // ===== DARK MODE =====
    function toggleDarkMode() {
      appState.darkMode = !appState.darkMode;
      document.documentElement.classList.toggle('dark', appState.darkMode);
      const toggle = document.getElementById('dark-mode-toggle');
      toggle.classList.toggle('on', appState.darkMode);
      localStorage.setItem('darkMode', appState.darkMode);
      
      if (window.electronAPI) {
        window.electronAPI.setSetting('theme', appState.darkMode ? 'dark' : 'light');
      }
    }

    function loadDarkMode() {
      const saved = localStorage.getItem('darkMode');
      if (saved === 'true') {
        appState.darkMode = true;
        document.documentElement.classList.add('dark');
        document.getElementById('dark-mode-toggle').classList.add('on');
      }
    }

    // ===== NAVIGATION =====
    function navigate(view) {
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      const viewEl = document.getElementById('view-' + view);
      if (viewEl) {
        viewEl.classList.remove('hidden');
        viewEl.classList.add('animate-fade-in');
      }
      
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(item => {
        if (item.getAttribute('onclick')?.includes(view)) {
          item.classList.add('active');
        }
      });
      
      if (view === 'bancas') setTimeout(initBancasMap, 100);
      if (view === 'results') initResultsCharts();
      if (view === 'wallet') initBalanceChart();
      if (view === 'profile') initProfileChart();
    }

    // ===== TOAST NOTIFICATIONS =====
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const icons = {
        success: 'fa-check',
        error: 'fa-times',
        warning: 'fa-exclamation',
        info: 'fa-info'
      };
      
      toast.className = 'toast ' + type;
      toast.innerHTML = 
        '<div class="toast-icon"><i class="fas ' + icons[type] + '"></i></div>' +
        '<div class="flex-1">' +
          '<p class="font-semibold text-sm text-gray-900 dark:text-white">' + message + '</p>' +
        '</div>' +
        '<button onclick="dismissToast(this.parentElement)" class="text-gray-400 hover:text-gray-600 p-1">' +
          '<i class="fas fa-times text-xs"></i>' +
        '</button>' +
        '<div class="toast-progress"></div>';
      
      container.appendChild(toast);
      
      if (appState.sounds) playNotificationSound();
      
      if (window.electronAPI && appState.notifications) {
        window.electronAPI.showNotification('LotoLink', message);
      }
      
      setTimeout(function() {
        toast.classList.add('dismissing');
        setTimeout(function() { toast.remove(); }, 300);
      }, 4000);
    }

    function dismissToast(toast) {
      toast.classList.add('dismissing');
      setTimeout(function() { toast.remove(); }, 300);
    }

    function playNotificationSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 800;
        g.gain.setValueAtTime(0.3, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.3);
      } catch (e) {}
    }

    // ===== RENDER FUNCTIONS =====
    function renderUpcomingDraws() {
      const container = document.getElementById('upcoming-draws');
      if (!container) return;
      
      container.innerHTML = LOTTERIES.slice(0, 3).map(function(lottery, index) {
        return '<div class="premium-card p-5 animate-slide-up delay-' + (index + 1) + '00">' +
          '<div class="flex items-center gap-4 mb-4">' +
            '<div class="w-14 h-14 rounded-2xl flex items-center justify-center text-white font-bold text-lg shadow-lg" style="background: linear-gradient(135deg, ' + lottery.color + ' 0%, ' + lottery.color + 'cc 100%)">' +
              lottery.logo +
            '</div>' +
            '<div class="flex-1">' +
              '<h4 class="font-bold text-gray-900 dark:text-white text-lg">' + lottery.name + '</h4>' +
              '<p class="text-xs text-gray-500 flex items-center gap-1"><i class="fas fa-clock"></i> ' + lottery.schedule + '</p>' +
            '</div>' +
          '</div>' +
          '<div class="countdown mb-4" id="countdown-' + lottery.id + '">' +
            '<div class="unit"><span class="value">--</span><span class="label">Hrs</span></div>' +
            '<span class="separator">:</span>' +
            '<div class="unit"><span class="value">--</span><span class="label">Min</span></div>' +
            '<span class="separator">:</span>' +
            '<div class="unit"><span class="value">--</span><span class="label">Seg</span></div>' +
          '</div>' +
          '<button onclick="navigate(\'play\'); selectLottery(\'' + lottery.id + '\')" class="w-full btn-premium text-sm py-3 titlebar-no-drag">' +
            '<i class="fas fa-play mr-2"></i>Jugar Ahora' +
          '</button>' +
        '</div>';
      }).join('');
      
      startCountdowns();
    }

    function startCountdowns() {
      setInterval(function() {
        LOTTERIES.forEach(function(lottery) {
          const container = document.getElementById('countdown-' + lottery.id);
          if (!container) return;
          
          const now = new Date();
          const hours = 23 - now.getHours();
          const minutes = 59 - now.getMinutes();
          const seconds = 59 - now.getSeconds();
          
          container.innerHTML = 
            '<div class="unit"><span class="value">' + pad(hours) + '</span><span class="label">Hrs</span></div>' +
            '<span class="separator">:</span>' +
            '<div class="unit"><span class="value">' + pad(minutes) + '</span><span class="label">Min</span></div>' +
            '<span class="separator">:</span>' +
            '<div class="unit"><span class="value">' + pad(seconds) + '</span><span class="label">Seg</span></div>';
        });
      }, 1000);
    }

    function renderLiveResults() {
      const container = document.getElementById('live-results');
      if (!container) return;
      
      container.innerHTML = MOCK_RESULTS.slice(0, 4).map(function(result, index) {
        return '<div class="premium-card p-6 animate-slide-up delay-' + (index + 1) + '00">' +
          '<div class="flex items-center justify-between mb-4">' +
            '<div class="flex items-center gap-2">' +
              '<span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>' +
              '<span class="px-3 py-1.5 text-white text-sm font-bold rounded-full shadow" style="background: ' + result.color + '">' + result.lottery + '</span>' +
            '</div>' +
            '<span class="text-gray-500 text-sm">' + result.time + ' â€¢ ' + result.date + '</span>' +
          '</div>' +
          '<div class="flex justify-center gap-4">' +
            result.numbers.map(function(num) { 
              return '<div class="lottery-ball ' + result.ballClass + ' animate-ball-bounce">' + num + '</div>'; 
            }).join('') +
          '</div>' +
        '</div>';
      }).join('');
    }

    function renderRecentPlays() {
      const container = document.getElementById('recent-plays');
      if (!container) return;
      
      // Get persisted tickets, fallback to mock data if empty
      var tickets = getTickets();
      var plays = [];
      
      if (tickets.length > 0) {
        plays = tickets.slice(0, 5).map(function(ticket) {
          var timeAgo = '';
          try {
            var ticketDate = new Date(ticket.createdAt);
            var now = new Date();
            var diffMs = now - ticketDate;
            var diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            var diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffHours < 1) {
              timeAgo = 'Hace unos minutos';
            } else if (diffHours < 24) {
              timeAgo = 'Hace ' + diffHours + ' hora' + (diffHours > 1 ? 's' : '');
            } else if (diffDays === 1) {
              timeAgo = 'Ayer';
            } else {
              timeAgo = 'Hace ' + diffDays + ' dÃ­as';
            }
          } catch (e) {
            timeAgo = 'Reciente';
          }
          
          return {
            lottery: ticket.lotteryName || 'LoterÃ­a',
            numbers: ticket.numbers || [],
            stake: ticket.stake || 0,
            time: timeAgo,
            status: ticket.status || 'pending',
            prize: ticket.prize || 0
          };
        });
      } else {
        // Fallback mock data
        plays = [
          { lottery: 'Nacional', numbers: ['23', '45'], stake: 50, time: 'Hace 2 horas', status: 'pending' },
          { lottery: 'Leidsa', numbers: ['12', '34', '56'], stake: 100, time: 'Ayer', status: 'won', prize: 500 },
          { lottery: 'Loteka', numbers: ['08', '66'], stake: 25, time: 'Hace 2 dÃ­as', status: 'lost' }
        ];
      }
      
      container.innerHTML = plays.map(function(play) {
        const statusColor = play.status === 'won' ? 'text-green-600 bg-green-50 dark:bg-green-900/30 dark:text-green-400' : 
                           play.status === 'lost' ? 'text-gray-500 bg-gray-50 dark:bg-gray-800 dark:text-gray-400' : 
                           'text-yellow-600 bg-yellow-50 dark:bg-yellow-900/30 dark:text-yellow-400';
        const statusText = play.status === 'won' ? 'Ganado' : play.status === 'lost' ? 'Perdido' : 'Pendiente';
        const statusIcon = play.status === 'won' ? 'fa-trophy' : play.status === 'lost' ? 'fa-times-circle' : 'fa-clock';
        
        return '<div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition">' +
          '<div class="flex items-center gap-4">' +
            '<div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shadow">' +
              '<i class="fas fa-ticket-alt"></i>' +
            '</div>' +
            '<div>' +
              '<p class="font-semibold text-gray-900 dark:text-white">' + play.lottery + ' - ' + play.numbers.join(', ') + '</p>' +
              '<p class="text-sm text-gray-500">' + formatMoney(play.stake) + ' â€¢ ' + play.time + '</p>' +
            '</div>' +
          '</div>' +
          '<div class="text-right">' +
            '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ' + statusColor + '">' +
              '<i class="fas ' + statusIcon + ' text-xs"></i> ' + statusText +
            '</span>' +
            (play.prize ? '<p class="text-green-600 font-bold mt-1">+' + formatMoney(play.prize) + '</p>' : '') +
          '</div>' +
        '</div>';
      }).join('') || '<p class="text-center text-gray-500 py-8">No hay jugadas recientes</p>';
    }

    function renderLotterySelection() {
      const container = document.getElementById('lottery-selection');
      if (!container) return;
      
      container.innerHTML = LOTTERIES.map(function(lottery) {
        return '<button onclick="selectLottery(\'' + lottery.id + '\')" id="lot-' + lottery.id + '" class="lottery-btn premium-card p-4 text-center border-2 border-transparent hover:border-blue-400 transition group titlebar-no-drag">' +
          '<div class="w-14 h-14 mx-auto rounded-2xl flex items-center justify-center text-white font-bold text-lg mb-3 shadow-lg group-hover:scale-110 transition-transform" style="background: linear-gradient(135deg, ' + lottery.color + ' 0%, ' + lottery.color + 'cc 100%)">' +
            lottery.logo +
          '</div>' +
          '<span class="text-sm font-semibold text-gray-900 dark:text-white block">' + lottery.name + '</span>' +
          '<p class="text-xs text-gray-500 mt-1 flex items-center justify-center gap-1"><i class="fas fa-clock"></i> ' + lottery.schedule + '</p>' +
        '</button>';
      }).join('');
    }

    function renderModalitySelection() {
      const container = document.getElementById('modality-selection');
      if (!container) return;
      
      const lottery = LOTTERIES.find(function(l) { return l.id === appState.selectedLottery; });
      if (!lottery) {
        container.innerHTML = '<p class="text-gray-400 text-sm col-span-2 text-center py-4"><i class="fas fa-arrow-up mr-2"></i>Selecciona una loterÃ­a primero</p>';
        return;
      }
      
      container.innerHTML = lottery.modalities.map(function(mod) {
        const info = MODALITIES[mod] || { numbers: 1, description: '', icon: 'fa-circle', prizes: [] };
        const topPrize = info.prizes && info.prizes[0] ? info.prizes[0].multiplier : info.multiplier + 'x';
        return '<button onclick="selectModality(\'' + mod + '\')" class="modality-btn flex flex-col p-4 rounded-xl border-2 border-gray-200 dark:border-gray-700 hover:border-blue-400 transition group titlebar-no-drag">' +
          '<div class="flex items-center gap-4 w-full">' +
            '<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white shadow group-hover:scale-110 transition-transform">' +
              '<i class="fas ' + info.icon + '"></i>' +
            '</div>' +
            '<div class="text-left flex-1">' +
              '<span class="font-semibold block text-gray-900 dark:text-white">' + mod + '</span>' +
              '<span class="text-sm text-gray-500">' + info.description + '</span>' +
            '</div>' +
            '<div class="text-right">' +
              '<span class="text-xs text-gray-400">Hasta</span>' +
              '<p class="text-lg font-bold text-green-600">' + topPrize + '</p>' +
            '</div>' +
          '</div>' +
          (info.prizes && info.prizes.length > 0 ? 
            '<div class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-700 w-full text-left">' +
              '<p class="text-xs text-gray-400 mb-2">ðŸ’° Tabla de premios:</p>' +
              info.prizes.slice(0, 2).map(function(p) {
                return '<div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-1">' +
                  '<span>' + p.position + '</span>' +
                  '<span class="font-bold text-green-600">' + p.multiplier + '</span>' +
                '</div>';
              }).join('') +
            '</div>' : '') +
        '</button>';
      }).join('');
    }

    function renderStakeSelection() {
      const container = document.getElementById('stake-selection');
      if (!container) return;
      
      const stakes = [10, 25, 50, 100, 200, 500];
      container.innerHTML = stakes.map(function(stake) {
        const isSelected = stake === appState.selectedStake;
        return '<button onclick="selectStake(' + stake + ')" class="stake-btn px-6 py-3 rounded-xl font-semibold transition titlebar-no-drag ' + 
          (isSelected ? 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg scale-105' : 'bg-gray-100 dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-gray-700 border-2 border-transparent hover:border-blue-400') + '">' +
          'RD$ ' + stake +
        '</button>';
      }).join('');
    }

    function generateNumberGrid() {
      const grid = document.getElementById('number-grid');
      if (!grid) return;
      
      grid.innerHTML = '';
      for (var i = 0; i <= 99; i++) {
        var num = pad(i);
        var btn = document.createElement('button');
        btn.id = 'num-' + num;
        btn.className = 'num-btn w-10 h-10 text-sm font-semibold titlebar-no-drag';
        btn.textContent = num;
        btn.onclick = (function(n) { return function() { toggleNumber(n); }; })(num);
        grid.appendChild(btn);
      }
    }

    function renderBancasList() {
      const container = document.getElementById('bancas-list');
      if (!container) return;
      
      container.innerHTML = BANCAS.map(function(banca) {
        const statusClass = banca.status === 'open' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400';
        const statusText = banca.status === 'open' ? 'Abierta' : 'Cerrada';
        
        return '<div class="premium-card p-6">' +
          '<div class="flex justify-between items-start mb-4">' +
            '<div class="flex items-start gap-3">' +
              '<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white text-xl shadow">' +
                '<i class="fas fa-store"></i>' +
              '</div>' +
              '<div>' +
                '<h3 class="font-bold text-gray-900 dark:text-white">' + banca.name + '</h3>' +
                '<p class="text-sm text-gray-500">' + banca.address + '</p>' +
              '</div>' +
            '</div>' +
            '<span class="px-3 py-1 ' + statusClass + ' text-xs font-semibold rounded-full">' +
              '<i class="fas fa-circle text-[6px] mr-1"></i>' + statusText +
            '</span>' +
          '</div>' +
          '<div class="flex items-center gap-4 text-sm text-gray-500 mb-4">' +
            '<span class="flex items-center gap-1"><i class="fas fa-map-marker-alt text-red-500"></i> ' + banca.distance + ' km</span>' +
            '<span class="flex items-center gap-1"><i class="fas fa-star text-yellow-500"></i> ' + banca.rating + '</span>' +
            '<span class="flex items-center gap-1"><i class="fas fa-ticket-alt text-blue-500"></i> ' + banca.lotteries.length + ' loterÃ­as</span>' +
          '</div>' +
          '<div class="flex gap-1 flex-wrap mb-4">' +
            banca.lotteries.slice(0, 3).map(function(l) {
              const colors = { 'Nacional': '#ef4444', 'Leidsa': '#22c55e', 'Real': '#eab308', 'Loteka': '#a855f7', 'La Primera': '#3b82f6' };
              return '<span class="px-2 py-1 text-xs rounded-full font-medium" style="background: ' + (colors[l] || '#6b7280') + '22; color: ' + (colors[l] || '#6b7280') + '">' + l + '</span>';
            }).join('') +
            (banca.lotteries.length > 3 ? '<span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs rounded-full">+' + (banca.lotteries.length - 3) + '</span>' : '') +
          '</div>' +
          '<button onclick="playAtBanca(' + banca.id + ')" ' + (banca.status !== 'open' ? 'disabled' : '') + ' class="' + (banca.status === 'open' ? 'btn-premium' : 'bg-gray-200 dark:bg-gray-800 text-gray-500 cursor-not-allowed') + ' w-full py-3 text-sm titlebar-no-drag">' +
            (banca.status === 'open' ? '<i class="fas fa-play mr-2"></i>Jugar AquÃ­' : '<i class="fas fa-times-circle mr-2"></i>No disponible') +
          '</button>' +
        '</div>';
      }).join('');
    }

    function renderLoteriasGrid() {
      const container = document.getElementById('loterias-grid');
      if (!container) return;
      
      container.innerHTML = LOTTERIES.map(function(lottery) {
        return '<div class="premium-card overflow-hidden group">' +
          '<div class="h-2" style="background: linear-gradient(90deg, ' + lottery.color + ', ' + lottery.color + 'aa)"></div>' +
          '<div class="p-6">' +
            '<div class="flex items-center gap-4 mb-4">' +
              '<div class="w-14 h-14 rounded-2xl flex items-center justify-center text-white text-xl font-bold shadow-lg group-hover:scale-110 transition-transform" style="background: linear-gradient(135deg, ' + lottery.color + ' 0%, ' + lottery.color + 'cc 100%)">' +
                lottery.logo +
              '</div>' +
              '<div>' +
                '<h3 class="font-bold text-lg text-gray-900 dark:text-white">' + lottery.name + '</h3>' +
                '<p class="text-sm text-gray-500 flex items-center gap-1"><i class="fas fa-clock"></i> ' + lottery.schedule + '</p>' +
              '</div>' +
            '</div>' +
            '<div class="flex gap-2 flex-wrap mb-4">' +
              lottery.modalities.map(function(m) {
                return '<span class="px-2 py-1 text-xs rounded-full font-medium" style="background: ' + lottery.color + '22; color: ' + lottery.color + '">' + m + '</span>';
              }).join('') +
            '</div>' +
            '<button onclick="navigate(\'play\'); selectLottery(\'' + lottery.id + '\')" class="w-full py-3 text-white font-semibold rounded-xl transition hover:opacity-90 titlebar-no-drag" style="background: linear-gradient(135deg, ' + lottery.color + ' 0%, ' + lottery.color + 'cc 100%)">' +
              '<i class="fas fa-play mr-2"></i>Jugar ' + lottery.name +
            '</button>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function renderTransactions() {
      const container = document.getElementById('transactions-list');
      if (!container) return;
      
      // Get persisted transactions, fallback to mock data if empty
      var transactions = getTransactions();
      if (transactions.length === 0) {
        // Use mock data for initial display
        transactions = TRANSACTIONS.map(function(tx) {
          return {
            id: uid('TXN'),
            type: tx.type === 'recharge' ? 'deposit' : tx.type,
            amount: tx.amount,
            method: tx.method,
            status: tx.status || 'completed',
            details: tx.method,
            createdAt: new Date().toISOString()
          };
        });
      }
      
      const iconMap = { deposit: 'fa-plus-circle', play: 'fa-dice', win: 'fa-trophy', withdrawal: 'fa-money-bill-wave' };
      const colorMap = { deposit: '#22c55e', play: '#3b82f6', win: '#eab308', withdrawal: '#f97316' };
      const typeNames = { deposit: 'Recarga', play: 'Jugada', win: 'Premio', withdrawal: 'Retiro' };
      
      container.innerHTML = transactions.slice(0, 20).map(function(tx) {
        const bgColor = colorMap[tx.type] || '#6b7280';
        const icon = iconMap[tx.type] || 'fa-circle';
        var dateStr = '';
        try {
          var txDate = new Date(tx.createdAt);
          var today = new Date();
          var yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          
          if (txDate.toDateString() === today.toDateString()) {
            dateStr = 'Hoy ' + txDate.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
          } else if (txDate.toDateString() === yesterday.toDateString()) {
            dateStr = 'Ayer ' + txDate.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
          } else {
            dateStr = txDate.toLocaleDateString('es-DO', { day: 'numeric', month: 'short' });
          }
        } catch (e) {
          dateStr = tx.createdAt;
        }
        
        return '<div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition">' +
          '<div class="flex items-center gap-4">' +
            '<div class="w-12 h-12 rounded-xl flex items-center justify-center text-lg shadow" style="background: ' + bgColor + '22; color: ' + bgColor + '">' +
              '<i class="fas ' + icon + '"></i>' +
            '</div>' +
            '<div>' +
              '<p class="font-semibold text-gray-900 dark:text-white">' + (typeNames[tx.type] || tx.type) + '</p>' +
              '<p class="text-sm text-gray-500">' + (tx.details || tx.method) + ' â€¢ ' + dateStr + (tx.status === 'pending' ? ' â€¢ <span class="text-yellow-600"><i class="fas fa-clock"></i> Pendiente</span>' : '') + '</p>' +
            '</div>' +
          '</div>' +
          '<span class="' + (tx.amount > 0 ? 'text-green-600' : 'text-gray-600 dark:text-gray-400') + ' font-bold text-lg">' + (tx.amount > 0 ? '+' : '') + formatMoney(tx.amount) + '</span>' +
        '</div>';
      }).join('') || '<p class="text-center text-gray-500 py-8">No hay transacciones aÃºn</p>';
    }

    function renderResultsHistory() {
      const container = document.getElementById('results-history');
      if (!container) return;
      
      container.innerHTML = MOCK_RESULTS.map(function(result) {
        return '<tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition">' +
          '<td class="px-6 py-4"><span class="px-3 py-1.5 text-white text-xs font-bold rounded-full shadow" style="background: ' + result.color + '">' + result.lottery + '</span></td>' +
          '<td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">' + result.date + '</td>' +
          '<td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">' + result.time + '</td>' +
          '<td class="px-6 py-4 text-center">' +
            '<div class="flex justify-center gap-2">' +
              result.numbers.map(function(num) {
                return '<div class="lottery-ball ' + result.ballClass + '" style="width: 40px; height: 40px; font-size: 14px;">' + num + '</div>';
              }).join('') +
            '</div>' +
          '</td>' +
        '</tr>';
      }).join('');
    }

    function renderBadges() {
      const container = document.getElementById('badges-grid');
      if (!container) return;
      
      const gradients = {
        blue: 'from-blue-500 to-indigo-600',
        yellow: 'from-yellow-400 to-orange-500',
        orange: 'from-orange-500 to-red-600',
        purple: 'from-purple-500 to-pink-600',
        pink: 'from-pink-500 to-rose-600',
        gold: 'from-yellow-400 to-amber-600'
      };
      
      container.innerHTML = BADGES.map(function(badge) {
        return '<div class="premium-card p-5 text-center ' + (badge.earned ? '' : 'opacity-50 grayscale') + '">' +
          '<div class="w-16 h-16 mx-auto mb-3 rounded-2xl bg-gradient-to-br ' + gradients[badge.color] + ' flex items-center justify-center text-white text-2xl shadow-lg">' +
            '<i class="fas ' + badge.icon + '"></i>' +
          '</div>' +
          '<p class="text-sm font-semibold text-gray-900 dark:text-white">' + badge.name + '</p>' +
          '<p class="text-xs text-gray-500 mt-1">' + (badge.earned ? '<i class="fas fa-check-circle text-green-500"></i> Obtenido' : '<i class="fas fa-lock text-gray-400"></i> Bloqueado') + '</p>' +
        '</div>';
      }).join('');
    }

    function renderTicketsHistory() {
      const container = document.getElementById('tickets-history');
      if (!container) return;
      
      // Get persisted tickets, fallback to mock data if empty
      var tickets = getTickets();
      if (tickets.length === 0) {
        // Use mock data for initial display
        tickets = [
          { lotteryName: 'Nacional', numbers: ['23', '45'], stake: 50, status: 'won', prize: 500 },
          { lotteryName: 'Leidsa', numbers: ['12', '34', '56'], stake: 100, status: 'lost', prize: 0 },
          { lotteryName: 'Real', numbers: ['78', '90'], stake: 25, status: 'pending', prize: 0 }
        ];
      }
      
      // Get lottery colors
      var lotteryColors = {};
      LOTTERIES.forEach(function(l) { lotteryColors[l.name] = l.color; });
      
      container.innerHTML = tickets.slice(0, 20).map(function(ticket) {
        var lottery = ticket.lotteryName || ticket.lottery || 'LoterÃ­a';
        var color = lotteryColors[lottery] || '#6b7280';
        var statusClass = ticket.status === 'won' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 
                          ticket.status === 'lost' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 
                          'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400';
        var statusText = ticket.status === 'won' ? 'Ganado' : ticket.status === 'lost' ? 'Perdido' : 'Pendiente';
        
        return '<tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition">' +
          '<td class="px-6 py-4 font-semibold text-gray-900 dark:text-white">' + lottery + '</td>' +
          '<td class="px-6 py-4">' +
            '<div class="flex gap-2">' +
              (ticket.numbers || []).map(function(num) {
                return '<span class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold shadow" style="background: ' + color + '">' + num + '</span>';
              }).join('') +
            '</div>' +
          '</td>' +
          '<td class="px-6 py-4 font-medium text-gray-900 dark:text-white">' + formatMoney(ticket.stake || 0) + '</td>' +
          '<td class="px-6 py-4"><span class="px-3 py-1 ' + statusClass + ' text-xs font-semibold rounded-full">' + statusText + '</span></td>' +
          '<td class="px-6 py-4 ' + (ticket.prize > 0 ? 'text-green-600 font-bold' : 'text-gray-400') + '">' + (ticket.prize > 0 ? '+' + formatMoney(ticket.prize) : '-') + '</td>' +
        '</tr>';
      }).join('') || '<tr><td colspan="5" class="text-center text-gray-500 py-8">No hay tickets aÃºn</td></tr>';
    }

    // ===== PLAY LOGIC =====
    function selectLottery(lotteryId) {
      appState.selectedLottery = lotteryId;
      
      document.querySelectorAll('.lottery-btn').forEach(function(btn) {
        btn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        btn.classList.add('border-transparent');
      });
      
      const btn = document.getElementById('lot-' + lotteryId);
      if (btn) {
        btn.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        btn.classList.remove('border-transparent');
      }
      
      appState.selectedModality = null;
      appState.selectedNumbers = [];
      appState.currentStep = 2;
      updateStepIndicator();
      
      renderModalitySelection();
      updateSelectedNumbers();
      updateSummary();
    }

    function selectModality(modality) {
      appState.selectedModality = modality;
      const info = MODALITIES[modality];
      appState.maxNumbers = info.numbers;
      appState.multiplier = info.multiplier;
      
      while (appState.selectedNumbers.length > appState.maxNumbers) {
        var num = appState.selectedNumbers.pop();
        var btn = document.getElementById('num-' + num);
        if (btn) btn.classList.remove('selected');
      }
      
      document.querySelectorAll('.modality-btn').forEach(function(btn) {
        btn.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        btn.classList.add('border-gray-200', 'dark:border-gray-700');
      });
      if (event.target.closest('.modality-btn')) {
        event.target.closest('.modality-btn').classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        event.target.closest('.modality-btn').classList.remove('border-gray-200', 'dark:border-gray-700');
      }
      
      document.getElementById('required-numbers').textContent = appState.maxNumbers;
      appState.currentStep = 3;
      updateStepIndicator();
      
      updateSelectedNumbers();
      updateSummary();
    }

    function toggleNumber(num) {
      var btn = document.getElementById('num-' + num);
      if (!btn) return;
      
      var idx = appState.selectedNumbers.indexOf(num);
      if (idx > -1) {
        appState.selectedNumbers.splice(idx, 1);
        btn.classList.remove('selected');
      } else if (appState.selectedNumbers.length < appState.maxNumbers) {
        appState.selectedNumbers.push(num);
        btn.classList.add('selected');
        
        if (appState.selectedNumbers.length === appState.maxNumbers) {
          appState.currentStep = 4;
          updateStepIndicator();
        }
      }
      
      updateSelectedNumbers();
      updateSummary();
    }

    function randomNumbers() {
      appState.selectedNumbers.forEach(function(num) {
        var btn = document.getElementById('num-' + num);
        if (btn) btn.classList.remove('selected');
      });
      appState.selectedNumbers = [];
      
      while (appState.selectedNumbers.length < appState.maxNumbers) {
        var num = pad(Math.floor(Math.random() * 100));
        if (appState.selectedNumbers.indexOf(num) === -1) {
          appState.selectedNumbers.push(num);
          var btn = document.getElementById('num-' + num);
          if (btn) btn.classList.add('selected');
        }
      }
      
      appState.currentStep = 4;
      updateStepIndicator();
      updateSelectedNumbers();
      updateSummary();
    }

    function selectStake(stake) {
      appState.selectedStake = stake;
      document.getElementById('stake-slider').value = stake;
      renderStakeSelection();
      updateSummary();
    }

    function updateStakeFromSlider(value) {
      appState.selectedStake = Number(value);
      renderStakeSelection();
      updateSummary();
    }

    function updateSelectedNumbers() {
      var container = document.getElementById('selected-numbers');
      if (!container) return;
      
      if (appState.selectedNumbers.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm"><i class="fas fa-hand-pointer mr-2"></i>Selecciona nÃºmeros del grid</span>';
      } else {
        container.innerHTML = appState.selectedNumbers.map(function(num) {
          return '<div class="lottery-ball animate-number-glow">' + num + '</div>';
        }).join('');
      }
    }

    function updateSummary() {
      var lottery = LOTTERIES.find(function(l) { return l.id === appState.selectedLottery; });
      document.getElementById('summary-lottery').textContent = lottery ? lottery.name : '-';
      document.getElementById('summary-modality').textContent = appState.selectedModality || '-';
      document.getElementById('summary-numbers').textContent = appState.selectedNumbers.length > 0 ? appState.selectedNumbers.join(', ') : '-';
      document.getElementById('summary-stake').textContent = formatMoney(appState.selectedStake);
      
      var prize = appState.selectedStake * appState.multiplier;
      document.getElementById('summary-prize').textContent = formatMoney(prize);
    }

    function updateStepIndicator() {
      for (var i = 1; i <= 4; i++) {
        var step = document.getElementById('step-' + i);
        var line = document.getElementById('line-' + i);
        
        if (step) {
          step.classList.remove('active', 'completed');
          if (i < appState.currentStep) {
            step.classList.add('completed');
            step.innerHTML = '<i class="fas fa-check"></i>';
          } else if (i === appState.currentStep) {
            step.classList.add('active');
            step.textContent = i;
          } else {
            step.textContent = i;
          }
        }
        
        if (line) {
          line.classList.remove('active', 'completed');
          if (i < appState.currentStep) {
            line.classList.add('completed');
          } else if (i === appState.currentStep) {
            line.classList.add('active');
          }
        }
      }
      
      var descriptions = [
        'Paso 1: Selecciona una loterÃ­a',
        'Paso 2: Elige la modalidad de juego',
        'Paso 3: Selecciona tus nÃºmeros de la suerte',
        'Paso 4: Define el monto de tu apuesta'
      ];
      document.getElementById('step-description').textContent = descriptions[appState.currentStep - 1];
    }

    function confirmPlay() {
      if (!appState.selectedLottery || !appState.selectedModality) {
        showToast('Selecciona una loterÃ­a y modalidad', 'warning');
        return;
      }
      if (appState.selectedNumbers.length < appState.maxNumbers) {
        showToast('Selecciona ' + appState.maxNumbers + ' nÃºmeros', 'warning');
        return;
      }
      
      var lottery = LOTTERIES.find(function(l) { return l.id === appState.selectedLottery; });
      var playData = {
        lotteryId: appState.selectedLottery,
        lotteryName: lottery.name,
        modality: appState.selectedModality,
        numbers: appState.selectedNumbers.slice(),
        stake: appState.selectedStake,
        potentialPrize: appState.selectedStake * appState.multiplier,
        banca: 'Banca Online'
      };
      
      // Show payment modal
      showPaymentModal(appState.selectedStake, 'play', function(paymentMethod, methodName) {
        // Save the ticket
        var ticket = saveTicket({
          lotteryId: playData.lotteryId,
          lotteryName: playData.lotteryName,
          modality: playData.modality,
          numbers: playData.numbers,
          stake: playData.stake,
          potentialPrize: playData.potentialPrize,
          paymentMethod: paymentMethod,
          banca: playData.banca
        });
        
        // Save the transaction
        saveTransaction({
          type: 'play',
          amount: -playData.stake,
          method: methodName,
          status: 'completed',
          details: playData.lotteryName + ' - ' + playData.modality
        });
        
        // Show ticket modal
        showTicketModal(playData.lotteryName, playData.modality, playData.numbers, playData.stake, paymentMethod);
        
        showToast('Â¡Jugada confirmada! Buena suerte ðŸ€', 'success');
        
        resetPlayState();
      }, playData);
    }

    function addPlayToCart() {
      if (!appState.selectedLottery || !appState.selectedModality) {
        showToast('Selecciona una loterÃ­a y modalidad', 'warning');
        return;
      }
      if (appState.selectedNumbers.length < appState.maxNumbers) {
        showToast('Selecciona ' + appState.maxNumbers + ' nÃºmeros', 'warning');
        return;
      }
      
      var lottery = LOTTERIES.find(function(l) { return l.id === appState.selectedLottery; });
      addToGlobalCart({
        lottery: lottery.name,
        modality: appState.selectedModality,
        numbers: appState.selectedNumbers.slice(),
        stake: appState.selectedStake,
        banca: 'Banca Online'
      });
      
      resetPlayState();
    }

    function resetPlayState() {
      appState.selectedNumbers = [];
      appState.currentStep = 1;
      updateStepIndicator();
      document.querySelectorAll('.num-btn').forEach(function(btn) { btn.classList.remove('selected'); });
      updateSelectedNumbers();
      updateSummary();
    }

    function showTicketModal(lottery, modality, numbers, stake, paymentMethod) {
      var modal = document.getElementById('ticket-modal');
      var content = document.getElementById('ticket-content');
      var ticketId = uid();
      var now = new Date();
      var dateStr = now.toLocaleDateString('es-DO', { year: 'numeric', month: 'long', day: 'numeric' });
      var timeStr = now.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
      var methodNames = {
        wallet: 'Wallet',
        card: 'Tarjeta',
        transfer: 'Transferencia'
      };
      var paymentLabel = paymentMethod ? (methodNames[paymentMethod] || paymentMethod) : 'Wallet';
      
      content.innerHTML = 
        '<div class="watermark">L</div>' +
        '<div class="relative">' +
          '<div class="flex justify-between items-start mb-6">' +
            '<div class="flex items-center gap-3">' +
              '<div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg">' +
                '<i class="fas fa-ticket-alt text-xl"></i>' +
              '</div>' +
              '<div>' +
                '<h3 class="text-xl font-bold text-gray-900">LotoLink</h3>' +
                '<p class="text-sm text-gray-500">Ticket Oficial</p>' +
              '</div>' +
            '</div>' +
            '<button onclick="closeTicketModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition titlebar-no-drag">' +
              '<i class="fas fa-times"></i>' +
            '</button>' +
          '</div>' +
          '<div class="bg-gradient-to-r from-blue-600 to-indigo-600 -mx-8 px-8 py-5 mb-6 text-white">' +
            '<h4 class="font-bold text-lg">' + lottery + ' - ' + modality + '</h4>' +
            '<p class="text-sm opacity-80">' + dateStr + ' â€¢ ' + timeStr + '</p>' +
          '</div>' +
          '<div class="flex justify-center gap-4 mb-6">' +
            numbers.map(function(num) {
              return '<div class="lottery-ball" style="width: 60px; height: 60px; font-size: 22px;">' + num + '</div>';
            }).join('') +
          '</div>' +
          '<div class="space-y-3 text-sm mb-6 bg-gray-50 rounded-xl p-4">' +
            '<div class="flex justify-between"><span class="text-gray-500">ID Ticket</span><span class="font-mono font-bold">' + ticketId + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-500">Apuesta</span><span class="font-bold">' + formatMoney(stake) + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-500">Premio Potencial</span><span class="font-bold text-green-600">' + formatMoney(stake * appState.multiplier) + '</span></div>' +
            '<div class="flex justify-between"><span class="text-gray-500">MÃ©todo de Pago</span><span class="font-medium">' + paymentLabel + '</span></div>' +
          '</div>' +
          '<div class="flex justify-center mb-6">' +
            '<img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + encodeURIComponent('LOTOLINK-' + ticketId) + '" alt="QR" class="rounded-lg shadow-md">' +
          '</div>' +
          '<div class="flex gap-3">' +
            '<button onclick="printTicket()" class="flex-1 btn-secondary py-3 titlebar-no-drag">' +
              '<i class="fas fa-print mr-2"></i>Imprimir' +
            '</button>' +
            '<button onclick="shareTicket()" class="flex-1 btn-premium py-3 titlebar-no-drag">' +
              '<i class="fas fa-share-alt mr-2"></i>Compartir' +
            '</button>' +
          '</div>' +
        '</div>';
      
      modal.classList.remove('hidden');
    }

    function closeTicketModal() {
      document.getElementById('ticket-modal').classList.add('hidden');
    }

    function printTicket() {
      if (window.electronAPI) {
        window.electronAPI.printTicket();
      } else {
        window.print();
      }
    }

    function shareTicket() {
      showToast('Funcionalidad de compartir disponible prÃ³ximamente', 'info');
    }

    // ===== MAP & BANCAS =====
    var bancasMap = null;
    
    function initBancasMap() {
      var container = document.getElementById('bancas-leaflet-map');
      if (!container || bancasMap) return;
      
      bancasMap = L.map('bancas-leaflet-map').setView([18.4861, -69.9312], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
        attribution: 'Â© OpenStreetMap' 
      }).addTo(bancasMap);
      
      BANCAS.forEach(function(banca) {
        var marker = L.marker(banca.coords).addTo(bancasMap);
        var popup = '<div style="text-align:center; min-width: 150px;">' +
          '<div style="font-weight:bold; margin-bottom:4px;">' + banca.name + '</div>' +
          '<div style="font-size:12px; color:#666; margin-bottom:8px;">' + (banca.status === 'open' ? 'ðŸŸ¢ Abierta' : 'ðŸ”´ Cerrada') + '</div>' +
          '<button onclick="playAtBanca(' + banca.id + ')" style="background:#3b82f6; color:white; border:none; padding:8px 16px; border-radius:20px; cursor:pointer; font-weight:600;">' +
            'Jugar AquÃ­' +
          '</button>' +
        '</div>';
        marker.bindPopup(popup);
      });
    }

    function toggleBancasView(view) {
      var listBtn = document.getElementById('btn-list');
      var mapBtn = document.getElementById('btn-map');
      var listView = document.getElementById('bancas-list');
      var mapView = document.getElementById('bancas-map');
      
      if (view === 'list') {
        listBtn.className = 'btn-premium text-sm py-2 px-5 titlebar-no-drag';
        mapBtn.className = 'btn-secondary text-sm py-2 px-5 titlebar-no-drag';
        listView.classList.remove('hidden');
        mapView.classList.add('hidden');
      } else {
        listBtn.className = 'btn-secondary text-sm py-2 px-5 titlebar-no-drag';
        mapBtn.className = 'btn-premium text-sm py-2 px-5 titlebar-no-drag';
        listView.classList.add('hidden');
        mapView.classList.remove('hidden');
        setTimeout(function() {
          if (bancasMap) bancasMap.invalidateSize();
          else initBancasMap();
        }, 100);
      }
    }

    function playAtBanca(bancaId) {
      var banca = BANCAS.find(function(b) { return b.id === bancaId; });
      if (banca) {
        showToast('Jugando en ' + banca.name, 'info');
        navigate('play');
      }
    }

    // ===== CHARTS =====
    var frequencyChart = null;
    var distributionChart = null;
    var balanceChart = null;
    var profileChart = null;
    
    function initResultsCharts() {
      var freqCtx = document.getElementById('frequency-chart');
      var distCtx = document.getElementById('distribution-chart');
      
      if (frequencyChart) frequencyChart.destroy();
      if (distributionChart) distributionChart.destroy();
      
      if (freqCtx) {
        frequencyChart = new Chart(freqCtx, {
          type: 'bar',
          data: {
            labels: ['23', '45', '12', '67', '08', '34'],
            datasets: [{
              label: 'Frecuencia',
              data: [15, 12, 11, 10, 9, 8],
              backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }
      
      if (distCtx) {
        distributionChart = new Chart(distCtx, {
          type: 'doughnut',
          data: {
            labels: ['Nacional', 'Leidsa', 'Loteka', 'Real'],
            datasets: [{
              data: [35, 30, 20, 15],
              backgroundColor: ['#ef4444', '#22c55e', '#a855f7', '#eab308']
            }]
          },
          options: { responsive: true }
        });
      }
      
      renderResultsHistory();
      document.getElementById('last-update').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-DO');
    }

    function initBalanceChart() {
      var ctx = document.getElementById('balance-chart');
      if (!ctx) return;
      if (balanceChart) balanceChart.destroy();
      
      balanceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
          datasets: [{
            label: 'Balance',
            data: [1500, 1800, 2200, 1900, 2300, 2500],
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
      
      renderTransactions();
    }

    function initProfileChart() {
      var ctx = document.getElementById('profile-stats-chart');
      if (!ctx) return;
      if (profileChart) profileChart.destroy();
      
      profileChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Ganadas', 'Perdidas', 'Pendientes'],
          datasets: [{
            data: [5, 35, 7],
            backgroundColor: ['#22c55e', '#ef4444', '#f59e0b']
          }]
        },
        options: { responsive: true, cutout: '60%' }
      });
      
      renderBadges();
      renderTicketsHistory();
    }

    function filterResults(period) {
      document.querySelectorAll('.results-tab').forEach(function(tab) {
        tab.classList.remove('bg-white', 'dark:bg-gray-700', 'shadow', 'text-gray-900', 'dark:text-white');
        tab.classList.add('text-gray-500', 'hover:text-gray-700');
      });
      
      if (event.target) {
        event.target.classList.remove('text-gray-500', 'hover:text-gray-700');
        event.target.classList.add('bg-white', 'dark:bg-gray-700', 'shadow', 'text-gray-900', 'dark:text-white');
      }
      
      showToast('Mostrando resultados de: ' + period, 'info');
    }

    function refreshResults() {
      showToast('Actualizando resultados...', 'info');
      initResultsCharts();
    }

    // ===== UTILITY FUNCTIONS =====
    function updateBalance() {
      document.getElementById('sidebar-balance').textContent = formatMoney(appState.user.balance);
      document.getElementById('wallet-balance').textContent = formatMoney(appState.user.balance);
      // Save balance to localStorage
      saveBalance();
    }

    function exportTransactions() {
      var transactions = getTransactions();
      if (transactions.length === 0) {
        showToast('No hay transacciones para exportar', 'warning');
        return;
      }
      
      // Create CSV content
      var csv = 'ID,Tipo,Monto,MÃ©todo,Estado,Detalles,Fecha\n';
      transactions.forEach(function(tx) {
        csv += tx.id + ',' + tx.type + ',' + tx.amount + ',' + tx.method + ',' + tx.status + ',"' + (tx.details || '') + '",' + tx.createdAt + '\n';
      });
      
      // Download file
      var blob = new Blob([csv], { type: 'text/csv' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'lotolink_transacciones_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Transacciones exportadas exitosamente', 'success');
    }

    function showEditProfileModal() {
      showToast('Editor de perfil prÃ³ximamente', 'info');
    }

    function toggleNotifications() {
      var toggle = document.getElementById('notifications-toggle');
      toggle.classList.toggle('on');
      appState.notifications = toggle.classList.contains('on');
      showToast('Notificaciones ' + (appState.notifications ? 'activadas' : 'desactivadas'), 'info');
    }

    function toggleSounds() {
      var toggle = document.getElementById('sounds-toggle');
      toggle.classList.toggle('on');
      appState.sounds = toggle.classList.contains('on');
      showToast('Sonidos ' + (appState.sounds ? 'activados' : 'desactivados'), 'info');
    }

    function toggleAutoRefresh() {
      var toggle = document.getElementById('autorefresh-toggle');
      toggle.classList.toggle('on');
      appState.autoRefresh = toggle.classList.contains('on');
      showToast('Auto-refresh ' + (appState.autoRefresh ? 'activado' : 'desactivado'), 'info');
    }

    function logout() {
      if (confirm('Â¿EstÃ¡s seguro de que deseas cerrar sesiÃ³n?')) {
        showToast('Cerrando sesiÃ³n...', 'info');
        setTimeout(function() {
          if (window.electronAPI) {
            window.electronAPI.logout();
          }
        }, 1000);
      }
    }

    function updateTime() {
      var now = new Date();
      var timeEl = document.getElementById('current-time');
      var dateEl = document.getElementById('current-date');
      var greetingEl = document.getElementById('greeting-time');
      
      if (timeEl) timeEl.textContent = now.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' });
      if (dateEl) dateEl.textContent = now.toLocaleDateString('es-DO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      
      var hour = now.getHours();
      var greeting = hour < 12 ? 'Buenos dÃ­as' : hour < 18 ? 'Buenas tardes' : 'Buenas noches';
      if (greetingEl) greetingEl.textContent = greeting;
      
      var syncEl = document.getElementById('last-sync');
      if (syncEl) syncEl.textContent = 'Sync: ahora';
    }

    function checkConnection() {
      var isOnline = navigator.onLine;
      var statusDot = document.getElementById('connection-status');
      var statusText = document.getElementById('connection-text');
      
      if (statusDot && statusText) {
        if (isOnline) {
          statusDot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
          statusText.textContent = 'Conectado';
        } else {
          statusDot.className = 'w-2 h-2 bg-gray-400 rounded-full';
          statusText.textContent = 'Sin conexiÃ³n';
        }
      }
    }

    // ===== NEW DESIGN COMPONENTS =====
    
    // Render Calendar Widget
    function renderCalendar() {
      var container = document.getElementById('calendar-days');
      var monthLabel = document.getElementById('calendar-month');
      if (!container) return;
      
      var now = new Date();
      var year = now.getFullYear();
      var month = now.getMonth();
      var today = now.getDate();
      
      var months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      if (monthLabel) monthLabel.textContent = months[month] + ' ' + year;
      
      var firstDay = new Date(year, month, 1).getDay();
      firstDay = firstDay === 0 ? 6 : firstDay - 1; // Adjust for Monday start
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      
      var html = '';
      // Empty cells for days before start of month
      for (var i = 0; i < firstDay; i++) {
        html += '<span class="calendar-day text-gray-300"></span>';
      }
      // Days of the month
      var highlightedDays = [5, 12, 18, 25]; // Example highlighted days (lottery dates)
      for (var day = 1; day <= daysInMonth; day++) {
        var classes = 'calendar-day';
        if (day === today) classes += ' today';
        else if (highlightedDays.indexOf(day) > -1) classes += ' highlighted';
        html += '<span class="' + classes + '">' + day + '</span>';
      }
      container.innerHTML = html;
    }
    
    // Render Online Users
    function renderOnlineUsers() {
      var container = document.getElementById('online-users');
      if (!container) return;
      
      var users = [
        { name: 'MarÃ­a GarcÃ­a', id: '#MG2024', status: 'online', initials: 'MG' },
        { name: 'Carlos RodrÃ­guez', id: '#CR2024', status: 'online', initials: 'CR' },
        { name: 'Ana MartÃ­nez', id: '#AM2024', status: 'online', initials: 'AM' },
        { name: 'Pedro LÃ³pez', id: '#PL2024', status: 'offline', initials: 'PL' }
      ];
      
      container.innerHTML = users.map(function(user) {
        return '<div class="user-list-item">' +
          '<div class="user-avatar">' + user.initials +
            '<div class="status-indicator ' + user.status + '"></div>' +
          '</div>' +
          '<div class="flex-1">' +
            '<p class="font-medium text-gray-900 text-sm">' + user.name + '</p>' +
            '<p class="text-xs text-gray-500">' + user.id + '</p>' +
          '</div>' +
        '</div>';
      }).join('');
    }
    
    // Render Content Cards with Gradient
    function renderLotteryContentCards() {
      var container = document.getElementById('lottery-content-cards');
      if (!container) return;
      
      var contentCards = [
        {
          title: 'LoterÃ­a Nacional',
          description: 'El sorteo mÃ¡s popular de RepÃºblica Dominicana con los mejores premios.',
          author: 'PrÃ³ximo sorteo: 8:00 PM',
          icon: 'fa-crown',
          gradient: 'linear-gradient(135deg, #E9D5FF 0%, #FBCFE8 100%)'
        },
        {
          title: 'Leidsa Quiniela',
          description: 'Juega tus nÃºmeros favoritos y gana hasta 70x tu apuesta.',
          author: 'PrÃ³ximo sorteo: 12:30 PM',
          icon: 'fa-star',
          gradient: 'linear-gradient(135deg, #D1FAE5 0%, #CFFAFE 100%)'
        },
        {
          title: 'Loteka Real',
          description: 'La loterÃ­a de los ganadores. Sorteos diarios con grandes premios.',
          author: 'PrÃ³ximo sorteo: 9:00 PM',
          icon: 'fa-gem',
          gradient: 'linear-gradient(135deg, #FEF3C7 0%, #FECACA 100%)'
        }
      ];
      
      container.innerHTML = contentCards.map(function(card) {
        return '<div class="content-card" style="background: ' + card.gradient + '">' +
          '<div class="card-image">' +
            '<i class="fas ' + card.icon + ' text-4xl text-purple-600"></i>' +
          '</div>' +
          '<div class="card-content">' +
            '<h4 class="card-title">' + card.title + '</h4>' +
            '<p class="card-description">' + card.description + '</p>' +
            '<p class="card-author"><i class="fas fa-clock mr-1"></i>' + card.author + '</p>' +
          '</div>' +
          '<button class="card-action titlebar-no-drag" onclick="navigate(\'play\')">' +
            '<i class="fas fa-arrow-right"></i>' +
          '</button>' +
        '</div>';
      }).join('');
    }

    // ===== INITIALIZE APP =====
    function initApp() {
      loadDarkMode();
      loadBalance(); // Load persisted balance
      
      renderUpcomingDraws();
      renderLiveResults();
      renderRecentPlays();
      renderLotterySelection();
      renderModalitySelection();
      renderStakeSelection();
      generateNumberGrid();
      renderBancasList();
      renderLoteriasGrid();
      
      // Render new design components
      renderCalendar();
      renderOnlineUsers();
      renderLotteryContentCards();
      
      updateTime();
      checkConnection();
      setInterval(updateTime, 1000);
      setInterval(checkConnection, 5000);
      
      updateBalance();
      updateCartBadge();
      renderCartPanel();
      
      // Load speech synthesis voices
      if ('speechSynthesis' in window) {
        window.speechSynthesis.onvoiceschanged = function() {
          // Voices are now loaded
        };
      }
      
      setTimeout(function() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        
        // Show welcome screen if first time
        if (appState.showWelcome) {
          showWelcomeScreen();
        } else {
          showToast('Bienvenido a LotoLink Desktop ðŸŽ°', 'success');
          // Greet with Luna
          if (appState.luna.voiceEnabled) {
            setTimeout(function() {
              speakText('Bienvenido a LotoLink. Â¿En quÃ© puedo ayudarte hoy?');
            }, 1000);
          }
        }
      }, 2000);
      
      if (window.electronAPI) {
        window.electronAPI.onUpdateAvailable(function() {
          showToast('Nueva versiÃ³n disponible. Descargando...', 'info');
        });
        
        window.electronAPI.onUpdateDownloaded(function() {
          showToast('ActualizaciÃ³n lista. Reinicia para instalar.', 'success');
        });
      }
    }

    // Voice toggle helper
    function toggleVoice() {
      appState.luna.voiceEnabled = !appState.luna.voiceEnabled;
      var toggle = document.getElementById('voice-toggle');
      toggle.classList.toggle('on', appState.luna.voiceEnabled);
      showToast('Voz ' + (appState.luna.voiceEnabled ? 'activada' : 'desactivada'), 'info');
    }

    function setVoiceGender(gender) {
      appState.luna.voiceGender = gender;
      showToast('Voz configurada: ' + (gender === 'female' ? 'Femenina' : 'Masculina'), 'info');
    }

    document.addEventListener('DOMContentLoaded', initApp);

    window.addEventListener('online', function() {
      checkConnection();
      showToast('ConexiÃ³n restaurada', 'success');
    });

    window.addEventListener('offline', function() {
      checkConnection();
      showToast('Sin conexiÃ³n a internet', 'warning');
    });
  </script>
</body>
</html>
