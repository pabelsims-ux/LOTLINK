<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>LotoLink ‚Äî Premium Lottery App</title>
  
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="LotoLink">
  <meta name="description" content="La aplicaci√≥n premium para jugar loter√≠as en Rep√∫blica Dominicana. Segura, r√°pida y f√°cil de usar.">
  <meta name="theme-color" content="#0071e3">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LotoLink">
  <meta name="msapplication-TileColor" content="#0071e3">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- iOS Splash Screens - Generated for common sizes -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230071e3' width='100' height='100' rx='20'/><text x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='50' font-family='Arial' font-weight='bold'>L</text></svg>">
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230071e3' width='180' height='180' rx='36'/><text x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='90' font-family='Arial' font-weight='bold'>L</text></svg>">
  
  <!-- PWA Manifest (inline for single file) -->
  <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22LotoLink%22%2C%22short_name%22%3A%22LotoLink%22%2C%22description%22%3A%22La%20aplicaci%C3%B3n%20premium%20para%20jugar%20loter%C3%ADas%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f5f5f7%22%2C%22theme_color%22%3A%22%230071e3%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520192%2520192%27%253E%253Crect%2520fill%3D%27%25230071e3%27%2520width%3D%27192%27%2520height%3D%27192%27%2520rx%3D%2738%27%2F%253E%253Ctext%2520x%3D%2750%2525%27%2520y%3D%2755%2525%27%2520dominant-baseline%3D%27middle%27%2520text-anchor%3D%27middle%27%2520fill%3D%27white%27%2520font-size%3D%2796%27%2520font-family%3D%27Arial%27%2520font-weight%3D%27bold%27%253EL%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%2C%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520512%2520512%27%253E%253Crect%2520fill%3D%27%25230071e3%27%2520width%3D%27512%27%2520height%3D%27512%27%2520rx%3D%27102%27%2F%253E%253Ctext%2520x%3D%2750%2525%27%2520y%3D%2755%2525%27%2520dominant-baseline%3D%27middle%27%2520text-anchor%3D%27middle%27%2520fill%3D%27white%27%2520font-size%3D%27256%27%2520font-family%3D%27Arial%27%2520font-weight%3D%27bold%27%253EL%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (Mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Font Awesome (Iconos para el Portal) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <!-- Chart.js (Gr√°ficas para el Portal) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Apple SF Pro Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* ========================================
       APPLE-INSPIRED ELEGANT DESIGN SYSTEM
       ======================================== */
    
    :root {
      /* Premium Color Palette - Apple inspired */
      --primary: #0071e3;
      --primary-dark: #0077ED;
      --primary-light: #42a5f5;
      --success: #34c759;
      --warning: #ff9f0a;
      --danger: #ff3b30;
      --purple: #af52de;
      
      /* Neutral Grays - Apple style */
      --gray-50: #fafafa;
      --gray-100: #f5f5f7;
      --gray-200: #e8e8ed;
      --gray-300: #d2d2d7;
      --gray-400: #86868b;
      --gray-500: #6e6e73;
      --gray-600: #1d1d1f;
      
      /* Glass Effect */
      --glass-bg: rgba(255, 255, 255, 0.72);
      --glass-border: rgba(255, 255, 255, 0.18);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      
      /* Premium Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.15);
      
      /* Border Radius - Apple style */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      --radius-full: 9999px;
    }

    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
    }

    body { 
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale;
      background: linear-gradient(180deg, #f5f5f7 0%, #ffffff 100%);
      letter-spacing: -0.01em;
    }
    
    /* Premium Button Styles */
    .btn-apple-primary {
      background: linear-gradient(180deg, #0077ED 0%, #0071e3 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 15px;
      letter-spacing: -0.01em;
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
      box-shadow: 0 4px 14px rgba(0, 113, 227, 0.35);
    }
    .btn-apple-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(0, 113, 227, 0.45);
    }
    .btn-apple-primary:active {
      transform: scale(0.98);
    }
    
    .btn-apple-secondary {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary);
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius-full);
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s ease;
    }
    .btn-apple-secondary:hover {
      background: rgba(0, 113, 227, 0.1);
    }

    /* Glass Morphism Cards */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }
    
    .premium-card {
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(0, 0, 0, 0.04);
      transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    .premium-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    /* Premium Header */
    .premium-header {
      background: rgba(255, 255, 255, 0.72);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }

    /* Elegant Modal Backdrop */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    /* Modo Oscuro - Premium Dark */
    .dark body { 
      background: linear-gradient(180deg, #000000 0%, #1c1c1e 100%);
      color: #f5f5f7; 
    }
    .dark .dark\:bg-slate-800 { background-color: #1c1c1e; }
    .dark .dark\:bg-slate-900 { background-color: #000000; }
    .dark .dark\:text-gray-100 { color: #f5f5f7; }
    .dark .dark\:text-gray-300 { color: #a1a1a6; }
    .dark .dark\:text-gray-500 { color: #6e6e73; }
    .dark .dark\:border-gray-700 { border-color: #38383a; }
    
    .dark .premium-header {
      background: rgba(28, 28, 30, 0.85);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .dark .glass-card {
      background: rgba(28, 28, 30, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .dark .premium-card {
      background: #1c1c1e;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    /* ========================================
       MOBILE RESPONSIVE ENHANCEMENTS
       ======================================== */
    
    /* Mobile-first responsive adjustments */
    @media (max-width: 640px) {
      .premium-card {
        padding: 16px;
        border-radius: var(--radius-lg);
      }
      
      .btn-apple-primary {
        padding: 10px 18px;
        font-size: 14px;
      }
      
      /* Fix for small screens */
      body {
        overflow-x: hidden;
      }
      
      /* Adjust main container padding on mobile */
      .max-w-7xl {
        padding-left: 12px;
        padding-right: 12px;
      }
    }
    
    @media (max-width: 480px) {
      /* Extra small devices */
      .premium-card {
        padding: 12px;
        margin-left: -4px;
        margin-right: -4px;
      }
    }
    
    /* Mobile menu animation */
    @keyframes slideInFromLeft {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Safe area support for notched devices (iPhone X+) */
    @supports (padding-top: env(safe-area-inset-top)) {
      .premium-header {
        padding-top: env(safe-area-inset-top);
      }
      
      .fixed.inset-0 {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }
    
    /* Touch-friendly tap targets */
    @media (hover: none) and (pointer: coarse) {
      button, a, .clickable {
        min-height: 44px;
        min-width: 44px;
      }
    }
    
    /* PWA Splash screen styles */
    .pwa-splash {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0071e3 0%, #0077ED 50%, #5856d6 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    @media print {
      body * { visibility: hidden; }
      #ticket-print-area, #ticket-print-area * { visibility: visible; }
      #ticket-print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }
    
    #demo-leaflet-map { width: 100%; height: 60vh; border-radius: var(--radius-xl); z-index: 1; }
    #banca-selection-map { width: 100%; height: 450px; border-radius: var(--radius-xl); z-index: 1; }
    
    /* Premium Toggle Switch - Apple style */
    .toggle {
      width: 51px; 
      height: 31px; 
      border-radius: var(--radius-full); 
      background: #e9e9eb; 
      position: relative; 
      display: inline-block; 
      vertical-align: middle; 
      cursor: pointer;
      transition: background 0.25s ease;
    }
    .toggle .knob {
      width: 27px; 
      height: 27px; 
      border-radius: var(--radius-full); 
      background: white; 
      position: absolute; 
      top: 2px; 
      left: 2px; 
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.1);
    }
    .toggle.on { background: var(--success); }
    .toggle.on .knob { transform: translateX(20px); }

    .modal-scroll { max-height: calc(100vh - 160px); overflow: auto; }
    
    /* Elegant Ticket Print Animation */
    .ticket-print {
      width: 340px; 
      border-radius: var(--radius-xl); 
      background: white;
      box-shadow: var(--shadow-xl);
      padding: 24px; 
      transform-origin: top center; 
      animation: printIn 700ms cubic-bezier(.25,.1,.25,1);
      color: #000 !important;
    }
    @keyframes printIn {
      0% { transform: translateY(40px) scale(.95); opacity: 0; }
      60% { transform: translateY(-8px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); }
    }
    
    .printer-slot { 
      width: 100%; 
      height: 14px; 
      background: linear-gradient(180deg, #2c2c2e 0%, #1c1c1e 100%);
      border-bottom: 4px solid rgba(0,0,0,0.4); 
      position: relative; 
      box-shadow: inset 0 2px 4px rgba(255,255,255,0.02); 
      margin-bottom: 8px; 
      border-radius: 8px 8px 0 0; 
    }
    .printer-slot::after { content: ''; position: absolute; left: 50%; transform: translateX(-50%); top: 50%; width: 60%; height: 4px; background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border-radius: 2px; }

    .ticket-entrance { transform-origin: top center; animation: slideFromTop 700ms cubic-bezier(.25,.1,.25,1); }
    @keyframes slideFromTop {
      0% { transform: translateY(-140%) scale(.98); opacity: 0; }
      60% { transform: translateY(10px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    
    /* Dark mode for modal card */
    .dark #modal-card { background: #1c1c1e; color: #f5f5f7; }
    .dark #modal-card .bg-white { background: #2c2c2e !important; }
    .dark #modal-card .text-gray-500 { color: #a1a1a6 !important; }
    .dark #modal-card .border { border-color: rgba(255,255,255,0.1) !important; }
    .dark #modal-card .bg-gray-50 { background: rgba(255,255,255,0.05) !important; }
    
    /* Lottery modal specific dark mode */
    #modal-card.lottery-dark-mode { background: #1c1c1e; color: #f5f5f7; }
    #modal-card.lottery-dark-mode .bg-white { background: #2c2c2e !important; }
    #modal-card.lottery-dark-mode .text-gray-500 { color: #a1a1a6 !important; }
    #modal-card.lottery-dark-mode .text-gray-600 { color: #8e8e93 !important; }
    #modal-card.lottery-dark-mode .text-gray-700 { color: #c7c7cc !important; }
    #modal-card.lottery-dark-mode .border { border-color: rgba(255,255,255,0.1) !important; }
    #modal-card.lottery-dark-mode .bg-gray-50 { background: rgba(255,255,255,0.05) !important; }
    #modal-card.lottery-dark-mode .bg-blue-50 { background: rgba(0, 113, 227, 0.15) !important; }
    #modal-card.lottery-dark-mode .bg-green-50 { background: rgba(52, 199, 89, 0.15) !important; }
    
    /* Premium Number Button */
    .num-btn { 
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
      border-radius: var(--radius-md);
    }
    .num-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .num-btn.selected { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 24px rgba(0, 113, 227, 0.3); 
    }
    
    /* Premium Brand Gradient */
    .bg-gradient-brand {
      background: linear-gradient(135deg, #0071e3 0%, #42a5f5 100%);
    }
    
    /* Premium Animations */
    .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(12px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    @keyframes loading { from { width: 0%; } to { width: 100%; } }
    
    /* Premium Input Fields */
    input, select, textarea {
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
    }
    
    /* Elegant Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }
    .dark ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
    }
    .dark ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Premium Trust Badge */
    .trust-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(0, 113, 227, 0.1) 100%);
      border: 1px solid rgba(52, 199, 89, 0.2);
      border-radius: var(--radius-full);
      font-size: 12px;
      font-weight: 500;
      color: var(--success);
    }

    /* Shimmer Effect for Loading */
    .shimmer {
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>
<body class="min-h-screen text-gray-900 antialiased">

  <div id="root"></div>

  <!-- React Libraries -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Utils -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- App Code -->
  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /* --- DATA --- */
    const DEFAULT_BANKS = [
      { id: 1, name: "Loteka - Av. Duarte", coords: [18.4693, -69.8990], hours: "Abierta hasta las 8:00 PM" },
      { id: 2, name: "Leidsa - Plaza Central", coords: [18.4825, -69.9312], hours: "Abierta hasta las 8:55 PM" },
      { id: 3, name: "La Primera - Zona Colonial", coords: [18.4661, -69.8989], hours: "Abierta hasta las 8:00 PM" },
      { id: 4, name: "Loter√≠a Nacional - Naco", coords: [18.4890, -69.9220], hours: "Abierta hasta las 6:00 PM" }
    ];

    const MOST_PLAYED = {
      Quiniela: ["08", "66", "36", "63", "42"],
      Tripleta: [["15", "26", "07"], ["12", "34", "56"]],
      Pale: [["08", "66"], ["36", "63"]]
    };

    const LOTERIES = {
      Leidsa: { next: "Hoy 8:55 PM", modalities: ["Quiniela", "Pal√©", "Tripleta", "Pega 3"] },
      Loteka: { next: "Hoy 7:55 PM", modalities: ["Quiniela", "Pal√©", "Tripleta", "Toca 3"] },
      "La Primera": { next: "Hoy 8:00 PM", modalities: ["Quiniela", "Pal√©", "Tripleta"] },
      "Loter√≠a Nacional": { next: "Hoy 9:00 PM", modalities: ["Quiniela", "Pal√©", "Tripleta"] }
    };

    /* --- HELPERS --- */
    function uid(prefix = "T") { return prefix + "-" + Date.now().toString(36).slice(2, 9).toUpperCase(); }
    function pad(n){ return String(n).padStart(2,'0'); }
    function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function QRImage({ value, size = 100 }) { const src = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(value)}`; return <img src={src} alt="QR" width={size} height={size} />; }

    /* --- LOTTERY RESULTS API CONFIGURATION ---
     * This configuration connects to loteriasdominicanas.com for real-time lottery results.
     * The API scrapes data from the official Dominican lottery results website.
     */
    const LOTTERY_API_CONFIG = {
      // Primary source: loteriasdominicanas.com
      BASE_URL: 'https://loteriasdominicanas.com',
      
      // Lottery endpoints
      ENDPOINTS: {
        LOTEKA: '/loteka',
        LEIDSA: '/leidsa', 
        NACIONAL: '/loteria-nacional',
        LA_PRIMERA: '/la-primera',
        REAL: '/la-suerte',
        AMERICANAS: '/americanas'
      },
      
      // CORS proxy options for browser requests
      CORS_PROXIES: [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest='
      ],
      
      // Update interval in milliseconds (30 seconds for real-time)
      UPDATE_INTERVAL_MS: 30000,
      
      // Fallback to simulation if API fails
      FALLBACK_TO_SIMULATION: true,
      
      // Cache duration in milliseconds (5 minutes)
      CACHE_DURATION_MS: 300000
    };

    /* --- REAL LOTTERY RESULTS FETCHER ---
     * Fetches real-time lottery results from loteriasdominicanas.com
     * Uses CORS proxy for browser compatibility
     */
    async function fetchRealLotteryResults(lotteryType) {
      const endpoint = LOTTERY_API_CONFIG.ENDPOINTS[lotteryType] || LOTTERY_API_CONFIG.ENDPOINTS.LOTEKA;
      const url = LOTTERY_API_CONFIG.BASE_URL + endpoint;
      
      // Try each CORS proxy until one works
      for (const proxy of LOTTERY_API_CONFIG.CORS_PROXIES) {
        try {
          const response = await fetch(proxy + encodeURIComponent(url), {
            method: 'GET',
            headers: {
              'Accept': 'text/html,application/xhtml+xml,application/xml',
              'Cache-Control': 'no-cache'
            }
          });
          
          if (!response.ok) continue;
          
          const html = await response.text();
          
          // Parse the HTML to extract lottery results
          const results = parseLotteryHTML(html, lotteryType);
          if (results && results.numbers && results.numbers.length > 0) {
            return results;
          }
        } catch (error) {
          console.warn(`CORS proxy failed: ${proxy}`, error);
          continue;
        }
      }
      
      return null;
    }

    /* --- HTML PARSER FOR LOTTERY RESULTS ---
     * Parses the loteriasdominicanas.com HTML to extract winning numbers
     */
    function parseLotteryHTML(html, lotteryType) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Look for result containers - loteriasdominicanas.com uses various class patterns
        const resultPatterns = [
          '.resultado', '.winning-numbers', '.numeros-ganadores',
          '.lottery-result', '.draw-result', '[class*="result"]',
          '.numero', '.ball', '.bola'
        ];
        
        for (const pattern of resultPatterns) {
          const elements = doc.querySelectorAll(pattern);
          if (elements.length > 0) {
            const numbers = [];
            elements.forEach(el => {
              const num = el.textContent?.trim();
              if (num && /^\d{1,2}$/.test(num)) {
                numbers.push(pad(parseInt(num)));
              }
            });
            
            if (numbers.length >= 3) {
              return {
                numbers: numbers.slice(0, 3),
                time: new Date().toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' }),
                isLive: true,
                source: 'loteriasdominicanas.com'
              };
            }
          }
        }
        
        // Alternative: Look for numbers in specific table structures
        const tables = doc.querySelectorAll('table');
        for (const table of tables) {
          const cells = table.querySelectorAll('td');
          const numbers = [];
          cells.forEach(cell => {
            const num = cell.textContent?.trim();
            if (num && /^\d{1,2}$/.test(num)) {
              numbers.push(pad(parseInt(num)));
            }
          });
          
          if (numbers.length >= 3) {
            return {
              numbers: numbers.slice(0, 3),
              time: new Date().toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' }),
              isLive: true,
              source: 'loteriasdominicanas.com'
            };
          }
        }
        
        return null;
      } catch (error) {
        console.error('Error parsing lottery HTML:', error);
        return null;
      }
    }

    /* --- LOTTERY RESULTS HOOK WITH REAL API ---
     * Fetches real lottery results from loteriasdominicanas.com
     * Falls back to simulation if API is unavailable
     */
    function useLotteryResults(updateMs = 30000) {
      const gen = () => ({ 
        time: new Date().toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' }), 
        numbers: [pad(rand(0,99)), pad(rand(0,99)), pad(rand(0,99))],
        isLive: false,
        source: 'simulaci√≥n'
      });
      
      const [feed, setFeed] = useState({ 
        Leidsa: gen(), 
        Loteka: gen(), 
        "Loter√≠a Nacional": gen(), 
        "La Primera": gen() 
      });
      const [isConnected, setIsConnected] = useState(false);
      const [lastUpdate, setLastUpdate] = useState(null);
      const cacheRef = useRef({});
      
      // Fetch all lottery results
      const fetchAllResults = async () => {
        const lotteryMap = {
          'Loteka': 'LOTEKA',
          'Leidsa': 'LEIDSA',
          'Loter√≠a Nacional': 'NACIONAL',
          'La Primera': 'LA_PRIMERA'
        };
        
        const newFeed = {};
        let anySuccess = false;
        
        for (const [displayName, apiKey] of Object.entries(lotteryMap)) {
          // Check cache first
          const cached = cacheRef.current[displayName];
          const now = Date.now();
          if (cached && (now - cached.timestamp) < LOTTERY_API_CONFIG.CACHE_DURATION_MS) {
            newFeed[displayName] = cached.data;
            anySuccess = true;
            continue;
          }
          
          try {
            const result = await fetchRealLotteryResults(apiKey);
            if (result) {
              newFeed[displayName] = result;
              cacheRef.current[displayName] = { data: result, timestamp: now };
              anySuccess = true;
            } else if (LOTTERY_API_CONFIG.FALLBACK_TO_SIMULATION) {
              newFeed[displayName] = gen();
            }
          } catch (error) {
            console.warn(`Failed to fetch ${displayName}:`, error);
            if (LOTTERY_API_CONFIG.FALLBACK_TO_SIMULATION) {
              newFeed[displayName] = gen();
            }
          }
        }
        
        if (Object.keys(newFeed).length > 0) {
          setFeed(prev => ({ ...prev, ...newFeed }));
          setIsConnected(anySuccess);
          setLastUpdate(new Date());
        }
      };
      
      useEffect(() => {
        // Initial fetch
        fetchAllResults();
        
        // Set up interval for real-time updates
        const intervalId = setInterval(fetchAllResults, updateMs);
        
        return () => clearInterval(intervalId);
      }, [updateMs]);
      
      return { feed, isConnected, lastUpdate };
    }

    /* --- LEGACY SIMULATED RESULTS (for compatibility) --- */
    function useSimulatedResults(updateMs = 10000) {
      const gen = () => ({ time: new Date().toLocaleTimeString(), numbers: [pad(rand(0,99)), pad(rand(0,99)), pad(rand(0,99))] });
      const [feed, setFeed] = useState({ Leidsa: gen(), Loteka: gen(), "Loter√≠a Nacional": gen(), "La Primera": gen() });
      useEffect(() => {
        const id = setInterval(() => setFeed({ Leidsa: gen(), Loteka: gen(), "Loter√≠a Nacional": gen(), "La Primera": gen() }), updateMs);
        return () => clearInterval(id);
      }, [updateMs]);
      return feed;
    }

    /* --- COMPONENT: BANCA PORTAL (Fusionado desde tu archivo) --- */
    function BancaPortal({ onBack }) {
      const [portalView, setPortalView] = useState('register'); // 'register' | 'login' | 'dashboard'
      const [submitted, setSubmitted] = useState(false);
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      // Efecto para Chart.js
      useEffect(() => {
        if (portalView === 'dashboard' && canvasRef.current) {
          if (chartRef.current) chartRef.current.destroy();
          if (typeof Chart !== 'undefined') {
            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
              type: 'line',
              data: {
                labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                datasets: [{
                  label: 'Ventas ($)',
                  data: [1200, 1900, 3000, 5000, 2300, 8400, 12450],
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  fill: true,
                  tension: 0.4
                }]
              },
              options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
          }
        }
      }, [portalView]);

      if (portalView === 'dashboard') {
        return (
          <div className="flex-grow w-full max-w-7xl mx-auto min-h-[80vh] bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col animate-fade-in mt-6">
            <header className="bg-white border-b px-6 py-4 flex justify-between items-center">
              <div><h2 className="text-xl font-bold text-gray-800">Hola, Banca La Fortuna</h2><p className="text-xs text-gray-500">ID: #LOTO-8821 ‚Ä¢ Plan Mixto</p></div>
              <div className="flex items-center gap-4">
                <button className="p-2 text-gray-400 hover:text-blue-600"><i className="fas fa-bell"></i></button>
                <button onClick={() => setPortalView('login')} className="text-sm text-red-500 hover:underline">Salir</button>
              </div>
            </header>
            <div className="flex-grow p-6 overflow-y-auto bg-gray-50">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                  <div className="flex justify-between"><div><p className="text-sm text-gray-500">Ventas de Hoy</p><h3 className="text-2xl font-bold text-gray-800">$12,450.00</h3></div><div className="text-blue-600"><i className="fas fa-cash-register text-xl"></i></div></div>
                </div>
                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                  <div className="flex justify-between"><div><p className="text-sm text-gray-500">Comisiones</p><h3 className="text-2xl font-bold text-gray-800">$4,200.00</h3></div><div className="text-green-600"><i className="fas fa-hand-holding-usd text-xl"></i></div></div>
                </div>
                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                  <div className="flex justify-between"><div><p className="text-sm text-gray-500">Tickets Activos</p><h3 className="text-2xl font-bold text-gray-800">142</h3></div><div className="text-purple-600"><i className="fas fa-ticket-alt text-xl"></i></div></div>
                </div>
              </div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
                <h3 className="font-bold text-gray-800 mb-4">Rendimiento Semanal</h3>
                <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="w-full max-w-7xl mx-auto mt-6 pb-20">
          <div className="mb-4 flex justify-between items-center px-2">
            <button onClick={onBack} className="flex items-center gap-2 text-gray-600 hover:text-black font-medium px-4 py-2 rounded-lg hover:bg-gray-100 transition"><i className="fas fa-arrow-left"></i> Volver al inicio</button>
            <button onClick={() => setPortalView(portalView === 'register' ? 'login' : 'register')} className="text-blue-600 font-medium border border-blue-200 px-4 py-2 rounded-lg hover:bg-blue-50 transition flex items-center gap-2">
              <i className="fas fa-user-lock"></i> {portalView === 'register' ? '¬øYa eres socio? Entrar' : '¬øNuevo? Reg√≠strate'}
            </button>
          </div>

          {portalView === 'login' ? (
            <div className="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden mt-10 animate-fade-in">
              <div className="bg-gradient-brand p-8 text-center text-white">
                <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 text-xl font-bold">L</div>
                <h2 className="text-2xl font-bold">Acceso a Socios</h2>
                <p className="text-blue-100 text-sm mt-2">Gestiona tu banca desde cualquier lugar</p>
              </div>
              <div className="p-8 space-y-5">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">ID de Banca o Correo</label><input className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej. BANCA-1023" /></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label><input className="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                <button onClick={() => setPortalView('dashboard')} className="w-full bg-gradient-brand text-white p-3 rounded-lg font-bold shadow-lg hover:opacity-90 transition-all">Ingresar al Sistema</button>
              </div>
            </div>
          ) : (
            <div className="bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[600px] animate-fade-in">
              <aside className="md:w-2/5 bg-gradient-brand p-10 text-white flex flex-col justify-between relative overflow-hidden">
                <div className="relative z-10">
                  <h1 className="text-4xl md:text-5xl font-bold mb-4">LotoLink <br/><span class="text-blue-200">Socios</span></h1>
                  <p className="text-blue-100 text-lg leading-relaxed mb-6">√önete a la red de bancas m√°s grande. Gestiona ventas y automatiza cobros hoy mismo.</p>
                  <ul className="space-y-4 mt-8">
                    <li className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i className="fas fa-check"></i></div> Comisiones instant√°neas</li>
                    <li className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i className="fas fa-mobile-alt"></i></div> App m√≥vil vendedores</li>
                    <li className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i className="fas fa-chart-line"></i></div> Reportes en vivo</li>
                  </ul>
                </div>
                <div className="relative z-10 mt-12 pt-8 border-t border-white/20"><p class="italic text-blue-100 text-sm">"Mis ventas subieron un 40% con LotoLink."</p></div>
              </aside>
              <section className="md:w-3/5 p-10 overflow-y-auto">
                <h2 className="text-2xl font-bold text-gray-900 mb-1">Solicitud de Registro</h2>
                <p className="text-sm text-gray-500 mb-8">Completa el formulario para validar tu banca. Toma menos de 5 minutos.</p>
                <form className="space-y-5" onSubmit={(e) => { e.preventDefault(); setSubmitted(true); setTimeout(() => setSubmitted(false), 5000); }}>
                  
                  {/* Grupo: Informaci√≥n del Negocio */}
                  <div>
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Datos del Negocio</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Nombre de la banca *</label>
                        <input 
                          type="text" 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow" 
                          placeholder="Ej. Banca Juana" 
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Tipo *</label>
                        <select 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                          <option value="">Selecciona...</option>
                          <option value="presencial">Presencial</option>
                          <option value="mixta">Mixta (F√≠sico + App)</option>
                          <option value="virtual">100% Virtual</option>
                        </select>
                      </div>
                      <div className="sm:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n completa *</label>
                        <input 
                          type="text" 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                          placeholder="Calle, N√∫mero, Sector" 
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Provincia / Estado *</label>
                        <input 
                          type="text" 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                          placeholder="Ej. Santo Domingo"
                        />
                      </div>
                      <div className="sm:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Software utilizado en la banca *</label>
                        <select 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                          <option value="">Selecciona el software que usas...</option>
                          <option value="loteria_electronica">Loter√≠a Electr√≥nica</option>
                          <option value="punto_lotto">Punto Lotto</option>
                          <option value="loto_pro">Loto Pro</option>
                          <option value="sistema_propio">Sistema Propio</option>
                          <option value="excel_manual">Excel / Manual</option>
                          <option value="otro">Otro</option>
                          <option value="ninguno">Ninguno / No uso software</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <hr className="border-gray-100" />

                  {/* Grupo: Contacto */}
                  <div>
                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Datos de Contacto y Pago</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Propietario *</label>
                        <input 
                          type="text" 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                          placeholder="Nombre completo"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Tel√©fono / WhatsApp *</label>
                        <input 
                          type="tel" 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                          placeholder="+1 (809)..." 
                        />
                      </div>
                      <div className="sm:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Correo electr√≥nico *</label>
                        <input 
                          type="email" 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                          placeholder="ejemplo@banca.com" 
                        />
                      </div>
                      <div className="sm:col-span-2">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Cuenta Bancaria / M√≥vil *</label>
                        <input 
                          type="text" 
                          required
                          className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" 
                          placeholder="Banco X - Cta #123456" 
                        />
                      </div>
                    </div>
                  </div>

                  {/* Grupo: Documentos */}
                  <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h3 className="text-sm font-bold text-blue-800 mb-2 flex items-center gap-2">
                      <i className="fas fa-file-upload"></i> Documentaci√≥n Requerida
                    </h3>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">C√©dula / ID (Foto clara) *</label>
                      <input 
                        type="file" 
                        accept="image/*,application/pdf"
                        className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer" 
                      />
                    </div>
                  </div>

                  {/* T√©rminos */}
                  <div className="pt-2">
                    <label className="flex items-start gap-3 cursor-pointer">
                      <input 
                        type="checkbox" 
                        required
                        className="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                      />
                      <span className="text-sm text-gray-600 leading-tight">
                        He le√≠do y acepto los <a href="#" className="text-blue-600 hover:underline">T√©rminos de Servicio</a>.
                      </span>
                    </label>
                  </div>

                  {/* Bot√≥n */}
                  <div className="pt-4">
                    <button 
                      type="submit"
                      disabled={submitted}
                      className={`w-full font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transform active:scale-[0.99] transition-all flex items-center justify-center gap-2 ${
                        submitted 
                          ? 'bg-green-600 text-white' 
                          : 'bg-gradient-brand text-white hover:opacity-90'
                      }`}
                    >
                      <span>{submitted ? '‚úì Solicitud enviada con √©xito' : 'Enviar Solicitud de Registro'}</span>
                      {!submitted && <i className="fas fa-arrow-right text-sm"></i>}
                    </button>
                    {submitted && (
                      <p className="text-sm text-green-600 font-medium mt-3 animate-fade-in text-center">
                        ¬°Gracias! Revisa tu correo para los pr√≥ximos pasos.
                      </p>
                    )}
                  </div>
                </form>
              </section>
            </div>
          )}
        </div>
      );
    }

    /* --- COMPONENT: Rankings (Full Implementation from MVP) --- */
    function Rankings() {
      const baseTopWinners = [
        { name: 'Juan P√©rez', wins: 15 }, { name: 'Mar√≠a G√≥mez', wins: 13 }, { name: 'Carlos Rodr√≠guez', wins: 11 },
        { name: 'Ana Mart√≠nez', wins: 9 }, { name: 'Luis Fern√°ndez', wins: 7 }, { name: 'Sof√≠a L√≥pez', wins: 6 },
        { name: 'Pedro Ram√≠rez', wins: 5 }, { name: 'Gloria Santana', wins: 4 }
      ];
      const topBanks = [
        { name: 'Banca La Suerte', paid: 1200000 }, { name: 'Banca Fortuna', paid: 980000 }, { name: 'Banca El Mill√≥n', paid: 760000 },
        { name: 'Banca Ganadora', paid: 540000 }, { name: 'Banca Central', paid: 310000 }, { name: 'Banca El Dorado', paid: 205000 },
        { name: 'Banca La Primera', paid: 150000 }, { name: 'Banca Villa Mella', paid: 92000 }
      ];
      const mostPlayedNumbers = ['05', '12', '23', '08', '66', '42', '15', '26', '07', '33'];

      const [topWinners, setTopWinners] = useState(baseTopWinners);
      const [userEntry, setUserEntry] = useState(null);

      useEffect(() => {
        const rawUser = localStorage.getItem("ll_user");
        const visible = localStorage.getItem("ll_visible_rank");
        const wins = localStorage.getItem("ll_user_wins");
        if (rawUser && visible === "true") {
          try {
            const u = JSON.parse(rawUser);
            const userWins = wins ? Number(wins) : 1;
            const entry = { name: u.name, wins: userWins, isYou: true };
            setUserEntry(entry);
            const merged = [...baseTopWinners.filter(b => b.name !== u.name), entry].sort((a,b) => b.wins - a.wins);
            setTopWinners(merged.slice(0, 8));
          } catch(e) { setUserEntry(null); setTopWinners(baseTopWinners); }
        } else { setUserEntry(null); setTopWinners(baseTopWinners); }

        function onUpdate() {
          const visible2 = localStorage.getItem("ll_visible_rank");
          const rawUser2 = localStorage.getItem("ll_user");
          const wins2 = localStorage.getItem("ll_user_wins");
          if (rawUser2 && visible2 === "true") {
            try {
              const u2 = JSON.parse(rawUser2);
              const entry2 = { name: u2.name, wins: Number(wins2 || 1), isYou: true };
              setUserEntry(entry2);
              const merged2 = [...baseTopWinners.filter(b => b.name !== u2.name), entry2].sort((a,b) => b.wins - a.wins);
              setTopWinners(merged2.slice(0, 8));
            } catch(e) { setUserEntry(null); setTopWinners(baseTopWinners); }
          } else { setUserEntry(null); setTopWinners(baseTopWinners); }
        }
        window.addEventListener('ll_rankings_update', onUpdate);
        return () => window.removeEventListener('ll_rankings_update', onUpdate);
      }, []);

      return (
        <section className="mt-6">
          <h2 className="text-2xl font-bold mb-2 dark:text-white">Rankings</h2>
          <p className="text-gray-600 dark:text-gray-300 mb-6">Top jugadores (por cantidad de veces ganadas), bancas y n√∫meros m√°s jugados.</p>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
              <div className="font-bold text-lg mb-4 dark:text-white">üèÜ Top Ganadores</div>
              <ol className="space-y-3 text-sm">
                {topWinners.map((w, i) => (
                  <li key={i} className={"flex justify-between items-center p-2 rounded-lg " + (w.isYou ? 'bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700' : '')}>
                    <div>
                      <div className="font-semibold dark:text-white">{i+1}. {w.name}{w.isYou ? ' (t√∫)' : ''}</div>
                      <div className="text-xs text-gray-500 dark:text-gray-400">{w.isYou ? 'Visible en rankings' : 'Jugador destacado'}</div>
                    </div>
                    <div className="text-sm font-bold text-blue-600">{w.wins} victorias</div>
                  </li>
                ))}
              </ol>
              <div className="mt-4 pt-3 border-t dark:border-slate-700 text-xs text-gray-500 dark:text-gray-400">Privacidad: mostramos victorias, no montos.</div>
            </div>
            <div className="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
              <div className="font-bold text-lg mb-4 dark:text-white">üí∞ Top Bancas</div>
              <ul className="space-y-3 text-sm">
                {topBanks.map((b, i) => (
                  <li key={i} className="flex justify-between items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700">
                    <div>
                      <div className="font-semibold dark:text-white">{b.name}</div>
                      <div className="text-xs text-gray-500 dark:text-gray-400">Pagos realizados</div>
                    </div>
                    <div className="text-sm font-bold text-green-600">RD${b.paid.toLocaleString('es-DO')}</div>
                  </li>
                ))}
              </ul>
            </div>
            <div className="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
              <div className="font-bold text-lg mb-4 dark:text-white">üî¢ N√∫meros m√°s jugados</div>
              <div className="grid grid-cols-2 gap-2 text-sm">
                {mostPlayedNumbers.map((n, idx) => (
                  <div key={idx} className="p-3 border dark:border-slate-600 rounded-lg flex items-center justify-between bg-gray-50 dark:bg-slate-900">
                    <div className="font-mono font-bold dark:text-white">{n}</div>
                    <div className="text-xs text-gray-500 dark:text-gray-400">#{idx + 1}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>
      );
    }

    /* --- COMPONENT: Most Played Section --- */
    function MostPlayedSection({ most }) {
      return (
        <section className="mt-6">
          <h2 className="text-2xl font-bold mb-2 dark:text-white">M√°s jugados</h2>
          <p className="text-gray-600 dark:text-gray-300 mb-6">N√∫meros y combinaciones m√°s populares en las distintas modalidades.</p>
          <div className="grid grid-cols-1 gap-3">
            {Object.entries(most).map(([k, v]) => (
              <div key={k} className="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
                <div className="font-bold text-lg mb-2 dark:text-white">{k}</div>
                <div className="text-sm text-gray-500 dark:text-gray-300">Muestra: {Array.isArray(v[0]) ? v[0].join(' ¬∑ ') : v.join(' ¬∑ ')}</div>
              </div>
            ))}
          </div>
        </section>
      );
    }

    /* --- COMPONENT: Join Us --- */
    function JoinUs() {
      const [name, setName] = useState(""); 
      const [loc, setLoc] = useState(""); 
      const [phone, setPhone] = useState("");
      const [submitted, setSubmitted] = useState(false);
      
      function submit(e) { 
        e.preventDefault(); 
        // Show success message visually
        setSubmitted(true);
        setTimeout(() => {
          setSubmitted(false);
          setName(""); 
          setLoc(""); 
          setPhone("");
        }, 3000);
      }
      
      return (
        <section className="mt-6">
          <h2 className="text-2xl font-bold mb-2 dark:text-white">√önete a LotoLink</h2>
          <p className="text-gray-600 dark:text-gray-300 mb-6">Si tienes una banca y quieres integrarte a LotoLink, d√©janos tus datos.</p>
          <form className="grid grid-cols-1 md:grid-cols-3 gap-4" onSubmit={submit}>
            <input 
              value={name} 
              onChange={(e)=>setName(e.target.value)} 
              placeholder="Nombre de la banca" 
              className="p-3 border rounded-lg bg-white dark:bg-slate-900 dark:text-white dark:border-slate-600" 
              required
            />
            <input 
              value={loc} 
              onChange={(e)=>setLoc(e.target.value)} 
              placeholder="Ubicaci√≥n" 
              className="p-3 border rounded-lg bg-white dark:bg-slate-900 dark:text-white dark:border-slate-600" 
              required
            />
            <input 
              value={phone} 
              onChange={(e)=>setPhone(e.target.value)} 
              placeholder="Tel√©fono" 
              className="p-3 border rounded-lg bg-white dark:bg-slate-900 dark:text-white dark:border-slate-600" 
              required
            />
            <div className="md:col-span-3">
              <button 
                type="submit" 
                disabled={submitted}
                className={`px-6 py-3 rounded-lg font-bold transition ${
                  submitted 
                    ? 'bg-green-600 text-white' 
                    : 'bg-slate-900 dark:bg-white dark:text-slate-900 text-white hover:bg-slate-800'
                }`}
              >
                {submitted ? '‚úì Solicitud enviada con √©xito' : 'Quiero unirme'}
              </button>
              {submitted && (
                <p className="mt-3 text-sm text-green-600 dark:text-green-400 font-medium animate-fade-in">
                  Gracias! Nos pondremos en contacto contigo pronto.
                </p>
              )}
            </div>
          </form>
        </section>
      );
    }

    /* --- COMPONENT: Popular Plays --- */
    function PopularPlays({ mostPlayed, onQuick }) {
      return (
        <div className="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
          <div className="font-bold mb-3 dark:text-white">Jugadas m√°s populares</div>
          {Object.entries(mostPlayed).map(([k, v]) => (
            <div key={k} className="mb-3 pb-3 border-b last:border-b-0 dark:border-slate-700">
              <div className="font-semibold text-sm dark:text-white mb-1">{k}</div>
              <div className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                {Array.isArray(v[0]) ? v[0].join(', ') : v.join(', ')}
              </div>
              <button 
                onClick={() => onQuick(k, Array.isArray(v[0]) ? v[0] : [v[0]])} 
                className="px-3 py-1.5 border dark:border-slate-600 rounded-lg text-xs hover:bg-gray-50 dark:hover:bg-slate-700 dark:text-gray-300 font-medium transition"
              >
                Agregar r√°pida
              </button>
            </div>
          ))}
        </div>
      );
    }

    /* --- COMPONENT: Payment Methods --- */
    function PaymentMethods() {
      return (
        <div className="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
          <div className="font-bold mb-3 dark:text-white">M√©todos de pago</div>
          <div className="grid grid-cols-2 gap-2 text-xs">
            <div className="p-3 border dark:border-slate-600 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-slate-700 transition">
              <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="Visa" className="h-6 mx-auto mb-1" />
              <p className="dark:text-gray-300">Tarjeta Visa</p>
            </div>
            <div className="p-3 border dark:border-slate-600 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-slate-700 transition">
              <img src="https://cdn-icons-png.flaticon.com/512/349/349221.png" alt="MasterCard" className="h-6 mx-auto mb-1" />
              <p className="dark:text-gray-300">MasterCard</p>
            </div>
            <div className="p-3 border dark:border-slate-600 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-slate-700 transition">
              <div className="text-lg mb-1">üçé</div>
              <p className="dark:text-gray-300">Apple Pay</p>
            </div>
            <div className="p-3 border dark:border-slate-600 rounded-lg text-center hover:bg-gray-50 dark:hover:bg-slate-700 transition">
              <img src="https://cdn-icons-png.flaticon.com/512/5969/5969059.png" alt="Banco" className="h-6 mx-auto mb-1" />
              <p className="dark:text-gray-300">Banco</p>
            </div>
          </div>
        </div>
      );
    }

    /* --- COMPONENT: How It Works --- */
    function HowItWorks() { 
      return (
        <section className="mt-6">
          <h2 className="text-2xl font-bold mb-2 dark:text-white">C√≥mo funciona</h2>
          <p className="text-gray-600 dark:text-gray-300 mb-6">LotoLink conecta jugadores y bancas de forma simple y segura.</p>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
              <div className="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üè™</div>
              <h3 className="font-bold text-lg mb-2 dark:text-white">1. Selecciona banca</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">Encuentra bancas cercanas en el mapa o lista.</p>
            </div>
            <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
              <div className="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üé≤</div>
              <h3 className="font-bold text-lg mb-2 dark:text-white">2. Elige n√∫meros</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">Selecciona tu loter√≠a favorita y tus n√∫meros de la suerte.</p>
            </div>
            <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
              <div className="w-16 h-16 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">üéüÔ∏è</div>
              <h3 className="font-bold text-lg mb-2 dark:text-white">3. Recibe ticket</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">Tu ticket digital est√° listo para cobrar si ganas.</p>
            </div>
          </div>
        </section>
      );
    }

    /* --- COMPONENT: BANCAS (With Portal Link) --- */
    function Bancas({ banks, onPlay, onJoin, initialViewMode = 'list', focusBank = null }) {
      const [viewMode, setViewMode] = useState(initialViewMode);
      const mapInitializedRef = useRef(false);
      const mapInstanceRef = useRef(null);
      
      // Initialize or update map when switching to map view or when focusBank changes
      useEffect(() => {
        if (viewMode === 'map') {
          // Small delay to ensure container is rendered
          const initMap = setTimeout(() => {
            const mapContainer = document.getElementById('bancas-map-container');
            if (mapContainer && !mapInitializedRef.current) {
              // Clear any placeholder content
              mapContainer.innerHTML = '';
              mapContainer.className = '';
              
              // Initialize Leaflet map
              const centerCoords = focusBank ? focusBank.coords : [18.4861, -69.9312];
              const zoomLevel = focusBank ? 16 : 13;
              
              const map = L.map('bancas-map-container').setView(centerCoords, zoomLevel);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '¬© OpenStreetMap contributors' 
              }).addTo(map);
              
              // Add markers for all banks
              banks.forEach(b => {
                const marker = L.marker(b.coords).addTo(map);
                
                // Create styled popup
                const popupContent = `
                  <div style="text-align:center; min-width: 180px; padding: 8px;">
                    <div style="font-weight:bold; margin-bottom:6px; font-size:15px; color:#1e3a5f;">${b.name}</div>
                    <div style="font-size:12px; color:#666; margin-bottom:10px;">
                      <i class="far fa-clock"></i> ${b.hours}
                    </div>
                    <button 
                      onclick="if(window.triggerPlayModal) window.triggerPlayModal(${b.id})" 
                      style="background: linear-gradient(135deg, #2563EB 0%, #1d4ed8 100%); color:white; border:none; padding:8px 16px; border-radius:20px; cursor:pointer; font-size:13px; font-weight:600; box-shadow:0 2px 8px rgba(37,99,235,0.3); width:100%;">
                      üéüÔ∏è Jugar Aqu√≠
                    </button>
                  </div>
                `;
                
                marker.bindPopup(popupContent);
                
                // If this is the focused bank, open its popup
                if (focusBank && b.id === focusBank.id) {
                  marker.openPopup();
                }
              });
              
              mapInstanceRef.current = map;
              mapInitializedRef.current = true;
            } else if (mapContainer && mapInitializedRef.current && mapInstanceRef.current && focusBank) {
              // Map already initialized, just pan to the focused bank
              mapInstanceRef.current.setView(focusBank.coords, 16);
              
              // Find and open the popup for the focused bank
              mapInstanceRef.current.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                  const pos = layer.getLatLng();
                  if (pos.lat === focusBank.coords[0] && pos.lng === focusBank.coords[1]) {
                    layer.openPopup();
                  }
                }
              });
            }
          }, 100);
          
          return () => clearTimeout(initMap);
        }
      }, [viewMode, focusBank, banks]);
      
      // Cleanup map on unmount
      useEffect(() => {
        return () => {
          if (mapInstanceRef.current) {
            mapInstanceRef.current.remove();
            mapInstanceRef.current = null;
            mapInitializedRef.current = false;
          }
        };
      }, []);
      
      // Update viewMode when initialViewMode prop changes
      useEffect(() => {
        setViewMode(initialViewMode);
      }, [initialViewMode]);
      
      return (
        <section className="mt-6">
          <div className="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-8 rounded-2xl mb-8 flex flex-col md:flex-row items-center justify-between shadow-xl relative overflow-hidden">
             <div className="relative z-10">
                <h3 className="text-2xl font-bold mb-2 flex items-center gap-3"><i className="fas fa-store text-3xl"></i> ¬øTienes una banca?</h3>
                <p className="text-blue-100 text-lg">√önete a la red digital m√°s grande y aumenta tus ventas hoy mismo.</p>
             </div>
             <div className="relative z-10 mt-6 md:mt-0">
                <button onClick={onJoin} className="bg-white text-blue-900 px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-50 transition transform hover:scale-105 flex items-center gap-2">
                   <span>√önete a LotoLink</span> <i className="fas fa-arrow-right"></i>
                </button>
             </div>
             <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full transform translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
          </div>

          <div className="flex justify-between items-center mb-4">
            <h2 className="text-2xl font-semibold dark:text-white">Bancas Disponibles</h2>
            <div className="flex gap-2">
              <button
                onClick={() => setViewMode('list')}
                className={`px-4 py-2 rounded-lg font-medium transition ${
                  viewMode === 'list'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-slate-600'
                }`}
              >
                <i className="fas fa-list mr-2"></i>Lista
              </button>
              <button
                onClick={() => setViewMode('map')}
                className={`px-4 py-2 rounded-lg font-medium transition ${
                  viewMode === 'map'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-slate-600'
                }`}
              >
                <i className="fas fa-map-marked-alt mr-2"></i>Mapa
              </button>
            </div>
          </div>

          {viewMode === 'list' ? (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {banks.map((b) => (
                <div key={b.id} className="p-5 bg-white dark:bg-slate-800 rounded-xl shadow-sm flex justify-between items-center border border-gray-100 dark:border-slate-700">
                  <div>
                    <div className="font-bold text-lg text-slate-800 dark:text-white">{b.name}</div>
                    <div className="text-sm text-gray-500 dark:text-gray-400 mt-1"><i className="far fa-clock mr-1"></i> {b.hours}</div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => onPlay(b)} className="px-5 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-sm">Jugar</button>
                    <button 
                      onClick={() => setViewMode('map')} 
                      className="px-4 py-2 bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-200 dark:hover:bg-slate-600 transition"
                      title="Ver en mapa"
                    >
                      <i className="fas fa-map-marker-alt"></i>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden">
              <div id="bancas-map-container" style={{ height: '500px', borderRadius: '12px' }}></div>
            </div>
          )}
        </section>
      );
    }

    /* --- STANDARD COMPONENTS (Header, Hero, etc.) --- */
    function Header({ theme, setTheme, user, onLogin, onLogout, onNav, onOpenPlay, cartCount, onToggleCart, winningTicketsCount, onShowWinningTickets, registeredCard, onManageCard }) {
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
      const [mobileSearchQuery, setMobileSearchQuery] = useState('');
      
      // Close mobile menu when navigating
      const handleNavClick = (view) => {
        setIsMobileMenuOpen(false);
        onNav(view);
      };
      
      // Handle mobile search
      const handleMobileSearch = (e) => {
        e.preventDefault();
        if (mobileSearchQuery.trim()) {
          // Search logic - could navigate to search results or filter content
          console.log('Searching for:', mobileSearchQuery);
          setIsMobileMenuOpen(false);
          // For now, navigate to loterias as a search result placeholder
          onNav('loterias');
        }
      };
      
      return (
        <>
          <header className="premium-header sticky top-0 z-40 transition-all duration-300">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between">
              <div className="flex items-center gap-3 sm:gap-5">
                {/* Mobile Menu Toggle - Shows on mobile only */}
                <button 
                  onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
                  className="lg:hidden w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100/80 dark:bg-white/10 hover:bg-gray-200/80 dark:hover:bg-white/20 transition-all"
                  aria-label="Men√∫"
                >
                  {isMobileMenuOpen ? (
                    <svg className="w-6 h-6 text-gray-700 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  ) : (
                    <svg className="w-6 h-6 text-gray-700 dark:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                  )}
                </button>
                
                {/* Premium Logo */}
                <div 
                  className="w-10 h-10 sm:w-11 sm:h-11 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl sm:rounded-2xl grid place-items-center text-white font-bold text-base sm:text-lg cursor-pointer shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-all duration-300 hover:scale-105" 
                  onClick={()=>handleNavClick('home')}
                >
                  L
                </div>
                <div className="font-semibold text-lg sm:text-xl hidden sm:block cursor-pointer text-gray-900 dark:text-white tracking-tight" onClick={()=>handleNavClick('home')}>
                  LotoLink
                  <span className="ml-2 text-xs font-medium text-gray-400 dark:text-gray-500">Premium</span>
                </div>
                
                {/* Desktop Navigation - Hidden on mobile/tablet */}
                <nav className="hidden lg:flex gap-1 text-sm ml-6">
                  <button onClick={() => handleNavClick('home')} className="px-4 py-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 font-medium transition-all">Inicio</button>
                  <button onClick={() => handleNavClick('how')} className="px-4 py-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 font-medium transition-all">C√≥mo funciona</button>
                  <button onClick={() => handleNavClick('demo')} className="px-4 py-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 font-medium transition-all">Demo/Mapa</button>
                  <button onClick={() => handleNavClick('loterias')} className="px-4 py-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 font-medium transition-all">Loter√≠as</button>
                  <button onClick={() => handleNavClick('bancas')} className="px-4 py-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 font-medium transition-all">Bancas</button>
                  <button onClick={() => handleNavClick('rankings')} className="px-4 py-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/10 font-medium transition-all">Rankings</button>
                </nav>
              </div>
              
              {/* Right side actions */}
              <div className="flex items-center gap-2 sm:gap-3">
                {/* Trust Badge - Hidden on small mobile */}
                <div className="hidden md:flex trust-badge">
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                  </svg>
                  <span>Seguro</span>
                </div>
                
                {/* Winning Tickets Indicator */}
                {winningTicketsCount > 0 && (
                  <button 
                    onClick={onShowWinningTickets}
                    className="relative px-3 sm:px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full font-semibold text-xs sm:text-sm flex items-center gap-1 sm:gap-2 shadow-lg shadow-green-500/30 hover:shadow-green-500/50 transition-all duration-300"
                  >
                    <span>üèÜ</span>
                    <span className="hidden sm:inline">Ganadores</span>
                    <span className="bg-white text-green-600 text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">{winningTicketsCount}</span>
                  </button>
                )}
                
                {/* Registered Card Indicator - Hidden on mobile */}
                {registeredCard && (
                  <button 
                    onClick={onManageCard}
                    className="hidden md:flex items-center gap-2 px-3 py-2 bg-gray-100/80 dark:bg-white/10 backdrop-blur-sm rounded-xl text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-200/80 dark:hover:bg-white/20 transition-all font-medium"
                    title={`${registeredCard.brand} terminada en ${registeredCard.lastFour}`}
                  >
                    <span className="text-lg">üí≥</span>
                    <span className="font-mono">‚Ä¢‚Ä¢‚Ä¢{registeredCard.lastFour}</span>
                  </button>
                )}
                
                {/* Theme Toggle - Hidden on small mobile */}
                <button 
                  onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} 
                  className="hidden sm:flex w-10 h-10 items-center justify-center rounded-full bg-gray-100/80 dark:bg-white/10 backdrop-blur-sm hover:bg-gray-200/80 dark:hover:bg-white/20 transition-all"
                >
                  {theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
                </button>
                
                {/* Profile - Always visible */}
                <button 
                  onClick={() => handleNavClick('profile')} 
                  className="w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-gray-100/80 dark:bg-white/10 backdrop-blur-sm hover:bg-gray-200/80 dark:hover:bg-white/20 transition-all flex items-center justify-center text-lg sm:text-xl"
                >
                  üë§
                </button>
                
                {/* Cart - Always visible */}
                <button 
                  onClick={onToggleCart} 
                  className="relative w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-gray-100/80 dark:bg-white/10 backdrop-blur-sm hover:bg-gray-200/80 dark:hover:bg-white/20 transition-all flex items-center justify-center"
                >
                  <span className="text-lg sm:text-xl">üõí</span>
                  {cartCount > 0 && (
                    <span className="absolute -top-1 -right-1 bg-gradient-to-r from-red-500 to-rose-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-lg">
                      {cartCount}
                    </span>
                  )}
                </button>
                
                {/* Auth Button - Hidden on small mobile */}
                {user ? (
                  <button onClick={onLogout} className="hidden sm:block px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium transition-colors">
                    Salir
                  </button>
                ) : (
                  <button onClick={onLogin} className="hidden sm:block px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium transition-colors">
                    Entrar
                  </button>
                )}
                
                {/* Primary CTA - Hidden on mobile */}
                <button 
                  onClick={onOpenPlay} 
                  className="btn-apple-primary hidden md:block text-sm px-4 py-2 sm:px-6 sm:py-3"
                >
                  Jugar Ahora
                </button>
              </div>
            </div>
          </header>
          
          {/* Mobile Slide-out Menu */}
          {isMobileMenuOpen && (
            <div className="fixed inset-0 z-50 lg:hidden">
              {/* Backdrop */}
              <div 
                className="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
                onClick={() => setIsMobileMenuOpen(false)}
              ></div>
              
              {/* Menu Panel */}
              <div className="absolute top-0 left-0 w-[85%] max-w-sm h-full bg-white dark:bg-slate-900 shadow-2xl transform transition-transform duration-300 ease-out overflow-y-auto">
                {/* Menu Header */}
                <div className="p-5 border-b border-gray-100 dark:border-slate-800 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl grid place-items-center text-white font-bold">
                      L
                    </div>
                    <div>
                      <div className="font-semibold text-gray-900 dark:text-white">LotoLink</div>
                      <div className="text-xs text-gray-500 dark:text-gray-400">Premium</div>
                    </div>
                  </div>
                  <button 
                    onClick={() => setIsMobileMenuOpen(false)}
                    className="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-slate-800 hover:bg-gray-200 dark:hover:bg-slate-700 transition-all"
                  >
                    <svg className="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
                
                {/* Search Bar */}
                <div className="p-4 border-b border-gray-100 dark:border-slate-800">
                  <form onSubmit={handleMobileSearch}>
                    <div className="relative">
                      <input 
                        type="text"
                        placeholder="Buscar loter√≠as, bancas..."
                        value={mobileSearchQuery}
                        onChange={(e) => setMobileSearchQuery(e.target.value)}
                        className="w-full pl-10 pr-4 py-3 bg-gray-100 dark:bg-slate-800 border-0 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"
                      />
                      <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>
                  </form>
                </div>
                
                {/* User Info Section (if logged in) */}
                {user && (
                  <div className="p-4 border-b border-gray-100 dark:border-slate-800">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-2xl">
                        üë§
                      </div>
                      <div>
                        <div className="font-semibold text-gray-900 dark:text-white">{user.name || 'Usuario'}</div>
                        <div className="text-xs text-gray-500 dark:text-gray-400">{user.email || 'usuario@lotolink.com'}</div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Quick Actions */}
                <div className="p-4 border-b border-gray-100 dark:border-slate-800">
                  <button 
                    onClick={() => { setIsMobileMenuOpen(false); onOpenPlay(); }}
                    className="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/25"
                  >
                    üéüÔ∏è Jugar Ahora
                  </button>
                </div>
                
                {/* Navigation Links */}
                <nav className="p-2">
                  <div className="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider px-4 py-2">
                    Navegaci√≥n
                  </div>
                  {[
                    { icon: 'üè†', label: 'Inicio', view: 'home' },
                    { icon: '‚ùì', label: 'C√≥mo funciona', view: 'how' },
                    { icon: 'üó∫Ô∏è', label: 'Demo / Mapa', view: 'demo' },
                    { icon: 'üé∞', label: 'Loter√≠as', view: 'loterias' },
                    { icon: 'üè™', label: 'Bancas', view: 'bancas' },
                    { icon: 'üèÜ', label: 'Rankings', view: 'rankings' },
                    { icon: '‚≠ê', label: 'M√°s Jugados', view: 'masjugados' },
                  ].map(item => (
                    <button
                      key={item.view}
                      onClick={() => handleNavClick(item.view)}
                      className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all font-medium"
                    >
                      <span className="text-xl">{item.icon}</span>
                      <span>{item.label}</span>
                    </button>
                  ))}
                </nav>
                
                {/* Account Section */}
                <div className="p-2 border-t border-gray-100 dark:border-slate-800">
                  <div className="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider px-4 py-2">
                    Mi Cuenta
                  </div>
                  <button
                    onClick={() => handleNavClick('profile')}
                    className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all font-medium"
                  >
                    <span className="text-xl">üë§</span>
                    <span>Mi Perfil</span>
                  </button>
                  <button
                    onClick={() => { setIsMobileMenuOpen(false); onToggleCart(); }}
                    className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all font-medium"
                  >
                    <span className="text-xl">üõí</span>
                    <span>Mi Carrito</span>
                    {cartCount > 0 && (
                      <span className="ml-auto bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">{cartCount}</span>
                    )}
                  </button>
                  {registeredCard && (
                    <button
                      onClick={() => { setIsMobileMenuOpen(false); onManageCard(); }}
                      className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all font-medium"
                    >
                      <span className="text-xl">üí≥</span>
                      <span>Tarjetas ‚Ä¢‚Ä¢‚Ä¢{registeredCard.lastFour}</span>
                    </button>
                  )}
                </div>
                
                {/* Theme and Auth */}
                <div className="p-4 border-t border-gray-100 dark:border-slate-800 space-y-2">
                  <button
                    onClick={() => { setTheme(theme === 'dark' ? 'light' : 'dark'); }}
                    className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all font-medium"
                  >
                    <span className="text-xl">{theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}</span>
                    <span>{theme === 'dark' ? 'Modo Claro' : 'Modo Oscuro'}</span>
                  </button>
                  
                  {user ? (
                    <button
                      onClick={() => { setIsMobileMenuOpen(false); onLogout(); }}
                      className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all font-medium"
                    >
                      <span className="text-xl">üö™</span>
                      <span>Cerrar Sesi√≥n</span>
                    </button>
                  ) : (
                    <button
                      onClick={() => { setIsMobileMenuOpen(false); onLogin(); }}
                      className="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all font-medium"
                    >
                      <span className="text-xl">üîê</span>
                      <span>Iniciar Sesi√≥n</span>
                    </button>
                  )}
                </div>
                
                {/* Partner CTA */}
                <div className="p-4 border-t border-gray-100 dark:border-slate-800">
                  <button
                    onClick={() => handleNavClick('portal')}
                    className="w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl font-semibold flex items-center justify-center gap-2"
                  >
                    <span>üè™</span>
                    <span>¬øTienes una banca? √önete</span>
                  </button>
                </div>
                
                {/* App Version */}
                <div className="p-4 text-center text-xs text-gray-400 dark:text-gray-600">
                  LotoLink v1.0.0 ‚Ä¢ Premium
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    function Hero({ onPlay, onBanca }) {
      return (
        <section className="premium-card p-10 mt-8 mb-10 animate-fade-in">
          <div className="flex flex-col lg:flex-row items-center gap-12">
            <div className="flex-1">
              {/* Subtle Badge */}
              <div className="flex items-center gap-3 mb-6">
                <span className="trust-badge">
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                  </svg>
                  <span>100% Seguro</span>
                </span>
                <span className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-full text-xs font-medium text-gray-600 dark:text-gray-400">
                  <span className="w-1.5 h-1.5 bg-gray-400 dark:bg-gray-500 rounded-full"></span>
                  Luna IA
                </span>
              </div>
              
              {/* Headline */}
              <h1 className="text-5xl lg:text-6xl font-bold text-gray-900 dark:text-white leading-tight tracking-tight">
                Tu conexi√≥n con<br/>
                <span className="bg-gradient-to-r from-blue-600 to-blue-500 bg-clip-text text-transparent">la suerte</span>
              </h1>
              
              <p className="mt-6 text-xl text-gray-500 dark:text-gray-400 leading-relaxed max-w-lg">
                Juega en tus bancas favoritas desde la app, gestiona tus tickets y cobra al instante. 
                <span className="text-gray-700 dark:text-gray-300 font-medium">Luna, tu asistente IA,</span> te gu√≠a paso a paso.
              </p>
              
              {/* CTA Buttons */}
              <div className="mt-10 flex flex-col sm:flex-row gap-4">
                <button 
                  onClick={onPlay} 
                  className="btn-apple-primary text-lg px-8 py-4"
                >
                  Jugar Ahora
                  <span className="ml-2">‚Üí</span>
                </button>
                <button 
                  onClick={onBanca} 
                  className="btn-apple-secondary text-lg px-8 py-4"
                >
                  Soy una Banca
                </button>
              </div>
              
              {/* Trust Indicators */}
              <div className="mt-10 flex items-center gap-6 text-sm text-gray-400">
                <div className="flex items-center gap-2">
                  <span className="text-green-500">‚úì</span>
                  <span>Pagos seguros</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-green-500">‚úì</span>
                  <span>Cobro instant√°neo</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-green-500">‚úì</span>
                  <span>24/7 Soporte</span>
                </div>
              </div>
            </div>
            
            {/* Elegant App Preview - More subtle design */}
            <div className="w-full max-w-sm">
              <div className="relative">
                {/* Subtle Phone Frame */}
                <div className="bg-gray-900 dark:bg-gray-800 rounded-[2.5rem] p-2 shadow-2xl shadow-gray-900/20 dark:shadow-black/40">
                  <div className="bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-gray-900 rounded-[2rem] p-6 h-80 flex flex-col items-center justify-center border border-gray-100 dark:border-gray-700">
                    {/* App Icon */}
                    <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white text-3xl font-bold shadow-lg shadow-blue-500/30 mb-4">
                      L
                    </div>
                    <div className="text-xl font-semibold text-gray-900 dark:text-white mb-1">LotoLink</div>
                    <div className="text-sm text-gray-500 dark:text-gray-400">Tu suerte, en tus manos</div>
                    
                    {/* Subtle loading indicator */}
                    <div className="mt-6 flex gap-1.5">
                      <div className="w-2 h-2 bg-gray-300 dark:bg-gray-600 rounded-full animate-pulse"></div>
                      <div className="w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full animate-pulse" style={{animationDelay: '0.2s'}}></div>
                      <div className="w-2 h-2 bg-gray-500 dark:bg-gray-400 rounded-full animate-pulse" style={{animationDelay: '0.4s'}}></div>
                    </div>
                  </div>
                </div>
                
                {/* Subtle floating badge */}
                <div className="absolute -top-2 -right-2 w-12 h-12 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 flex items-center justify-center text-xl">
                  üéØ
                </div>
              </div>
            </div>
          </div>
        </section>
      );
    }

    /* --- Profile Constants --- */
    const PROFILE_CONFIG = {
      WIN_RATE_DIVISOR: 3,         // Demo: ~33% win rate (tickets where idSum % 3 === 0 win)
      PRIZE_MULTIPLIER: 5,         // Demo: Winners receive 5x their bet amount
      MAX_TRANSACTION_HISTORY: 100, // Maximum number of transactions to store
      HOURS_UNTIL_RESULT: 24,      // Hours after ticket creation before result is determined
      WINNING_CHECK_DELAY_MS: 1000 // Delay before checking for winning tickets on app load
    };

    /* --- Wallet/Ticket Download Helper --- */
    function downloadTicketForWallet(ticket, prizeMult, walletType = 'json') {
      const ticketData = {
        type: 'LotoLink Ticket',
        id: ticket.id,
        bank: ticket.bank,
        total: ticket.total,
        subtotal: ticket.subtotal || ticket.total,
        commission: ticket.commission || 0,
        paymentStatus: ticket.paymentStatus || 'paid',
        createdAt: ticket.createdAt,
        drawTime: ticket.drawTime,
        prize: prizeMult > 1 ? (ticket.total * prizeMult).toLocaleString('es-DO') : null,
        status: ticket.paymentStatus === 'pending' ? 'Pendiente de Pago en Sucursal' : 'Ticket Confirmado'
      };
      
      // Generate filename based on wallet type
      const fileExtension = walletType === 'pkpass' ? 'pkpass' : 'json';
      const mimeType = walletType === 'pkpass' ? 'application/vnd.apple.pkpass' : 'application/json';
      
      const blob = new Blob([JSON.stringify(ticketData, null, 2)], {type: mimeType});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `LotoLink-Ticket-${ticket.id}.${fileExtension}`;
      a.click();
      URL.revokeObjectURL(url);
    }

    /* --- Profile Helper Functions --- */
    function getTicketStatus(ticket) {
      // Simulated status based on creation time for demo purposes
      if (!ticket || !ticket.createdAt) return 'active';
      const created = new Date(ticket.createdAt);
      const now = new Date();
      const hoursSinceCreation = (now - created) / (1000 * 60 * 60);
      
      // Check if already collected
      if (ticket.collected) return 'collected';
      // After configured hours, deterministically decide if won or lost (for demo)
      if (hoursSinceCreation > PROFILE_CONFIG.HOURS_UNTIL_RESULT) {
        // Use ticket ID character codes to deterministically decide winner status
        // This creates a consistent ~33% win rate for demo purposes
        const idSum = ticket.id.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
        return idSum % PROFILE_CONFIG.WIN_RATE_DIVISOR === 0 ? 'won' : 'lost';
      }
      return 'active';
    }

    function getStatusBadge(status) {
      const badges = {
        'active': { text: 'ACTIVO', bg: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300' },
        'won': { text: 'GANADOR', bg: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300' },
        'lost': { text: 'NO GAN√ì', bg: 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400' },
        'collected': { text: 'COBRADO', bg: 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300' }
      };
      return badges[status] || badges['active'];
    }

    function calculatePrize(ticket) {
      // Prize calculation: multiplier applied to bet amount for winning tickets
      if (!ticket) return 0;
      return ticket.total * PROFILE_CONFIG.PRIZE_MULTIPLIER;
    }

    function Profile({ user, ticket, registeredCards = [], onManageCards }) {
      const [visible, setVisible] = useState(() => localStorage.getItem("ll_visible_rank") === "true");
      const [wins, setWins] = useState(() => Number(localStorage.getItem("ll_user_wins") || 1));
      const [balance, setBalance] = useState(() => Number(localStorage.getItem("ll_user_balance") || 0));
      const [hist, setHist] = useState(() => JSON.parse(localStorage.getItem("ll_history") || "[]"));
      const [profileView, setProfileView] = useState('overview'); // 'collect' | 'history' | 'overview' | 'wallet' | 'withdraw' | 'cards'
      const [historyFilter, setHistoryFilter] = useState('all'); // 'all' | 'active' | 'won' | 'lost' | 'collected'
      const [historyPage, setHistoryPage] = useState(1);
      const [collectingTicket, setCollectingTicket] = useState(null);
      const [viewingTicket, setViewingTicket] = useState(null); // For viewing full ticket with QR
      const [collectAtBanca, setCollectAtBanca] = useState(false); // For showing ticket QR for physical collection
      const [withdrawAmount, setWithdrawAmount] = useState('');
      const [withdrawMethod, setWithdrawMethod] = useState('bank');
      const [showFeedback, setShowFeedback] = useState({ type: '', message: '' });
      const ITEMS_PER_PAGE = 5;

      // Computed values (memoized to avoid redundant filtering)
      const activeTicketsCount = useMemo(() => hist.filter(t => getTicketStatus(t) === 'active').length, [hist]);

      // Persist balance changes
      useEffect(() => {
        localStorage.setItem("ll_user_balance", String(balance));
      }, [balance]);

      // Refresh history from localStorage
      const refreshHistory = () => {
        const freshHist = JSON.parse(localStorage.getItem("ll_history") || "[]");
        setHist(freshHist);
      };

      const toggleVisible = () => { 
        const n = !visible; 
        setVisible(n); 
        localStorage.setItem("ll_visible_rank", n ? "true" : "false"); 
        window.dispatchEvent(new Event('ll_rankings_update')); 
      };

      const saveWins = (e) => { 
        e.preventDefault(); 
        localStorage.setItem("ll_user_wins", String(wins)); 
        window.dispatchEvent(new Event('ll_rankings_update')); 
        showFeedbackMessage('success', '‚úì Victorias guardadas');
      };

      const showFeedbackMessage = (type, message) => {
        setShowFeedback({ type, message });
        setTimeout(() => setShowFeedback({ type: '', message: '' }), 3000);
      };

      // --- COLLECTION SYSTEM ---
      const collectPrize = (ticketId) => {
        const ticketToCollect = hist.find(h => h.id === ticketId);
        if (!ticketToCollect) return;
        
        const status = getTicketStatus(ticketToCollect);
        if (status !== 'won') {
          showFeedbackMessage('error', 'Este ticket no tiene premio para cobrar');
          return;
        }
        
        const prize = calculatePrize(ticketToCollect);
        
        // Update ticket as collected
        const updatedHist = hist.map(h => 
          h.id === ticketId ? { ...h, collected: true, collectedAt: new Date().toISOString(), prizeAmount: prize } : h
        );
        
        // Add to balance
        setBalance(prev => prev + prize);
        setHist(updatedHist);
        localStorage.setItem("ll_history", JSON.stringify(updatedHist));
        
        // Update wins count
        const newWins = wins + 1;
        setWins(newWins);
        localStorage.setItem("ll_user_wins", String(newWins));
        window.dispatchEvent(new Event('ll_rankings_update'));
        
        showFeedbackMessage('success', `üéâ ¬°Premio de RD$ ${prize.toLocaleString('es-DO')} cobrado exitosamente!`);
        setCollectingTicket(null);
        setProfileView('overview');
      };

      // --- WITHDRAWAL SYSTEM ---
      const handleWithdraw = (e) => {
        e.preventDefault();
        const amount = Number(withdrawAmount);
        
        if (isNaN(amount) || amount <= 0) {
          showFeedbackMessage('error', 'Ingresa un monto v√°lido');
          return;
        }
        
        if (amount > balance) {
          showFeedbackMessage('error', 'Saldo insuficiente');
          return;
        }
        
        if (amount < 100) {
          showFeedbackMessage('error', 'El monto m√≠nimo de retiro es RD$ 100');
          return;
        }
        
        // Process withdrawal (simulated)
        setBalance(prev => prev - amount);
        
        // Save transaction to history
        const transaction = {
          id: 'WD-' + Date.now().toString(36).toUpperCase(),
          type: 'withdrawal',
          amount: amount,
          method: withdrawMethod,
          createdAt: new Date().toISOString(),
          status: 'processed'
        };
        
        const transactions = JSON.parse(localStorage.getItem("ll_transactions") || "[]");
        transactions.unshift(transaction);
        localStorage.setItem("ll_transactions", JSON.stringify(transactions.slice(0, PROFILE_CONFIG.MAX_TRANSACTION_HISTORY)));
        
        const methodNames = {
          'bank': 'Transferencia Bancaria',
          'card': 'Tarjeta de D√©bito',
          'mobile': 'Billetera M√≥vil'
        };
        
        showFeedbackMessage('success', `‚úì Retiro de RD$ ${amount.toLocaleString('es-DO')} procesado v√≠a ${methodNames[withdrawMethod]}`);
        setWithdrawAmount('');
        setProfileView('overview');
      };

      // --- HISTORY FILTERING ---
      const filteredHistory = hist.filter(h => {
        if (historyFilter === 'all') return true;
        const status = getTicketStatus(h);
        return status === historyFilter;
      });

      const paginatedHistory = filteredHistory.slice(
        (historyPage - 1) * ITEMS_PER_PAGE,
        historyPage * ITEMS_PER_PAGE
      );

      const totalPages = Math.ceil(filteredHistory.length / ITEMS_PER_PAGE);

      // Calculate stats
      const wonTickets = hist.filter(h => getTicketStatus(h) === 'won' || getTicketStatus(h) === 'collected');
      const totalWinnings = wonTickets.reduce((sum, t) => sum + calculatePrize(t), 0);
      const pendingCollection = hist.filter(h => getTicketStatus(h) === 'won').reduce((sum, t) => sum + calculatePrize(t), 0);

      if (!user) return (
        <div className="mt-10 p-12 text-center premium-card animate-fade-in">
          <div className="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 rounded-3xl flex items-center justify-center text-4xl">
            üîí
          </div>
          <h3 className="text-2xl font-bold text-gray-900 dark:text-white">Acceso Restringido</h3>
          <p className="text-gray-500 dark:text-gray-400 mt-3 text-lg">Debes iniciar sesi√≥n para ver tu perfil.</p>
          <button className="btn-apple-primary mt-6">
            Iniciar Sesi√≥n
          </button>
        </div>
      );

      return (
        <section className="mt-8 animate-fade-in">
          {/* Profile Header */}
          <div className="text-center mb-10">
            <div className="w-24 h-24 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl flex items-center justify-center text-5xl shadow-lg shadow-blue-500/30">
              üë§
            </div>
            <h1 className="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">{user?.name || 'Mi Perfil'}</h1>
            <p className="text-gray-500 dark:text-gray-400 mt-2">{user?.email}</p>
            <div className="flex items-center justify-center gap-4 mt-4">
              <div className="trust-badge">
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                </svg>
                <span>Cuenta Verificada</span>
              </div>
            </div>
          </div>
          
          {/* Feedback Message */}
          {showFeedback.message && (
            <div className={`mb-6 p-4 rounded-2xl text-center font-medium animate-fade-in backdrop-blur-sm ${
              showFeedback.type === 'success' 
                ? 'bg-green-500/10 text-green-600 dark:text-green-400 border border-green-500/20' 
                : 'bg-red-500/10 text-red-600 dark:text-red-400 border border-red-500/20'
            }`}>
              {showFeedback.message}
            </div>
          )}

          {/* Premium Navigation Tabs */}
          <div className="flex flex-wrap gap-2 mb-8 justify-center p-2 bg-gray-100/80 dark:bg-white/5 rounded-2xl backdrop-blur-sm">
            <button 
              onClick={() => setProfileView('overview')}
              className={`px-5 py-2.5 rounded-xl font-medium text-sm transition-all duration-300 ${
                profileView === 'overview' 
                  ? 'bg-white dark:bg-white/10 text-blue-600 dark:text-blue-400 shadow-md' 
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              üìä Resumen
            </button>
            <button 
              onClick={() => { setProfileView('wallet'); refreshHistory(); }}
              className={`px-5 py-2.5 rounded-xl font-medium text-sm transition-all duration-300 flex items-center gap-2 ${
                profileView === 'wallet' 
                  ? 'bg-white dark:bg-white/10 text-indigo-600 dark:text-indigo-400 shadow-md' 
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              üíº Mi Cartera
              {activeTicketsCount > 0 && (
                <span className="bg-indigo-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{activeTicketsCount}</span>
              )}
            </button>
            <button 
              onClick={() => setProfileView('cards')}
              className={`px-5 py-2.5 rounded-xl font-medium text-sm transition-all duration-300 flex items-center gap-2 ${
                profileView === 'cards' 
                  ? 'bg-white dark:bg-white/10 text-blue-600 dark:text-blue-400 shadow-md' 
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              üí≥ Mis Tarjetas
              {registeredCards.length > 0 && (
                <span className="bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{registeredCards.length}</span>
              )}
            </button>
            <button 
              onClick={() => { setProfileView('history'); refreshHistory(); }}
              className={`px-5 py-2.5 rounded-xl font-medium text-sm transition-all duration-300 ${
                profileView === 'history' 
                  ? 'bg-white dark:bg-white/10 text-gray-900 dark:text-white shadow-md' 
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              üìú Historial
            </button>
            <button 
              onClick={() => { setProfileView('collect'); refreshHistory(); }}
              className={`px-5 py-2.5 rounded-xl font-medium text-sm transition-all duration-300 flex items-center gap-2 ${
                profileView === 'collect' 
                  ? 'bg-white dark:bg-white/10 text-green-600 dark:text-green-400 shadow-md' 
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              üí∞ Cobrar
              {pendingCollection > 0 && (
                <span className="bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse">{wonTickets.filter(t => getTicketStatus(t) === 'won').length}</span>
              )}
            </button>
            <button 
              onClick={() => setProfileView('withdraw')}
              className={`px-5 py-2.5 rounded-xl font-medium text-sm transition-all duration-300 ${
                profileView === 'withdraw' 
                  ? 'bg-white dark:bg-white/10 text-blue-600 dark:text-blue-400 shadow-md' 
                  : 'text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
              }`}
            >
              üè¶ Retirar
            </button>
          </div>

          {/* OVERVIEW VIEW */}
          {profileView === 'overview' && (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {/* Personal Data Card */}
              <div className="premium-card p-6">
                <div className="flex items-center gap-3 mb-6">
                  <div className="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center">
                    <span className="text-xl">üë§</span>
                  </div>
                  <h3 className="font-semibold text-lg text-gray-900 dark:text-white">Datos Personales</h3>
                </div>
                <div className="space-y-4 text-sm">
                  <div className="flex justify-between items-center p-3 bg-gray-50 dark:bg-white/5 rounded-xl">
                    <span className="text-gray-500 dark:text-gray-400">Nombre</span>
                    <span className="font-medium text-gray-900 dark:text-white">{user.name}</span>
                  </div>
                  <div className="flex justify-between items-center p-3 bg-gray-50 dark:bg-white/5 rounded-xl">
                    <span className="text-gray-500 dark:text-gray-400">Email</span>
                    <span className="font-medium text-gray-900 dark:text-white">{user.email}</span>
                  </div>
                </div>
                <div className="mt-6 pt-6 border-t border-gray-100 dark:border-white/10">
                  <h4 className="text-xs font-semibold uppercase text-gray-400 mb-4 tracking-wider">Privacidad</h4>
                  <div className="flex items-center justify-between mb-4 p-3 bg-gray-50 dark:bg-white/5 rounded-xl">
                    <span className="text-sm text-gray-700 dark:text-gray-300">Visible en Ranking</span>
                    <div onClick={toggleVisible} className={`toggle ${visible ? 'on' : ''}`}>
                      <div className="knob"></div>
                    </div>
                  </div>
                  <form onSubmit={saveWins} className="flex gap-3 items-center p-3 bg-gray-50 dark:bg-white/5 rounded-xl">
                    <span className="text-sm text-gray-500 dark:text-gray-400">Victorias</span>
                    <input 
                      type="number" 
                      min="1" 
                      value={wins} 
                      onChange={e => setWins(Number(e.target.value) || 1)} 
                      className="w-20 p-2 border border-gray-200 dark:border-white/10 rounded-xl text-center text-sm bg-white dark:bg-white/5 dark:text-white focus:ring-2 focus:ring-blue-500/30" 
                    />
                    <button type="submit" className="btn-apple-primary text-xs px-4 py-2">
                      Guardar
                    </button>
                  </form>
                </div>
              </div>

              {/* Recent Tickets Card */}
              <div className="premium-card p-6">
                <div className="flex justify-between items-center mb-6">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-indigo-500/10 rounded-xl flex items-center justify-center">
                      <span className="text-xl">üé´</span>
                    </div>
                    <h3 className="font-semibold text-lg text-gray-900 dark:text-white">Tickets Recientes</h3>
                  </div>
                  <button 
                    onClick={() => { setProfileView('wallet'); refreshHistory(); }}
                    className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 font-medium"
                  >
                    Ver todos ‚Üí
                  </button>
                </div>
                {hist.slice(0, 3).map(h => {
                  const status = getTicketStatus(h);
                  const badge = getStatusBadge(status);
                  return (
                    <div 
                      key={h.id} 
                      className="mb-3 p-4 bg-gray-50 dark:bg-white/5 rounded-xl cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-all duration-300"
                      onClick={() => setViewingTicket(h)}
                    >
                      <div className="flex justify-between items-center mb-1">
                        <span className={`text-xs font-bold px-2 py-0.5 rounded ${badge.bg}`}>{badge.text}</span>
                        <span className="text-xs font-mono dark:text-gray-400">#{h.id.slice(-5)}</span>
                      </div>
                      <div className="text-sm font-medium dark:text-white">{h.bank}</div>
                      <div className="flex justify-between items-center mt-1">
                        <div className="text-lg font-bold text-gray-800 dark:text-gray-200">RD$ {h.total}</div>
                        {status === 'won' && (
                          <button 
                            onClick={(e) => { e.stopPropagation(); setCollectingTicket(h); setProfileView('collect'); }}
                            className="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700"
                          >
                            Cobrar
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })}
                {hist.length === 0 && <p className="text-sm text-gray-400 italic text-center py-6">No tienes historial de tickets.</p>}
              </div>

              {/* Balance Card */}
              <div className="premium-card p-6 flex flex-col justify-center items-center text-center">
                <div className="w-20 h-20 bg-gradient-to-br from-green-400 to-emerald-600 rounded-3xl flex items-center justify-center text-4xl mb-4 shadow-lg shadow-green-500/30">
                  üí∞
                </div>
                <h3 className="font-semibold text-lg text-gray-900 dark:text-white">Saldo Disponible</h3>
                <p className="text-4xl font-bold bg-gradient-to-r from-green-500 to-emerald-600 bg-clip-text text-transparent my-3">
                  RD$ {balance.toLocaleString('es-DO')}
                </p>
                
                {pendingCollection > 0 && (
                  <div className="w-full p-4 bg-gradient-to-r from-amber-500/10 to-yellow-500/10 border border-amber-500/20 rounded-2xl mb-4">
                    <p className="text-sm text-amber-600 dark:text-amber-400 font-medium flex items-center justify-center gap-2">
                      <span className="text-lg">üèÜ</span>
                      Premios pendientes: <span className="font-bold">RD$ {pendingCollection.toLocaleString('es-DO')}</span>
                    </p>
                  </div>
                )}

                <div className="grid grid-cols-2 gap-3 w-full mt-2">
                  <button 
                    onClick={() => setProfileView('collect')}
                    className="bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-semibold text-sm shadow-lg shadow-green-500/30 hover:shadow-green-500/50 transition-all duration-300"
                  >
                    Cobrar Premio
                  </button>
                  <button 
                    onClick={() => setProfileView('withdraw')}
                    className="bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white py-3 rounded-xl font-semibold text-sm hover:bg-gray-200 dark:hover:bg-white/20 transition-all duration-300"
                  >
                    Retirar
                  </button>
                </div>

                {/* Quick Stats */}
                <div className="w-full mt-6 pt-6 border-t border-gray-100 dark:border-white/10">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-4 bg-blue-500/10 rounded-2xl">
                      <p className="text-3xl font-bold text-blue-600">{hist.length}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Total Tickets</p>
                    </div>
                    <div className="p-4 bg-green-500/10 rounded-2xl">
                      <p className="text-3xl font-bold text-green-600">{wonTickets.length}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Ganados</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* HISTORY VIEW */}
          {profileView === 'history' && (
            <div className="premium-card p-6">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center">
                    <span className="text-xl">üìú</span>
                  </div>
                  <h3 className="font-semibold text-xl text-gray-900 dark:text-white">Historial de Tickets</h3>
                </div>
                <div className="flex flex-wrap gap-2 p-1 bg-gray-100/80 dark:bg-white/5 rounded-xl">
                  {['all', 'active', 'won', 'lost', 'collected'].map(filter => (
                    <button
                      key={filter}
                      onClick={() => { setHistoryFilter(filter); setHistoryPage(1); }}
                      className={`px-4 py-2 rounded-lg text-xs font-medium transition-all duration-300 ${
                        historyFilter === filter 
                          ? 'bg-white dark:bg-white/10 text-blue-600 dark:text-blue-400 shadow-sm' 
                          : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'
                      }`}
                    >
                      {filter === 'all' ? 'Todos' : filter === 'active' ? 'Activos' : filter === 'won' ? 'Ganados' : filter === 'lost' ? 'Perdidos' : 'Cobrados'}
                    </button>
                  ))}
                </div>
              </div>

              {paginatedHistory.length === 0 ? (
                <div className="text-center py-8">
                  <p className="text-4xl mb-2">üé´</p>
                  <p className="text-gray-500 dark:text-gray-400">No hay tickets {historyFilter !== 'all' ? `con estado "${historyFilter}"` : 'en tu historial'}</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {paginatedHistory.map(h => {
                    const status = getTicketStatus(h);
                    const badge = getStatusBadge(status);
                    const prize = calculatePrize(h);
                    return (
                      <div 
                        key={h.id} 
                        className="p-4 bg-gray-50 dark:bg-slate-900 rounded-lg border dark:border-slate-700 cursor-pointer hover:shadow-md hover:border-blue-300 dark:hover:border-blue-600 transition"
                        onClick={() => setViewingTicket(h)}
                      >
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              <span className={`text-xs font-bold px-2 py-0.5 rounded ${badge.bg}`}>{badge.text}</span>
                              <span className="text-xs font-mono text-gray-500 dark:text-gray-400">#{h.id}</span>
                              <span className="text-xs text-blue-500 ml-auto">Ver ticket ‚Üí</span>
                            </div>
                            <p className="font-medium dark:text-white">{h.bank}</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                              {new Date(h.createdAt).toLocaleDateString('es-DO', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                            </p>
                            {h.plays && (
                              <div className="mt-2 flex flex-wrap gap-1">
                                {h.plays.slice(0, 3).map((p, i) => (
                                  <span key={i} className="text-xs bg-gray-200 dark:bg-slate-700 px-2 py-0.5 rounded">
                                    {p.type}: {Array.isArray(p.numbers) ? p.numbers.join('-') : p.numbers}
                                  </span>
                                ))}
                                {h.plays.length > 3 && <span className="text-xs text-gray-500">+{h.plays.length - 3} m√°s</span>}
                              </div>
                            )}
                          </div>
                          <div className="text-right">
                            <p className="text-lg font-bold dark:text-white">RD$ {h.total}</p>
                            {status === 'won' && (
                              <>
                                <p className="text-sm text-green-600 font-medium">Premio: RD$ {prize.toLocaleString('es-DO')}</p>
                                <button 
                                  onClick={(e) => { e.stopPropagation(); collectPrize(h.id); }}
                                  className="mt-2 text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
                                >
                                  üí∞ Cobrar Ahora
                                </button>
                              </>
                            )}
                            {status === 'collected' && (
                              <p className="text-sm text-purple-600 font-medium">
                                Cobrado: RD$ {(h.prizeAmount || prize).toLocaleString('es-DO')}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* Pagination */}
              {totalPages > 1 && (
                <div className="flex justify-center items-center gap-2 mt-6">
                  <button 
                    onClick={() => setHistoryPage(p => Math.max(1, p - 1))}
                    disabled={historyPage === 1}
                    className="px-3 py-1 rounded bg-gray-200 dark:bg-slate-700 disabled:opacity-50"
                  >
                    ‚Üê
                  </button>
                  <span className="text-sm dark:text-gray-300">P√°gina {historyPage} de {totalPages}</span>
                  <button 
                    onClick={() => setHistoryPage(p => Math.min(totalPages, p + 1))}
                    disabled={historyPage === totalPages}
                    className="px-3 py-1 rounded bg-gray-200 dark:bg-slate-700 disabled:opacity-50"
                  >
                    ‚Üí
                  </button>
                </div>
              )}
            </div>
          )}

          {/* COLLECT VIEW */}
          {profileView === 'collect' && (
            <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow border border-gray-100 dark:border-slate-700">
              <h3 className="font-bold text-xl mb-4 dark:text-white">üí∞ Cobrar Premios</h3>
              
              {collectingTicket ? (
                /* Confirmation Modal for specific ticket */
                <div className="max-w-md mx-auto">
                  <div className="p-6 bg-green-50 dark:bg-green-900/20 rounded-xl border-2 border-green-200 dark:border-green-700">
                    <div className="text-center mb-4">
                      <div className="text-4xl mb-2">üéâ</div>
                      <h4 className="text-xl font-bold text-green-700 dark:text-green-300">¬°Ticket Ganador!</h4>
                    </div>
                    <div className="space-y-2 text-sm mb-4">
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Ticket:</span>
                        <span className="font-mono font-bold dark:text-white">{collectingTicket.id}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Banca:</span>
                        <span className="font-medium dark:text-white">{collectingTicket.bank}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Apuesta:</span>
                        <span className="font-medium dark:text-white">RD$ {collectingTicket.total}</span>
                      </div>
                      <div className="flex justify-between pt-2 border-t dark:border-slate-600">
                        <span className="text-green-700 dark:text-green-300 font-bold">Premio:</span>
                        <span className="text-xl font-bold text-green-600">RD$ {calculatePrize(collectingTicket).toLocaleString('es-DO')}</span>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => collectPrize(collectingTicket.id)}
                        className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition"
                      >
                        ‚úì Confirmar Cobro
                      </button>
                      <button 
                        onClick={() => setCollectingTicket(null)}
                        className="px-4 py-3 bg-gray-200 dark:bg-slate-600 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-slate-500 transition"
                      >
                        Cancelar
                      </button>
                    </div>
                  </div>
                </div>
              ) : (
                /* List of winning tickets to collect */
                <>
                  {hist.filter(h => getTicketStatus(h) === 'won').length === 0 ? (
                    <div className="text-center py-8">
                      <p className="text-4xl mb-2">üé´</p>
                      <p className="text-gray-500 dark:text-gray-400 mb-4">No tienes premios pendientes por cobrar</p>
                      <p className="text-sm text-gray-400 dark:text-gray-500">Cuando ganes, tus premios aparecer√°n aqu√≠</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Tienes <span className="font-bold text-green-600">{hist.filter(h => getTicketStatus(h) === 'won').length}</span> premios pendientes por cobrar
                      </p>
                      {hist.filter(h => getTicketStatus(h) === 'won').map(h => {
                        const prize = calculatePrize(h);
                        return (
                          <div key={h.id} className="p-4 bg-green-50 dark:bg-green-900/10 rounded-lg border border-green-200 dark:border-green-800 flex justify-between items-center">
                            <div>
                              <p className="font-mono text-sm text-gray-600 dark:text-gray-400">#{h.id.slice(-8)}</p>
                              <p className="font-medium dark:text-white">{h.bank}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-400">Apuesta: RD$ {h.total}</p>
                            </div>
                            <div className="text-right">
                              <p className="text-lg font-bold text-green-600">RD$ {prize.toLocaleString('es-DO')}</p>
                              <button 
                                onClick={() => setCollectingTicket(h)}
                                className="mt-1 text-sm bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition"
                              >
                                Cobrar
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </>
              )}
            </div>
          )}

          {/* WITHDRAW VIEW */}
          {profileView === 'withdraw' && (
            <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow border border-gray-100 dark:border-slate-700 max-w-lg mx-auto">
              <h3 className="font-bold text-xl mb-4 dark:text-white">üè¶ Retirar Fondos</h3>
              
              <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg mb-6">
                <p className="text-sm text-gray-600 dark:text-gray-400">Saldo disponible</p>
                <p className="text-2xl font-bold text-blue-600">RD$ {balance.toLocaleString('es-DO')}</p>
              </div>

              {balance < 100 ? (
                <div className="text-center py-6">
                  <p className="text-4xl mb-2">üí≥</p>
                  <p className="text-gray-500 dark:text-gray-400">Necesitas al menos RD$ 100 para retirar</p>
                  <p className="text-sm text-gray-400 dark:text-gray-500 mt-2">Tu saldo actual: RD$ {balance.toLocaleString('es-DO')}</p>
                </div>
              ) : (
                <form onSubmit={handleWithdraw} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                      Monto a retirar (RD$)
                    </label>
                    <input
                      type="number"
                      value={withdrawAmount}
                      onChange={(e) => setWithdrawAmount(e.target.value)}
                      min="100"
                      max={balance}
                      placeholder="M√≠nimo RD$ 100"
                      className="w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-600"
                      required
                    />
                    <div className="flex gap-2 mt-2">
                      {[500, 1000, 2500].filter(v => v <= balance).map(amount => (
                        <button
                          key={amount}
                          type="button"
                          onClick={() => setWithdrawAmount(String(amount))}
                          className="px-3 py-1 text-xs bg-gray-100 dark:bg-slate-700 rounded hover:bg-gray-200 dark:hover:bg-slate-600 dark:text-gray-300"
                        >
                          RD$ {amount.toLocaleString('es-DO')}
                        </button>
                      ))}
                      <button
                        type="button"
                        onClick={() => setWithdrawAmount(String(balance))}
                        className="px-3 py-1 text-xs bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-900/50"
                      >
                        Todo
                      </button>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      M√©todo de retiro
                    </label>
                    <div className="grid grid-cols-1 gap-2">
                      {[
                        { id: 'bank', name: 'Transferencia Bancaria', icon: 'üè¶', desc: '1-2 d√≠as h√°biles' },
                        { id: 'card', name: 'Tarjeta de D√©bito', icon: 'üí≥', desc: 'Instant√°neo' },
                        { id: 'mobile', name: 'Billetera M√≥vil', icon: 'üì±', desc: 'Instant√°neo' }
                      ].map(method => (
                        <button
                          key={method.id}
                          type="button"
                          onClick={() => setWithdrawMethod(method.id)}
                          className={`p-3 rounded-lg border-2 text-left transition ${
                            withdrawMethod === method.id 
                              ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' 
                              : 'border-gray-200 dark:border-slate-600 hover:border-gray-300 dark:hover:border-slate-500'
                          }`}
                        >
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">{method.icon}</span>
                            <div>
                              <p className="font-medium dark:text-white">{method.name}</p>
                              <p className="text-xs text-gray-500 dark:text-gray-400">{method.desc}</p>
                            </div>
                            {withdrawMethod === method.id && (
                              <span className="ml-auto text-blue-600">‚úì</span>
                            )}
                          </div>
                        </button>
                      ))}
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={!withdrawAmount || Number(withdrawAmount) < 100 || Number(withdrawAmount) > balance}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Confirmar Retiro
                  </button>
                </form>
              )}
            </div>
          )}

          {/* CARDS VIEW - My Payment Cards */}
          {profileView === 'cards' && (
            <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow border border-gray-100 dark:border-slate-700">
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h3 className="font-bold text-xl dark:text-white">üí≥ Mis Tarjetas</h3>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Gestiona tus tarjetas de d√©bito y cr√©dito</p>
                </div>
                <button 
                  onClick={onManageCards}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition flex items-center gap-2"
                >
                  <span>‚ûï</span> Agregar Tarjeta
                </button>
              </div>

              {registeredCards.length === 0 ? (
                <div className="text-center py-12">
                  <p className="text-5xl mb-4">üí≥</p>
                  <p className="text-gray-500 dark:text-gray-400 text-lg">No tienes tarjetas registradas</p>
                  <p className="text-sm text-gray-400 dark:text-gray-500 mt-2">Agrega una tarjeta para poder pagar en la app</p>
                  <button 
                    onClick={onManageCards}
                    className="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition"
                  >
                    Agregar Primera Tarjeta
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  {registeredCards.map((card, index) => {
                    // Brand-specific styling
                    const brandStyles = {
                      'Visa': { gradient: 'from-blue-600 to-blue-800', icon: 'ùó©' },
                      'Mastercard': { gradient: 'from-red-500 to-orange-600', icon: '‚óâ‚óâ' },
                      'Tarjeta': { gradient: 'from-gray-500 to-gray-700', icon: 'üí≥' }
                    };
                    const style = brandStyles[card.brand] || brandStyles['Tarjeta'];
                    
                    return (
                      <div 
                        key={card.id} 
                        className="p-5 rounded-xl border-2 border-gray-200 dark:border-slate-600 hover:border-blue-300 dark:hover:border-blue-500 transition bg-gradient-to-r from-gray-50 to-white dark:from-slate-700 dark:to-slate-800"
                      >
                        <div className="flex justify-between items-start">
                          <div className="flex items-center gap-4">
                            <div className={`w-14 h-14 bg-gradient-to-br ${style.gradient} rounded-xl flex items-center justify-center text-white text-2xl shadow-lg font-bold`}>
                              {style.icon}
                            </div>
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="font-bold text-lg dark:text-white">{card.brand}</span>
                                {index === 0 && (
                                  <span className="text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full">Principal</span>
                                )}
                              </div>
                              <div className="text-sm font-mono text-gray-500 dark:text-gray-400 mt-1">
                                ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {card.lastFour}
                              </div>
                              {card.name && (
                              <div className="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                {card.name}
                              </div>
                            )}
                          </div>
                        </div>
                        <div className="text-right">
                          <p className="text-xs text-gray-400 dark:text-gray-500">
                            Registrada {new Date(card.registeredAt).toLocaleDateString('es-DO')}
                          </p>
                        </div>
                      </div>
                    </div>
                  );
                  })}
                  
                  <div className="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <div className="flex items-start gap-3">
                      <span className="text-blue-600 text-xl">‚ÑπÔ∏è</span>
                      <div className="text-sm text-blue-700 dark:text-blue-300">
                        <strong>Seguridad:</strong> Solo almacenamos los √∫ltimos 4 d√≠gitos de tus tarjetas. 
                        Nunca guardamos el n√∫mero completo ni el CVV.
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* WALLET VIEW - Digital Ticket Wallet */}
          {profileView === 'wallet' && (
            <div className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow border border-gray-100 dark:border-slate-700">
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h3 className="font-bold text-xl dark:text-white">üíº Mi Cartera Digital</h3>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Guarda tus tickets como en una billetera m√≥vil</p>
                </div>
                <div className="text-right">
                  <p className="text-2xl font-bold text-indigo-600">{activeTicketsCount}</p>
                  <p className="text-xs text-gray-500 dark:text-gray-400">Tickets Activos</p>
                </div>
              </div>

              {hist.length === 0 ? (
                <div className="text-center py-12">
                  <p className="text-5xl mb-4">üé´</p>
                  <p className="text-gray-500 dark:text-gray-400 text-lg">Tu cartera est√° vac√≠a</p>
                  <p className="text-sm text-gray-400 dark:text-gray-500 mt-2">Cuando juegues, tus tickets aparecer√°n aqu√≠</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {hist.slice(0, 9).map(h => {
                    const status = getTicketStatus(h);
                    const badge = getStatusBadge(status);
                    const statusColors = {
                      'active': 'border-blue-400 bg-gradient-to-br from-blue-50 to-white dark:from-blue-900/20 dark:to-slate-900',
                      'won': 'border-green-400 bg-gradient-to-br from-green-50 to-white dark:from-green-900/20 dark:to-slate-900',
                      'lost': 'border-gray-300 bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-slate-900 opacity-60',
                      'collected': 'border-purple-400 bg-gradient-to-br from-purple-50 to-white dark:from-purple-900/20 dark:to-slate-900'
                    };
                    return (
                      <button 
                        key={h.id}
                        onClick={() => setViewingTicket(h)}
                        className={`p-4 rounded-xl border-2 text-left transition hover:shadow-lg hover:scale-[1.02] ${statusColors[status] || statusColors['active']}`}
                      >
                        <div className="flex justify-between items-start mb-2">
                          <span className={`text-xs font-bold px-2 py-1 rounded ${badge.bg}`}>{badge.text}</span>
                          <span className="text-xs text-gray-400">#{h.id.slice(-6)}</span>
                        </div>
                        <div className="text-lg font-bold dark:text-white mb-1">RD$ {h.total}</div>
                        <div className="text-xs text-gray-600 dark:text-gray-400">{h.bank}</div>
                        <div className="text-xs text-gray-400 mt-2">
                          {new Date(h.createdAt).toLocaleDateString('es-DO', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                        </div>
                        <div className="mt-3 text-center text-xs text-indigo-600 dark:text-indigo-400 font-medium">
                          Toca para ver ticket completo ‚Üí
                        </div>
                      </button>
                    );
                  })}
                </div>
              )}
              
              {hist.length > 9 && (
                <div className="text-center mt-6">
                  <button 
                    onClick={() => setProfileView('history')}
                    className="text-indigo-600 dark:text-indigo-400 text-sm font-medium hover:underline"
                  >
                    Ver todos los tickets ({hist.length}) ‚Üí
                  </button>
                </div>
              )}
            </div>
          )}

          {/* TICKET DETAIL MODAL - Full ticket view with QR */}
          {viewingTicket && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
              <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-auto">
                {/* Ticket Header with Status */}
                {(() => {
                  const status = getTicketStatus(viewingTicket);
                  const badge = getStatusBadge(status);
                  const prize = calculatePrize(viewingTicket);
                  const statusBg = {
                    'active': 'bg-blue-600',
                    'won': 'bg-green-600',
                    'lost': 'bg-gray-500',
                    'collected': 'bg-purple-600'
                  };
                  return (
                    <>
                      <div className={`${statusBg[status] || statusBg['active']} p-4 text-white text-center rounded-t-2xl`}>
                        <div className="text-3xl mb-2">
                          {status === 'active' && 'üé´'}
                          {status === 'won' && 'üèÜ'}
                          {status === 'lost' && 'üòî'}
                          {status === 'collected' && '‚úÖ'}
                        </div>
                        <div className="text-xl font-bold">{badge.text}</div>
                        <div className="text-sm opacity-90">
                          {status === 'active' && 'Ticket pendiente de resultado'}
                          {status === 'won' && `¬°Ganaste RD$ ${prize.toLocaleString('es-DO')}!`}
                          {status === 'lost' && 'Este ticket no result√≥ ganador'}
                          {status === 'collected' && `Premio de RD$ ${(viewingTicket.prizeAmount || prize).toLocaleString('es-DO')} cobrado`}
                        </div>
                      </div>
                      
                      <div className="p-6">
                        {/* Ticket Info */}
                        <div className="text-center mb-4">
                          <h2 className="text-xl font-bold dark:text-white">LotoLink Ticket</h2>
                          <p className="text-xs text-gray-500 dark:text-gray-400 font-mono">ID: {viewingTicket.id}</p>
                          <p className="text-xs text-gray-500 dark:text-gray-400">
                            {new Date(viewingTicket.createdAt).toLocaleString('es-DO')}
                          </p>
                        </div>

                        {/* Plays */}
                        <div className="border-t border-b border-dashed border-gray-300 dark:border-gray-600 py-4 my-4 space-y-2">
                          {viewingTicket.plays && viewingTicket.plays.map((p, i) => (
                            <div key={i} className="flex justify-between text-sm dark:text-gray-200">
                              <span className="font-mono">{p.type || 'Jugada'}</span>
                              <span className="font-mono font-bold">[{p.numbers ? (Array.isArray(p.numbers) ? p.numbers.join('-') : p.numbers) : '--'}]</span>
                              <span className="font-bold">RD${p.amount || 0}</span>
                            </div>
                          ))}
                        </div>

                        {/* Banca & Total */}
                        <div className="text-sm mb-2 dark:text-gray-300">
                          <div className="flex justify-between">
                            <span>Banca:</span>
                            <span className="font-semibold">{viewingTicket.bank}</span>
                          </div>
                        </div>
                        <div className="text-xl font-bold text-center mb-4 text-green-600">
                          Total: RD$ {viewingTicket.total}
                        </div>

                        {/* QR Code */}
                        <div className="flex justify-center mb-4 bg-white p-4 rounded-lg">
                          <QRImage 
                            value={JSON.stringify({
                              id: viewingTicket.id, 
                              total: viewingTicket.total, 
                              status: status,
                              bank: viewingTicket.bank
                            })} 
                            size={150} 
                          />
                        </div>
                        <p className="text-xs text-gray-400 text-center mb-4">
                          Escanea para validar ‚Ä¢ Guarda en tu wallet
                        </p>

                        {/* Action Buttons */}
                        <div className="grid grid-cols-2 gap-3">
                          {status === 'won' && !collectAtBanca && (
                            <>
                              <button 
                                onClick={() => { collectPrize(viewingTicket.id); setViewingTicket(null); }}
                                className="col-span-2 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2"
                              >
                                <span>üí≥</span> Cobrar a mi Tarjeta
                              </button>
                              <p className="col-span-2 text-xs text-center text-gray-500 dark:text-gray-400 -mt-2">
                                Dep√≥sito directo a tu tarjeta registrada
                              </p>
                              <button 
                                onClick={() => setCollectAtBanca(true)}
                                className="col-span-2 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 flex items-center justify-center gap-2"
                              >
                                <span>üè™</span> Cobrar en Efectivo (Sucursal)
                              </button>
                            </>
                          )}
                          {collectAtBanca && status === 'won' && (
                            <div className="col-span-2 space-y-4">
                              <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-700">
                                <p className="text-center text-indigo-700 dark:text-indigo-300 font-medium mb-2">
                                  üìç Presenta este QR en la sucursal
                                </p>
                                <p className="text-xs text-center text-indigo-600 dark:text-indigo-400 mb-3">
                                  El encargado escanear√° tu ticket para entregarte el premio en efectivo
                                </p>
                                
                                {/* Wallet Save Options */}
                                <div className="space-y-2 mt-4 pt-4 border-t border-indigo-200 dark:border-indigo-700">
                                  <p className="text-xs font-medium text-indigo-700 dark:text-indigo-300 text-center mb-2">
                                    üíº Guardar ticket para cobrar despu√©s:
                                  </p>
                                  <div className="grid grid-cols-2 gap-2">
                                    <button 
                                      onClick={() => downloadTicketForWallet(viewingTicket, PROFILE_CONFIG.PRIZE_MULTIPLIER)}
                                      className="bg-black text-white py-2 px-3 rounded-lg text-xs font-medium flex items-center justify-center gap-1"
                                    >
                                      üçé Apple Wallet
                                    </button>
                                    <button 
                                      onClick={() => downloadTicketForWallet(viewingTicket, PROFILE_CONFIG.PRIZE_MULTIPLIER)}
                                      className="bg-blue-700 text-white py-2 px-3 rounded-lg text-xs font-medium flex items-center justify-center gap-1"
                                    >
                                      üì± Samsung/Google
                                    </button>
                                  </div>
                                  <button 
                                    onClick={() => window.print()}
                                    className="w-full bg-gray-200 dark:bg-slate-600 text-gray-700 dark:text-white py-2 rounded-lg text-xs font-medium"
                                  >
                                    üñ®Ô∏è Imprimir Ticket
                                  </button>
                                </div>
                              </div>
                              <button 
                                onClick={() => setCollectAtBanca(false)}
                                className="w-full text-sm text-indigo-600 dark:text-indigo-400 hover:underline"
                              >
                                ‚Üê Volver a opciones de cobro
                              </button>
                            </div>
                          )}
                          {!collectAtBanca && (
                            <>
                              <button 
                                onClick={() => window.print()}
                                className="bg-slate-900 dark:bg-slate-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-slate-700"
                              >
                                üñ®Ô∏è Imprimir
                              </button>
                              <button 
                                onClick={() => { setViewingTicket(null); setCollectAtBanca(false); }}
                                className="border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 dark:hover:bg-slate-700"
                              >
                                Cerrar
                              </button>
                            </>
                          )}
                          {collectAtBanca && (
                            <button 
                              onClick={() => { setViewingTicket(null); setCollectAtBanca(false); }}
                              className="col-span-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 dark:hover:bg-slate-700"
                            >
                              Cerrar
                            </button>
                          )}
                        </div>

                        {/* Add to Wallet hint */}
                        {!collectAtBanca && (
                          <div className="mt-4 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                            <p className="text-xs text-center text-gray-500 dark:text-gray-400">
                              üí° <strong>Tip:</strong> Toma captura de pantalla para guardar en tu wallet del tel√©fono
                            </p>
                          </div>
                        )}
                      </div>
                    </>
                  );
                })()}
              </div>
            </div>
          )}
        </section>
      );
    }

    /* --- MAIN APP LOGIC --- */
    function LotoLinkApp() {
      const [view, setView] = useState("home");
      const [user, setUser] = useState(() => JSON.parse(localStorage.getItem("ll_user") || "null"));
      const [cart, setCart] = useState(() => JSON.parse(localStorage.getItem("ll_cart") || "[]"));
      const [cartBanca, setCartBanca] = useState(() => JSON.parse(localStorage.getItem("ll_cart_banca") || "null")); // Single-banca cart enforcement
      const [showBancaConflictModal, setShowBancaConflictModal] = useState(false);
      const [pendingPlay, setPendingPlay] = useState(null);
      const [ticket, setTicket] = useState(null);
      const [selectedBank, setSelectedBank] = useState(DEFAULT_BANKS[0]);
      const [bancasViewMode, setBancasViewMode] = useState('list'); // 'list' | 'map'
      const [bancasFocusBank, setBancasFocusBank] = useState(null); // Bank to focus on in map view
      const [showPlayModal, setShowPlayModal] = useState(false);
      const [playModalStep, setPlayModalStep] = useState('lottery'); // 'lottery' | 'modality' | 'play'
      const [playModalLottery, setPlayModalLottery] = useState(null);
      const [playModalModality, setPlayModalModality] = useState(null);
      const [playModalNumbers, setPlayModalNumbers] = useState([]); // Selected numbers
      const [playModalStake, setPlayModalStake] = useState(10); // Stake amount
      const [showAuthModal, setShowAuthModal] = useState(false);
      const [isCartOpen, setIsCartOpen] = useState(false);
      const [theme, setTheme] = useState(() => localStorage.getItem('ll_theme') || 'light');
      
      // Real-time lottery results from loteriasdominicanas.com
      const { feed: resultsFeed, isConnected: isLotteryConnected, lastUpdate: lotteryLastUpdate } = useLotteryResults(30000);
      
      // NEW: Card registration and winning tickets notification system
      const [registeredCards, setRegisteredCards] = useState(() => JSON.parse(localStorage.getItem("ll_registered_cards") || "[]"));
      const [selectedCardIndex, setSelectedCardIndex] = useState(0);
      const registeredCard = registeredCards.length > 0 ? registeredCards[selectedCardIndex] : null;
      const [showCardRegistration, setShowCardRegistration] = useState(false);
      const [showCardManagement, setShowCardManagement] = useState(false); // New: Card management modal
      const [showWinningTicketsModal, setShowWinningTicketsModal] = useState(false);
      const [winningTickets, setWinningTickets] = useState([]);
      const [cardForm, setCardForm] = useState({ number: '', expiry: '', cvv: '', name: '' });
      
      // NEW: Payment options and checkout flow
      const [showPaymentOptions, setShowPaymentOptions] = useState(false);
      const [paymentMethod, setPaymentMethod] = useState('app'); // 'app' | 'branch'
      const [showTicketConfirmation, setShowTicketConfirmation] = useState(false);
      const [confirmedTicket, setConfirmedTicket] = useState(null);
      
      // App commission configuration
      const APP_COMMISSION_RATE = 0.07; // 7% commission

      // Voice Assistant state - Natural language AI with personality, context memory, and varied responses
      const [isVoiceAssistantOpen, setIsVoiceAssistantOpen] = useState(false);
      const [isListening, setIsListening] = useState(false);
      const [voiceMessage, setVoiceMessage] = useState('');
      const [assistantResponse, setAssistantResponse] = useState('');
      const [isSpeaking, setIsSpeaking] = useState(false);
      const [isThinking, setIsThinking] = useState(false); // AI processing animation
      const [conversationHistory, setConversationHistory] = useState([]); // Context memory
      const [showWelcomeScreen, setShowWelcomeScreen] = useState(() => {
        // Show welcome screen only on first visit or if user hasn't dismissed it
        const hasSeenWelcome = localStorage.getItem('ll_has_seen_welcome');
        return !hasSeenWelcome;
      });
      const [welcomeStep, setWelcomeStep] = useState(0); // 0: loading, 1: greeting, 2: ask action
      const [assistantMode, setAssistantMode] = useState('idle'); // 'idle' | 'guided_play' | 'select_banca' | 'select_lottery' | 'select_modality' | 'select_numbers'
      const [guidedPlayData, setGuidedPlayData] = useState({ banca: null, lottery: null, modality: null, numbers: [] });
      
      // AI Assistant configuration constants - Enhanced for LLM and TTS Integration
      const AI_CONFIG = {
        MAX_CONVERSATION_HISTORY: 20,
        MIN_THINKING_TIME_MS: 300,
        MAX_THINKING_TIME_MS: 800,
        SPEECH_RATE: 0.95,
        SPEECH_PITCH: 1.05,
        
        // LLM Integration Settings (for future GPT-5 or similar API integration)
        LLM_ENDPOINT: '/api/ai/chat',  // Backend endpoint for LLM requests
        LLM_MODEL: 'gpt-5',            // Target model
        LLM_MAX_TOKENS: 150,           // Max response length
        LLM_TEMPERATURE: 0.7,          // Response creativity (0-1)
        
        // Text-to-Speech (TTS) Settings - Configurable voice options
        TTS_ENABLED: true,
        TTS_PROVIDER: 'browser',       // 'browser' | 'google_wavenet' | 'amazon_polly'
        TTS_VOICE_GENDER: 'female',    // 'male' | 'female'
        TTS_VOICE_ACCENT: 'es-ES',     // Spanish (Spain), 'es-MX' for Mexico, 'es-DO' for Dominican
        TTS_VOICE_NAME: null,          // Auto-selected based on gender/accent
        TTS_VOLUME: 1.0,               // 0.0 to 1.0
        TTS_RATE_SLOW: 0.8,
        TTS_RATE_NORMAL: 0.95,
        TTS_RATE_FAST: 1.2,
        
        // Backend API Settings
        API_BASE_URL: '/api',
        API_TIMEOUT_MS: 10000,
        
        // Privacy and Security
        ANONYMIZE_USER_DATA: true,
        LOG_CONVERSATIONS: false,
        ENCRYPTION_ENABLED: true
      };
      
      // AI Voice Preferences State
      const [voiceSettings, setVoiceSettings] = useState({
        enabled: true,
        gender: 'female',
        accent: 'es-ES',
        speed: 'normal',
        volume: 1.0
      });
      
      // Available voices cache
      const [availableVoices, setAvailableVoices] = useState([]);
      
      // Load available TTS voices
      useEffect(() => {
        const loadVoices = () => {
          if ('speechSynthesis' in window) {
            const voices = window.speechSynthesis.getVoices();
            const spanishVoices = voices.filter(v => v.lang.startsWith('es'));
            setAvailableVoices(spanishVoices);
          }
        };
        loadVoices();
        if ('speechSynthesis' in window) {
          window.speechSynthesis.onvoiceschanged = loadVoices;
        }
      }, []);
      
      const [assistantPersonality] = useState({
        name: 'Luna',
        greeting: '¬°Hola! Soy Luna, tu asistente inteligente de LotoLink.',
        traits: ['amigable', 'servicial', 'entusiasta']
      });

      // Welcome screen animation effect
      useEffect(() => {
        if (showWelcomeScreen) {
          // Step 0: Loading animation (1.5s)
          const timer1 = setTimeout(() => setWelcomeStep(1), 1500);
          // Step 1: Greeting (speak after 2s)
          const timer2 = setTimeout(() => {
            setWelcomeStep(2);
            speakText('¬°Hola! Soy Luna, tu asistente inteligente de LotoLink. ¬øQu√© te gustar√≠a hacer hoy?');
          }, 2500);
          return () => { clearTimeout(timer1); clearTimeout(timer2); };
        }
      }, [showWelcomeScreen]);

      // Check for winning tickets on app load
      useEffect(() => {
        const checkWinningTickets = () => {
          const history = JSON.parse(localStorage.getItem("ll_history") || "[]");
          const winners = history.filter(t => {
            const status = getTicketStatus(t);
            return status === 'won';
          });
          if (winners.length > 0 && user) {
            setWinningTickets(winners);
            setShowWinningTicketsModal(true);
          }
        };
        // Check after configured delay to allow app to load
        const timer = setTimeout(checkWinningTickets, PROFILE_CONFIG.WINNING_CHECK_DELAY_MS);
        return () => clearTimeout(timer);
      }, [user]);

      // Persist registered cards (only non-sensitive display info)
      useEffect(() => {
        localStorage.setItem("ll_registered_cards", JSON.stringify(registeredCards));
      }, [registeredCards]);

      const registerCard = () => {
        // Basic validation
        if (!cardForm.number || !cardForm.expiry || !cardForm.cvv || !cardForm.name) return;
        if (cardForm.number.length < 16) return;
        if (cardForm.cvv.length < 3) return;
        
        // Only store non-sensitive display information (no CVV, no full card number)
        const maskedCard = {
          id: 'CARD-' + Date.now().toString(36).toUpperCase(),
          lastFour: cardForm.number.slice(-4),
          brand: cardForm.number.startsWith('4') ? 'Visa' : cardForm.number.startsWith('5') ? 'Mastercard' : 'Tarjeta',
          name: cardForm.name,
          registeredAt: new Date().toISOString()
        };
        setRegisteredCards(prev => [...prev, maskedCard]);
        setSelectedCardIndex(registeredCards.length); // Select the new card
        setShowCardRegistration(false);
        setShowCardManagement(false);
        setCardForm({ number: '', expiry: '', cvv: '', name: '' });
      };
      
      const deleteCard = (cardId) => {
        const updatedCards = registeredCards.filter(c => c.id !== cardId);
        setRegisteredCards(updatedCards);
        if (selectedCardIndex >= updatedCards.length) {
          setSelectedCardIndex(Math.max(0, updatedCards.length - 1));
        }
      };

      // Voice Assistant Functions - Enhanced TTS with configurable voice options
      const speakText = (text) => {
        // Check if TTS is enabled in settings
        if (!voiceSettings.enabled || !AI_CONFIG.TTS_ENABLED) {
          console.log('TTS disabled:', text);
          return;
        }
        
        if ('speechSynthesis' in window) {
          // Cancel any ongoing speech before starting new one
          if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
          }
          
          const utterance = new SpeechSynthesisUtterance(text);
          
          // Configure language/accent based on settings
          utterance.lang = voiceSettings.accent || AI_CONFIG.TTS_VOICE_ACCENT;
          
          // Configure speech rate based on settings
          const rates = {
            'slow': AI_CONFIG.TTS_RATE_SLOW,
            'normal': AI_CONFIG.TTS_RATE_NORMAL,
            'fast': AI_CONFIG.TTS_RATE_FAST
          };
          utterance.rate = rates[voiceSettings.speed] || AI_CONFIG.SPEECH_RATE;
          
          // Configure pitch and volume
          utterance.pitch = AI_CONFIG.SPEECH_PITCH;
          utterance.volume = voiceSettings.volume || AI_CONFIG.TTS_VOLUME;
          
          // Select appropriate voice based on gender preference
          // Uses a robust matching approach that works across browsers/OS
          if (availableVoices.length > 0) {
            // Common Spanish voice name patterns by gender (cross-browser compatible)
            const femalePatterns = [
              'female', 'mujer', 'femenin', 'woman',
              // Common Spanish female voice names across platforms
              'paulina', 'm√≥nica', 'monica', 'helena', 'conchita', 
              'lucia', 'carmen', 'rosa', 'maria', 'elena', 'sara',
              'google espa√±ol', 'microsoft helena', 'microsoft laura'
            ];
            const malePatterns = [
              'male', 'hombre', 'masculin', 'man',
              // Common Spanish male voice names across platforms
              'jorge', 'diego', 'enrique', 'pablo', 'carlos', 'juan',
              'antonio', 'andres', 'miguel', 'pedro',
              'microsoft pablo'
            ];
            
            const patterns = voiceSettings.gender === 'female' ? femalePatterns : malePatterns;
            
            // First, try to find a voice matching the selected accent
            let preferredVoice = availableVoices.find(v => {
              const voiceName = v.name.toLowerCase();
              const voiceLang = v.lang.toLowerCase();
              const matchesGender = patterns.some(p => voiceName.includes(p));
              const matchesAccent = voiceLang === voiceSettings.accent.toLowerCase();
              return matchesGender && matchesAccent;
            });
            
            // If no match with accent, try gender only
            if (!preferredVoice) {
              preferredVoice = availableVoices.find(v => {
                const voiceName = v.name.toLowerCase();
                return patterns.some(p => voiceName.includes(p));
              });
            }
            
            // Fallback to first available voice
            utterance.voice = preferredVoice || availableVoices[0];
          }
          
          utterance.onstart = () => setIsSpeaking(true);
          utterance.onend = () => setIsSpeaking(false);
          utterance.onerror = () => setIsSpeaking(false);
          
          window.speechSynthesis.speak(utterance);
        } else {
          // Fallback: just show the text without speaking
          console.log('Speech synthesis not supported');
        }
      };
      
      // LLM API Service - For future GPT-5 or similar integration
      const callLLMService = async (userMessage, conversationContext) => {
        // This is the structure for future LLM API integration
        // Currently uses local pattern matching, but ready for API upgrade
        
        const requestPayload = {
          model: AI_CONFIG.LLM_MODEL,
          messages: [
            {
              role: 'system',
              content: `Eres Luna, una asistente virtual amigable y entusiasta para la app de loter√≠a LotoLink. 
                Tu objetivo es guiar a los usuarios a trav√©s del proceso de juego de loter√≠a, desde la bienvenida 
                hasta la selecci√≥n final de n√∫meros. Mant√©n un tono c√°lido y servicial. Las loter√≠as disponibles 
                son: Leidsa, Loteka, La Primera, y Loter√≠a Nacional. Las modalidades de juego son: Quiniela (1 n√∫mero), 
                Pal√© (2 n√∫meros), y Tripleta (3 n√∫meros). Responde siempre en espa√±ol.`
            },
            ...conversationContext.map(msg => ({
              role: msg.role,
              content: msg.message
            })),
            {
              role: 'user',
              content: userMessage
            }
          ],
          max_tokens: AI_CONFIG.LLM_MAX_TOKENS,
          temperature: AI_CONFIG.LLM_TEMPERATURE
        };
        
        // For production: Uncomment and configure actual API call
        /*
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), AI_CONFIG.API_TIMEOUT_MS);
          
          // getSecureToken should be implemented to retrieve API token securely
          // Example: return sessionStorage.getItem('ai_api_token') or fetch from secure backend
          const getSecureToken = () => {
            // In production, implement secure token retrieval
            // Never hard-code tokens in client-side code
            return sessionStorage.getItem('ll_ai_token') || '';
          };
          
          const response = await fetch(AI_CONFIG.API_BASE_URL + AI_CONFIG.LLM_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${getSecureToken()}`
            },
            body: JSON.stringify(requestPayload),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) throw new Error('LLM API error');
          
          const data = await response.json();
          return {
            success: true,
            response: data.choices[0].message.content,
            intent: data.intent || 'general'
          };
        } catch (error) {
          console.error('LLM API error:', error);
          return {
            success: false,
            response: null,
            error: error.message
          };
        }
        */
        
        // Current fallback: return null to use local pattern matching
        return { success: false, response: null };
      };
      
      // Context Manager - Maintains conversation state and user preferences
      const contextManager = {
        getFullContext: () => ({
          user: user ? { name: user.name } : null,
          selectedBanca: selectedBank,
          currentView: view,
          assistantMode: assistantMode,
          guidedPlayData: guidedPlayData,
          conversationHistory: conversationHistory.slice(-AI_CONFIG.MAX_CONVERSATION_HISTORY)
        }),
        
        summarizeContext: () => {
          const ctx = contextManager.getFullContext();
          let summary = '';
          if (ctx.user) summary += `Usuario: ${ctx.user.name}. `;
          if (ctx.selectedBanca) summary += `Banca: ${ctx.selectedBanca.name}. `;
          if (ctx.guidedPlayData.lottery) summary += `Loter√≠a: ${ctx.guidedPlayData.lottery}. `;
          if (ctx.guidedPlayData.modality) summary += `Modalidad: ${ctx.guidedPlayData.modality}. `;
          return summary;
        }
      };

      // Natural language AI response generator with varied responses
      const generateNaturalResponse = (intent, context = {}) => {
        const responses = {
          greeting: [
            '¬°Hola! Qu√© gusto saludarte. ¬øEn qu√© puedo ayudarte hoy?',
            '¬°Hey! Soy Luna, tu asistente. ¬øQu√© necesitas?',
            '¬°Buenas! Estoy aqu√≠ para ayudarte. ¬øQu√© quieres hacer?'
          ],
          play_start: [
            '¬°Excelente! Me encanta tu esp√≠ritu de suerte. Vamos a jugar juntos. Tu banca m√°s cercana es {banca}. ¬øTe parece bien jugar ah√≠?',
            '¬°Genial! Vamos a probar suerte. He encontrado que {banca} est√° cerca de ti. ¬øJugamos ah√≠?',
            '¬°Perfecto! Me emociona ayudarte a jugar. La banca m√°s cercana es {banca}. ¬øQu√© dices?'
          ],
          select_lottery: [
            'Muy bien, ya tenemos la banca. Ahora cu√©ntame, ¬øa qu√© loter√≠a te gustar√≠a jugar? Tenemos Leidsa, Loteka, La Primera y Loter√≠a Nacional.',
            'Perfecto. ¬øCu√°l es tu loter√≠a favorita? Puedes elegir entre Leidsa, Loteka, La Primera o la Nacional.',
            'Excelente elecci√≥n de banca. Ahora dime, ¬øcu√°l loter√≠a te llama hoy?'
          ],
          select_modality: [
            'Buena elecci√≥n con {lottery}. ¬øQu√© tipo de juego prefieres? Puede ser Quiniela, Pal√© o Tripleta.',
            'Me gusta {lottery}. Ahora cu√©ntame, ¬øvas por Quiniela, Pal√© o Tripleta?',
            '{lottery}, excelente. ¬øC√≥mo quieres jugar? ¬øQuiniela para un n√∫mero, Pal√© para dos, o Tripleta para tres?'
          ],
          select_numbers: [
            'Ya casi terminamos. Ahora viene lo m√°s importante: ¬øcu√°les son tus n√∫meros de la suerte?',
            'Perfecto, modalidad {modality}. ¬øCu√°les n√∫meros sientes que van a salir hoy?',
            'Muy bien. Dime los n√∫meros que quieres jugar. Puedes decirlos o dictarlos uno a uno.'
          ],
          confirm_play: [
            '¬°Listo! He preparado tu jugada. Revisa los detalles en el panel y confirma cuando est√©s listo.',
            'Tu jugada est√° lista. Dale un vistazo al resumen y conf√≠rmala si todo est√° bien.',
            '¬°Perfecto! Ya tengo todo. Revisa tu boleto y confirma para procesar.'
          ],
          go_profile: [
            'Claro, te llevo a tu perfil. Ah√≠ puedes ver tu historial, premios y cartera digital.',
            'Por supuesto. Vamos a tu perfil donde est√° toda tu informaci√≥n.',
            'Entendido. Tu perfil te espera con todos tus datos.'
          ],
          go_bancas: [
            'Te muestro las bancas cercanas. Puedes ver cu√°les est√°n abiertas ahora.',
            'Aqu√≠ tienes el mapa de bancas. Las m√°s cercanas aparecen primero.',
            'Vamos a ver las sucursales disponibles cerca de ti.'
          ],
          go_lotteries: [
            'Aqu√≠ est√°n todas las loter√≠as disponibles con sus pr√≥ximos sorteos.',
            'Te muestro las loter√≠as. Puedes ver cu√°ndo es el pr√≥ximo sorteo de cada una.',
            'Estas son las loter√≠as activas. ¬øHay alguna que te llame la atenci√≥n?'
          ],
          collect_prize: [
            '¬°Que emoci√≥n! Vamos a cobrar tus premios. Te llevo a la secci√≥n de cobros.',
            '¬°Felicidades por ganar! Te muestro tus opciones de cobro.',
            'Muy bien, vamos a ver tus premios pendientes de cobrar.'
          ],
          open_cart: [
            'Aqu√≠ est√° tu bolso de jugadas. Puedes ver todo lo que has seleccionado.',
            'Tu carrito est√° listo. Revisa tus jugadas antes de confirmar.',
            'Abriendo tu bolso de jugadas. Dime si quieres agregar algo m√°s.'
          ],
          help: [
            'Puedo ayudarte con muchas cosas. Dime "quiero jugar" para guiarte paso a paso, o preg√∫ntame por bancas, loter√≠as, tu perfil, o c√≥mo cobrar premios. ¬øQu√© prefieres?',
            'Estoy aqu√≠ para ayudarte. Puedo guiarte para jugar, mostrarte bancas cercanas, loter√≠as disponibles, o ayudarte a cobrar premios. ¬øPor d√≥nde empezamos?',
            'Soy tu asistente personal de loter√≠a. Puedo ayudarte a jugar, ver resultados, encontrar bancas o cobrar premios. Solo dime qu√© necesitas.'
          ],
          thanks: [
            '¬°De nada! Para eso estoy. ¬øNecesitas algo m√°s?',
            '¬°Con gusto! Si necesitas algo m√°s, solo dime.',
            '¬°Es un placer ayudarte! ¬øHay algo m√°s en lo que pueda asistirte?'
          ],
          bye: [
            '¬°Hasta pronto! Que tengas mucha suerte. Estar√© aqu√≠ cuando me necesites.',
            '¬°Chao! Espero que ganes mucho. Vuelve cuando quieras.',
            '¬°Nos vemos! Que la suerte est√© de tu lado.'
          ],
          not_understood: [
            'Mmm, no estoy segura de entender. ¬øPuedes decirlo de otra forma? Puedo ayudarte a jugar, ver bancas, loter√≠as o cobrar premios.',
            'Perdona, no capt√© bien eso. ¬øMe lo repites? Recuerda que puedo ayudarte con juegos, bancas, loter√≠as y cobros.',
            'No logr√© entenderte. Intenta con algo como "quiero jugar", "ver bancas", "mostrar loter√≠as" o "cobrar premio".'
          ],
          confirm_yes: [
            '¬°Perfecto! Continuemos.',
            '¬°Genial! Vamos adelante.',
            '¬°Excelente! Sigamos.'
          ],
          cancel: [
            'Entendido, he cancelado la selecci√≥n. ¬øEmpezamos de nuevo o prefieres hacer otra cosa?',
            'Sin problema, lo cancel√©. ¬øEn qu√© m√°s puedo ayudarte?',
            'Listo, reiniciamos. Cu√©ntame qu√© quieres hacer ahora.'
          ]
        };
        
        const pickRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
        let response = pickRandom(responses[intent] || responses.not_understood);
        
        // Replace all placeholders with context values in a single pass
        const replacements = { '{banca}': context.banca, '{lottery}': context.lottery, '{modality}': context.modality };
        Object.entries(replacements).forEach(([placeholder, value]) => {
          if (value) response = response.replace(placeholder, value);
        });
        
        return response;
      };

      // Add message to conversation history for context
      const addToConversation = (role, message) => {
        setConversationHistory(prev => [...prev.slice(-AI_CONFIG.MAX_CONVERSATION_HISTORY), { role, message, timestamp: Date.now() }]);
      };

      const processVoiceCommand = async (transcript) => {
        // Sanitize and validate input
        if (!transcript || typeof transcript !== 'string') {
          setAssistantResponse('No pude procesar el comando. Intenta de nuevo.');
          return;
        }
        
        // Add user message to conversation history
        addToConversation('user', transcript);
        
        // Show thinking animation for more natural feel
        setIsThinking(true);
        setAssistantResponse('');
        
        // Try LLM service first (for future API integration)
        const llmResult = await callLLMService(transcript, conversationHistory);
        
        if (llmResult.success && llmResult.response) {
          // Use LLM response
          setIsThinking(false);
          setAssistantResponse(llmResult.response);
          addToConversation('assistant', llmResult.response);
          speakText(llmResult.response);
        } else {
          // Fallback to local pattern matching
          const thinkingTime = AI_CONFIG.MIN_THINKING_TIME_MS + Math.random() * (AI_CONFIG.MAX_THINKING_TIME_MS - AI_CONFIG.MIN_THINKING_TIME_MS);
          
          setTimeout(() => {
            setIsThinking(false);
            processCommandInternal(transcript);
          }, thinkingTime);
        }
      };
      
      const processCommandInternal = (transcript) => {
        const command = transcript.toLowerCase().trim().replace(/[^\w\s√°√©√≠√≥√∫√±√º0-9]/g, '');
        if (command.length === 0) {
          const response = generateNaturalResponse('not_understood');
          setAssistantResponse(response);
          addToConversation('assistant', response);
          speakText(response);
          return;
        }
        
        let response = '';
        
        // Handle guided play mode
        if (assistantMode === 'select_banca') {
          // User is selecting a banca
          const foundBanca = DEFAULT_BANKS.find(b => 
            command.includes(b.name.toLowerCase()) || 
            (command.includes('primera') && b.name.includes('Primera')) ||
            (command.includes('loteka') && b.name.includes('Loteka')) ||
            (command.includes('leidsa') && b.name.includes('Leidsa')) ||
            (command.includes('nacional') && b.name.includes('Nacional'))
          );
          
          if (foundBanca) {
            setGuidedPlayData(prev => ({ ...prev, banca: foundBanca }));
            setSelectedBank(foundBanca);
            setAssistantMode('select_lottery');
            response = `Perfecto, seleccionaste ${foundBanca.name}. Ahora, ¬øa qu√© loter√≠a deseas jugar? Las opciones son: Leidsa, Loteka, La Primera, o Loter√≠a Nacional.`;
          } else if (command.includes('cercana') || command.includes('cerca')) {
            const nearestBanca = DEFAULT_BANKS[0]; // Simulated nearest
            setGuidedPlayData(prev => ({ ...prev, banca: nearestBanca }));
            setSelectedBank(nearestBanca);
            setAssistantMode('select_lottery');
            response = `Tu banca m√°s cercana es ${nearestBanca.name}. La he seleccionado. Ahora, ¬øa qu√© loter√≠a deseas jugar? Las opciones son: Leidsa, Loteka, La Primera, o Loter√≠a Nacional.`;
          } else {
            response = 'No encontr√© esa banca. Di el nombre de la banca, o di "la m√°s cercana" para usar la m√°s cercana a ti.';
          }
          setAssistantResponse(response);
          speakText(response);
          return;
        }
        
        if (assistantMode === 'select_lottery') {
          // User is selecting a lottery
          const lotteries = ['leidsa', 'loteka', 'la primera', 'loter√≠a nacional', 'nacional'];
          let selectedLottery = null;
          
          if (command.includes('leidsa')) selectedLottery = 'Leidsa';
          else if (command.includes('loteka')) selectedLottery = 'Loteka';
          else if (command.includes('primera')) selectedLottery = 'La Primera';
          else if (command.includes('nacional')) selectedLottery = 'Loter√≠a Nacional';
          
          if (selectedLottery) {
            setGuidedPlayData(prev => ({ ...prev, lottery: selectedLottery }));
            setPlayModalLottery(selectedLottery);
            setAssistantMode('select_modality');
            const modalities = LOTERIES[selectedLottery].modalities.join(', ');
            response = `Excelente, jugamos a ${selectedLottery}. ¬øQu√© tipo de juego deseas? Las modalidades son: ${modalities}.`;
          } else {
            response = 'No reconoc√≠ esa loter√≠a. Di: Leidsa, Loteka, La Primera, o Loter√≠a Nacional.';
          }
          setAssistantResponse(response);
          speakText(response);
          return;
        }
        
        if (assistantMode === 'select_modality') {
          // User is selecting game type
          let selectedModality = null;
          
          if (command.includes('quiniela')) selectedModality = 'Quiniela';
          else if (command.includes('pal√©') || command.includes('pale')) selectedModality = 'Pal√©';
          else if (command.includes('tripleta')) selectedModality = 'Tripleta';
          else if (command.includes('pega')) selectedModality = 'Pega 3';
          else if (command.includes('toca')) selectedModality = 'Toca 3';
          
          if (selectedModality) {
            setGuidedPlayData(prev => ({ ...prev, modality: selectedModality }));
            setPlayModalModality(selectedModality);
            setAssistantMode('select_numbers');
            const numCount = selectedModality === 'Quiniela' ? 'un n√∫mero' : selectedModality === 'Pal√©' ? 'dos n√∫meros' : 'tres n√∫meros';
            response = `Perfecto, modalidad ${selectedModality}. Ahora dime ${numCount} del 00 al 99. Por ejemplo, di "quince, veintitr√©s".`;
          } else {
            response = 'No reconoc√≠ esa modalidad. Di: Quiniela, Pal√©, o Tripleta.';
          }
          setAssistantResponse(response);
          speakText(response);
          return;
        }
        
        if (assistantMode === 'select_numbers') {
          // User is selecting numbers - parse numbers from speech
          const numberWords = {
            'cero': '00', 'uno': '01', 'dos': '02', 'tres': '03', 'cuatro': '04',
            'cinco': '05', 'seis': '06', 'siete': '07', 'ocho': '08', 'nueve': '09',
            'diez': '10', 'once': '11', 'doce': '12', 'trece': '13', 'catorce': '14',
            'quince': '15', 'diecis√©is': '16', 'diecisiete': '17', 'dieciocho': '18', 'diecinueve': '19',
            'veinte': '20', 'veintiuno': '21', 'veintid√≥s': '22', 'veintitr√©s': '23', 'veinticuatro': '24',
            'veinticinco': '25', 'veintis√©is': '26', 'veintisiete': '27', 'veintiocho': '28', 'veintinueve': '29',
            'treinta': '30', 'cuarenta': '40', 'cincuenta': '50', 'sesenta': '60', 'setenta': '70',
            'ochenta': '80', 'noventa': '90'
          };
          
          let numbers = [];
          // Try to find numbers in the command
          const matches = command.match(/\d+/g);
          if (matches) {
            numbers = matches.filter(n => parseInt(n, 10) <= 99).map(n => n.padStart(2, '0'));
          }
          
          // Also check for word numbers
          Object.keys(numberWords).forEach(word => {
            if (command.includes(word)) {
              numbers.push(numberWords[word]);
            }
          });
          
          if (numbers.length > 0) {
            setGuidedPlayData(prev => ({ ...prev, numbers }));
            setPlayModalNumbers(numbers.slice(0, 3));
            setAssistantMode('idle');
            
            // Open the play modal with the selections
            setShowPlayModal(true);
            setPlayModalStep('play');
            
            response = `¬°Listo! Seleccionaste los n√∫meros: ${numbers.join(', ')}. He abierto el panel de juego para que confirmes tu apuesta.`;
          } else {
            response = 'No pude identificar los n√∫meros. Di los n√∫meros del 00 al 99, por ejemplo: "quince, veintitr√©s" o "15, 23".';
          }
          setAssistantResponse(response);
          speakText(response);
          return;
        }
        
        // Standard navigation commands when not in guided mode
        if (command.includes('inicio') || command.includes('home') || command.includes('principal')) {
          setView('home');
          setAssistantMode('idle');
          response = 'Te llevo a la p√°gina de inicio.';
        } else if (command.includes('jugar') || command.includes('apostar') || command.includes('quiero jugar')) {
          // Start guided play mode
          setAssistantMode('select_banca');
          const nearestBanca = DEFAULT_BANKS[0].name;
          response = `¬°Excelente! Vamos a jugar. Tu banca m√°s cercana es ${nearestBanca}. ¬øDeseas jugar en esta banca? Di "s√≠" o el nombre de otra banca.`;
        } else if (command.includes('perfil') || command.includes('mi cuenta') || command.includes('cuenta')) {
          setView('profile');
          setAssistantMode('idle');
          response = 'Mostrando tu perfil y cartera digital.';
        } else if (command.includes('historial') || command.includes('tickets') || command.includes('mis jugadas')) {
          setView('profile');
          setAssistantMode('idle');
          response = 'Aqu√≠ puedes ver tu historial de tickets.';
        } else if (command.includes('banca') || command.includes('bancas') || command.includes('sucursal')) {
          setView('bancas');
          setAssistantMode('idle');
          response = 'Mostrando las bancas disponibles cerca de ti.';
        } else if (command.includes('loter√≠a') || command.includes('loter√≠as') || command.includes('loterias')) {
          setView('loterias');
          setAssistantMode('idle');
          response = 'Aqu√≠ est√°n todas las loter√≠as disponibles.';
        } else if (command.includes('ranking') || command.includes('ganadores') || command.includes('mejores')) {
          setView('rankings');
          setAssistantMode('idle');
          response = 'Mostrando el ranking de los mejores jugadores.';
        } else if (command.includes('cobrar') || command.includes('premio') || command.includes('retirar')) {
          setView('profile');
          setAssistantMode('idle');
          response = 'Ve a tu perfil para cobrar tus premios o retirar fondos.';
        } else if (command.includes('carrito') || command.includes('bolso') || command.includes('canasta')) {
          setIsCartOpen(true);
          setAssistantMode('idle');
          response = 'Abriendo tu bolso de jugadas.';
        } else if (command.includes('s√≠') || command.includes('si') || command.includes('ok') || command.includes('confirmar')) {
          if (assistantMode === 'select_banca' || assistantMode === 'idle') {
            // Accept nearest banca and continue
            const nearestBanca = DEFAULT_BANKS[0];
            setGuidedPlayData(prev => ({ ...prev, banca: nearestBanca }));
            setSelectedBank(nearestBanca);
            setAssistantMode('select_lottery');
            response = `Perfecto, usaremos ${nearestBanca.name}. ¬øA qu√© loter√≠a deseas jugar? Las opciones son: Leidsa, Loteka, La Primera, o Loter√≠a Nacional.`;
          }
        } else if (command.includes('ayuda') || command.includes('qu√© puedo hacer') || command.includes('comandos')) {
          response = 'Puedo guiarte para jugar paso a paso. Di "quiero jugar" y te ayudar√© a seleccionar banca, loter√≠a, tipo de juego y n√∫meros. Tambi√©n puedes decir: perfil, historial, bancas, loter√≠as, ranking, o cobrar premios.';
        } else if (command.includes('hola') || command.includes('buenos d√≠as') || command.includes('buenas')) {
          response = '¬°Hola! Soy tu asistente inteligente de LotoLink. ¬øQuieres jugar? Solo dime "quiero jugar" y te gu√≠o paso a paso.';
        } else if (command.includes('gracias')) {
          response = '¬°De nada! Estoy aqu√≠ para ayudarte a ganar.';
        } else if (command.includes('cancelar') || command.includes('reiniciar')) {
          setAssistantMode('idle');
          setGuidedPlayData({ banca: null, lottery: null, modality: null, numbers: [] });
          response = 'He cancelado la selecci√≥n. ¬øEn qu√© m√°s puedo ayudarte?';
        } else if (command.includes('cerrar') || command.includes('salir') || command.includes('adi√≥s')) {
          setIsVoiceAssistantOpen(false);
          setAssistantMode('idle');
          response = '¬°Hasta pronto! Si me necesitas, estar√© en el bot√≥n del micr√≥fono.';
        } else {
          response = 'No entend√≠. Di "quiero jugar" para empezar, o "ayuda" para ver todos los comandos.';
        }
        
        setAssistantResponse(response);
        speakText(response);
      };

      const startListening = () => {
        // Check for both speech recognition and synthesis support
        const hasSpeechRecognition = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
        const hasSpeechSynthesis = 'speechSynthesis' in window;
        
        if (!hasSpeechRecognition) {
          setAssistantResponse('Lo siento, tu navegador no soporta reconocimiento de voz. Prueba con Chrome, Edge o Safari.');
          return;
        }
        
        if (!hasSpeechSynthesis) {
          setAssistantResponse('Nota: Tu navegador no soporta s√≠ntesis de voz, pero puedo escucharte.');
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = () => {
          setIsListening(true);
          setVoiceMessage('');
          setAssistantResponse('Escuchando...');
        };
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          setVoiceMessage(transcript);
          processVoiceCommand(transcript);
        };
        
        recognition.onerror = (event) => {
          setIsListening(false);
          // Handle specific error types with appropriate messages
          switch(event.error) {
            case 'no-speech':
              setAssistantResponse('No escuch√© nada. Habla m√°s cerca del micr√≥fono e intenta de nuevo.');
              break;
            case 'audio-capture':
              setAssistantResponse('No se pudo acceder al micr√≥fono. Verifica que est√© conectado.');
              break;
            case 'not-allowed':
              setAssistantResponse('Permiso de micr√≥fono denegado. Habil√≠talo en la configuraci√≥n del navegador.');
              break;
            case 'network':
              setAssistantResponse('Error de red. Verifica tu conexi√≥n a internet.');
              break;
            default:
              setAssistantResponse('Error de reconocimiento. Intenta de nuevo.');
          }
        };
        
        recognition.onend = () => {
          setIsListening(false);
        };
        
        // Start recognition - browser will prompt for microphone permission if needed
        try {
          recognition.start();
        } catch (error) {
          setIsListening(false);
          setAssistantResponse('No se pudo iniciar el reconocimiento de voz. Intenta de nuevo.');
        }
      };

      const openVoiceAssistant = () => {
        setIsVoiceAssistantOpen(true);
        setVoiceMessage('');
        setIsThinking(false);
        const greeting = generateNaturalResponse('greeting');
        setAssistantResponse(greeting);
        addToConversation('assistant', greeting);
        speakText(greeting);
      };

      useEffect(() => { document.documentElement.classList.toggle('dark', theme === 'dark'); localStorage.setItem('ll_theme', theme); }, [theme]);
      useEffect(() => localStorage.setItem("ll_cart", JSON.stringify(cart)), [cart]);
      useEffect(() => localStorage.setItem("ll_cart_banca", JSON.stringify(cartBanca)), [cartBanca]);
      
      // Re-render lotteries when view changes to "loterias"
      useEffect(() => {
        if (view === 'loterias') {
          // Use setTimeout to ensure DOM is ready
          const timer = setTimeout(() => {
            if (window.renderLotteries) {
              window.renderLotteries();
            }
          }, 50);
          return () => clearTimeout(timer);
        }
      }, [view]);

      const addPlayToCart = (play) => { 
        // Single-banca cart enforcement
        if (!cartBanca) {
          // First play - set banca
          setCartBanca(play.banca || selectedBank?.name || 'Sin banca');
          setCart(c => [play, ...c]); 
          setIsCartOpen(true);
        } else if (cartBanca === (play.banca || selectedBank?.name || 'Sin banca')) {
          // Same banca - add normally
          setCart(c => [play, ...c]); 
          setIsCartOpen(true);
        } else {
          // Different banca - show conflict modal
          setPendingPlay(play);
          setShowBancaConflictModal(true);
        }
      };
      const removeCartIndex = (i) => setCart(c => c.filter((_, idx) => idx !== i));
      
      // Memoized cart totals for consistent display and calculation
      const cartTotals = useMemo(() => {
        const subtotal = cart.reduce((s, p) => s + Number(p.amount||0), 0);
        const commission = Math.round(subtotal * APP_COMMISSION_RATE * 100) / 100;
        const total = subtotal + commission;
        return { subtotal, commission, total };
      }, [cart]);
      
      // Show payment options before checkout
      const initiateCheckout = () => { 
        if (!cart.length) {
          return;
        }
        setShowPaymentOptions(true);
      };
      
      // Draw time configuration
      const DRAW_TIME_HOURS = 4; // Hours until draw (for simulation)
      
      // Process checkout with selected payment method
      const processCheckout = () => { 
        const t = { 
          id: uid("TK"), 
          plays: cart, 
          bank: cartBanca || selectedBank?.name, 
          subtotal: cartTotals.subtotal,
          commission: cartTotals.commission,
          total: cartTotals.total,
          paymentMethod: paymentMethod,
          paymentStatus: paymentMethod === 'app' ? 'paid' : 'pending',
          paymentCard: paymentMethod === 'app' && registeredCard ? registeredCard.lastFour : null,
          createdAt: new Date().toISOString(),
          drawTime: new Date(Date.now() + DRAW_TIME_HOURS * 60 * 60 * 1000).toISOString()
        }; 
        
        // If paying in app, require card
        if (paymentMethod === 'app' && !registeredCard) {
          setShowPaymentOptions(false);
          setShowCardRegistration(true);
          return;
        }
        
        setTicket(t); // Set main ticket state for consistency
        setConfirmedTicket(t);
        const h = JSON.parse(localStorage.getItem("ll_history") || "[]"); 
        h.unshift(t); 
        localStorage.setItem("ll_history", JSON.stringify(h.slice(0,50))); 
        setCart([]); 
        setCartBanca(null);
        setIsCartOpen(false);
        setShowPaymentOptions(false);
        setShowTicketConfirmation(true);
      };
      
      // Legacy checkout function for compatibility
      const checkout = () => {
        initiateCheckout();
      };

      useEffect(() => { window.addGlobalCartItem = (item) => addPlayToCart({ type: `${item.lottery} - ${item.modality}`, numbers: item.numbers, amount: item.stake, banca: item.banca || selectedBank?.name || 'Sin banca' }); return () => delete window.addGlobalCartItem; }, [selectedBank]);
      useEffect(() => { window.triggerPlayModal = (bankId) => { const bank = DEFAULT_BANKS.find(b => b.id === bankId); if(bank) { setSelectedBank(bank); setShowPlayModal(true); } }; return () => delete window.triggerPlayModal; }, []);
      
      // Reset play modal state when opening
      const openPlayModal = (bank = null) => {
        if (bank) setSelectedBank(bank);
        setPlayModalStep('lottery');
        setPlayModalLottery(null);
        setPlayModalModality(null);
        setPlayModalNumbers([]);
        setPlayModalStake(10);
        setShowPlayModal(true);
      };
      
      const closePlayModal = () => {
        setShowPlayModal(false);
        setPlayModalStep('lottery');
        setPlayModalLottery(null);
        setPlayModalModality(null);
        setPlayModalNumbers([]);
        setPlayModalStake(10);
      };
      
      // Toggle number selection
      const toggleNumber = (num) => {
        const maxNumbers = playModalModality === 'Quiniela' ? 1 : playModalModality === 'Pal√©' ? 2 : 3;
        if (playModalNumbers.includes(num)) {
          setPlayModalNumbers(playModalNumbers.filter(n => n !== num));
        } else if (playModalNumbers.length < maxNumbers) {
          setPlayModalNumbers([...playModalNumbers, num]);
        }
      };

      // Dismiss welcome screen and save preference
      const dismissWelcomeScreen = () => {
        setShowWelcomeScreen(false);
        localStorage.setItem('ll_has_seen_welcome', 'true');
      };

      // Start guided play from welcome screen
      const startGuidedPlayFromWelcome = () => {
        dismissWelcomeScreen();
        setIsVoiceAssistantOpen(true);
        setAssistantMode('select_banca');
        const nearestBanca = DEFAULT_BANKS[0].name;
        const response = `¬°Perfecto! Vamos a jugar. Tu banca m√°s cercana es ${nearestBanca}. ¬øDeseas jugar en esta banca? Di "s√≠" o el nombre de otra banca.`;
        setAssistantResponse(response);
        speakText(response);
      };

      return (
        <div className={theme === 'dark' ? 'dark' : ''}>
          {/* Welcome Screen with AI Assistant */}
          {showWelcomeScreen && (
            <div className="fixed inset-0 z-[100] bg-gradient-to-br from-gray-900 via-slate-900 to-gray-800 flex items-center justify-center">
              <div className="text-center text-white p-8 max-w-lg">
                {/* Loading Animation */}
                {welcomeStep === 0 && (
                  <div className="animate-pulse">
                    <div className="w-32 h-32 mx-auto mb-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-6xl shadow-2xl">
                      üé∞
                    </div>
                    <div className="h-2 bg-white/30 rounded-full w-48 mx-auto overflow-hidden">
                      <div className="h-full bg-white rounded-full" style={{animation: 'loading 1.5s ease-in-out forwards'}}></div>
                    </div>
                  </div>
                )}
                
                {/* Greeting */}
                {welcomeStep >= 1 && (
                  <div className="animate-fade-in">
                    <div className="w-32 h-32 mx-auto mb-6 bg-gradient-to-br from-gray-700 to-gray-800 rounded-full flex items-center justify-center text-6xl shadow-2xl border-4 border-white/20">
                      üåô
                    </div>
                    <h1 className="text-4xl font-bold mb-2 animate-fade-in">¬°Hola! Soy Luna</h1>
                    <p className="text-xl text-gray-300 mb-8">Tu asistente inteligente de LotoLink</p>
                    
                    {welcomeStep >= 2 && (
                      <div className="space-y-4 animate-fade-in">
                        <p className="text-lg mb-6 bg-white/10 rounded-xl p-4">
                          {isSpeaking && <span className="inline-block animate-pulse mr-2">üîä</span>}
                          ¬øQu√© te gustar√≠a hacer hoy?
                        </p>
                        
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <button
                            onClick={startGuidedPlayFromWelcome}
                            className="bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 px-6 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition transform hover:scale-105 flex items-center justify-center gap-3"
                          >
                            <span className="text-2xl">üé≤</span>
                            <span>Quiero Jugar</span>
                          </button>
                          
                          <button
                            onClick={dismissWelcomeScreen}
                            className="bg-white/20 backdrop-blur text-white py-4 px-6 rounded-xl font-bold text-lg shadow-lg hover:bg-white/30 transition flex items-center justify-center gap-3"
                          >
                            <span className="text-2xl">üëÜ</span>
                            <span>Explorar la App</span>
                          </button>
                        </div>
                        
                        <p className="text-sm text-gray-400 mt-6">
                          üí° Puedes hablar conmigo en cualquier momento tocando el bot√≥n üåô
                        </p>
                      </div>
                    )}
                  </div>
                )}
              </div>
              
              {/* Skip button */}
              <button
                onClick={dismissWelcomeScreen}
                className="absolute top-6 right-6 text-white/60 hover:text-white transition text-sm flex items-center gap-2"
              >
                Omitir <span>‚Üí</span>
              </button>
            </div>
          )}

          {view !== 'portal' && (<Header theme={theme} setTheme={setTheme} user={user} onLogin={()=>setShowAuthModal(true)} onLogout={()=>{setUser(null);localStorage.removeItem("ll_user")}} onNav={setView} onOpenPlay={()=>openPlayModal(DEFAULT_BANKS[0])} cartCount={cart.length} onToggleCart={()=>setIsCartOpen(true)} winningTicketsCount={winningTickets.length} onShowWinningTickets={() => setShowWinningTicketsModal(true)} registeredCard={registeredCard} onManageCard={() => setShowCardManagement(true)} />)}

          <main className="max-w-7xl mx-auto px-4 sm:px-6 pb-24 lg:pb-32" style={{ paddingBottom: 'max(96px, calc(24px + env(safe-area-inset-bottom)))' }}>
            {view === "home" && (
              <>
                <Hero onPlay={() => openPlayModal()} onBanca={() => setView("bancas")} />
                
                {/* Premium Section: Nearby Banks */}
                <div className="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-8">
                  {/* Left Column - Bancas cercanas y Resultados */}
                  <div className="lg:col-span-2 space-y-8">
                    {/* Bancas cercanas */}
                    <section>
                      <div className="flex items-center justify-between mb-6">
                        <div>
                          <h3 className="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">Bancas Cercanas</h3>
                          <p className="text-gray-500 dark:text-gray-400 mt-1">Encuentra tu banca favorita</p>
                        </div>
                        <button 
                          onClick={() => setView('bancas')}
                          className="text-blue-600 dark:text-blue-400 font-medium text-sm hover:text-blue-700"
                        >
                          Ver todas ‚Üí
                        </button>
                      </div>
                      <div className="space-y-4">
                        {DEFAULT_BANKS.map((b) => (
                          <div key={b.id} className="premium-card p-5 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                              <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white text-xl shadow-lg shadow-blue-500/25">
                                üè™
                              </div>
                              <div>
                                <div className="font-semibold text-gray-900 dark:text-white">{b.name}</div>
                                <div className="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
                                  <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                  {b.hours}
                                </div>
                              </div>
                            </div>
                            <div className="flex gap-3">
                              <button 
                                onClick={() => openPlayModal(b)} 
                                className="btn-apple-primary px-5 py-2.5 text-sm"
                              >
                                Jugar
                              </button>
                              <button 
                                onClick={() => {
                                  setBancasFocusBank(b);
                                  setBancasViewMode('map');
                                  setView('bancas');
                                }} 
                                className="px-4 py-2.5 bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-gray-300 rounded-full font-medium text-sm hover:bg-gray-200 dark:hover:bg-white/20 transition-all flex items-center gap-1"
                              >
                                <i className="fas fa-map-marker-alt text-xs"></i> Ver
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </section>
                    
                    {/* Resultados en vivo */}
                    <section>
                      <div className="flex items-center justify-between mb-6">
                        <div>
                          <h3 className="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">Resultados en Vivo</h3>
                          <p className="text-gray-500 dark:text-gray-400 mt-1">
                            {isLotteryConnected ? (
                              <>Conectado a <span className="text-blue-500 font-medium">loteriasdominicanas.com</span></>
                            ) : (
                              '√öltimos n√∫meros ganadores'
                            )}
                          </p>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                          <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full ${isLotteryConnected ? 'bg-green-500/10' : 'bg-yellow-500/10'}`}>
                            <span className={`w-2 h-2 rounded-full animate-pulse ${isLotteryConnected ? 'bg-green-500' : 'bg-yellow-500'}`}></span>
                            <span className={`text-xs font-medium ${isLotteryConnected ? 'text-green-600 dark:text-green-400' : 'text-yellow-600 dark:text-yellow-400'}`}>
                              {isLotteryConnected ? 'En vivo' : 'Simulaci√≥n'}
                            </span>
                          </div>
                          {lotteryLastUpdate && (
                            <span className="text-[10px] text-gray-400">
                              Actualizado: {lotteryLastUpdate.toLocaleTimeString('es-DO', { hour: '2-digit', minute: '2-digit' })}
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {Object.entries(resultsFeed).map(([k,v]) => (
                          <div key={k} className="premium-card p-5 text-center group hover:scale-105 transition-all duration-300 relative">
                            {v.isLive && (
                              <span className="absolute top-2 right-2 w-2 h-2 bg-green-500 rounded-full animate-pulse" title="Datos en vivo"></span>
                            )}
                            <div className="font-semibold text-sm text-gray-900 dark:text-white mb-3">{k}</div>
                            <div className="flex justify-center gap-1.5">
                              {v.numbers.map((num, i) => (
                                <span key={i} className={`w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold text-sm shadow-lg ${
                                  v.isLive 
                                    ? 'bg-gradient-to-br from-green-500 to-emerald-600 shadow-green-500/25' 
                                    : 'bg-gradient-to-br from-blue-500 to-blue-600 shadow-blue-500/25'
                                }`}>
                                  {num}
                                </span>
                              ))}
                            </div>
                            <div className="text-xs text-gray-400 mt-3">{v.time}</div>
                            {v.source && (
                              <div className="text-[9px] text-gray-400 mt-1 opacity-60">{v.source}</div>
                            )}
                          </div>
                        ))}
                      </div>
                    </section>
                  </div>
                  
                  {/* Right Column - Sidebar */}
                  <aside className="space-y-6">
                    {/* Jugadas m√°s populares */}
                    <PopularPlays 
                      mostPlayed={MOST_PLAYED} 
                      onQuick={(type, sample) => addPlayToCart({ type, numbers: sample, amount: 10, banca: selectedBank?.name || 'Sin banca' })} 
                    />
                    
                    {/* Cart Reminder */}
                    <div className="premium-card p-6 text-center bg-gradient-to-br from-blue-500/5 to-indigo-500/5">
                      <div className="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-blue-500/30">
                        üõí
                      </div>
                      <p className="text-sm text-gray-600 dark:text-gray-300 mb-4 font-medium">
                        Tu carrito est√° listo en todo momento.
                      </p>
                      <button 
                        onClick={() => setIsCartOpen(true)} 
                        className="btn-apple-primary w-full"
                      >
                        Ver Carrito ({cart.length})
                      </button>
                    </div>
                    
                    {/* M√©todos de pago */}
                    <PaymentMethods />
                  </aside>
                </div>
                
                {/* Download App Section */}
                <section className="mt-12 mb-8">
                  <div className="bg-gradient-to-br from-blue-600 via-blue-700 to-indigo-800 rounded-3xl p-8 sm:p-12 text-center text-white relative overflow-hidden">
                    {/* Background decoration */}
                    <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full transform translate-x-1/2 -translate-y-1/2 blur-3xl"></div>
                    <div className="absolute bottom-0 left-0 w-48 h-48 bg-blue-400/20 rounded-full transform -translate-x-1/2 translate-y-1/2 blur-2xl"></div>
                    
                    <div className="relative z-10">
                      <div className="text-5xl mb-4">üì≤</div>
                      <h3 className="text-2xl sm:text-3xl font-bold mb-3">Descarga la App LotoLink</h3>
                      <p className="text-blue-100 mb-8 max-w-md mx-auto">
                        Lleva tus jugadas en tu bolsillo. Disponible para iPhone, Android y PC.
                      </p>
                      
                      <div className="flex flex-col sm:flex-row items-center justify-center gap-4">
                        {/* iOS Button */}
                        <button 
                          onClick={() => {
                            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                              alert('üì± Para instalar en iPhone/iPad:\n\n1. Toca el bot√≥n de Compartir (cuadrado con flecha)\n2. Despl√°zate y selecciona "A√±adir a pantalla de inicio"\n3. Toca "A√±adir"\n\n¬°La app aparecer√° como icono en tu pantalla!');
                            } else {
                              alert('üì± Para instalar en iPhone/iPad:\n\nAbre esta p√°gina en Safari en tu dispositivo iOS y sigue estos pasos:\n\n1. Toca el bot√≥n de Compartir\n2. Selecciona "A√±adir a pantalla de inicio"\n3. Toca "A√±adir"');
                            }
                          }}
                          className="flex items-center gap-3 bg-black hover:bg-gray-900 text-white px-6 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg min-w-[200px]"
                        >
                          <svg className="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                          </svg>
                          <div className="text-left">
                            <div className="text-[10px] opacity-80">Descargar en</div>
                            <div className="text-lg font-bold -mt-1">App Store</div>
                          </div>
                        </button>
                        
                        {/* Android Button */}
                        <button 
                          onClick={() => {
                            if (/Android/.test(navigator.userAgent)) {
                              // Trigger the install prompt if available
                              if (window.deferredPrompt) {
                                window.deferredPrompt.prompt();
                              } else {
                                alert('üì± Para instalar en Android:\n\n1. Toca el men√∫ (‚ãÆ) en Chrome\n2. Selecciona "Instalar aplicaci√≥n" o "A√±adir a pantalla de inicio"\n3. Confirma la instalaci√≥n\n\n¬°La app aparecer√° como icono en tu pantalla!');
                              }
                            } else {
                              alert('üì± Para instalar en Android:\n\nAbre esta p√°gina en Chrome en tu dispositivo Android:\n\n1. Toca el men√∫ (‚ãÆ)\n2. Selecciona "Instalar aplicaci√≥n"\n3. Confirma la instalaci√≥n');
                            }
                          }}
                          className="flex items-center gap-3 bg-black hover:bg-gray-900 text-white px-6 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg min-w-[200px]"
                        >
                          <svg className="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3.609 1.814L13.792 12 3.61 22.186a.996.996 0 01-.61-.92V2.734a1 1 0 01.609-.92zm10.89 10.893l2.302 2.302-10.937 6.333 8.635-8.635zm3.199-3.198l2.807 1.626a1 1 0 010 1.73l-2.808 1.626L15.206 12l2.492-2.491zM5.864 2.658L16.8 8.99l-2.302 2.302-8.634-8.634z"/>
                          </svg>
                          <div className="text-left">
                            <div className="text-[10px] opacity-80">Disponible en</div>
                            <div className="text-lg font-bold -mt-1">Google Play</div>
                          </div>
                        </button>
                        
                        {/* Desktop Button */}
                        <button 
                          onClick={() => {
                            if (window.deferredPrompt) {
                              window.deferredPrompt.prompt();
                            } else {
                              alert('üíª Para instalar en PC/Mac:\n\nEn Chrome o Edge:\n1. Busca el icono de instalaci√≥n (‚äï) en la barra de direcciones\n2. Haz clic y selecciona "Instalar"\n\nO en el men√∫ (‚ãÆ):\n1. Selecciona "Instalar LotoLink..."\n2. Confirma la instalaci√≥n\n\n¬°La app se abrir√° en su propia ventana!');
                            }
                          }}
                          className="flex items-center gap-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-6 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg min-w-[200px] border border-white/30"
                        >
                          <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                          </svg>
                          <div className="text-left">
                            <div className="text-[10px] opacity-80">Tambi√©n en</div>
                            <div className="text-lg font-bold -mt-1">PC / Mac</div>
                          </div>
                        </button>
                      </div>
                      
                      <p className="mt-6 text-xs text-blue-200 opacity-75">
                        üí° Esta es una Progressive Web App (PWA) - se instala directamente desde el navegador sin necesidad de tiendas de aplicaciones.
                      </p>
                    </div>
                  </div>
                </section>
              </>
            )}

            {view === "bancas" && <Bancas banks={DEFAULT_BANKS} onPlay={(b) => openPlayModal(b)} onJoin={() => setView("portal")} initialViewMode={bancasViewMode} focusBank={bancasFocusBank} />}
            {view === "portal" && <BancaPortal onBack={() => setView("home")} />}
            {view === "profile" && <Profile user={user} ticket={ticket} registeredCards={registeredCards} onManageCards={() => setShowCardManagement(true)} />}
            {view === "rankings" && <Rankings />}
            {view === "masjugados" && <MostPlayedSection most={MOST_PLAYED} />}
            {view === "join" && <JoinUs />}
            {view === "how" && <HowItWorks />}
            
            {view === "loterias" && (
               <section className="mt-6">
                 <h2 className="text-2xl font-bold mb-2 dark:text-white">Loter√≠as Disponibles</h2>
                 <p className="text-gray-600 dark:text-gray-300 mb-6">Las jugadas se agregar√°n autom√°ticamente a tu <strong>Bolso Global</strong>.</p>
                 <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
                   <div id="lotteries" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                 </div>
                 
                 {/* Modal Container */}
                 <div id="modal-root" className="fixed inset-0 z-50 hidden items-start justify-center p-6">
                   <div 
                     id="modal-backdrop" 
                     className="absolute inset-0 bg-black/60 backdrop-blur-sm" 
                     onClick={() => window.closeLottery && window.closeLottery()}
                   ></div>
                   <section 
                     id="modal-card" 
                     className="relative w-full max-w-5xl bg-white dark:bg-slate-800 rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] modal-scroll"
                   ></section>
                 </div>
               </section>
            )}

            {view === "demo" && (
              <section className="mt-6">
                <h2 className="text-2xl font-bold mb-2 dark:text-white">Demo / Mapa</h2>
                <p className="text-gray-600 dark:text-gray-300 mb-4">Selecciona una banca en el mapa para jugar directamente.</p>
                <div className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow border border-gray-100 dark:border-slate-700 overflow-hidden" style={{height: '60vh'}}>
                  <div id="demo-leaflet-map" style={{width: '100%', height: '100%'}}></div>
                </div>
              </section>
            )}

            {view === "ticket" && ticket && (
              <div className="mt-8 flex justify-center" id="ticket-print-area">
                <div className="flex flex-col items-center">
                  {/* Printer Slot Animation */}
                  <div className="printer-slot"></div>
                  
                  {/* Ticket with entrance animation */}
                  <div className="ticket-print ticket-entrance text-center border relative bg-white text-gray-900">
                    <div className="w-full h-3 bg-slate-900 mb-4 mx-auto rounded-full opacity-10"></div>
                    <h2 className="text-2xl font-bold mb-1 text-gray-900">LotoLink Ticket</h2>
                    <p className="text-xs text-gray-500 mb-2">ID: {ticket.id}</p>
                    <p className="text-xs text-gray-500 mb-4">{new Date(ticket.createdAt).toLocaleString('es-DO')}</p>
                    
                    <div className="border-t border-b border-dashed border-gray-300 py-4 my-4 space-y-2">
                      {ticket.plays.map((p, i) => (
                        <div key={i} className="flex justify-between text-sm text-gray-900">
                          <span className="font-mono text-left">{p.type}</span>
                          <span className="font-mono">[{Array.isArray(p.numbers) ? p.numbers.join('-') : p.numbers}]</span>
                          <span className="font-bold">RD${p.amount}</span>
                        </div>
                      ))}
                    </div>
                    
                    <div className="mb-2 text-sm text-gray-900">
                      <div className="flex justify-between"><span>Banca:</span><span className="font-semibold">{ticket.bank}</span></div>
                    </div>
                    
                    <div className="text-xl font-bold mb-4 text-green-600">Total: RD$ {ticket.total}</div>
                    
                    <div className="flex justify-center mb-4 bg-white p-2 rounded">
                      <QRImage value={JSON.stringify({id: ticket.id, total: ticket.total})} size={120} />
                    </div>
                    
                    <div className="text-xs text-gray-400 mb-4">Escanea para validar</div>
                    
                    <div className="grid grid-cols-2 gap-2">
                      <button onClick={() => window.print()} className="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700">
                        Imprimir
                      </button>
                      <button onClick={() => setView('home')} className="border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-100">
                        Cerrar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </main>

          {/* Cart Drawer */}
          {isCartOpen && (
            <div className="fixed inset-0 z-50 flex justify-end">
              <div className="absolute inset-0 bg-black/50 transition-opacity" onClick={() => setIsCartOpen(false)}></div>
              <div className="relative w-full max-w-md bg-white dark:bg-slate-900 h-full shadow-2xl flex flex-col transform transition-transform duration-300">
                {/* Header */}
                <div className="p-4 border-b bg-gray-50 dark:bg-slate-800 flex justify-between items-center">
                  <div>
                    <div className="font-bold text-lg dark:text-white">
                      üõçÔ∏è Bolso {cartBanca ? `- ${cartBanca}` : ''}
                    </div>
                    {cartBanca && <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">Ticket espec√≠fico para esta sucursal</div>}
                  </div>
                  <button onClick={() => setIsCartOpen(false)} className="p-2 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-full text-gray-600 dark:text-gray-300">‚úï</button>
                </div>
                
                {/* Cart Items */}
                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                  {cart.length === 0 ? (
                    <div className="text-center py-10 text-gray-500 dark:text-gray-400">
                      <p className="text-4xl mb-2">üï∏Ô∏è</p>
                      <p>Tu bolso est√° vac√≠o.</p>
                      <p className="text-sm mt-2">Selecciona una sucursal y empieza a jugar.</p>
                      <button onClick={() => setIsCartOpen(false)} className="mt-4 text-blue-600 underline">Seguir jugando</button>
                    </div>
                  ) : (
                    cart.map((c, i) => (
                      <div key={i} className="flex justify-between items-center border dark:border-slate-700 rounded-lg p-3 bg-white dark:bg-slate-800 shadow-sm">
                        <div>
                          <div className="font-bold text-blue-600">{c.type}</div>
                          <div className="text-sm font-mono bg-gray-100 dark:bg-slate-700 px-2 py-0.5 rounded inline-block mt-1">
                            {Array.isArray(c.numbers) ? c.numbers.join(' - ') : c.numbers}
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="font-semibold text-lg dark:text-white">RD${c.amount}</div>
                          <button onClick={() => removeCartIndex(i)} className="text-xs text-red-500 hover:text-red-700 font-medium mt-1">Eliminar</button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
                
                {/* Footer */}
                <div className="p-4 border-t bg-gray-50 dark:bg-slate-800">
                  <div className="flex justify-between items-center mb-4">
                    <span className="text-gray-600 dark:text-gray-400">Total a pagar:</span>
                    <span className="text-2xl font-bold text-green-600">RD$ {cart.reduce((s, p) => s + Number(p.amount || 0), 0)}</span>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <button 
                      onClick={() => { setCart([]); setCartBanca(null); }} 
                      disabled={cart.length===0} 
                      className="px-4 py-3 border rounded-lg font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 disabled:opacity-50"
                    >
                      Vaciar
                    </button>
                    <button 
                      onClick={checkout} 
                      disabled={cart.length===0} 
                      className="px-4 py-3 bg-slate-900 dark:bg-white dark:text-slate-900 text-white rounded-lg font-bold hover:bg-slate-800 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Pagar Ahora
                    </button>
                  </div>
                  
                  {/* Payment Methods Display */}
                  <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700 text-center">
                    <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">M√©todos aceptados</p>
                    <div className="flex justify-center gap-3 grayscale opacity-60">
                      <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" className="h-6" alt="Visa" />
                      <img src="https://cdn-icons-png.flaticon.com/512/349/349221.png" className="h-6" alt="MC" />
                      <img src="https://cdn-icons-png.flaticon.com/512/5968/5968260.png" className="h-6" alt="PayPal" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          {/* Play Modal - Step by Step */}
          {showPlayModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
              <div className="bg-white dark:bg-slate-800 w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
                {/* Modal Header */}
                <div className="p-6 bg-gray-50 dark:bg-slate-900 border-b dark:border-slate-700 flex justify-between items-center">
                  <div>
                    <div className="text-sm text-gray-500 dark:text-gray-400">Jugando en</div>
                    <div className="font-bold text-lg dark:text-white">{selectedBank?.name ?? '‚Äî'}</div>
                  </div>
                  <button onClick={closePlayModal} className="text-gray-400 hover:text-black dark:hover:text-white text-2xl">‚úï</button>
                </div>
                
                {/* Modal Body */}
                <div className="p-8">
                  {/* Step 1: Select Lottery */}
                  {playModalStep === 'lottery' && (
                    <div>
                      <h3 className="text-2xl font-bold mb-2 dark:text-white">Paso 1: Selecciona la loter√≠a</h3>
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-6">¬øEn cu√°l loter√≠a quieres jugar?</p>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {Object.keys(LOTERIES).map(lotteryName => (
                          <button
                            key={lotteryName}
                            onClick={() => {
                              setPlayModalLottery(lotteryName);
                              setPlayModalStep('modality');
                            }}
                            className="border-2 dark:border-slate-600 rounded-xl p-5 text-left hover:shadow-xl transition-all transform hover:scale-105 group bg-white dark:bg-slate-800 hover:border-blue-500"
                          >
                            <div className="font-bold text-lg dark:text-white mb-2">{lotteryName}</div>
                            <div className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                              üïê {LOTERIES[lotteryName].next}
                            </div>
                            <div className="mt-3 text-sm font-medium text-blue-600 dark:text-blue-400">
                              Jugar aqu√≠ ‚Üí
                            </div>
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Step 2: Select Modality */}
                  {playModalStep === 'modality' && playModalLottery && (
                    <div>
                      <div className="mb-6 flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                        <span className="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full font-medium">
                          ‚úì {playModalLottery}
                        </span>
                        <span>‚Üí</span>
                        <button onClick={() => setPlayModalStep('lottery')} className="hover:text-blue-600 dark:hover:text-blue-400 underline">
                          Cambiar loter√≠a
                        </button>
                      </div>
                      
                      <h3 className="text-2xl font-bold mb-2 dark:text-white">Paso 2: Selecciona la modalidad</h3>
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-6">¬øC√≥mo quieres jugar?</p>
                      
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {LOTERIES[playModalLottery].modalities.map(modality => (
                          <button
                            key={modality}
                            onClick={() => {
                              setPlayModalModality(modality);
                              setPlayModalStep('play');
                            }}
                            className="border-2 dark:border-slate-600 rounded-xl p-6 text-left hover:shadow-xl transition-all transform hover:scale-105 group bg-white dark:bg-slate-800 hover:border-blue-500"
                          >
                            <div className="text-3xl mb-3">
                              {modality === 'Quiniela' ? 'üéØ' : modality === 'Pal√©' ? 'üé∞' : 'üé≤'}
                            </div>
                            <div className="font-bold text-xl mb-2 dark:text-white">{modality}</div>
                            <div className="text-sm text-gray-600 dark:text-gray-400">
                              {modality === 'Quiniela' ? '1 n√∫mero' : modality === 'Pal√©' ? '2 n√∫meros' : '3 n√∫meros'}
                            </div>
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Step 3: Play */}
                  {playModalStep === 'play' && playModalLottery && playModalModality && (
                    <div>
                      <div className="mb-6 flex flex-wrap items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                        <span className="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full font-medium">
                          ‚úì {playModalLottery}
                        </span>
                        <span>‚Üí</span>
                        <span className="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full font-medium">
                          ‚úì {playModalModality}
                        </span>
                        <span>‚Üí</span>
                        <button onClick={() => setPlayModalStep('modality')} className="hover:text-blue-600 dark:hover:text-blue-400 underline">
                          Cambiar
                        </button>
                      </div>
                      
                      <h3 className="text-2xl font-bold mb-2 dark:text-white">Paso 3: Selecciona tus n√∫meros</h3>
                      <p className="text-sm text-gray-600 dark:text-gray-400 mb-6">
                        Selecciona {playModalModality === 'Quiniela' ? '1 n√∫mero' : playModalModality === 'Pal√©' ? '2 n√∫meros' : '3 n√∫meros'}
                      </p>
                      
                      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Number Grid */}
                        <div className="lg:col-span-2 space-y-4">
                          <div className="p-4 border dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900">
                            <div className="flex justify-between items-center mb-3">
                              <div className="text-sm text-gray-500 dark:text-gray-400">
                                Selecciona n√∫meros (00-99) - {playModalNumbers.length}/{playModalModality === 'Quiniela' ? 1 : playModalModality === 'Pal√©' ? 2 : 3}
                              </div>
                              <button 
                                onClick={() => { 
                                  const maxNumbers = playModalModality === 'Quiniela' ? 1 : playModalModality === 'Pal√©' ? 2 : 3;
                                  const randomNums = Array.from({length: maxNumbers}, () => pad(rand(0,99)));
                                  setPlayModalNumbers(randomNums);
                                }} 
                                className="px-3 py-1.5 bg-gray-100 dark:bg-slate-700 rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-slate-600 dark:text-white"
                              >
                                üé≤ Al Azar
                              </button>
                            </div>
                            <div className="grid grid-cols-10 gap-1">
                              {Array.from({ length: 100 }).map((_, i) => {
                                const n = pad(i);
                                const isSelected = playModalNumbers.includes(n);
                                return (
                                  <button 
                                    key={n}
                                    onClick={() => toggleNumber(n)}
                                    className={`aspect-square p-2 text-xs font-bold rounded border transition ${
                                      isSelected 
                                        ? 'bg-blue-600 text-white border-blue-600' 
                                        : 'border-gray-300 dark:border-slate-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 dark:text-white'
                                    }`}
                                  >
                                    {n}
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                          
                          {/* Rules Section */}
                          <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <div className="font-bold text-sm mb-2 dark:text-white">üìã Reglas de {playModalModality}</div>
                            <div className="text-xs text-gray-700 dark:text-gray-300 space-y-1">
                              {playModalModality === 'Quiniela' && (
                                <>
                                  <p>‚Ä¢ Selecciona 1 n√∫mero del 00 al 99</p>
                                  <p>‚Ä¢ Si coincide con el 1er premio: Ganas 60x</p>
                                  <p>‚Ä¢ Si coincide con el 2do premio: Ganas 8x</p>
                                  <p>‚Ä¢ Si coincide con el 3er premio: Ganas 4x</p>
                                </>
                              )}
                              {playModalModality === 'Pal√©' && (
                                <>
                                  <p>‚Ä¢ Selecciona 2 n√∫meros del 00 al 99</p>
                                  <p>‚Ä¢ Si ambos aparecen en 1er y 2do: Ganas 1,000x</p>
                                  <p>‚Ä¢ Si ambos aparecen en 1er y 3er: Ganas 1,000x</p>
                                  <p>‚Ä¢ Si ambos aparecen en 2do y 3er: Ganas 100x</p>
                                </>
                              )}
                              {playModalModality === 'Tripleta' && (
                                <>
                                  <p>‚Ä¢ Selecciona 3 n√∫meros del 00 al 99</p>
                                  <p>‚Ä¢ Si los 3 coinciden (cualquier orden): Ganas 3,000x</p>
                                  <p>‚Ä¢ Si 2 de 3 coinciden: Ganas 150x</p>
                                </>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        {/* Summary Panel */}
                        <div className="bg-gray-50 dark:bg-slate-900 p-6 rounded-xl border dark:border-slate-700 h-fit space-y-4">
                          <div>
                            <label className="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase block mb-2">Monto a Apostar</label>
                            <input 
                              type="number" 
                              value={playModalStake}
                              onChange={(e) => setPlayModalStake(Math.max(1, parseInt(e.target.value) || 1))}
                              className="w-full border dark:border-slate-600 p-3 rounded-lg dark:bg-slate-700 dark:text-white text-center font-bold text-lg" 
                              min="1"
                            />
                          </div>
                          
                          <div className="p-4 bg-white dark:bg-slate-800 rounded-lg border dark:border-slate-600">
                            <div className="text-xs text-gray-500 dark:text-gray-400 mb-2">N√∫meros seleccionados:</div>
                            <div className="font-mono font-bold text-xl text-center text-blue-600 min-h-[40px] flex items-center justify-center">
                              {playModalNumbers.length > 0 ? playModalNumbers.join(', ') : '‚Äî'}
                            </div>
                          </div>
                          
                          {/* Potential Winnings */}
                          <div className="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                            <div className="text-xs font-bold text-green-800 dark:text-green-300 mb-2">üí∞ Ganancia Potencial</div>
                            <div className="space-y-1 text-xs text-green-700 dark:text-green-400">
                              {playModalModality === 'Quiniela' && (
                                <>
                                  <div>1er: RD$ {(playModalStake * 60).toLocaleString()}</div>
                                  <div>2do: RD$ {(playModalStake * 8).toLocaleString()}</div>
                                  <div>3er: RD$ {(playModalStake * 4).toLocaleString()}</div>
                                </>
                              )}
                              {playModalModality === 'Pal√©' && (
                                <>
                                  <div>M√°ximo: RD$ {(playModalStake * 1000).toLocaleString()}</div>
                                  <div>M√≠nimo: RD$ {(playModalStake * 100).toLocaleString()}</div>
                                </>
                              )}
                              {playModalModality === 'Tripleta' && (
                                <>
                                  <div>3 n√∫meros: RD$ {(playModalStake * 3000).toLocaleString()}</div>
                                  <div>2 n√∫meros: RD$ {(playModalStake * 150).toLocaleString()}</div>
                                </>
                              )}
                            </div>
                          </div>
                          
                          <button 
                            onClick={() => { 
                              if (playModalNumbers.length > 0) {
                                addPlayToCart({ 
                                  type: `${playModalLottery} - ${playModalModality}`, 
                                  numbers: playModalNumbers, 
                                  amount: playModalStake,
                                  banca: selectedBank?.name || 'Sin banca'
                                }); 
                                closePlayModal();
                              } else {
                                alert('Por favor selecciona al menos un n√∫mero');
                              }
                            }} 
                            disabled={playModalNumbers.length === 0}
                            className={`w-full py-3 rounded-xl font-bold shadow-lg ${
                              playModalNumbers.length > 0 
                                ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            }`}
                          >
                            Agregar al Bolso
                          </button>
                          
                          <button 
                            onClick={closePlayModal} 
                            className="w-full border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 py-3 rounded-xl font-bold hover:bg-gray-100 dark:hover:bg-slate-700"
                          >
                            Cancelar
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
          
          {showAuthModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
              <div className="premium-card w-full max-w-sm p-8 text-center animate-fade-in">
                <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg shadow-blue-500/30">
                  üëã
                </div>
                <h3 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">Bienvenido a LotoLink</h3>
                <p className="text-gray-500 dark:text-gray-400 mb-6">Ingresa tus datos para continuar</p>
                <input 
                  id="loginName" 
                  className="w-full border border-gray-200 dark:border-white/10 p-4 rounded-xl mb-4 bg-gray-50 dark:bg-white/5 dark:text-white focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-all" 
                  placeholder="Tu nombre" 
                />
                <input 
                  className="w-full border border-gray-200 dark:border-white/10 p-4 rounded-xl mb-6 bg-gray-50 dark:bg-white/5 dark:text-white focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-all" 
                  placeholder="Tu email" 
                />
                <button 
                  onClick={() => { 
                    const n = document.getElementById('loginName').value; 
                    if(n) { 
                      setUser({ name: n, email: "usuario@lotolink.com", id: uid("U") }); 
                      setShowAuthModal(false); 
                    } 
                  }} 
                  className="btn-apple-primary w-full py-4"
                >
                  Entrar
                </button>
                <button 
                  onClick={() => setShowAuthModal(false)} 
                  className="mt-4 text-gray-500 dark:text-gray-400 text-sm hover:text-gray-700 dark:hover:text-gray-200 transition-colors"
                >
                  Cancelar
                </button>
              </div>
            </div>
          )}

          {/* Card Registration Modal */}
          {showCardRegistration && (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
              <div className="premium-card w-full max-w-md p-8 animate-fade-in">
                <div className="text-center mb-8">
                  <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-6 text-4xl shadow-lg shadow-blue-500/30">üí≥</div>
                  <h3 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">Registra tu Tarjeta</h3>
                  <p className="text-gray-500 dark:text-gray-400 text-sm">
                    Para jugar en la app, necesitas registrar una tarjeta.
                  </p>
                </div>
                
                <div className="space-y-5">
                  <div>
                    <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Nombre en la tarjeta</label>
                    <input 
                      type="text"
                      value={cardForm.name}
                      onChange={(e) => setCardForm({...cardForm, name: e.target.value})}
                      className="w-full border border-gray-200 dark:border-white/10 p-4 rounded-xl bg-gray-50 dark:bg-white/5 dark:text-white focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-all" 
                      placeholder="JUAN P√âREZ"
                    />
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">N√∫mero de tarjeta</label>
                    <input 
                      type="text"
                      value={cardForm.number}
                      onChange={(e) => {
                        const num = e.target.value.replace(/\D/g, '').slice(0, 16);
                        setCardForm({...cardForm, number: num});
                      }}
                      className={`w-full border p-4 rounded-xl bg-gray-50 dark:bg-white/5 dark:text-white font-mono focus:ring-2 focus:ring-blue-500/30 transition-all ${
                        cardForm.number.length > 0 && cardForm.number.length < 16 
                          ? 'border-amber-400 dark:border-amber-500/50' 
                          : 'border-gray-200 dark:border-white/10'
                      }`}
                      placeholder="4000 1234 5678 9012"
                    />
                    {cardForm.number.length > 0 && cardForm.number.length < 16 && (
                      <p className="text-xs text-amber-600 dark:text-amber-400 mt-2 flex items-center gap-1">
                        <span>‚ö†Ô∏è</span> Ingresa los 16 d√≠gitos de tu tarjeta
                      </p>
                    )}
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">Expiraci√≥n</label>
                      <input 
                        type="text"
                        value={cardForm.expiry}
                        onChange={(e) => {
                          let val = e.target.value.replace(/\D/g, '').slice(0, 4);
                          if (val.length >= 2) val = val.slice(0, 2) + '/' + val.slice(2);
                          setCardForm({...cardForm, expiry: val});
                        }}
                        className="w-full border border-gray-200 dark:border-white/10 p-4 rounded-xl bg-gray-50 dark:bg-white/5 dark:text-white font-mono focus:ring-2 focus:ring-blue-500/30 transition-all" 
                        placeholder="MM/YY"
                        maxLength={5}
                      />
                    </div>
                    <div>
                      <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">CVV</label>
                      <input 
                        type="password"
                        value={cardForm.cvv}
                        onChange={(e) => setCardForm({...cardForm, cvv: e.target.value.replace(/\D/g, '').slice(0, 4)})}
                        className="w-full border border-gray-200 dark:border-white/10 p-4 rounded-xl bg-gray-50 dark:bg-white/5 dark:text-white font-mono focus:ring-2 focus:ring-blue-500/30 transition-all" 
                        placeholder="***"
                      />
                    </div>
                  </div>
                </div>
                
                <div className="mt-8 space-y-3">
                  <button 
                    onClick={registerCard}
                    disabled={!cardForm.number || cardForm.number.length < 16 || !cardForm.expiry || cardForm.expiry.length < 5 || !cardForm.cvv || cardForm.cvv.length < 3 || !cardForm.name}
                    className="btn-apple-primary w-full py-4 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                  >
                    Registrar Tarjeta
                  </button>
                  <button 
                    onClick={() => setShowCardRegistration(false)}
                    className="w-full text-gray-500 dark:text-gray-400 text-sm hover:text-gray-700 dark:hover:text-gray-200 transition-colors py-2"
                  >
                    Cancelar
                  </button>
                </div>
                
                <div className="mt-6 p-4 bg-green-500/10 rounded-xl border border-green-500/20 flex items-center gap-3">
                  <span className="text-green-600 text-xl">üîí</span>
                  <p className="text-xs text-green-700 dark:text-green-400">
                    Solo guardamos los √∫ltimos 4 d√≠gitos para tu seguridad
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Card Management Modal - View/Add/Delete Cards */}
          {showCardManagement && (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
              <div className="premium-card w-full max-w-md overflow-hidden animate-fade-in">
                {/* Header */}
                <div className="bg-gradient-to-r from-blue-500 to-indigo-600 p-8 text-white">
                  <div className="flex justify-between items-start">
                    <div>
                      <h3 className="text-2xl font-bold">Mis Tarjetas</h3>
                      <p className="text-blue-100 text-sm mt-2">Gestiona tus m√©todos de pago</p>
                    </div>
                    <button 
                      onClick={() => setShowCardManagement(false)}
                      className="w-10 h-10 flex items-center justify-center hover:bg-white/20 rounded-full transition-all"
                    >
                      ‚úï
                    </button>
                  </div>
                </div>
                
                <div className="p-6">
                  {/* Cards List */}
                  {registeredCards.length > 0 ? (
                    <div className="space-y-4 mb-6">
                      {registeredCards.map((card, index) => {
                        const brandStyles = {
                          'Visa': { gradient: 'from-blue-500 to-blue-700', icon: 'ùó©' },
                          'Mastercard': { gradient: 'from-red-500 to-orange-500', icon: '‚óâ‚óâ' },
                          'Tarjeta': { gradient: 'from-gray-500 to-gray-700', icon: 'üí≥' }
                        };
                        const style = brandStyles[card.brand] || brandStyles['Tarjeta'];
                        
                        return (
                          <div 
                            key={card.id} 
                            className={`p-5 rounded-2xl border-2 transition-all duration-300 cursor-pointer ${
                              selectedCardIndex === index 
                                ? 'border-blue-500 bg-blue-500/5 shadow-lg shadow-blue-500/10' 
                                : 'border-gray-200 dark:border-white/10 hover:border-blue-300 dark:hover:border-blue-500/50'
                            }`}
                            onClick={() => setSelectedCardIndex(index)}
                          >
                            <div className="flex justify-between items-start">
                              <div className="flex items-center gap-4">
                                <div className={`w-12 h-12 bg-gradient-to-br ${style.gradient} rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg`}>
                                  {style.icon}
                                </div>
                                <div>
                                  <div className="font-semibold text-gray-900 dark:text-white">{card.brand}</div>
                                  <div className="text-sm text-gray-500 dark:text-gray-400 font-mono">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {card.lastFour}</div>
                                  {card.name && <div className="text-xs text-gray-400 dark:text-gray-500 mt-1">{card.name}</div>}
                                </div>
                              </div>
                              <div className="flex flex-col items-end gap-2">
                                {selectedCardIndex === index && (
                                  <span className="text-xs bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-3 py-1 rounded-full font-medium shadow-md">Principal</span>
                                )}
                                <button 
                                  onClick={(e) => { e.stopPropagation(); deleteCard(card.id); }}
                                  className="text-xs text-red-500 hover:text-red-600 font-medium transition-colors"
                                >
                                  Eliminar
                                </button>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-center py-8 mb-6">
                      <div className="text-5xl mb-4">üí≥</div>
                      <h4 className="font-bold text-lg mb-2 dark:text-white">No tienes tarjetas registradas</h4>
                      <p className="text-sm text-gray-500 dark:text-gray-400">Agrega una tarjeta para pagar en la app</p>
                    </div>
                  )}
                  
                  {/* Add New Card Button */}
                  <button 
                    onClick={() => { setShowCardManagement(false); setShowCardRegistration(true); }}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2"
                  >
                    <span>‚ûï</span> Agregar Nueva Tarjeta
                  </button>
                  
                  {/* Info */}
                  <p className="text-xs text-center text-gray-400 mt-4">
                    üîí Tus tarjetas est√°n protegidas. Solo guardamos los √∫ltimos 4 d√≠gitos.
                  </p>
                </div>
              </div>
            </div>
          )}
          
          {/* Payment Options Modal */}
          {showPaymentOptions && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
              <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                {/* Header */}
                <div className="bg-gradient-to-r from-green-600 to-emerald-600 p-6 text-white text-center">
                  <div className="text-4xl mb-2">üí∞</div>
                  <h3 className="text-xl font-bold">M√©todo de Pago</h3>
                  <p className="text-green-100 text-sm mt-1">¬øC√≥mo deseas pagar tu ticket?</p>
                </div>
                
                <div className="p-6">
                  {/* Order Summary */}
                  <div className="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 mb-6">
                    <h4 className="font-bold text-sm text-gray-600 dark:text-gray-300 mb-3">Resumen del Pedido</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600 dark:text-gray-400">Subtotal ({cart.length} jugada{cart.length > 1 ? 's' : ''}):</span>
                        <span className="font-medium dark:text-white">RD$ {cartTotals.subtotal.toLocaleString('es-DO')}</span>
                      </div>
                      <div className="flex justify-between text-orange-600 dark:text-orange-400">
                        <span>Servicio App (7%):</span>
                        <span className="font-medium">RD$ {cartTotals.commission.toLocaleString('es-DO')}</span>
                      </div>
                      <div className="border-t dark:border-slate-600 pt-2 mt-2">
                        <div className="flex justify-between text-lg font-bold">
                          <span className="dark:text-white">Total a Pagar:</span>
                          <span className="text-green-600">RD$ {cartTotals.total.toLocaleString('es-DO')}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Payment Method Selection */}
                  <div className="space-y-3 mb-6">
                    {/* Pay in App */}
                    <button 
                      onClick={() => setPaymentMethod('app')}
                      className={`w-full p-4 rounded-xl border-2 text-left transition ${
                        paymentMethod === 'app' 
                          ? 'border-green-500 bg-green-50 dark:bg-green-900/20' 
                          : 'border-gray-200 dark:border-slate-600 hover:border-green-300'
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center text-2xl">
                          üí≥
                        </div>
                        <div className="flex-1">
                          <div className="font-bold dark:text-white">Pagar Aqu√≠ en la App</div>
                          <div className="text-sm text-gray-500 dark:text-gray-400">
                            {registeredCard 
                              ? `Usar ${registeredCard.brand} ‚Ä¢‚Ä¢‚Ä¢${registeredCard.lastFour}` 
                              : 'Agrega una tarjeta para continuar'}
                          </div>
                        </div>
                        {paymentMethod === 'app' && <span className="text-green-600 text-xl">‚úì</span>}
                      </div>
                    </button>
                    
                    {/* Pay at Branch */}
                    <button 
                      onClick={() => setPaymentMethod('branch')}
                      className={`w-full p-4 rounded-xl border-2 text-left transition ${
                        paymentMethod === 'branch' 
                          ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' 
                          : 'border-gray-200 dark:border-slate-600 hover:border-blue-300'
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center text-2xl">
                          üè™
                        </div>
                        <div className="flex-1">
                          <div className="font-bold dark:text-white">Pagar en la Sucursal</div>
                          <div className="text-sm text-gray-500 dark:text-gray-400">
                            Lleva el ticket y paga antes del sorteo
                          </div>
                        </div>
                        {paymentMethod === 'branch' && <span className="text-blue-600 text-xl">‚úì</span>}
                      </div>
                    </button>
                  </div>
                  
                  {/* Branch Payment Warning */}
                  {paymentMethod === 'branch' && (
                    <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-3 mb-4">
                      <div className="flex items-start gap-2">
                        <span className="text-yellow-600">‚ö†Ô∏è</span>
                        <div className="text-sm text-yellow-700 dark:text-yellow-300">
                          <strong>Importante:</strong> Debes pagar en la sucursal <strong>antes del sorteo</strong>. 
                          El ticket no ser√° v√°lido si no se paga a tiempo.
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Action Buttons */}
                  <div className="space-y-3">
                    <button 
                      onClick={processCheckout}
                      disabled={paymentMethod === 'app' && !registeredCard}
                      className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      {paymentMethod === 'app' ? (
                        <>
                          <span>üí≥</span> Pagar RD$ {cartTotals.total.toLocaleString('es-DO')}
                        </>
                      ) : (
                        <>
                          <span>üéüÔ∏è</span> Generar Ticket para Pagar en Sucursal
                        </>
                      )}
                    </button>
                    
                    {paymentMethod === 'app' && !registeredCard && (
                      <button 
                        onClick={() => { setShowPaymentOptions(false); setShowCardRegistration(true); }}
                        className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition"
                      >
                        Agregar Tarjeta
                      </button>
                    )}
                    
                    <button 
                      onClick={() => setShowPaymentOptions(false)}
                      className="w-full text-gray-500 dark:text-gray-400 text-sm hover:underline"
                    >
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* Ticket Confirmation Modal - After Payment */}
          {showTicketConfirmation && confirmedTicket && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
              <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                {/* Header */}
                <div className={`p-6 text-white text-center ${
                  confirmedTicket.paymentMethod === 'app' 
                    ? 'bg-gradient-to-r from-green-500 to-emerald-600' 
                    : 'bg-gradient-to-r from-blue-500 to-indigo-600'
                }`}>
                  <div className="text-5xl mb-2">{confirmedTicket.paymentMethod === 'app' ? '‚úÖ' : 'üéüÔ∏è'}</div>
                  <h3 className="text-2xl font-bold">
                    {confirmedTicket.paymentMethod === 'app' ? '¬°Ticket Pagado!' : '¬°Ticket Generado!'}
                  </h3>
                  <p className="text-white/80 text-sm mt-1">
                    {confirmedTicket.paymentMethod === 'app' 
                      ? 'Tu jugada est√° confirmada' 
                      : 'Recuerda pagar en la sucursal antes del sorteo'}
                  </p>
                </div>
                
                <div className="p-6" id="ticket-print-area">
                  {/* Ticket Details */}
                  <div className="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 mb-4">
                    <div className="text-center mb-4">
                      <div className="font-mono text-lg font-bold text-blue-600">#{confirmedTicket.id}</div>
                      <div className="text-sm text-gray-500 dark:text-gray-400">{confirmedTicket.bank}</div>
                    </div>
                    
                    {/* Plays */}
                    <div className="space-y-2 mb-4">
                      {confirmedTicket.plays.map((play, i) => (
                        <div key={i} className="flex justify-between text-sm">
                          <span className="text-gray-600 dark:text-gray-400">{play.type}</span>
                          <span className="font-mono font-bold dark:text-white">{Array.isArray(play.numbers) ? play.numbers.join(' - ') : play.numbers}</span>
                        </div>
                      ))}
                    </div>
                    
                    {/* Payment Breakdown */}
                    <div className="border-t dark:border-slate-600 pt-3 space-y-2">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600 dark:text-gray-400">Subtotal:</span>
                        <span className="dark:text-white">RD$ {confirmedTicket.subtotal.toLocaleString('es-DO')}</span>
                      </div>
                      <div className="flex justify-between text-sm text-orange-600 dark:text-orange-400">
                        <span>Servicio App:</span>
                        <span>RD$ {confirmedTicket.commission.toLocaleString('es-DO')}</span>
                      </div>
                      <div className="flex justify-between text-lg font-bold">
                        <span className="dark:text-white">Total:</span>
                        <span className="text-green-600">RD$ {confirmedTicket.total.toLocaleString('es-DO')}</span>
                      </div>
                    </div>
                    
                    {/* Payment Status */}
                    <div className="mt-4 pt-3 border-t dark:border-slate-600">
                      <div className="flex justify-between text-sm">
                        <span className="text-gray-600 dark:text-gray-400">Estado:</span>
                        <span className={`font-bold ${confirmedTicket.paymentStatus === 'paid' ? 'text-green-600' : 'text-yellow-600'}`}>
                          {confirmedTicket.paymentStatus === 'paid' ? '‚úì PAGADO' : '‚è≥ PENDIENTE DE PAGO'}
                        </span>
                      </div>
                      {confirmedTicket.paymentCard && (
                        <div className="flex justify-between text-sm mt-1">
                          <span className="text-gray-600 dark:text-gray-400">Pagado con:</span>
                          <span className="dark:text-white">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {confirmedTicket.paymentCard}</span>
                        </div>
                      )}
                      {confirmedTicket.paymentMethod === 'branch' && (
                        <div className="flex justify-between text-sm mt-1">
                          <span className="text-gray-600 dark:text-gray-400">Pagar antes de:</span>
                          <span className="text-red-600 font-bold">{new Date(confirmedTicket.drawTime).toLocaleString('es-DO', { 
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit' 
                          })}</span>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* QR Code for Branch Payment */}
                  {confirmedTicket.paymentMethod === 'branch' && (
                    <div className="flex justify-center mb-4">
                      <div className="bg-white p-3 rounded-lg">
                        <QRImage 
                          value={JSON.stringify({
                            id: confirmedTicket.id, 
                            total: confirmedTicket.total, 
                            status: confirmedTicket.paymentStatus,
                            bank: confirmedTicket.bank
                          })} 
                          size={120} 
                        />
                      </div>
                    </div>
                  )}
                </div>
                
                {/* Wallet Save Options */}
                <div className="px-6 pb-6 space-y-3">
                  <p className="text-xs text-center text-gray-500 dark:text-gray-400 mb-3">
                    üíº Guarda tu ticket para tenerlo siempre a mano
                  </p>
                  
                  <div className="grid grid-cols-2 gap-2">
                    <button 
                      onClick={() => downloadTicketForWallet(confirmedTicket, 1, 'pkpass')}
                      className="bg-black text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center gap-1 hover:bg-gray-800 transition"
                    >
                      üçé Apple Wallet
                    </button>
                    <button 
                      onClick={() => downloadTicketForWallet(confirmedTicket, 1, 'json')}
                      className="bg-blue-700 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center gap-1 hover:bg-blue-800 transition"
                    >
                      üì± Google Wallet
                    </button>
                  </div>
                  
                  <button 
                    onClick={() => { 
                      // Store ticket in app's local storage for later access
                      const savedTickets = JSON.parse(localStorage.getItem('ll_saved_tickets') || '[]');
                      if (!savedTickets.find(t => t.id === confirmedTicket.id)) {
                        savedTickets.push(confirmedTicket);
                        localStorage.setItem('ll_saved_tickets', JSON.stringify(savedTickets));
                      }
                      alert('‚úÖ Ticket guardado en la app');
                    }}
                    className="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition"
                  >
                    üì≤ Guardar en la App
                  </button>
                  
                  <button 
                    onClick={() => window.print()}
                    className="w-full bg-gray-200 dark:bg-slate-600 text-gray-700 dark:text-white py-2 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-slate-500 transition"
                  >
                    üñ®Ô∏è Imprimir Ticket
                  </button>
                  
                  <button 
                    onClick={() => { setShowTicketConfirmation(false); setConfirmedTicket(null); setView('home'); }}
                    className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition"
                  >
                    Listo ‚úì
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Winning Tickets Notification Modal */}
          {showWinningTicketsModal && winningTickets.length > 0 && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
              <div className="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
                {/* Header with celebration */}
                <div className="bg-gradient-to-r from-green-500 to-emerald-600 p-6 text-white text-center">
                  <div className="text-5xl mb-2">üéâüèÜüéâ</div>
                  <h3 className="text-2xl font-bold">¬°Tienes Tickets Ganadores!</h3>
                  <p className="text-green-100 mt-1">
                    {winningTickets.length} ticket{winningTickets.length > 1 ? 's' : ''} pendiente{winningTickets.length > 1 ? 's' : ''} de cobro
                  </p>
                </div>
                
                <div className="p-6">
                  {/* Winning tickets list */}
                  <div className="space-y-3 max-h-60 overflow-auto">
                    {winningTickets.map((t, i) => {
                      const prize = t.total * PROFILE_CONFIG.PRIZE_MULTIPLIER;
                      return (
                        <div key={t.id} className="p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border-2 border-green-200 dark:border-green-700">
                          <div className="flex justify-between items-center">
                            <div>
                              <p className="font-mono text-sm text-gray-600 dark:text-gray-400">#{t.id}</p>
                              <p className="font-medium dark:text-white">{t.bank}</p>
                            </div>
                            <div className="text-right">
                              <p className="text-xs text-gray-500 dark:text-gray-400">Premio:</p>
                              <p className="text-xl font-bold text-green-600">RD$ {prize.toLocaleString('es-DO')}</p>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Total */}
                  <div className="mt-4 p-4 bg-gray-50 dark:bg-slate-700 rounded-xl">
                    <div className="flex justify-between items-center">
                      <span className="font-medium dark:text-white">Total a Cobrar:</span>
                      <span className="text-2xl font-bold text-green-600">
                        RD$ {winningTickets.reduce((sum, t) => sum + (t.total * PROFILE_CONFIG.PRIZE_MULTIPLIER), 0).toLocaleString('es-DO')}
                      </span>
                    </div>
                  </div>
                  
                  {/* Actions */}
                  <div className="mt-6 space-y-3">
                    <button 
                      onClick={() => { setShowWinningTicketsModal(false); setView('profile'); }}
                      className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition flex items-center justify-center gap-2"
                    >
                      <span>üí∞</span> Ir a Cobrar Mis Premios
                    </button>
                    <button 
                      onClick={() => setShowWinningTicketsModal(false)}
                      className="w-full text-gray-500 dark:text-gray-400 text-sm hover:underline"
                    >
                      Cobrar m√°s tarde
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* Banca Conflict Modal */}
          {showBancaConflictModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
              <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <div className="text-center mb-6">
                  <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">‚ö†Ô∏è</div>
                  <h3 className="text-2xl font-bold mb-2 dark:text-white">Ticket Diferente</h3>
                  <p className="text-gray-600 dark:text-gray-300">
                    Ya tienes jugadas de <strong className="text-blue-600">{cartBanca}</strong>
                  </p>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">
                    Cada ticket solo puede ser para una sucursal espec√≠fica.
                  </p>
                </div>
                
                <div className="space-y-3">
                  <button 
                    onClick={() => {
                      // Complete current ticket and start new one
                      checkout();
                      setShowBancaConflictModal(false);
                      if (pendingPlay) {
                        setCartBanca(pendingPlay.banca || selectedBank?.name || 'Sin banca');
                        setCart([pendingPlay]);
                        setIsCartOpen(true);
                        setPendingPlay(null);
                      }
                    }}
                    className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition"
                  >
                    ‚úÖ Completar Ticket Actual
                  </button>
                  
                  <button 
                    onClick={() => {
                      // Clear current cart and start new one
                      setCart([]);
                      setCartBanca(null);
                      setShowBancaConflictModal(false);
                      if (pendingPlay) {
                        setCartBanca(pendingPlay.banca || selectedBank?.name || 'Sin banca');
                        setCart([pendingPlay]);
                        setIsCartOpen(true);
                        setPendingPlay(null);
                      }
                    }}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition"
                  >
                    üè™ Agregar Nueva Sucursal
                  </button>
                  
                  <button 
                    onClick={() => {
                      setShowBancaConflictModal(false);
                      setPendingPlay(null);
                    }}
                    className="w-full border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 py-3 rounded-lg font-bold hover:bg-gray-100 dark:hover:bg-slate-700 transition"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Luna AI Assistant Floating Button */}
          <button
            onClick={openVoiceAssistant}
            className="fixed bottom-24 right-6 w-16 h-16 bg-gradient-to-br from-gray-800 to-gray-900 dark:from-gray-700 dark:to-gray-800 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center z-40 border border-gray-700"
            title="Luna - Tu Asistente IA"
          >
            <span className="text-3xl">üåô</span>
          </button>

          {/* Voice Assistant Modal - ChatGPT-like AI Interface */}
          {isVoiceAssistantOpen && (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 p-4">
              <div className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
                {/* Header */}
                <div className="bg-gradient-to-r from-gray-800 to-gray-900 p-4 text-white">
                  <div className="flex justify-between items-center">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center border-2 border-white/20">
                        <span className="text-2xl">üåô</span>
                      </div>
                      <div>
                        <h3 className="font-bold text-lg">Luna</h3>
                        <p className="text-xs text-gray-300">
                          {assistantMode === 'idle' ? '‚ú® Tu asistente IA de LotoLink' :
                           assistantMode === 'select_banca' ? 'üìç Paso 1: Selecciona Banca' :
                           assistantMode === 'select_lottery' ? 'üé∞ Paso 2: Selecciona Loter√≠a' :
                           assistantMode === 'select_modality' ? 'üé≤ Paso 3: Tipo de Juego' :
                           assistantMode === 'select_numbers' ? 'üî¢ Paso 4: Elige tus N√∫meros' :
                           'üéØ Gui√°ndote para jugar'}
                        </p>
                      </div>
                    </div>
                    <button
                      onClick={() => { setIsVoiceAssistantOpen(false); setAssistantMode('idle'); setIsThinking(false); window.speechSynthesis.cancel(); }}
                      className="p-2 hover:bg-white/20 rounded-full transition"
                    >
                      ‚úï
                    </button>
                  </div>
                  
                  {/* Guided Play Progress Bar */}
                  {assistantMode !== 'idle' && (
                    <div className="mt-3 flex gap-1">
                      <div className={`h-1 flex-1 rounded ${assistantMode === 'select_banca' || assistantMode === 'select_lottery' || assistantMode === 'select_modality' || assistantMode === 'select_numbers' ? 'bg-white' : 'bg-white/30'}`}></div>
                      <div className={`h-1 flex-1 rounded ${assistantMode === 'select_lottery' || assistantMode === 'select_modality' || assistantMode === 'select_numbers' ? 'bg-white' : 'bg-white/30'}`}></div>
                      <div className={`h-1 flex-1 rounded ${assistantMode === 'select_modality' || assistantMode === 'select_numbers' ? 'bg-white' : 'bg-white/30'}`}></div>
                      <div className={`h-1 flex-1 rounded ${assistantMode === 'select_numbers' ? 'bg-white' : 'bg-white/30'}`}></div>
                    </div>
                  )}
                </div>

                {/* Guided Play Current Selections */}
                {assistantMode !== 'idle' && (guidedPlayData.banca || guidedPlayData.lottery || guidedPlayData.modality) && (
                  <div className="px-4 py-2 bg-gray-50 dark:bg-gray-900/30 border-b dark:border-slate-700 flex flex-wrap gap-2 text-xs">
                    {guidedPlayData.banca && (
                      <span className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-2 py-1 rounded-full">
                        üìç {guidedPlayData.banca.name.split(' - ')[0]}
                      </span>
                    )}
                    {guidedPlayData.lottery && (
                      <span className="bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                        üé∞ {guidedPlayData.lottery}
                      </span>
                    )}
                    {guidedPlayData.modality && (
                      <span className="bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
                        üé≤ {guidedPlayData.modality}
                      </span>
                    )}
                  </div>
                )}

                {/* Luna AI Avatar Animation */}
                <div className="p-6 text-center">
                  <div className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center text-5xl mb-4 transition-all ${
                    isThinking ? 'bg-gray-100 dark:bg-gray-800' :
                    isListening ? 'bg-red-100 dark:bg-red-900/30 animate-pulse scale-110' : 
                    isSpeaking ? 'bg-blue-50 dark:bg-blue-900/20 animate-bounce' :
                    'bg-gray-50 dark:bg-gray-800'
                  }`}>
                    {isThinking ? (
                      <div className="flex gap-1">
                        <span className="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></span>
                        <span className="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></span>
                        <span className="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></span>
                      </div>
                    ) : isListening ? 'üëÇ' : isSpeaking ? 'üåô' : 'üåô'}
                  </div>
                  
                  {/* Status */}
                  <p className={`text-sm font-medium mb-2 ${
                    isThinking ? 'text-gray-600 dark:text-gray-400' :
                    isListening ? 'text-red-600 dark:text-red-400' : 
                    isSpeaking ? 'text-blue-600 dark:text-blue-400' : 
                    'text-gray-600 dark:text-gray-400'
                  }`}>
                    {isThinking ? 'üí≠ Luna est√° pensando...' : 
                     isListening ? 'üî¥ Escuchando...' : 
                     isSpeaking ? 'üîä Luna est√° hablando...' : 
                     'üü¢ Lista para ayudarte'}
                  </p>

                  {/* User's voice message */}
                  {voiceMessage && (
                    <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-3">
                      <p className="text-xs text-gray-500 dark:text-gray-400 mb-1">T√∫ dijiste:</p>
                      <p className="text-blue-700 dark:text-blue-300 font-medium">"{voiceMessage}"</p>
                    </div>
                  )}

                  {/* Assistant response */}
                  {assistantResponse && (
                    <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
                      <p className="text-gray-700 dark:text-gray-200">{assistantResponse}</p>
                    </div>
                  )}
                </div>

                {/* Voice Settings Panel - TTS Customization */}
                <div className="px-6 py-3 border-t dark:border-slate-700 bg-gray-50 dark:bg-slate-900">
                  <details className="group">
                    <summary className="flex items-center justify-between cursor-pointer text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                      <span className="flex items-center gap-2">
                        <span>‚öôÔ∏è</span>
                        <span>Configuraci√≥n de Voz</span>
                      </span>
                      <span className="group-open:rotate-180 transition-transform">‚ñº</span>
                    </summary>
                    <div className="mt-3 space-y-3">
                      {/* Voice Enable Toggle */}
                      <div className="flex items-center justify-between">
                        <span className="text-xs text-gray-600 dark:text-gray-300">Voz habilitada</span>
                        <button
                          onClick={() => setVoiceSettings(prev => ({ ...prev, enabled: !prev.enabled }))}
                          className={`w-12 h-6 rounded-full transition-colors ${voiceSettings.enabled ? 'bg-blue-600' : 'bg-gray-300 dark:bg-slate-600'}`}
                        >
                          <span className={`block w-5 h-5 bg-white rounded-full shadow transform transition-transform ${voiceSettings.enabled ? 'translate-x-6' : 'translate-x-0.5'}`}></span>
                        </button>
                      </div>
                      
                      {/* Voice Gender Selection */}
                      <div className="flex items-center justify-between">
                        <span className="text-xs text-gray-600 dark:text-gray-300">Tipo de voz</span>
                        <div className="flex gap-1">
                          <button
                            onClick={() => setVoiceSettings(prev => ({ ...prev, gender: 'female' }))}
                            className={`px-3 py-1 text-xs rounded-full transition ${voiceSettings.gender === 'female' ? 'bg-pink-500 text-white' : 'bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300'}`}
                          >
                            üë© Femenina
                          </button>
                          <button
                            onClick={() => setVoiceSettings(prev => ({ ...prev, gender: 'male' }))}
                            className={`px-3 py-1 text-xs rounded-full transition ${voiceSettings.gender === 'male' ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300'}`}
                          >
                            üë® Masculina
                          </button>
                        </div>
                      </div>
                      
                      {/* Speech Speed */}
                      <div className="flex items-center justify-between">
                        <span className="text-xs text-gray-600 dark:text-gray-300">Velocidad</span>
                        <div className="flex gap-1">
                          {['slow', 'normal', 'fast'].map(speed => (
                            <button
                              key={speed}
                              onClick={() => setVoiceSettings(prev => ({ ...prev, speed }))}
                              className={`px-2 py-1 text-xs rounded transition ${voiceSettings.speed === speed ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-slate-700 text-gray-600 dark:text-gray-300'}`}
                            >
                              {speed === 'slow' ? 'üê¢' : speed === 'fast' ? 'üê∞' : 'üö∂'}
                            </button>
                          ))}
                        </div>
                      </div>
                      
                      {/* Accent Selection */}
                      <div className="flex items-center justify-between">
                        <span className="text-xs text-gray-600 dark:text-gray-300">Acento</span>
                        <select
                          value={voiceSettings.accent}
                          onChange={(e) => setVoiceSettings(prev => ({ ...prev, accent: e.target.value }))}
                          className="text-xs border dark:border-slate-600 rounded px-2 py-1 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200"
                        >
                          <option value="es-ES">üá™üá∏ Espa√±a</option>
                          <option value="es-MX">üá≤üáΩ M√©xico</option>
                          <option value="es-DO">üá©üá¥ Dominicano</option>
                          <option value="es-AR">üá¶üá∑ Argentina</option>
                          <option value="es-CO">üá®üá¥ Colombia</option>
                        </select>
                      </div>
                      
                      {/* Test Voice Button */}
                      <button
                        onClick={() => speakText('¬°Hola! Esta es una prueba de voz. ¬øC√≥mo se escucha?')}
                        className="w-full py-2 text-xs bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition border border-gray-200 dark:border-gray-700"
                      >
                        üîä Probar Voz
                      </button>
                    </div>
                  </details>
                </div>

                {/* Microphone Button */}
                <div className="p-6 pt-0">
                  <button
                    onClick={startListening}
                    disabled={isListening}
                    className={`w-full py-4 rounded-xl font-bold text-lg transition flex items-center justify-center gap-3 ${
                      isListening 
                        ? 'bg-red-500 text-white animate-pulse' 
                        : 'bg-gradient-to-r from-gray-800 to-gray-900 text-white hover:shadow-lg'
                    }`}
                  >
                    <span className="text-2xl">{isListening ? '‚èπÔ∏è' : 'üé§'}</span>
                    {isListening ? 'Escuchando...' : 'Hablar'}
                  </button>
                  
                  {/* Context-aware hints */}
                  <p className="text-xs text-center text-gray-400 mt-4">
                    {assistantMode === 'idle' && 'üí° Di "Quiero jugar" para empezar guiado, o "Ayuda" para m√°s comandos'}
                    {assistantMode === 'select_banca' && 'üí° Di el nombre de una banca o "la m√°s cercana"'}
                    {assistantMode === 'select_lottery' && 'üí° Di: Leidsa, Loteka, La Primera, o Loter√≠a Nacional'}
                    {assistantMode === 'select_modality' && 'üí° Di: Quiniela, Pal√©, o Tripleta'}
                    {assistantMode === 'select_numbers' && 'üí° Di los n√∫meros, por ejemplo: "quince, veintitr√©s"'}
                  </p>
                  
                  {/* Cancel guided flow button */}
                  {assistantMode !== 'idle' && (
                    <button
                      onClick={() => { 
                        setAssistantMode('idle'); 
                        setGuidedPlayData({ banca: null, lottery: null, modality: null, numbers: [] });
                        setAssistantResponse('He cancelado la selecci√≥n. ¬øEn qu√© m√°s puedo ayudarte?');
                        speakText('He cancelado la selecci√≥n. ¬øEn qu√© m√°s puedo ayudarte?');
                      }}
                      className="w-full mt-3 py-2 text-gray-500 dark:text-gray-400 text-sm hover:text-gray-700 dark:hover:text-gray-200 transition"
                    >
                      ‚úï Cancelar y empezar de nuevo
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
          
          {/* Mobile Bottom Navigation Bar - Only visible on mobile devices */}
          {view !== 'portal' && !showWelcomeScreen && (
            <nav className="lg:hidden fixed bottom-0 left-0 right-0 z-40 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl border-t border-gray-200 dark:border-slate-800" style={{ paddingBottom: 'max(8px, env(safe-area-inset-bottom))' }}>
              <div className="flex items-center justify-around px-2 py-2">
                <button 
                  onClick={() => setView('home')}
                  className={`flex flex-col items-center justify-center w-16 py-1.5 rounded-xl transition-all ${view === 'home' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`}
                >
                  <span className="text-xl mb-0.5">üè†</span>
                  <span className="text-[10px] font-medium">Inicio</span>
                </button>
                
                <button 
                  onClick={() => setView('loterias')}
                  className={`flex flex-col items-center justify-center w-16 py-1.5 rounded-xl transition-all ${view === 'loterias' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`}
                >
                  <span className="text-xl mb-0.5">üé∞</span>
                  <span className="text-[10px] font-medium">Loter√≠as</span>
                </button>
                
                <button 
                  onClick={() => openPlayModal(DEFAULT_BANKS[0])}
                  className="flex flex-col items-center justify-center -mt-4"
                >
                  <div className="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white text-2xl shadow-lg shadow-blue-500/40">
                    üéüÔ∏è
                  </div>
                  <span className="text-[10px] font-semibold text-blue-600 dark:text-blue-400 mt-1">Jugar</span>
                </button>
                
                <button 
                  onClick={() => setView('bancas')}
                  className={`flex flex-col items-center justify-center w-16 py-1.5 rounded-xl transition-all ${view === 'bancas' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`}
                >
                  <span className="text-xl mb-0.5">üè™</span>
                  <span className="text-[10px] font-medium">Bancas</span>
                </button>
                
                <button 
                  onClick={() => setView('profile')}
                  className={`flex flex-col items-center justify-center w-16 py-1.5 rounded-xl transition-all ${view === 'profile' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`}
                >
                  <span className="text-xl mb-0.5">üë§</span>
                  <span className="text-[10px] font-medium">Perfil</span>
                </button>
              </div>
            </nav>
          )}
        </div>
      );
    }

    ReactDOM.render(<LotoLinkApp />, document.getElementById('root'));

    /* --- MAP INIT LOGIC (Improved from MVP) --- */
    setInterval(() => {
       const mapContainer = document.getElementById('demo-leaflet-map');
       if (mapContainer && !mapContainer._leaflet_id) {
          const map = L.map('demo-leaflet-map').setView([18.4861, -69.9312], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
          DEFAULT_BANKS.forEach(b => {
             const m = L.marker(b.coords).addTo(map);
             
             // Create styled popup with explicit button
             const popupContent = `
               <div style="text-align:center; min-width: 150px;">
                 <div style="font-weight:bold; margin-bottom:4px; font-size:14px;">${b.name}</div>
                 <div style="font-size:12px; color:#666; margin-bottom:8px;">${b.hours}</div>
                 <button id="btn-play-${b.id}" style="background-color:#2563EB; color:white; border:none; padding:6px 12px; border-radius:20px; cursor:pointer; font-size:12px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                   Jugar Aqu√≠ üéüÔ∏è
                 </button>
               </div>
             `;
             
             m.bindPopup(popupContent);
             
             // Attach click event after popup opens
             m.on('popupopen', () => {
                setTimeout(() => {
                   const btn = document.getElementById(`btn-play-${b.id}`);
                   if (btn) {
                      btn.onclick = (e) => {
                         e.preventDefault();
                         if (window.triggerPlayModal) {
                            window.triggerPlayModal(b.id);
                         }
                      };
                   }
                }, 50);
             });
          });
       }
    }, 1000);
  </script>

  <!-- Vanilla JS Lottery Modal Logic (Enhanced from MVP) -->
  <script>
    (function(){
      // Sound effect for ticket generation
      function playChaChing() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          const now = ctx.currentTime;
          o.frequency.setValueAtTime(600, now);
          o.frequency.exponentialRampToValueAtTime(1200, now + 0.18);
          g.gain.setValueAtTime(0, now);
          g.gain.linearRampToValueAtTime(0.9, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          o.stop(now + 0.5);
        } catch (e) {
          console.warn('Audio not supported', e);
        }
      }
      
      // Dark mode toggle for lottery modal
      function toggleLotteryDarkMode() {
        const card = document.getElementById('modal-card');
        if (!card) return;
        card.classList.toggle('lottery-dark-mode');
        const btn = document.getElementById('lottery-dark-toggle-btn');
        if (btn) {
          btn.textContent = card.classList.contains('lottery-dark-mode') ? '‚òÄÔ∏è' : 'üåô';
        }
      }
      
      const MOCKUP_LOTTERIES = [
        { 
          id: "leidsa", 
          name: "Leidsa", 
          color: "#FFD700", 
          schedule: "Hoy 8:55 PM (dom: 3:55 PM)", 
          logoText: "LD", 
          modalities: [ 
            { 
              id: "quiniela", 
              name: "Quiniela", 
              pickCount: 1, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { first: 60, second: 8, third: 4 }, 
              description: "Elige 1 n√∫mero (00-99). Si coincide con 1er/2do/3er premio gana seg√∫n la tabla.",
              rules: "Selecciona un n√∫mero del 00 al 99. Si tu n√∫mero coincide con las dos √∫ltimas cifras del primer premio, ganas.",
              prizes: [
                { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
                { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
                { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
              ]
            }, 
            { 
              id: "pale", 
              name: "Pal√©", 
              pickCount: 2, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { firstSecond: 1000, firstThird: 1000, secondThird: 100 },
              description: "Elige 2 n√∫meros (00-99). Ganas si tus 2 n√∫meros aparecen entre los 3 premios.",
              rules: "Selecciona dos n√∫meros del 00 al 99. Ganas si tus n√∫meros coinciden con las dos √∫ltimas cifras de los dos primeros premios, en cualquier orden.",
              prizes: [
                { position: "1er y 2do Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "1er y 3er Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "2do y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }, 
            { 
              id: "tripleta", 
              name: "Tripleta", 
              pickCount: 3, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { three: 3000, two: 150 },
              description: "Elige 3 n√∫meros (00-99). Gana 3 en cualquiera orden o 2 de 3 con pago menor.",
              rules: "Selecciona tres n√∫meros del 00 al 99. Ganas si tus n√∫meros coinciden con las dos √∫ltimas cifras de los tres primeros premios, en cualquier orden.",
              prizes: [
                { position: "3 n√∫meros (cualquier orden)", multiplier: "3,000x", example: "Apuesta RD$10 = Gana RD$30,000" },
                { position: "2 de 3 n√∫meros", multiplier: "150x", example: "Apuesta RD$10 = Gana RD$1,500" }
              ]
            },
            { 
              id: "pega3", 
              name: "Pega 3", 
              pickCount: 3, 
              numberRange: [0, 9], 
              minBet: 5, 
              payouts: { exact: 700, anyOrder: 100 },
              description: "Elige 3 d√≠gitos (0-9). Pago mayor si aciertan en el mismo orden, menor si es cualquier orden.",
              rules: "Selecciona tres d√≠gitos del 0 al 9. Ganas m√°s si coinciden en orden exacto.",
              prizes: [
                { position: "Orden Exacto", multiplier: "700x", example: "Apuesta RD$10 = Gana RD$7,000" },
                { position: "Cualquier Orden", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }
          ] 
        },
        { 
          id: "loteka", 
          name: "Loteka", 
          color: "#00B0DB", 
          schedule: "Hoy 7:55 PM (diario)", 
          logoText: "LK", 
          modalities: [ 
            { 
              id: "quiniela", 
              name: "Quiniela", 
              pickCount: 1, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { first: 60, second: 8, third: 4 },
              description: "Elige 1 n√∫mero (00-99).",
              rules: "Selecciona un n√∫mero del 00 al 99. Ganas si coincide con las dos √∫ltimas cifras del primer premio.",
              prizes: [
                { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
                { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
                { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
              ]
            }, 
            { 
              id: "pale", 
              name: "Pal√©", 
              pickCount: 2, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { firstSecond: 1000, firstThird: 1000, secondThird: 100 },
              description: "Elige 2 n√∫meros (00-99).",
              rules: "Selecciona dos n√∫meros. Ganas si coinciden con los dos primeros premios en cualquier orden.",
              prizes: [
                { position: "1er y 2do Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "1er y 3er Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "2do y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }, 
            { 
              id: "tripleta", 
              name: "Tripleta", 
              pickCount: 3, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { three: 20000, two: 100 },
              description: "Elige 3 n√∫meros (00-99). Premio mayor si aciertas los 3 (cualquier orden).",
              rules: "Selecciona tres n√∫meros. Ganas si coinciden con los tres primeros premios en cualquier orden.",
              prizes: [
                { position: "3 n√∫meros (cualquier orden)", multiplier: "20,000x", example: "Apuesta RD$10 = Gana RD$200,000" },
                { position: "2 de 3 n√∫meros", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            },
            { 
              id: "toca3", 
              name: "Toca 3", 
              pickCount: 3, 
              numberRange: [0, 9], 
              minBet: 5, 
              payouts: { exact: 600, anyOrder: 100 },
              description: "Elige 3 d√≠gitos (0-9). Pago mayor si aciertan en el mismo orden, menor si es cualquier orden.",
              rules: "Selecciona tres d√≠gitos del 0 al 9. Ganas m√°s si coinciden en orden exacto.",
              prizes: [
                { position: "Orden Exacto", multiplier: "600x", example: "Apuesta RD$10 = Gana RD$6,000" },
                { position: "Cualquier Orden", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }
          ] 
        },
        {
          id: "laprimera", 
          name: "La Primera", 
          color: "#C81F46", 
          schedule: "Hoy 8:00 PM (y 12:00 PM)", 
          logoText: "LP",
          modalities: [ 
            { 
              id: "quiniela", 
              name: "Quiniela", 
              pickCount: 1, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { first: 60, second: 8, third: 4 },
              description: "Elige 1 n√∫mero (00-99).",
              rules: "Selecciona un n√∫mero del 00 al 99. Ganas si coincide con el primer premio.",
              prizes: [
                { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
                { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
                { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
              ]
            }, 
            { 
              id: "pale", 
              name: "Pal√©", 
              pickCount: 2, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { firstSecond: 1000, firstThird: 100, secondThird: 100 },
              description: "Elige 2 n√∫meros (00-99).",
              rules: "Selecciona dos n√∫meros. Ganas si coinciden con los dos primeros premios en cualquier orden.",
              prizes: [
                { position: "1er y 2do Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "1er y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" },
                { position: "2do y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }, 
            { 
              id: "tripleta", 
              name: "Tripleta", 
              pickCount: 3, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { three: 20000, two: 100 },
              description: "Elige 3 n√∫meros (00-99).",
              rules: "Selecciona tres n√∫meros. Ganas si coinciden con los tres primeros premios en cualquier orden.",
              prizes: [
                { position: "3 n√∫meros (cualquier orden)", multiplier: "20,000x", example: "Apuesta RD$10 = Gana RD$200,000" },
                { position: "2 de 3 n√∫meros", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            } 
          ]
        },
        {
          id: "loteria-nacional", 
          name: "Loter√≠a Nacional", 
          color: "#496079", 
          schedule: "Gana M√°s: 2:30 PM ‚Äî Loter√≠a (billetes): 9:00 PM", 
          logoText: "LN",
          modalities: [ 
            { 
              id: "quiniela", 
              name: "Quiniela (Gana M√°s)", 
              pickCount: 1, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { first: 60, second: 8, third: 4 },
              description: "Elige 1 n√∫mero (00-99) en Gana M√°s.",
              rules: "Selecciona un n√∫mero del 00 al 99. Ganas si coincide con el primer premio.",
              prizes: [
                { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
                { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
                { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
              ]
            },
            { 
              id: "pale", 
              name: "Pal√©", 
              pickCount: 2, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { firstSecond: 1000, firstThird: 1000, secondThird: 100 },
              description: "Elige 2 n√∫meros (00-99).",
              rules: "Selecciona dos n√∫meros. Ganas si coinciden con los dos primeros premios en cualquier orden.",
              prizes: [
                { position: "1er y 2do Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "1er y 3er Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "2do y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            },
            { 
              id: "tripleta", 
              name: "Tripleta", 
              pickCount: 3, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { three: 20000, two: 100 },
              description: "Elige 3 n√∫meros (00-99).",
              rules: "Selecciona tres n√∫meros. Ganas si coinciden con los tres primeros premios en cualquier orden.",
              prizes: [
                { position: "3 n√∫meros (cualquier orden)", multiplier: "20,000x", example: "Apuesta RD$10 = Gana RD$200,000" },
                { position: "2 de 3 n√∫meros", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }
          ]
        },
        {
          id: "loteria-real", 
          name: "Loter√≠a Real", 
          color: "#008000", 
          schedule: "Hoy 12:55 PM (varios sorteos)", 
          logoText: "LR",
          modalities: [ 
            { 
              id: "quiniela", 
              name: "Quiniela", 
              pickCount: 1, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { first: 60, second: 8, third: 4 },
              description: "Elige 1 n√∫mero (00-99).",
              rules: "Selecciona un n√∫mero del 00 al 99. Ganas si coincide con el primer premio.",
              prizes: [
                { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
                { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
                { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
              ]
            },
            { 
              id: "pale", 
              name: "Pal√©", 
              pickCount: 2, 
              numberRange: [0, 99], 
              minBet: 5, 
              payouts: { firstSecond: 1200, firstThird: 1200, secondThird: 200 },
              description: "Elige 2 n√∫meros (00-99). Loter√≠a Real suele pagar un poco m√°s en pal√© y tripleta.",
              rules: "Selecciona dos n√∫meros. Ganas si coinciden con los dos primeros premios en cualquier orden.",
              prizes: [
                { position: "1er y 2do Premio", multiplier: "1,200x", example: "Apuesta RD$10 = Gana RD$12,000" },
                { position: "1er y 3er Premio", multiplier: "1,200x", example: "Apuesta RD$10 = Gana RD$12,000" },
                { position: "2do y 3er Premio", multiplier: "200x", example: "Apuesta RD$10 = Gana RD$2,000" }
              ]
            },
            { 
              id: "tripleta", 
              name: "Tripleta", 
              pickCount: 3, 
              numberRange: [0, 99], 
              minBet: 5, 
              payouts: { three: 30000, two: 200 },
              description: "Elige 3 n√∫meros (00-99). Pago m√°ximo mayor en Loter√≠a Real.",
              rules: "Selecciona tres n√∫meros. Ganas si coinciden con los tres primeros premios en cualquier orden.",
              prizes: [
                { position: "3 n√∫meros (cualquier orden)", multiplier: "30,000x", example: "Apuesta RD$10 = Gana RD$300,000" },
                { position: "2 de 3 n√∫meros", multiplier: "200x", example: "Apuesta RD$10 = Gana RD$2,000" }
              ]
            }
          ]
        },
        {
          id: "la-suerte", 
          name: "La Suerte Dominicana", 
          color: "#FFA500", 
          schedule: "12:30 PM y 6:00 PM (Diario)", 
          logoText: "LS",
          modalities: [ 
            { 
              id: "quiniela", 
              name: "Quiniela D√≠a/Tarde", 
              pickCount: 1, 
              numberRange: [0, 99], 
              minBet: 5, 
              payouts: { first: 60, second: 8, third: 4 },
              description: "Elige 1 n√∫mero (00-99).",
              rules: "Selecciona un n√∫mero del 00 al 99. Ganas si coincide con el primer premio.",
              prizes: [
                { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
                { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
                { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
              ]
            },
            { 
              id: "pale", 
              name: "Pal√©", 
              pickCount: 2, 
              numberRange: [0, 99], 
              minBet: 5, 
              payouts: { firstSecond: 1000, firstThird: 1000, secondThird: 100 },
              description: "Elige 2 n√∫meros (00-99).",
              rules: "Selecciona dos n√∫meros. Ganas si coinciden con los dos primeros premios en cualquier orden.",
              prizes: [
                { position: "1er y 2do Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "1er y 3er Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "2do y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            },
            { 
              id: "tripleta", 
              name: "Tripleta", 
              pickCount: 3, 
              numberRange: [0, 99], 
              minBet: 5, 
              payouts: { three: 20000, two: 100 },
              description: "Elige 3 n√∫meros (00-99).",
              rules: "Selecciona tres n√∫meros. Ganas si coinciden con los tres primeros premios en cualquier orden.",
              prizes: [
                { position: "3 n√∫meros (cualquier orden)", multiplier: "20,000x", example: "Apuesta RD$10 = Gana RD$200,000" },
                { position: "2 de 3 n√∫meros", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }
          ]
        },
        {
          id: "lotedom", 
          name: "LoteDom", 
          color: "#800080", 
          schedule: "Sorteos diarios (12:00 PM)", 
          logoText: "LDm",
          modalities: [ 
            { 
              id: "quiniela", 
              name: "Quiniela", 
              pickCount: 1, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { first: 60, second: 8, third: 4 },
              description: "Elige 1 n√∫mero (00-99).",
              rules: "Selecciona un n√∫mero del 00 al 99. Ganas si coincide con el primer premio.",
              prizes: [
                { position: "1er Premio", multiplier: "60x", example: "Apuesta RD$10 = Gana RD$600" },
                { position: "2do Premio", multiplier: "8x", example: "Apuesta RD$10 = Gana RD$80" },
                { position: "3er Premio", multiplier: "4x", example: "Apuesta RD$10 = Gana RD$40" }
              ]
            },
            { 
              id: "pale", 
              name: "Pal√©", 
              pickCount: 2, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { firstSecond: 1000, firstThird: 1000, secondThird: 100 },
              description: "Elige 2 n√∫meros (00-99).",
              rules: "Selecciona dos n√∫meros. Ganas si coinciden con los dos primeros premios en cualquier orden.",
              prizes: [
                { position: "1er y 2do Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "1er y 3er Premio", multiplier: "1,000x", example: "Apuesta RD$10 = Gana RD$10,000" },
                { position: "2do y 3er Premio", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            },
            { 
              id: "tripleta", 
              name: "Tripleta", 
              pickCount: 3, 
              numberRange: [0, 99], 
              minBet: 1, 
              payouts: { three: 20000, two: 100 },
              description: "Elige 3 n√∫meros (00-99).",
              rules: "Selecciona tres n√∫meros. Ganas si coinciden con los tres primeros premios en cualquier orden.",
              prizes: [
                { position: "3 n√∫meros (cualquier orden)", multiplier: "20,000x", example: "Apuesta RD$10 = Gana RD$200,000" },
                { position: "2 de 3 n√∫meros", multiplier: "100x", example: "Apuesta RD$10 = Gana RD$1,000" }
              ]
            }
          ]
        }
      ];
      
      function fmt(n) { return String(n).padStart(2, "0"); }
      let selected = null; 
      let playing = null; 
      let selectedBanca = null;
      let bancaViewMode = 'list'; // 'list' or 'map'
      let bancaSelectionMap = null;
      let stake = 10;
      let modalStep = 'banca'; // 'banca' ‚Üí 'gameType' ‚Üí 'numbers'
      let selectedGameType = null; // 'quiniela', 'pale', 'tripleta', 'pega3', 'toca3'

      function renderLotteries() {
        const container = document.getElementById('lotteries'); 
        if (!container) return; 
        container.innerHTML = '';
        
        MOCKUP_LOTTERIES.forEach(l => {
          const btn = document.createElement('button'); 
          btn.className = "text-left rounded-xl bg-gray-50 dark:bg-slate-900 p-5 hover:shadow-md transition-all border border-transparent hover:border-blue-200 dark:hover:border-blue-500";
          btn.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold shadow-sm" style="background: ${l.color}">
                ${l.logoText}
              </div>
              <div>
                <div class="font-bold text-lg leading-tight dark:text-white">${l.name}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${l.schedule}</div>
              </div>
            </div>
          `;
          btn.onclick = () => openLottery(l.id); 
          container.appendChild(btn);
        });
      }
      
      function openLottery(id) { 
        selected = MOCKUP_LOTTERIES.find(x => x.id === id); 
        playing = null; 
        selectedBanca = null; // Reset banca selection
        bancaViewMode = 'list'; // Reset to list view
        modalStep = 'banca'; // Start from banca step
        selectedGameType = null; // Reset game type
        stake = 10;
        const root = document.getElementById('modal-root'); 
        if(root) { 
          root.classList.remove('hidden'); 
          root.classList.add('flex'); 
        } 
        renderModal(); 
      }
      
      function closeLottery() { 
        selected = null; 
        playing = null; 
        selectedBanca = null; // Reset banca selection
        bancaViewMode = 'list'; // Reset view mode
        modalStep = 'banca'; // Reset to first step
        selectedGameType = null; // Reset game type
        if (bancaSelectionMap) {
          bancaSelectionMap.remove();
          bancaSelectionMap = null;
        }
        const root = document.getElementById('modal-root'); 
        if(root) { 
          root.classList.add('hidden'); 
          root.classList.remove('flex'); 
        } 
        document.getElementById('modal-card').innerHTML = ''; 
      }
      
      function selectBanca(bancaId) {
        if (bancaId === null) {
          selectedBanca = null;
          modalStep = 'banca';
        } else {
          selectedBanca = DEFAULT_BANKS.find(b => b.id === bancaId);
          modalStep = 'gameType'; // Advance to game type selection
        }
        renderModal();
      }
      
      function toggleBancaView(mode) {
        bancaViewMode = mode;
        renderModal();
        if (mode === 'map') {
          setTimeout(initBancaMap, 100);
        }
      }
      
      function initBancaMap() {
        const mapContainer = document.getElementById('banca-selection-map');
        if (!mapContainer) return;
        
        // Remove existing map if any
        if (bancaSelectionMap) {
          bancaSelectionMap.remove();
          bancaSelectionMap = null;
        }
        
        // Create new map
        bancaSelectionMap = L.map('banca-selection-map').setView([18.4861, -69.9312], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
          attribution: '¬© OpenStreetMap' 
        }).addTo(bancaSelectionMap);
        
        // Add markers for each bank
        DEFAULT_BANKS.forEach(b => {
          const marker = L.marker(b.coords).addTo(bancaSelectionMap);
          
          const popupContent = `
            <div style="text-align:center; min-width: 150px;">
              <div style="font-weight:bold; margin-bottom:4px; font-size:14px;">${b.name}</div>
              <div style="font-size:12px; color:#666; margin-bottom:8px;">${b.hours}</div>
              <button id="btn-select-banca-${b.id}" style="background-color:#10b981; color:white; border:none; padding:6px 12px; border-radius:20px; cursor:pointer; font-size:12px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                Seleccionar esta banca ‚úì
              </button>
            </div>
          `;
          
          marker.bindPopup(popupContent);
          
          marker.on('popupopen', () => {
            setTimeout(() => {
              const btn = document.getElementById(`btn-select-banca-${b.id}`);
              if (btn) {
                btn.onclick = (e) => {
                  e.preventDefault();
                  selectBanca(b.id);
                };
              }
            }, 50);
          });
        });
      }
      
      // New helper functions for redesigned UI
      function selectGameType(gameType) {
        selectedGameType = gameType;
        
        // Since lottery is already selected at the beginning, go directly to numbers
        // Find the modality that matches the selected game type
        const modality = selected.modalities.find(m => {
          if (gameType === 'quiniela') return m.id.includes('quiniela');
          if (gameType === 'pale') return m.id.includes('pale');
          if (gameType === 'tripleta') return m.id.includes('tripleta');
          if (gameType === 'pega3') return m.id === 'pega3';
          if (gameType === 'toca3') return m.id === 'toca3';
          return false;
        });
        
        if (!modality) {
          console.error('No matching modality found for game type:', gameType);
          return;
        }
        
        playing = {
          lotteryId: selected.id,
          modality: modality,
          selectedNumbers: []
        };
        
        modalStep = 'numbers';
        renderModal();
      }
      
      function changeStep(step) {
        modalStep = step;
        if (step === 'banca') {
          selectedBanca = null;
          selectedGameType = null;
          playing = null;
        } else if (step === 'gameType') {
          selectedGameType = null;
          playing = null;
        }
        renderModal();
      }
      
      function startPlay(modId) {
        if (!selectedBanca) {
          // Show error if no banca selected
          const errorMsg = document.createElement('div');
          errorMsg.className = 'text-red-600 text-sm font-medium mt-2 animate-fade-in';
          errorMsg.textContent = '‚ö†Ô∏è Debes seleccionar una banca primero';
          const container = document.querySelector('.grid.grid-cols-1');
          if(container) {
            const existing = container.querySelector('.text-red-600');
            if(existing) existing.remove();
            container.appendChild(errorMsg);
            setTimeout(() => errorMsg.remove(), 3000);
          }
          return;
        }
        playing = { 
          lotteryId: selected.id, 
          modality: selected.modalities.find(m=>m.id===modId), 
          selectedNumbers: [] 
        }; 
        renderModal(); 
      }
      
      function toggleNumber(n) { 
        if(!playing) return; 
        const idx = playing.selectedNumbers.indexOf(n); 
        if(idx !== -1) {
          playing.selectedNumbers.splice(idx, 1); 
        } else { 
          const max = playing.modality.pickCount || 1; 
          if(playing.selectedNumbers.length < max) {
            playing.selectedNumbers.push(n); 
          }
        } 
        renderModal(); 
      }
      
      function quickPick() {
        if(!playing) return;
        const count = playing.modality.pickCount || 1;
        const maxNumber = playing.modality.numberRange ? playing.modality.numberRange[1] : 99;
        const isDigitOnly = maxNumber === 9;
        const nums = [];
        while(nums.length < count) {
          const randomNum = Math.floor(Math.random() * (maxNumber + 1));
          const n = isDigitOnly ? String(randomNum) : fmt(randomNum);
          if(!nums.includes(n)) nums.push(n);
        }
        playing.selectedNumbers = nums;
        renderModal();
      }
      
      function addToCartMock() { 
        if(window.addGlobalCartItem && playing && playing.selectedNumbers.length === playing.modality.pickCount && selectedBanca) { 
          window.addGlobalCartItem({ 
            lottery: selected.name, 
            modality: playing.modality.name, 
            numbers: [...playing.selectedNumbers], 
            stake: Number(stake),
            banca: selectedBanca.name,
            bancaHours: selectedBanca.hours
          }); 
          playing.selectedNumbers = []; 
          renderModal();
          // Success feedback - visual notification
          const btn = document.querySelector('.w-full.py-3.bg-green-600');
          if(btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Agregado al Bolso';
            btn.style.background = '#059669';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.style.background = '';
            }, 2000);
          }
        } else {
          // Error feedback - visual instead of alert
          const errorMsg = document.createElement('div');
          errorMsg.className = 'text-red-600 text-sm font-medium mt-2 animate-fade-in';
          if (!selectedBanca) {
            errorMsg.textContent = '‚ö†Ô∏è Debes seleccionar una banca primero';
          } else {
            errorMsg.textContent = `‚ö†Ô∏è Debes seleccionar ${playing.modality.pickCount} n√∫mero(s)`;
          }
          const container = document.querySelector('.lg\\:col-span-2');
          if(container) {
            const existing = container.querySelector('.text-red-600');
            if(existing) existing.remove();
            container.appendChild(errorMsg);
            setTimeout(() => errorMsg.remove(), 3000);
          }
        }
      }

      function renderModal() {
        const card = document.getElementById('modal-card'); 
        if(!card) return;
        
        // Dynamic header based on current selection
        let headerColor = selected ? selected.color : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        let headerLogo = selected ? selected.logoText : 'üé∞';
        let headerTitle = selected ? selected.name : 'Selecciona tu Juego';
        let headerSubtitle = selected ? `Pr√≥ximo sorteo: ${selected.schedule}` : 'Elige loter√≠a y modalidad';
        
        const headerHtml = `
          <div class="p-6 flex items-center gap-4 text-white" style="background: ${headerColor}">
            <div class="w-16 h-16 rounded-xl bg-white/20 flex items-center justify-center text-2xl font-bold shadow-lg">
              ${headerLogo}
            </div>
            <div class="flex-1">
              <h2 class="text-3xl font-bold">${headerTitle}</h2>
              <p class="text-sm text-white/80 mt-1">${headerSubtitle}</p>
            </div>
            <div class="flex items-center gap-2">
              <button id="lottery-dark-toggle-btn" onclick="toggleLotteryDarkMode()" class="bg-white/10 hover:bg-white/30 px-3 py-2 rounded-lg font-medium transition text-lg">
                üåô
              </button>
              <button onclick="window.closeLottery()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium transition">
                Cerrar
              </button>
            </div>
          </div>
        `;
        
        let contentHtml = '';
        
        // REDESIGNED UI: Step-based intuitive flow
        // Step 1: Select Banca
        if (modalStep === 'banca' || !selectedBanca) {
          contentHtml = `
            <div class="p-8">
              <h3 class="text-xl font-bold mb-2 dark:text-white">Paso 1: Selecciona tu banca</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Elige la sucursal donde realizar√°s tu jugada</p>
              
              <div class="flex gap-2 mb-6 justify-center">
                <button 
                  onclick="window.toggleBancaView('list')" 
                  class="px-4 py-2 rounded-lg font-medium text-sm transition ${bancaViewMode === 'list' ? 'bg-blue-600 text-white' : 'bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600'}"
                >
                  üìã Ver Lista
                </button>
                <button 
                  onclick="window.toggleBancaView('map')" 
                  class="px-4 py-2 rounded-lg font-medium text-sm transition ${bancaViewMode === 'map' ? 'bg-blue-600 text-white' : 'bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-slate-600'}"
                >
                  üó∫Ô∏è Buscar en el mapa
                </button>
              </div>
              
              ${bancaViewMode === 'list' ? `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  ${DEFAULT_BANKS.map(b => `
                    <button 
                      onclick="window.selectBanca(${b.id})" 
                      class="border-2 dark:border-slate-600 rounded-xl p-5 text-left hover:border-blue-500 hover:shadow-lg transition group"
                    >
                      <div class="flex items-start gap-3">
                        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center text-2xl flex-shrink-0">
                          üè™
                        </div>
                        <div class="flex-1">
                          <div class="font-bold text-lg mb-1 dark:text-white group-hover:text-blue-600">${b.name}</div>
                          <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                            <span class="inline-flex items-center gap-1">
                              üïê ${b.hours}
                            </span>
                          </div>
                          <div class="text-xs text-gray-400 dark:text-gray-500">
                            üìç Coordenadas: ${b.coords[0].toFixed(4)}, ${b.coords[1].toFixed(4)}
                          </div>
                        </div>
                      </div>
                      <div class="mt-3 text-xs text-blue-600 dark:text-blue-400 font-medium">
                        Seleccionar esta banca ‚Üí
                      </div>
                    </button>
                  `).join('')}
                </div>
              ` : `
                <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm text-gray-700 dark:text-gray-300 text-center">
                  <strong>üí° Tip:</strong> Haz clic en un marcador del mapa para ver los detalles y seleccionar la banca
                </div>
                <div id="banca-selection-map"></div>
              `}
              
              <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <div class="flex items-start gap-3">
                  <div class="text-2xl">‚ÑπÔ∏è</div>
                  <div class="text-sm text-gray-700 dark:text-gray-300">
                    <strong>¬øPor qu√© seleccionar una banca?</strong> La banca que selecciones procesar√° tu jugada y ser√° donde puedas cobrar tus premios si ganas.
                  </div>
                </div>
              </div>
            </div>
          `;
        } 
        // Step 2: Select Game Type
        else if (modalStep === 'gameType' || !selectedGameType) {
          const gameTypes = [
            { id: 'quiniela', name: 'Quiniela', icon: 'üéØ', desc: '1 n√∫mero', prize: '60x', color: 'blue' },
            { id: 'pale', name: 'Pal√©', icon: 'üé∞', desc: '2 n√∫meros', prize: 'Hasta 1,200x', color: 'purple' },
            { id: 'tripleta', name: 'Tripleta', icon: 'üé≤', desc: '3 n√∫meros', prize: 'Hasta 30,000x', color: 'green' },
            { id: 'pega3', name: 'Pega 3 / Toca 3', icon: 'üî¢', desc: '3 d√≠gitos (0-9)', prize: '70,000x', color: 'red' },
          ];
          
          contentHtml = `
            <div class="p-8">
              <div class="mb-6 flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                <span class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full font-medium">
                  ‚úì ${selectedBanca.name}
                </span>
                <span>‚Üí</span>
                <button onclick="window.changeStep('banca')" class="hover:text-blue-600 dark:hover:text-blue-400 underline">
                  Cambiar banca
                </button>
              </div>
              
              <h3 class="text-2xl font-bold mb-2 dark:text-white">Paso 2: Selecciona el tipo de juego</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">¬øC√≥mo quieres jugar hoy?</p>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${gameTypes.map(gt => `
                  <button 
                    onclick="window.selectGameType('${gt.id}')" 
                    class="border-2 dark:border-slate-600 rounded-xl p-6 text-left hover:border-${gt.color}-500 hover:shadow-xl transition-all transform hover:scale-105 group bg-white dark:bg-slate-800"
                  >
                    <div class="flex items-start gap-4">
                      <div class="w-16 h-16 bg-gradient-to-br from-${gt.color}-400 to-${gt.color}-600 rounded-xl flex items-center justify-center text-3xl shadow-lg">
                        ${gt.icon}
                      </div>
                      <div class="flex-1">
                        <div class="font-bold text-2xl mb-1 dark:text-white group-hover:text-${gt.color}-600">${gt.name}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">${gt.desc}</div>
                        <div class="inline-flex items-center gap-1 px-3 py-1 bg-green-50 dark:bg-green-900/20 rounded-full">
                          <span class="text-xs font-semibold text-green-700 dark:text-green-300">üí∞ Ganas hasta ${gt.prize}</span>
                        </div>
                      </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 text-${gt.color}-600 dark:text-${gt.color}-400 font-medium text-sm">
                      <span>Seleccionar</span>
                      <span>‚Üí</span>
                    </div>
                  </button>
                `).join('')}
              </div>
              
              <div class="mt-6 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg text-sm text-gray-600 dark:text-gray-400 text-center">
                <strong>üí° Consejo:</strong> Cada tipo de juego tiene diferentes premios y formas de ganar
              </div>
            </div>
          `;
        }
        // Step 3: Select Numbers
        else if (modalStep === 'numbers' && playing) {
          // Determine number range based on modality
          const maxNumber = playing.modality.numberRange ? playing.modality.numberRange[1] : 99;
          const isDigitOnly = maxNumber === 9; // For pega3/toca3
          
          let gridHtml = `<div class="grid ${isDigitOnly ? 'grid-cols-5 gap-2' : 'grid-cols-10 gap-1.5'} mt-4">`; 
          for(let i=0; i <= maxNumber; i++) { 
            const n = isDigitOnly ? String(i) : fmt(i); 
            const active = playing.selectedNumbers.includes(n); 
            gridHtml += `
              <button 
                onclick="window.toggleNumber('${n}')" 
                class="aspect-square p-2 text-sm font-bold rounded border transition ${
                  active 
                    ? 'bg-slate-900 text-white border-slate-900 shadow-md transform scale-105' 
                    : 'bg-white dark:bg-slate-700 dark:text-white border-gray-300 dark:border-slate-600 hover:bg-gray-100 dark:hover:bg-slate-600'
                }"
              >
                ${n}
              </button>
            `; 
          } 
          gridHtml += '</div>';
          
          const gameTypeName = selectedGameType === 'quiniela' ? 'Quiniela' : 
                               selectedGameType === 'pale' ? 'Pal√©' : 
                               selectedGameType === 'tripleta' ? 'Tripleta' :
                               selectedGameType === 'pega3' ? 'Pega 3 / Toca 3' : 'Toca 3';
          
          contentHtml = `
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div class="lg:col-span-2">
                <div class="mb-4 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg">
                  <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600 dark:text-gray-400">
                    <span class="px-2 py-1 bg-white dark:bg-slate-700 rounded font-medium">üè™ ${selectedBanca.name}</span>
                    <span>‚Ä¢</span>
                    <span class="px-2 py-1 bg-white dark:bg-slate-700 rounded font-medium">${gameTypeName}</span>
                    <span>‚Ä¢</span>
                    <span class="px-2 py-1 bg-white dark:bg-slate-700 rounded font-medium" style="color: ${selected.color}">${selected.name}</span>
                    <div class="flex-1"></div>
                    <button onclick="window.changeStep('gameType')" class="hover:text-blue-600 dark:hover:text-blue-400 underline">
                      Cambiar
                    </button>
                  </div>
                </div>
                
                <div class="flex justify-between items-center mb-4">
                  <div>
                    <h3 class="text-xl font-bold dark:text-white">${playing.modality.name}</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Selecciona ${playing.modality.pickCount} n√∫mero(s)</p>
                  </div>
                  <button 
                    onclick="window.quickPick()" 
                    class="px-4 py-2 bg-gray-100 dark:bg-slate-700 rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-slate-600 dark:text-white"
                  >
                    üé≤ Al Azar
                  </button>
                </div>
                ${gridHtml}
              </div>
              
              <div class="bg-gray-50 dark:bg-slate-900 p-6 rounded-xl border dark:border-slate-700 h-fit space-y-4">
                <div class="p-4 bg-white dark:bg-slate-800 rounded-lg border dark:border-slate-600 text-center">
                  <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">N√∫meros seleccionados:</div>
                  <div class="font-mono font-bold text-2xl text-blue-600 min-h-[40px] flex items-center justify-center">
                    ${playing.selectedNumbers.length ? playing.selectedNumbers.join(' - ') : '---'}
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                    ${playing.selectedNumbers.length} de ${playing.modality.pickCount}
                  </div>
                </div>
                
                ${playing.modality.prizes && playing.modality.prizes.length > 0 ? `
                  <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                    <div class="text-xs font-bold text-green-800 dark:text-green-300 mb-2 flex items-center gap-1">
                      <span>üí∞</span> Posibles Premios
                    </div>
                    ${playing.modality.prizes.map(p => `
                      <div class="mb-3 last:mb-0">
                        <div class="flex items-center justify-between mb-1">
                          <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">${p.position}</span>
                          <span class="text-sm font-bold text-green-600 dark:text-green-400">${p.multiplier}</span>
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">${p.example}</div>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                
                <div>
                  <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase block mb-2">Monto a Apostar (RD$)</label>
                  <input 
                    type="number" 
                    value="${stake}" 
                    oninput="window.updateStake(this.value)" 
                    class="w-full border dark:border-slate-600 p-3 rounded-lg dark:bg-slate-700 dark:text-white text-center font-bold text-lg" 
                    min="1"
                  />
                </div>
                
                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm text-center">
                  <div class="text-gray-600 dark:text-gray-300">Total a pagar:</div>
                  <div class="text-2xl font-bold text-blue-600">RD$ ${stake}</div>
                </div>
                
                <button 
                  onclick="window.addToCartMock()" 
                  class="w-full py-3 bg-green-600 text-white rounded-lg font-bold shadow-lg hover:bg-green-700 transition"
                >
                  Agregar al Bolso Global
                </button>
              </div>
            </div>
          `;
        }

        
        
        card.innerHTML = headerHtml + contentHtml;
      }
      
      function updateStake(value) {
        stake = Number(value) || 1;
      }
      
      function init() { 
        if(!document.getElementById('lotteries')) return setTimeout(init, 50); 
        renderLotteries(); 
      } 
      
      init();
      
      window.renderLotteries = renderLotteries;
      window.openLottery = openLottery; 
      window.closeLottery = closeLottery; 
      window.selectBanca = selectBanca;
      window.toggleBancaView = toggleBancaView;
      window.selectGameType = selectGameType;
      window.changeStep = changeStep;
      window.startPlay = startPlay; 
      window.toggleNumber = toggleNumber; 
      window.addToCartMock = addToCartMock;
      window.quickPick = quickPick;
      window.updateStake = updateStake;
      window.toggleLotteryDarkMode = toggleLotteryDarkMode;
      window.renderModal = renderModal;
    })();
  </script>
  
  <!-- PWA Install Banner & Service Worker -->
  <script>
    (function() {
      // PWA Install prompt handling
      let deferredPrompt;
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isAndroid = /Android/.test(navigator.userAgent);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      
      // Check if user has dismissed install banner
      const hasDeclinedInstall = localStorage.getItem('ll_declined_install');
      const hasInstalledApp = localStorage.getItem('ll_app_installed');
      
      // Create install banner for mobile users
      function createInstallBanner() {
        if (isStandalone || hasDeclinedInstall || hasInstalledApp) return;
        
        const banner = document.createElement('div');
        banner.id = 'pwa-install-banner';
        banner.className = 'fixed bottom-0 left-0 right-0 z-50 p-4 pb-6 transition-transform duration-300';
        banner.style.cssText = 'background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%); padding-bottom: max(24px, env(safe-area-inset-bottom));';
        
        if (isIOS) {
          // iOS-specific install instructions
          banner.innerHTML = `
            <div class="max-w-md mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-4 flex items-center gap-4">
              <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold flex-shrink-0 shadow-lg">L</div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-900 dark:text-white text-sm">Instalar LotoLink</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Toca <span class="inline-flex items-center bg-gray-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-[10px]">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/></svg>
                </span> y luego "A√±adir a inicio"</div>
              </div>
              <button onclick="dismissInstallBanner()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          `;
        } else if (deferredPrompt || isAndroid) {
          // Android/Desktop with install prompt
          banner.innerHTML = `
            <div class="max-w-md mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-4 flex items-center gap-4">
              <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white text-2xl font-bold flex-shrink-0 shadow-lg">L</div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-900 dark:text-white text-sm">Instalar LotoLink</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">Instala la app para una mejor experiencia</div>
              </div>
              <button onclick="installApp()" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-xl hover:bg-blue-700 transition-all">
                Instalar
              </button>
              <button onclick="dismissInstallBanner()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          `;
        }
        
        if (banner.innerHTML) {
          document.body.appendChild(banner);
          
          // Animate in after a short delay
          setTimeout(() => {
            banner.style.transform = 'translateY(0)';
          }, 2000);
          banner.style.transform = 'translateY(100%)';
        }
      }
      
      // Install app function
      window.installApp = async function() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            localStorage.setItem('ll_app_installed', 'true');
            const banner = document.getElementById('pwa-install-banner');
            if (banner) banner.remove();
          }
          deferredPrompt = null;
        }
      };
      
      // Dismiss install banner
      window.dismissInstallBanner = function() {
        localStorage.setItem('ll_declined_install', Date.now().toString());
        const banner = document.getElementById('pwa-install-banner');
        if (banner) {
          banner.style.transform = 'translateY(100%)';
          setTimeout(() => banner.remove(), 300);
        }
      };
      
      // Listen for install prompt event
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        createInstallBanner();
      });
      
      // Track successful installation
      window.addEventListener('appinstalled', () => {
        localStorage.setItem('ll_app_installed', 'true');
        const banner = document.getElementById('pwa-install-banner');
        if (banner) banner.remove();
      });
      
      // Show iOS banner after page load
      if (isIOS && !isStandalone) {
        setTimeout(createInstallBanner, 3000);
      }
      
      // Register minimal service worker for offline support
      if ('serviceWorker' in navigator) {
        // Using inline service worker via blob URL for single-file app
        const swCode = `
          const CACHE_NAME = 'lotolink-v1';
          const urlsToCache = ['/'];
          
          self.addEventListener('install', (event) => {
            self.skipWaiting();
          });
          
          self.addEventListener('activate', (event) => {
            event.waitUntil(clients.claim());
          });
          
          self.addEventListener('fetch', (event) => {
            event.respondWith(
              caches.match(event.request).then((response) => {
                return response || fetch(event.request);
              })
            );
          });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        // Note: Blob URLs won't work for service workers in production
        // This is a placeholder - in production, use a separate sw.js file
        console.log('LotoLink PWA: Ready for installation');
      }
    })();
  </script>
</body>
</html>